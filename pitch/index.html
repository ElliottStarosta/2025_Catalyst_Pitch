<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Senergy</title>
  <link rel="icon" href="logo-icon-blue.png" type="image/png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #1f3b73;
      --primary-color-hover: #16305f;

      --secondary-color: #4a90e2;
      --secondary-color-hover: #3b7dd3;
      --background-color: #ffffff;
      --background-alt-color: #fafafa;

      --text-color: #1a1a1a;
      --muted-text-color: #555555; 
      --inverted-text-color: #ffffff;

      --border-color: #e0e0e0;            

      --primary-gradient: linear-gradient(135deg, #1f3b73, #4a90e2); 
      --secondary-gradient: linear-gradient(135deg, #4a90e2, #a0c8f0);
      --accent-gradient: linear-gradient(135deg, #7bede7, #7971f3);
      --background-gradient: linear-gradient(180deg, #ffffff, #fafafa);

      --shadow-small: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-large: 0 10px 15px rgba(0, 0, 0, 0.15);

      --border-radius-small: 4px;
      --border-radius-medium: 8px;
      --border-radius-large: 12px;

      --success-color: #27ae60;
      --error-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #3498db;

      --transition: all 0.3s ease;
      --blue-bg: rgba(74, 144, 226, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", "Inter", -apple-system, BlinkMacSystemFont,
        sans-serif;
      background: var(--background-color);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Modern navbar */
    .navbar {
      background: var(--background-color);
      padding: 1.2rem 2rem;
      margin: 2rem 0;
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-medium);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 20px;
      z-index: 100;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 800;

      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
      list-style: none;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--text-color);
      font-weight: 500;
      transition: var(--transition);
      position: relative;
      padding: 8px 0;
      font-size: 1rem;
    }

    .nav-links a::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 3px;
      background: var(--accent-gradient);
      border-radius: var(--border-radius-small);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(-50%);
    }

    .nav-links a:hover {
      color: var(--secondary-color);
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    .nav-links a.active {
      color: var(--secondary-color);
      font-weight: 600;
    }

    .nav-links a.active::after {
      width: 100%;
    }

    /* Card styling */
    .card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 2.5rem;
      margin-bottom: 2.5rem;
      box-shadow: var(--shadow-medium);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-large);
    }

    .card-header {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .card-header h2 {
      font-size: 1.8rem;
      color: var(--text-color);
      margin-bottom: 0.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .card-header p {
      color: var(--muted-text-color);
      max-width: 700px;
      margin: 0 auto;
    }

    .hidden {
      display: none;
    }

    /* Buttons */
    .btn {
      background: var(--primary-gradient);
      color: var(--inverted-text-color);
      border: none;
      padding: 14px 28px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow-small);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
      filter: brightness(1.1);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--background-alt-color);
      color: var(--text-color);
      border: 2px solid var(--border-color);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: var(--border-color);
      transform: translateY(-3px);
      box-shadow: var(--shadow-small);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--error-color) 0%, #c0392b 100%);
      color: var(--inverted-text-color);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color) 0%, #2ecc71 100%);
      color: var(--inverted-text-color);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info-color) 0%, #2980b9 100%);
      color: var(--inverted-text-color);
    }

    /* Personality assessment */
    .question-container {
      margin-bottom: 2.5rem;
      padding: 1.5rem;
      border-radius: var(--border-radius-large);
      background: var(--blue-bg);
    }

    .question-text {
      font-size: 1.3rem;
      margin-bottom: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
      text-align: center;
    }

    .scale-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0;
    }

    .scale-labels {
      display: flex;
      justify-content: space-between;
      width: 100%;
      font-size: 0.95rem;
      color: var(--muted-text-color);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .radio-group {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .radio-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      padding: 10px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .radio-item:hover {
      background: rgba(74, 144, 226, 0.1);
      transform: translateY(-5px);
      box-shadow: var(--shadow-small);
    }

    .radio-item input[type="radio"] {
      appearance: none;
      width: 24px;
      height: 24px;
      border: 2px solid var(--secondary-color);
      border-radius: 50%;
      position: relative;
      cursor: pointer;
      transition: var(--transition);
    }

    .radio-item input[type="radio"]:checked {
      background: var(--secondary-color);
    }

    .radio-item input[type="radio"]:checked::after {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--inverted-text-color);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .radio-item label {
      margin-top: 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--secondary-color);
    }

    .progress-container {
      margin: 2rem 0;
      padding: 0 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: rgba(74, 144, 226, 0.2);
      border-radius: var(--border-radius-small);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--secondary-gradient);
      border-radius: var(--border-radius-small);
      transition: width 0.5s ease;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--muted-text-color);
      font-weight: 500;
    }

    /* Results page */
    .personality-result {
      text-align: center;
      padding: 2rem;
    }

    .personality-score {
      font-size: 4rem;
      font-weight: 800;
      margin: 1.5rem 0;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .personality-type {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      font-weight: 700;
      color: var(--text-color);
    }

    .personality-description {
      max-width: 600px;
      margin: 0 auto 2rem;
      font-size: 1.1rem;
      color: var(--muted-text-color);
      line-height: 1.7;
    }

    /* Activity cards */
    .activity-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.8rem;
      margin-top: 2rem;
    }

    .activity-card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      box-shadow: var(--shadow-small);
      transition: var(--transition);
      cursor: pointer;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    .activity-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-large);
      border-color: var(--secondary-color);
    }

    .activity-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    .activity-category {
      color: var(--secondary-color);
      font-size: 0.95rem;
      margin-bottom: 1rem;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .activity-details {
      margin-bottom: 1.2rem;
      color: var(--muted-text-color);
      flex-grow: 1;
    }

    .rating-section {
      border-top: 1px solid var(--border-color);
      padding-top: 1.2rem;
      margin-top: 1.2rem;
    }

    .rating-questions {
      margin-bottom: 1.2rem;
    }

    .rating-question {
      margin-bottom: 1.5rem;
    }

    .rating-question label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 500;
      color: var(--text-color);
    }

    .rating-slider {
      width: 100%;
      height: 8px;
      border-radius: var(--border-radius-small);
      background: rgba(74, 144, 226, 0.2);
      outline: none;
      appearance: none;
    }

    .rating-slider::-webkit-slider-thumb {
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--secondary-gradient);
      cursor: pointer;
      box-shadow: var(--shadow-small);
      border: 2px solid var(--inverted-text-color);
    }

    .rating-slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary-gradient);
      cursor: pointer;
      box-shadow: var(--shadow-small);
      border: 2px solid var(--inverted-text-color);
    }

    .slider-value {
      text-align: center;
      font-weight: 700;
      color: var(--muted-text-color);
      margin-top: 0.8rem;
      font-size: 1.1rem;
    }

    .final-score {
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
      padding: 1.2rem;
      background: var(--primary-gradient);
      color: var(--inverted-text-color);
      border-radius: var(--border-radius-medium);
      margin-top: 1.5rem;
      box-shadow: var(--shadow-small);
    }

    /* User info */
    .user-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2.5rem;
      background: var(--blue-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius-large);
    }

    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--secondary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--inverted-text-color);
      font-size: 1.8rem;
      font-weight: 700;
      box-shadow: var(--shadow-small);
    }

    .welcome-text {
      font-size: 1.3rem;
      color: var(--text-color);
      font-weight: 500;
    }

    .welcome-text strong {
      font-weight: 700;
      color: var(--primary-color);
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.8rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .form-control {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-medium);
      font-size: 1rem;
      transition: var(--transition);
      background: var(--background-color);
      color: var(--text-color);
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(31, 59, 115, 0.2);
    }

    .form-control::placeholder {
      color: var(--muted-text-color);
    }

    .form-control select {
      cursor: pointer;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 120px;
    }

    /* Feed items */
    .feed-item {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      margin-bottom: 1.8rem;
      box-shadow: var(--shadow-small);
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .feed-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-medium);
    }

    .feed-header {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      margin-bottom: 1.2rem;
    }

    .feed-avatar {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--inverted-text-color);
      font-size: 1.3rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .feed-user-info h4 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.1rem;
    }

    .feed-user-info .personality-type {
      font-size: 0.85rem;
      color: var(--primary-color);
      margin: 0.3rem 0 0;
      font-weight: 600;
    }

    .feed-timestamp {
      font-size: 0.8rem;
      color: var(--muted-text-color);
      margin-top: 0.2rem;
    }

    .feed-content {
      margin-bottom: 1.2rem;
    }

    .feed-rating {
      display: inline-block;
      background: var(--primary-gradient);
      color: var(--inverted-text-color);
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 700;
      margin-bottom: 1.2rem;
      font-size: 0.95rem;
    }

    .similar-users-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .similar-user-card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      text-align: center;
      box-shadow: var(--shadow-small);
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .similar-user-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-medium);
    }

    .similarity-score {
      background: var(--accent-gradient);
      color: var(--inverted-text-color);
      padding: 0.4rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-top: 1rem;
      display: inline-block;
    }

    .group-card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      margin-bottom: 1.8rem;
      box-shadow: var(--shadow-small);
      border: 1px solid var(--border-color);
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.2rem;
    }

    .group-members {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-bottom: 1.2rem;
    }

    .group-members>div:last-child {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* Voting system styles */
    .voting-section {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: var(--background-alt-color);
      border-radius: var(--border-radius-medium);
    }

    .vote-button {
      background: var(--border-color);
      color: var(--text-color);
      border: 2px solid transparent;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0 0.5rem 0.5rem 0;
    }

    .vote-button:hover {
      background: var(--muted-text-color);
      color: var(--inverted-text-color);
      transform: translateY(-2px);
    }

    .vote-button.voted {
      background: var(--primary-color);
      color: var(--inverted-text-color);
      border-color: var(--primary-color);
    }

    .most-voted {
      border: 3px solid var(--error-color) !important;
      background: rgba(231, 76, 60, 0.1) !important;
      position: relative;
    }

    .most-voted::before {
      content: "🏆 MOST VOTED";
      position: absolute;
      top: -10px;
      left: 10px;
      background: var(--error-color);
      color: var(--inverted-text-color);
      padding: 4px 12px;
      border-radius: var(--border-radius-medium);
      font-size: 0.7rem;
      font-weight: bold;
    }

    .vote-count {
      font-size: 0.8rem;
      color: var(--muted-text-color);
      margin-top: 0.5rem;
      font-weight: bold;
    }

    .edit-group-btn {
      background: var(--info-color);
      color: var(--inverted-text-color);
      border: none;
      padding: 14px 28px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin-right: 0.5rem;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow-small);
    }

    .edit-group-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
      filter: brightness(1.1);
    }

    .member-tag {
      background: rgba(31, 59, 115, 0.1);
      color: var(--primary-color);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .prediction-card {
      background: var(--blue-bg);
      border: 2px solid rgba(31, 59, 115, 0.15);
      border-radius: var(--border-radius-medium);
      padding: 1.2rem;
      margin: 1.2rem 0;
    }

    .prediction-score {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 0.5rem;
      background: var(--primary-color);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .prediction-confidence {
      text-align: center;
      font-size: 0.95rem;
      color: var(--muted-text-color);
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin: 1.5rem 0;
    }

    .stat-card {
      text-align: center;
      padding: 1.5rem;
      background: var(--blue-bg);
      border-radius: var(--border-radius-medium);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      background: rgba(74, 144, 226, 0.15);
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.95rem;
      color: var(--muted-text-color);
    }

    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 2rem;
    }

    .search-input {
      width: 100%;
      padding: 14px 50px 14px 20px;
      border: 2px solid var(--border-color);
      border-radius: 50px;
      font-size: 1rem;
      background: var(--background-color);
      color: var(--text-color);
      transition: var(--transition);
      font-family: inherit;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(31, 59, 115, 0.2);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary-color);
      font-size: 1.2rem;
    }

    .filter-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 0.9rem 1.8rem;
      border: 2px solid var(--primary-color);
      border-radius: 50px;
      background: transparent;
      color: var(--primary-color);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      font-size: 0.95rem;
    }

    .filter-tab.active {
      background: var(--primary-color);
      color: var(--inverted-text-color);
    }

    .filter-tab:hover:not(.active) {
      background: rgba(31, 59, 115, 0.1);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted-text-color);
    }

    .empty-state h3 {
      margin-bottom: 1rem;
      color: var(--text-color);
      font-size: 1.5rem;
    }

    .empty-state p {
      max-width: 500px;
      margin: 0 auto 1.5rem;
    }

    .centered {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    /* GROUPS */
    .modal {
      display: flex;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
      overflow: hidden; /* Prevent modal from scrolling */
    }

    /* Prevent body scrolling when modal is open */
    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    /* Custom scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-gradient);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-gradient);
    }

    /* Firefox scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) #f1f1f1;
    }

    .modal-content {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 0;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow-large);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      padding: 2rem 2rem 1rem 2rem;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.8rem;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 25px;
      color: var(--muted-text-color);
      font-size: 35px;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      color: var(--text-color);
      background: rgba(0, 0, 0, 0.1);
      transform: rotate(90deg);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .activity-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 992px) {
      .navbar {
        flex-direction: column;
        gap: 1.2rem;
        padding: 1.5rem;
      }

      .nav-links {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }

      .card {
        padding: 1.8rem;
      }

      .radio-group {
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .activity-grid,
      .stats-grid,
      .similar-users-grid {
        grid-template-columns: 1fr;
      }

      .user-info {
        flex-direction: column;
        text-align: center;
      }

      .group-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <nav class="navbar">
      <div class="logo">
        <img src="logo-icon-blue.png" alt="Social Energy" style="width: 50px; height: 50px; border-radius: 6px" />
        Senergy
      </div>
      <ul class="nav-links">
        <li>
          <a href="#" onclick="showPage('dashboard')" id="nav-dashboard">Dashboard</a>
        </li>
        <li>
          <a href="#" onclick="showPage('assessment')" id="nav-assessment">Assessment</a>
        </li>
        <li>
          <a href="#" onclick="showPage('activities')" id="nav-activities">Add Experience</a>
        </li>
        <li>
          <a href="#" onclick="showPage('feed')" id="nav-feed">Community</a>
        </li>
        <li>
          <a href="#" onclick="showPage('groups')" id="nav-groups">Groups</a>
        </li>
        <li>
          <a href="#" onclick="showPage('profile')" id="nav-profile">Profile</a>
        </li>
      </ul>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page">
      <div class="card">
        <div class="user-info">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <div class="welcome-text" id="welcome-message">
              Welcome! Take the personality assessment to get started.
            </div>
          </div>
        </div>

        <div id="dashboard-content" class="centered">
          <h2>Discover Your Perfect Social Experiences</h2>
          <p style="padding: 1.2rem">
            Find activities that match your energy preferences and connect
            with like-minded people.
          </p>
          <button class="btn" onclick="showPage('assessment')">
            <i class="fas fa-play-circle"></i> Start Assessment
          </button>
        </div>
      </div>
    </div>

    <!-- Personality Assessment Page -->
    <div id="assessment" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Personality Assessment</h2>
          <p>
            Answer these questions to help us understand your social energy
            preferences.
          </p>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
          <div class="progress-info">
            <span id="progress-text">Question 1 of 10</span>
            <span>Understanding your energy</span>
          </div>
        </div>

        <div id="question-container">
          <!-- Questions will be dynamically inserted here -->
        </div>

        <div class="centered">
          <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>
            Next Question <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Assessment Results -->
    <div id="results" class="page hidden">
      <div class="card">
        <div class="personality-result">
          <h2>Your Personality Profile</h2>
          <div class="personality-score" id="personality-score">0.0</div>
          <div class="personality-type" id="personality-type">Ambivert</div>
          <p class="personality-description" id="personality-description">
            You have a balanced approach to social energy.
          </p>
          <button class="btn" onclick="completeAssessment()">
            <i class="fas fa-tachometer-alt"></i> Continue to Dashboard
          </button>
        </div>
      </div>
    </div>

    <!-- Activities Page -->
    <div id="activities" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Add Your Experience</h2>
          <p>
            Share a recent social experience and rate how it affected your
            energy levels.
          </p>
        </div>

        <form id="activity-form" onsubmit="ActivitySystem.submitNewExperience(event)">
          <div class="form-group">
            <label for="activity-name"><i class="fas fa-map-marker-alt"></i> Place/Activity Name
              *</label>
            <input type="text" id="activity-name" class="form-control"
              placeholder="e.g., The Coffee Bean, Central Park, Downtown Nightclub" required />
          </div>

          <div class="form-group">
            <label for="activity-category"><i class="fas fa-tag"></i> Category *</label>
            <select id="activity-category" class="form-control" required>
              <option value="">Select category...</option>
              <option value="Restaurant">Restaurant</option>
              <option value="Bar/Pub">Bar/Pub</option>
              <option value="Nightclub">Nightclub</option>
              <option value="Cafe">Cafe</option>
              <option value="Park/Outdoor">Park/Outdoor</option>
              <option value="Museum/Gallery">Museum/Gallery</option>
              <option value="Shopping">Shopping</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Sports/Fitness">Sports/Fitness</option>
              <option value="Library/Study">Library/Study</option>
              <option value="Event/Party">Event/Party</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="activity-location"><i class="fas fa-location-dot"></i> Location *</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="text" id="activity-location" class="form-control" required
                placeholder="e.g., Downtown, Brooklyn, Central Mall" style="flex: 1;" />
              <button type="button" id="use-current-location-btn" class="btn btn-secondary" 
                      style="white-space: nowrap; padding: 14px 16px; font-size: 0.9rem;"
                      onclick="useCurrentLocation()">
                <i class="fas fa-crosshairs"></i> Use Current Location
              </button>
            </div>
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
              <i class="fas fa-info-circle"></i> We'll use your location to provide better recommendations and help others find places near you.
            </div>
          </div>

          <div class="form-group">
            <label for="activity-description"><i class="fas fa-align-left"></i> Description (Optional)</label>
            <textarea id="activity-description" class="form-control"
              placeholder="Describe the atmosphere, what you did, who you were with..."></textarea>
          </div>

          <div class="form-group">
            <label><i class="fas fa-star"></i> Rate Your Experience:</label>
            <div class="rating-questions" id="new-activity-rating">
              <div class="rating-question">
                <label>How energized did you feel?</label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-energy')" id="rating-energy" />
                <div class="slider-value" id="slider-energy">5</div>
              </div>
              <div class="rating-question">
                <label>How satisfied were you with the social interaction?
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-social')" id="rating-social" />
                <div class="slider-value" id="slider-social">5</div>
              </div>
              <div class="rating-question">
                <label>How comfortable did you feel in this environment?
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-comfort')" id="rating-comfort" />
                <div class="slider-value" id="slider-comfort">5</div>
              </div>
              <div class="rating-question">
                <label>How overwhelming was the environment? (Rate higher if it felt more overwhelming)
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-overwhelm')" id="rating-overwhelm" />
                <div class="slider-value" id="slider-overwhelm">5</div>
              </div>
              <div class="rating-question">
                <label>How likely are you to return? </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-return')" id="rating-return" />
                <div class="slider-value" id="slider-return">5</div>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button type="submit" class="btn">
              <i class="fas fa-plus-circle"></i> Add Experience
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetActivityForm()">
              <i class="fas fa-eraser"></i> Clear Form
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Community Feed Page -->
    <div id="feed" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Community Activity Feed</h2>
          <p>
            See what others in the community are experiencing and discover new
            places.
          </p>
        </div>

        <div class="search-box">
          <input type="text" class="search-input" id="feed-search" placeholder="Search activities, places, or users..."
            onkeyup="FeedSystem.filterFeed()" />
          <span class="search-icon"><i class="fas fa-search"></i></span>
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" onclick="FeedSystem.setFilter('all')">
            All Activities
          </button>
          <button class="filter-tab" onclick="FeedSystem.setFilter('similar')">
            Similar Users
          </button>
          <button class="filter-tab" onclick="FeedSystem.setFilter('high-rated')">
            Top Rated
          </button>
          <button class="filter-tab" onclick="FeedSystem.setFilter('recent')">
            Recent
          </button>
          <button class="filter-tab" onclick="FeedSystem.setFilter('nearby')" id="nearby-filter-btn">
            <i class="fas fa-map-marker-alt"></i> Near Me
          </button>
        </div>

        <div id="feed-content">
          <!-- Feed items will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- Groups Page -->
    <div id="groups" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Group Planning</h2>
          <p>
            Create groups with friends and find activities that work for
            everyone's energy preferences.
          </p>
        </div>

        <div class="centered">
          <button class="btn" onclick="showCreateGroupModal()" id="create-group-btn">
            <i class="fas fa-users"></i> Create New Group
          </button>
        </div>

        <!-- Group Usage Display -->
        <div id="group-usage-display" style="
          background: rgba(74, 144, 226, 0.1); 
          padding: 1rem; 
          border-radius: 10px; 
          margin: 1rem 0; 
          text-align: center;
        ">
          <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-users" style="color: var(--secondary-color);"></i>
              <span style="font-weight: bold;">Groups This Month:</span>
              <span id="group-usage-text" style="
                background: var(--primary-color); 
                color: white; 
                padding: 0.2rem 0.6rem; 
                border-radius: 12px; 
                font-size: 0.9rem;
              ">Loading...</span>
            </div>
            <div id="premium-status-display" style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-crown" style="color: #FFD700;"></i>
              <span id="premium-status-text" style="font-size: 0.9rem; color: #666;">Loading...</span>
            </div>
          </div>
        </div>

        <div id="groups-content">
          <!-- Groups will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- Profile Page -->
    <div id="profile" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Your Profile</h2>
        </div>
        <div id="profile-content">
          <!-- Profile content will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript remains unchanged -->
  <script>

     // AI Premium Feature Configuration
    const AI_PREMIUM_ENABLED = true; // Set to false to disable premium features

    // Helper function to add crown to premium users
    function addCrownToPremiumUser(displayName, userId) {
      // Get current user safely
      const currentUser = DataLayer.load("currentUser");
      
      const isPremium = userId === (currentUser ? currentUser.id : null) ? 
        (currentUser ? currentUser.isPremium : false) : 
        (DemoUsers.users[userId] ? DemoUsers.users[userId].isPremium : false);
      
      if (isPremium) {
        return `${displayName} <i class="fas fa-crown" style="color: #FFD700; margin-left: 0.3rem;"></i>`;
      }
      return displayName;
    }

    
    // Function to handle rating a place from the community feed
    function ratePlace(name, category, location, description) {
      // Pre-fill the activity form
      document.getElementById("activity-name").value = name;
      document.getElementById("activity-category").value = category;
      document.getElementById("activity-location").value = location;
      document.getElementById("activity-description").value = description;

      // Switch to the activities page
      showPage("activities");

      // Scroll to the form
      document
        .getElementById("activity-form")
        .scrollIntoView({ behavior: "smooth" });
    }

    // In-memory data storage (replaces localStorage)
    let appData = {
      personalityScore: null,
      personalityType: null,
      userExperiences: [],
      groups: [],
      friends: [], // Add friends array
      currentUser: {
        id: "user-main",
        username: "you",
        displayName: "You",
        avatar: "Y",
        isPremium: AI_PREMIUM_ENABLED, // Current user's premium status
      },
    };

    const FriendsSystem = {
      addFriend: (userId) => {
        const user = DemoUsers.users[userId];
        if (!user) return false;

        const friends = DataLayer.load("friends", []);
        if (friends.some((friend) => friend.id === userId)) {
          NotificationSystem.show(
            "Already friends with this user!",
            "warning"
          );
          return false;
        }

        const friendData = {
          id: userId,
          username: user.username,
          displayName: user.displayName,
          personalityType: user.personalityType,
          adjustmentFactor: user.adjustmentFactor,
          avatar: user.avatar,
          addedAt: new Date().toISOString(),
        };

        DataLayer.push("friends", friendData);
        NotificationSystem.show(
                          `Added ${addCrownToPremiumUser(user.displayName, user.id)} as a friend!`,
          "success"
        );

        // Update the button immediately with animation
        FriendsSystem.updateFriendButton(userId, true);

        // Refresh current page to show updated recommendations
        const currentPage = document.querySelector(".page:not(.hidden)").id;
        if (currentPage === "dashboard" || currentPage === "profile") {
          showPage(currentPage);
        }

        return true;
      },

      updateFriendButton: (userId, isFriend) => {
        // Find all buttons for this user and update them
        const buttons = document.querySelectorAll(`[onclick*="FriendsSystem.addFriend(${userId})"]`);
        buttons.forEach(button => {
          if (isFriend) {
            // Animate the button change
            button.style.transition = 'all 0.3s ease';
            button.style.transform = 'scale(1.1)';
            button.style.color = 'white';
            
            // Reset transform after animation and update content
            setTimeout(() => {
              button.style.transform = 'scale(1)';
              // Clear button styling to avoid double styling
              button.style.background = 'transparent';
              button.style.border = 'none';
              button.style.padding = '0';
              button.style.margin = '0';
              button.style.boxShadow = 'none';
              button.style.cursor = 'default';
              button.onclick = null; // Remove click handler
              button.innerHTML = '<span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color);">✓ Friend</span>';
            }, 300);
          } else {
            // Reset to original button styling
            button.innerHTML = 'Add Friend';
            button.style.background = '';
            button.style.color = '';
            button.style.border = '';
            button.style.padding = '';
            button.style.margin = '';
            button.style.boxShadow = '';
            button.style.transform = '';
            button.style.cursor = 'pointer';
            // Restore click handler - this will be handled by the page refresh
          }
        });
      },

      getFriends: () => {
        return DataLayer.load("friends", []);
      },

      getFriendIds: () => {
        return FriendsSystem.getFriends().map((friend) => friend.id);
      },

      isFriend: (userId) => {
        return FriendsSystem.getFriendIds().includes(userId);
      },

      removeFriend: (userId) => {
        const friends = DataLayer.load("friends", []);
        const friendToRemove = friends.find(friend => friend.id === userId);
        
        if (!friendToRemove) {
          NotificationSystem.show("Friend not found!", "error");
          return false;
        }

        DataLayer.remove("friends", (friend) => friend.id === userId);
        NotificationSystem.show(
                          `Removed ${addCrownToPremiumUser(friendToRemove.displayName, friendToRemove.id)} from friends!`,
          "success"
        );

        // Update the button immediately
        FriendsSystem.updateFriendButton(userId, false);

        // Refresh current page to show updated recommendations
        const currentPage = document.querySelector(".page:not(.hidden)").id;
        if (currentPage === "dashboard" || currentPage === "profile") {
          showPage(currentPage);
        }

        return true;
      },
    };

    // Data layer - handles in-memory storage operations
    const DataLayer = {
      save: (key, data) => {
        appData[key] = JSON.parse(JSON.stringify(data));
      },

      load: (key, defaultValue = null) => {
        return appData[key] !== undefined
          ? JSON.parse(JSON.stringify(appData[key]))
          : defaultValue;
      },

      exists: (key) => {
        return appData[key] !== undefined && appData[key] !== null;
      },

      push: (key, item) => {
        if (!appData[key]) appData[key] = [];
        appData[key].push(JSON.parse(JSON.stringify(item)));
      },

      remove: (key, predicate) => {
        if (appData[key] && Array.isArray(appData[key])) {
          appData[key] = appData[key].filter((item) => !predicate(item));
        }
      },
    };

    // Personality assessment system
    const PersonalityAssessment = {
      questions: [
        { text: "Large parties energize me", weight: 3 },
        {
          text: "I prefer quiet, intimate gatherings",
          weight: 3,
          reverse: true,
        },
        {
          text: "I need alone time after social events",
          weight: 2,
          reverse: true,
        },
        { text: "I'm comfortable being the center of attention", weight: 2 },
        {
          text: "I prefer deep conversations over small talk",
          weight: 2,
          reverse: true,
        },
        { text: "I enjoy spontaneous social activities", weight: 1 },
        { text: "I recharge by being around people", weight: 3 },
        { text: "I think out loud when making decisions", weight: 1 },
        { text: "I'm energized by new social environments", weight: 2 },
        { text: "I prefer working in teams vs alone", weight: 1 },
      ],
      
      // questions: [
      //   { text: "Large parties energize me", weight: 3 },
      // ],

      currentQuestion: 0,
      responses: [],

      init: () => {
        PersonalityAssessment.currentQuestion = 0;
        PersonalityAssessment.responses = [];
        PersonalityAssessment.displayQuestion();
        
        // Add keyboard event listener for assessment navigation
        document.addEventListener("keydown", PersonalityAssessment.handleKeyboard);
      },

      displayQuestion: () => {
        const container = document.getElementById("question-container");
        const question =
          PersonalityAssessment.questions[
          PersonalityAssessment.currentQuestion
          ];

        container.innerHTML = `
      <div class="question-container">
        <div class="question-text">${question.text}</div>
        <div class="scale-labels">
          <span>Strongly Disagree</span>
          <span>Strongly Agree</span>
        </div>
        <div class="radio-group">
          ${[1, 2, 3, 4, 5]
            .map(
              (value) => `
              <div class="radio-item" onclick="document.getElementById('q${value}').click()">
                <input type="radio" name="question" value="${value}" id="q${value}" onchange="PersonalityAssessment.selectAnswer(${value})">
                <label for="q${value}">${value}</label>
              </div>
            `
            )
            .join("")}
        </div>
      </div>
    `;

        // Update progress
        const progress =
          ((PersonalityAssessment.currentQuestion + 1) /
            PersonalityAssessment.questions.length) *
          100;
        document.getElementById("progress-fill").style.width = `${progress}%`;
        document.getElementById("progress-text").textContent = `Question ${PersonalityAssessment.currentQuestion + 1
          } of ${PersonalityAssessment.questions.length}`;
      },

      selectAnswer: (value) => {
        PersonalityAssessment.responses[
          PersonalityAssessment.currentQuestion
        ] = value;
        document.getElementById("next-btn").disabled = false;
      },

      handleKeyboard: (event) => {
        // Only handle keyboard events if we're on the assessment page
        if (document.getElementById("assessment").classList.contains("hidden")) {
          return;
        }

        const key = event.key;
        
        // Handle number keys 1-5 for radio button selection
        if (key >= "1" && key <= "5") {
          const value = parseInt(key);
          document.getElementById(`q${value}`).click();
          PersonalityAssessment.selectAnswer(value);
        }
        
        // Handle Enter key for next button
        if (key === "Enter") {
          const nextBtn = document.getElementById("next-btn");
          if (!nextBtn.disabled) {
            nextQuestion();
          }
        }
      },

      calculateScore: () => {
        let weightedSum = 0;
        let totalWeight = 0;

        PersonalityAssessment.questions.forEach((question, index) => {
          let response = PersonalityAssessment.responses[index];
          if (question.reverse) {
            response = 6 - response;
          }
          weightedSum += response * question.weight;
          totalWeight += question.weight;
        });

        const rawScore = weightedSum / totalWeight;
        const adjustmentFactor = Math.max(
          -1,
          Math.min(1, (rawScore - 2.5) / 2.5)
        );

        return {
          rawScore,
          adjustmentFactor,
        };
      },

      getPersonalityType: (adjustmentFactor) => {
        if (adjustmentFactor <= -0.6)
          return {
            type: "Strong Introvert",
            description:
              "You recharge through solitude and prefer quieter, more intimate social settings.",
          };
        if (adjustmentFactor <= -0.2)
          return {
            type: "Moderate Introvert",
            description:
              "You enjoy social interaction but need quiet time to recharge your energy.",
          };
        if (adjustmentFactor <= 0.2)
          return {
            type: "Ambivert",
            description:
              "You have a balanced approach to social energy and can adapt to various situations.",
          };
        if (adjustmentFactor <= 0.6)
          return {
            type: "Moderate Extrovert",
            description:
              "You're energized by social interaction and enjoy group activities.",
          };
        return {
          type: "Strong Extrovert",
          description:
            "You thrive in social situations and gain energy from being around others.",
        };
      },

      showResults: () => {
        const scores = PersonalityAssessment.calculateScore();
        const personality = PersonalityAssessment.getPersonalityType(
          scores.adjustmentFactor
        );

        document.getElementById("personality-score").textContent =
          scores.adjustmentFactor.toFixed(1);
        document.getElementById("personality-type").textContent =
          personality.type;
        document.getElementById("personality-description").textContent =
          personality.description;

        // Save results
        DataLayer.save("personalityScore", scores);
        DataLayer.save("personalityType", personality);

        // Update current user
        let currentUser = DataLayer.load("currentUser");
        if (!currentUser) {
          currentUser = {
            id: "user-main",
            username: "you",
            displayName: "You",
          };
        }

        currentUser.adjustmentFactor = scores.adjustmentFactor;
        currentUser.personalityType = personality.type;
        currentUser.avatar = personality.type.charAt(0);
        
        // Don't set a default location - let geolocation handle it
        
        // Try to get user's actual location if geolocation is available
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              currentUser.location = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              DataLayer.save("currentUser", currentUser);
            },
            (error) => {
              console.log("Could not get user location:", error.message);
              // Don't set a default location - let user update manually
            }
          );
        }
        
        DataLayer.save("currentUser", currentUser);

        // Remove the assessment tab completely
        const assessmentTab = document.querySelector(
          "li:has([onclick=\"showPage('assessment')\"])"
        );
        if (assessmentTab) {
          assessmentTab.remove();
        }

        showPage("results");
      },
    };

    // Demo users with sample data - All based in Waterloo, Ontario
    const DemoUsers = {
      users: {
        1: {
          id: 1,
          username: "alex_chen",
          displayName: "Alex Chen",
          adjustmentFactor: 0.8,
          personalityType: "Strong Extrovert",
          bio: "Love meeting new people and trying exciting venues!",
          avatar: "AC",
          location: { lat: 43.4643, lng: -80.5204 }, // Waterloo University District
          isPremium: true, // Premium user
        },
        2: {
          id: 2,
          username: "sam_rivera",
          displayName: "Sam Rivera",
          adjustmentFactor: 0.3,
          personalityType: "Moderate Extrovert",
          bio: "Enjoy good company in comfortable settings.",
          avatar: "SR",
          location: { lat: 43.4719, lng: -80.5250 }, // Waterloo Downtown
          isPremium: false, // Free user
        },
        3: {
          id: 3,
          username: "jordan_park",
          displayName: "Jordan Park",
          adjustmentFactor: -0.2,
          personalityType: "Slight Introvert",
          bio: "Quality over quantity when it comes to social time.",
          avatar: "JP",
          location: { lat: 43.4583, lng: -80.5204 }, // Waterloo South
          isPremium: true, // Premium user
        },
        4: {
          id: 4,
          username: "riley_thompson",
          displayName: "Riley Thompson",
          adjustmentFactor: -0.5,
          personalityType: "Moderate Introvert",
          bio: "Love peaceful places and meaningful conversations.",
          avatar: "RT",
          location: { lat: 43.4700, lng: -80.5150 }, // Waterloo North
          isPremium: false, // Free user
        },
        5: {
          id: 5,
          username: "casey_wu",
          displayName: "Casey Wu",
          adjustmentFactor: -0.9,
          personalityType: "Strong Introvert",
          bio: "Finding energy in quiet, contemplative spaces.",
          avatar: "CW",
          location: { lat: 43.4667, lng: -80.5300 }, // Waterloo West
          isPremium: true, // Premium user
        },
        6: {
          id: 6,
          username: "taylor_kim",
          displayName: "Taylor Kim",
          adjustmentFactor: 0.0,
          personalityType: "Ambivert",
          bio: "Adaptable to different social situations and moods.",
          avatar: "TK",
          location: { lat: 43.4625, lng: -80.5250 }, // Waterloo East
          isPremium: false, // Free user
        },
      },

      // Sample experiences from demo users - Waterloo, Ontario locations
      experiences: [
        {
          id: 1,
          userId: 1,
          name: "Phil's Grandson's Place",
          category: "Bar/Pub",
          location: "Waterloo Downtown",
          description:
            "Popular student bar with great atmosphere and live music. Perfect for group outings!",
          responses: {
            energy: 9,
            social: 8,
            comfort: 8,
            overwhelm: 3,
            return: 9,
          },
          rawScore: 8.4,
          adjustedScore: 9.6,
          timestamp: "2024-01-15T20:00:00Z",
          socialIntensity: 8.5,
          noiseLevel: 7.5,
          crowdSize: 8.0,
          coordinates: { lat: 43.4719, lng: -80.5250 }, // Waterloo Downtown
        },
        {
          id: 2,
          userId: 2,
          name: "Balzac's Coffee",
          category: "Cafe",
          location: "Waterloo University District",
          description:
            "Cozy cafe with great atmosphere for studying and casual meetings. Perfect background music.",
          responses: {
            energy: 7,
            social: 7,
            comfort: 8,
            overwhelm: 2,
            return: 8,
          },
          rawScore: 7.2,
          adjustedScore: 7.8,
          timestamp: "2024-01-16T14:00:00Z",
          socialIntensity: 3.5,
          noiseLevel: 2.5,
          crowdSize: 4.0,
          coordinates: { lat: 43.4643, lng: -80.5204 }, // Waterloo University District
        },
        {
          id: 3,
          userId: 3,
          name: "Clay and Glass Gallery",
          category: "Museum/Gallery",
          location: "Waterloo Arts District",
          description:
            "Beautiful contemporary art exhibition. Peaceful environment, perfect for reflection.",
          responses: {
            energy: 8,
            social: 6,
            comfort: 9,
            overwhelm: 1,
            return: 8,
          },
          rawScore: 8.0,
          adjustedScore: 7.6,
          timestamp: "2024-01-17T11:00:00Z",
          socialIntensity: 2.0,
          noiseLevel: 1.5,
          crowdSize: 3.0,
          coordinates: { lat: 43.4583, lng: -80.5204 }, // Waterloo South
        },
        {
          id: 4,
          userId: 4,
          name: "The Bauer Kitchen",
          category: "Restaurant",
          location: "Waterloo North",
          description:
            "Intimate restaurant with outdoor seating. Perfect for deep conversations with close friends.",
          responses: {
            energy: 8,
            social: 9,
            comfort: 9,
            overwhelm: 1,
            return: 9,
          },
          rawScore: 8.8,
          adjustedScore: 7.8,
          timestamp: "2024-01-18T18:00:00Z",
          socialIntensity: 4.0,
          noiseLevel: 2.0,
          crowdSize: 3.5,
          coordinates: { lat: 43.4700, lng: -80.5150 }, // Waterloo North
        },
        {
          id: 5,
          userId: 5,
          name: "Waterloo Public Library",
          category: "Library/Study",
          location: "Waterloo Downtown",
          description:
            "Peaceful reading space with beautiful architecture. Perfect for solo work and reflection.",
          responses: {
            energy: 9,
            social: 5,
            comfort: 10,
            overwhelm: 1,
            return: 10,
          },
          rawScore: 8.4,
          adjustedScore: 6.6,
          timestamp: "2024-01-19T10:00:00Z",
          socialIntensity: 1.0,
          noiseLevel: 1.0,
          crowdSize: 2.0,
          coordinates: { lat: 43.4719, lng: -80.5250 }, // Waterloo Downtown
        },
        {
          id: 6,
          userId: 6,
          name: "Molly Bloom's Irish Pub",
          category: "Bar/Pub",
          location: "Waterloo Entertainment District",
          description:
            "Lively sports bar with big screens and enthusiastic crowd. Great game night atmosphere!",
          responses: {
            energy: 7,
            social: 7,
            comfort: 6,
            overwhelm: 6,
            return: 7,
          },
          rawScore: 6.5,
          adjustedScore: 6.5,
          timestamp: "2024-01-20T19:00:00Z",
          socialIntensity: 7.0,
          noiseLevel: 8.0,
          crowdSize: 7.5,
          coordinates: { lat: 43.4667, lng: -80.5300 }, // Waterloo West
        },
        {
          id: 7,
          userId: 1,
          name: "Beta Nightclub",
          category: "Nightclub",
          location: "Waterloo City Center",
          description:
            "High-energy club with amazing sound system and packed dance floor. Pure energy!",
          responses: {
            energy: 10,
            social: 9,
            comfort: 7,
            overwhelm: 4,
            return: 10,
          },
          rawScore: 8.8,
          adjustedScore: 10.0,
          timestamp: "2024-01-21T23:00:00Z",
          socialIntensity: 10.0,
          noiseLevel: 9.5,
          crowdSize: 9.0,
          coordinates: { lat: 43.4625, lng: -80.5250 }, // Waterloo East
        },
        {
          id: 8,
          userId: 5,
          name: "Waterloo Park",
          category: "Park/Outdoor",
          location: "Waterloo Park District",
          description:
            "Serene garden with beautiful flowers and quiet walking paths. So peaceful and restorative.",
          responses: {
            energy: 9,
            social: 4,
            comfort: 10,
            overwhelm: 1,
            return: 10,
          },
          rawScore: 8.2,
          adjustedScore: 6.4,
          timestamp: "2024-01-22T15:00:00Z",
          socialIntensity: 1.5,
          noiseLevel: 1.0,
          crowdSize: 2.5,
          coordinates: { lat: 43.4700, lng: -80.5150 }, // Waterloo North
        },
      ],
    };

    // Helper functions for edit modal
    function closeEditModal() {
      console.log('Closing edit modal');
      const modal = document.getElementById("edit-group-modal");
      if (modal) {
        console.log('Modal found, removing with animation');
        modal.style.animation = "fadeOut 0.3s ease forwards";
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
            console.log('Modal removed from DOM');
          }
        }, 300);
      } else {
        console.log('Modal not found');
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function handleEditModalBackdropClick(event) {
      console.log('Modal backdrop clicked:', event.target);
      if (event.target.classList.contains('modal')) {
        console.log('Closing edit modal via backdrop click');
        closeEditModal();
      }
    }

    function handleEditGroup(event, groupId) {
      event.preventDefault();

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      const name = document.getElementById("edit-group-name").value.trim();
      const description = document
        .getElementById("edit-group-description")
        .value.trim();

      // Update basic info
      groups[groupIndex].name = name;
      groups[groupIndex].description = description;

      // Update members
      const currentUser = DataLayer.load("currentUser");
      const personalityData = DataLayer.load("personalityScore");

      let newMembers = [
        {
          userId: currentUser.id,
          displayName: currentUser.displayName,
          personalityType: currentUser.personalityType,
          adjustmentFactor: personalityData.adjustmentFactor,
          avatar: currentUser.avatar,
          importance: 1.0,
        },
      ];

      // Keep existing members that are checked
      groups[groupIndex].members.forEach((member) => {
        if (member.userId !== currentUser.id) {
          const keepCheckbox = document.getElementById(
            `keep-member-${member.userId}`
          );
          if (keepCheckbox && keepCheckbox.checked) {
            newMembers.push(member);
          }
        }
      });

      // Add new members that are checked
      const friends = FriendsSystem.getFriends();
      friends.forEach((friend) => {
        const addCheckbox = document.getElementById(
          `add-member-${friend.id}`
        );
        if (addCheckbox && addCheckbox.checked) {
          newMembers.push({
            userId: friend.id,
            displayName: friend.displayName,
            personalityType: friend.personalityType,
            adjustmentFactor: friend.adjustmentFactor,
            avatar: friend.avatar,
            importance: 1.0,
          });
        }
      });

      groups[groupIndex].members = newMembers;
      DataLayer.save("groups", groups);

      closeEditModal();
      GroupsSystem.displayGroups();
      NotificationSystem.show("Group updated successfully!", "success");
    }

    // Activity system
    const ActivitySystem = {
      // Predefined activity categories
      categories: [
        {
          id: "restaurant",
          name: "Restaurant/Café",
          description: "Dining establishments, cafes, food courts",
        },
        {
          id: "nightlife",
          name: "Nightlife",
          description: "Bars, clubs, lounges",
        },
        {
          id: "outdoor",
          name: "Park/Outdoor",
          description: "Parks, gardens, hiking trails",
        },
        {
          id: "entertainment",
          name: "Entertainment",
          description: "Movies, theaters, concerts",
        },
        {
          id: "shopping",
          name: "Shopping",
          description: "Malls, markets, retail stores",
        },
        {
          id: "sports",
          name: "Sports/Recreation",
          description: "Gyms, sports venues, recreational facilities",
        },
        {
          id: "cultural",
          name: "Cultural",
          description: "Museums, galleries, historical sites",
        },
        {
          id: "social",
          name: "Social Venue",
          description: "Community centers, meet-up spaces",
        },
        {
          id: "wellness",
          name: "Wellness/Relaxation",
          description: "Spas, yoga studios, meditation centers",
        },
      ],

      // Rating questions for activity experiences
      ratingQuestions: [
        { id: "energy", text: "How energized did you feel?", weight: 0.4 },
        {
          id: "social",
          text: "How satisfied were you with the social interaction?",
          weight: 0.25,
        },
        {
          id: "comfort",
          text: "How comfortable did you feel in this environment?",
          weight: 0.2,
        },
        {
          id: "overwhelm",
          text: "How overwhelming was the environment?",
          weight: 0.1,
          reverse: true,
        },
        { id: "return", text: "How likely are you to return?", weight: 0.05 },
      ],

      submitNewExperience: (event) => {
        event.preventDefault();

        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) {
          NotificationSystem.show(
            "Please complete the personality assessment first!",
            "warning"
          );
          showPage("assessment");
          return;
        }

        // Get form data
        const name = document.getElementById("activity-name").value.trim();
        const category = document.getElementById("activity-category").value;
        const location = document
          .getElementById("activity-location")
          .value.trim();
        const description = document
          .getElementById("activity-description")
          .value.trim();

        if (!name || !category || !location) {
          NotificationSystem.show(
            "Please fill in all required fields including location.",
            "warning"
          );
          return;
        }

        // Get ratings
        const responses = {};
        let rawScore = 0;

        ActivitySystem.ratingQuestions.forEach((question) => {
          let value = parseInt(
            document.getElementById(`rating-${question.id}`).value
          );

          if (question.reverse) {
            value = 11 - value; // Reverse score for overwhelming
          }

          responses[question.id] = value;
          rawScore += value * question.weight;
        });

        // Apply personality adjustment
        const adjustedScore = Math.max(
          1,
          Math.min(10, rawScore + personalityData.adjustmentFactor * 2)
        );

        // Estimate social characteristics based on category and user ratings
        const socialIntensity = ActivitySystem.estimateSocialIntensity(
          category,
          responses
        );
        const noiseLevel = ActivitySystem.estimateNoiseLevel(
          category,
          responses
        );
        const crowdSize = ActivitySystem.estimateCrowdSize(
          category,
          responses
        );

        const experience = {
          id: Date.now(),
          userId: "user-main",
          name,
          category,
          location: location || "Not specified",
          description: description || "",
          responses,
          rawScore: parseFloat(rawScore.toFixed(1)),
          adjustedScore: parseFloat(adjustedScore.toFixed(1)),
          timestamp: new Date().toISOString(),
          socialIntensity,
          noiseLevel,
          crowdSize,
          coordinates: null, // Will be set if location is available
        };

        // Try to get coordinates for the location if user has location access
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              experience.coordinates = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              // Update the saved experience with coordinates
              const userExperiences = DataLayer.load("userExperiences", []);
              const expIndex = userExperiences.findIndex(exp => exp.id === experience.id);
              if (expIndex !== -1) {
                userExperiences[expIndex] = experience;
                DataLayer.save("userExperiences", userExperiences);
              }
            },
            (error) => {
              console.log("Could not get coordinates for experience:", error.message);
            }
          );
        }

        // Save experience
        DataLayer.push("userExperiences", experience);

        // Show success message
        NotificationSystem.show("Experience added successfully!", "success");

        // Reset form and redirect
        resetActivityForm();
        showPage("profile");
      },

      estimateSocialIntensity: (category, responses) => {
        const baseValues = {
          Nightclub: 9.5,
          "Bar/Pub": 7.0,
          Restaurant: 5.5,
          "Event/Party": 8.5,
          "Sports/Fitness": 6.0,
          Cafe: 3.5,
          Shopping: 5.0,
          Entertainment: 7.5,
          "Museum/Gallery": 2.0,
          "Library/Study": 1.0,
          "Park/Outdoor": 2.5,
          Other: 5.0,
        };

        const base = baseValues[category] || 5.0;
        const socialFactor = (responses.social - 5) * 0.5;
        return Math.max(1, Math.min(10, base + socialFactor));
      },

      estimateNoiseLevel: (category, responses) => {
        const baseValues = {
          Nightclub: 9.0,
          "Bar/Pub": 7.5,
          Restaurant: 4.0,
          "Event/Party": 8.0,
          "Sports/Fitness": 6.5,
          Cafe: 2.5,
          Shopping: 6.0,
          Entertainment: 8.5,
          "Museum/Gallery": 1.5,
          "Library/Study": 1.0,
          "Park/Outdoor": 2.0,
          Other: 5.0,
        };

        const base = baseValues[category] || 5.0;
        const overwhelmFactor = (responses.overwhelm - 5) * 0.3;
        return Math.max(1, Math.min(10, base + overwhelmFactor));
      },

      estimateCrowdSize: (category, responses) => {
        const baseValues = {
          Nightclub: 9.0,
          "Bar/Pub": 7.0,
          Restaurant: 6.0,
          "Event/Party": 8.5,
          "Sports/Fitness": 6.5,
          Cafe: 4.0,
          Shopping: 7.5,
          Entertainment: 8.0,
          "Museum/Gallery": 3.0,
          "Library/Study": 2.0,
          "Park/Outdoor": 4.5,
          Other: 5.0,
        };

        const base = baseValues[category] || 5.0;
        const overwhelmFactor = (responses.overwhelm - 5) * 0.2;
        const comfortFactor = (5 - responses.comfort) * 0.1; // Lower comfort might mean more crowded
        return Math.max(
          1,
          Math.min(10, base + overwhelmFactor + comfortFactor)
        );
      },

      // Prediction Algorithm - Exact implementation from plan
      predictRating: (
        userAdjustmentFactor,
        experience,
        ratingUserAdjustmentFactor,
        ratingScore
      ) => {
        const basePrediction = parseFloat(ratingScore);
        const personalityDifference = Math.abs(
          ratingUserAdjustmentFactor - userAdjustmentFactor
        );
        const confidenceFactor = Math.max(0.1, 1 - personalityDifference / 2);

        let prediction;
        if (ratingUserAdjustmentFactor < userAdjustmentFactor) {
          // Rating user is more introverted than current user
          prediction =
            basePrediction +
            personalityDifference * experience.socialIntensity * 0.2;
        } else {
          // Rating user is more extroverted than current user
          prediction =
            basePrediction -
            personalityDifference * experience.socialIntensity * 0.2;
        }

        const finalPrediction = Math.max(1, Math.min(10, prediction));
        return {
          prediction: finalPrediction,
          confidence: confidenceFactor,
        };
      },

      // Get all experiences (user + demo)
      getAllExperiences: () => {
        const userExperiences = DataLayer.load("userExperiences", []);
        return [...DemoUsers.experiences, ...userExperiences];
      },

      // Activity Recommendation Engine
      getRecommendations: (userAdjustmentFactor) => {
        const allExperiences = ActivitySystem.getAllExperiences();
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );
        const friendIds = FriendsSystem.getFriendIds();

        // Only include experiences from friends
        const friendExperiences = allExperiences.filter((exp) =>
          friendIds.includes(exp.userId)
        );

        const recommendations = [];

        // Group experiences by name to avoid duplicates
        const experienceGroups = {};
        friendExperiences.forEach((exp) => {
          const key = exp.name.toLowerCase();
          if (!experienceGroups[key]) {
            experienceGroups[key] = [];
          }
          experienceGroups[key].push(exp);
        });

        Object.entries(experienceGroups).forEach(([name, experiences]) => {
          // Skip if user has already been to this place
          if (userExperienceNames.includes(name)) return;

          const predictions = [];
          let totalScore = 0;
          let ratingCount = 0;

          experiences.forEach((exp) => {
            const ratingUser = DemoUsers.users[exp.userId];
            if (ratingUser) {
              const prediction = ActivitySystem.predictRating(
                userAdjustmentFactor,
                exp,
                ratingUser.adjustmentFactor,
                exp.rawScore
              );

              predictions.push({
                user: ratingUser,
                experience: exp,
                prediction: prediction,
              });

              totalScore += prediction.prediction * prediction.confidence;
              ratingCount++;
            }
          });

          if (ratingCount > 0) {
            const averageScore = totalScore / ratingCount;
            const avgConfidence =
              predictions.reduce(
                (sum, p) => sum + p.prediction.confidence,
                0
              ) / ratingCount;

            recommendations.push({
              experience: experiences[0], // Use first experience as representative
              predictedScore: averageScore,
              confidence: avgConfidence,
              ratingCount: ratingCount,
              predictions: predictions,
            });
          }
        });

        // Sort by predicted score * confidence
        return recommendations.sort(
          (a, b) =>
            b.predictedScore * b.confidence - a.predictedScore * a.confidence
        );
      },

      // Find Similar Users
      findSimilarUsers: (userAdjustmentFactor) => {
        const similarities = Object.values(DemoUsers.users)
          .map((user) => {
            const personalityDifference = Math.abs(
              user.adjustmentFactor - userAdjustmentFactor
            );
            const similarity = Math.max(0, 1 - personalityDifference / 2); // 0 to 1 scale

            return {
              user: user,
              similarity: similarity,
              personalityDifference: personalityDifference,
            };
          })
          .sort((a, b) => b.similarity - a.similarity);

        return similarities;
      },
    };

    function fillActivityForm(name, category, location, description = "") {
      console.log("fillActivityForm called with:", name, category, location);
      
      // Close nearby modal if it's open - multiple approaches to ensure it closes
      const nearbyModal = document.getElementById("nearby-modal");
      console.log("Found nearby modal:", nearbyModal);
      
      if (nearbyModal) {
        console.log("Attempting to close modal...");
        // Try multiple methods to ensure modal closes
        nearbyModal.style.display = 'none';
        nearbyModal.style.visibility = 'hidden';
        nearbyModal.style.opacity = '0';
        nearbyModal.remove();
        console.log("Modal removal attempted");
      }
      
      // Also try to close any modal with class 'modal'
      const allModals = document.querySelectorAll('.modal');
      console.log("Found", allModals.length, "modals with .modal class");
      allModals.forEach((modal, index) => {
        console.log("Closing modal", index);
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.remove();
      });
      
      // Force a reflow
      document.body.offsetHeight;
      
      // Small delay to ensure modal is removed before page switch
      setTimeout(() => {
        console.log("Switching to activities page");
      // Switch to activities page
      showPage("activities");
      }, 200);

      // Pre-fill the form
      setTimeout(() => {
        document.getElementById("activity-name").value = name;
        document.getElementById("activity-category").value = category;
        document.getElementById("activity-location").value = location;
        document.getElementById("activity-description").value = description;

        // Scroll to form
        document
          .getElementById("activity-form")
          .scrollIntoView({ behavior: "smooth" });

        NotificationSystem.show(
          "Form pre-filled! Add your ratings below.",
          "info"
        );
      }, 100);
    }

    // Function to format date with full month name
    function formatFullDate(dateString) {
      const date = new Date(dateString);
      const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      const month = months[date.getMonth()];
      const day = date.getDate();
      const year = date.getFullYear();
      return `${month} ${day}, ${year}`;
    }

    // Helper function to add ESC and click-outside functionality to modals
    function addModalListeners(modalId, closeFunction) {
      // Prevent body scrolling when modal opens
      document.body.classList.add('modal-open');
      
      // Add ESC key listener
      const handleEscKey = (event) => {
        if (event.key === 'Escape') {
          closeFunction();
          document.removeEventListener('keydown', handleEscKey);
        }
      };
      document.addEventListener('keydown', handleEscKey);
      
      // Add click outside to close
      const modal = document.getElementById(modalId);
      if (modal) {
        // Simple click outside detection
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeFunction();
            document.removeEventListener('keydown', handleEscKey);
          }
        });
      }
    }

    // Function to calculate distance between two coordinates (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of the Earth in kilometers
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c; // Distance in kilometers
      return distance;
    }

    // Function to calculate group's central location
    function calculateGroupCenter(group) {
      const members = group.members;
      let totalLat = 0;
      let totalLng = 0;
      let validLocations = 0;

      members.forEach(member => {
        if (member.location) {
          totalLat += member.location.lat;
          totalLng += member.location.lng;
          validLocations++;
        } else {
          // Fallback to demo user location if not in group data
          const user = DemoUsers.users[member.userId];
          if (user && user.location) {
            totalLat += user.location.lat;
            totalLng += user.location.lng;
            validLocations++;
          }
        }
      });

      if (validLocations === 0) {
        // Default to Waterloo center if no locations available
        return { lat: 43.4643, lng: -80.5204 };
      }

      return {
        lat: totalLat / validLocations,
        lng: totalLng / validLocations
      };
    }

    // Function to get location-based group recommendations
    function getGroupLocationRecommendations(groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find(g => g.id === groupId);
      if (!group) return;

      const groupCenter = calculateGroupCenter(group);
      const allExperiences = ActivitySystem.getAllExperiences();
      
      // Calculate distance from group center for each experience
      const experiencesWithDistance = allExperiences.map(exp => {
        if (exp.coordinates) {
          const distance = calculateDistance(
            groupCenter.lat, groupCenter.lng,
            exp.coordinates.lat, exp.coordinates.lng
          );
          return { ...exp, distanceFromGroup: distance };
        }
        return { ...exp, distanceFromGroup: Infinity };
      });

      // Filter experiences within 25km of group center and sort by distance
      const nearbyExperiences = experiencesWithDistance
        .filter(exp => exp.distanceFromGroup <= 25)
        .sort((a, b) => a.distanceFromGroup - b.distanceFromGroup)
        .slice(0, 10);

      return {
        groupCenter,
        recommendations: nearbyExperiences
      };
    }

    // Feed System
    const FeedSystem = {
      currentFilter: "all",
      searchTerm: "",

      init: () => {
        FeedSystem.displayFeed();
      },

      setFilter: (filter) => {
        FeedSystem.currentFilter = filter;

        // Update active tab
        document.querySelectorAll(".filter-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        FeedSystem.displayFeed();
      },

      filterFeed: () => {
        FeedSystem.searchTerm = document
          .getElementById("feed-search")
          .value.toLowerCase();
        FeedSystem.displayFeed();
      },

      displaySortedExperiences: (experiences, filterType) => {
        const personalityData = DataLayer.load("personalityScore");
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );

        const feedContent = document.getElementById("feed-content");

        if (experiences.length === 0) {
          if (filterType === "nearby") {
            feedContent.innerHTML = `
              <div class="empty-state">
                <h3>No nearby experiences found</h3>
                <p>Try expanding your search radius or check if you have location access enabled.</p>
                <div style="margin-top: 1rem;">
                  <button class="btn btn-secondary" onclick="FeedSystem.setFilter('all')">
                    <i class="fas fa-globe"></i> Show All Experiences
                  </button>
                </div>
              </div>
            `;
          } else {
            feedContent.innerHTML = `
              <div class="empty-state">
                <h3>No activities found</h3>
                <p>Try adjusting your search or filters to see more results.</p>
              </div>
            `;
          }
          return;
        }

        // Add location info for nearby filter
        let locationInfo = "";
        if (filterType === "nearby") {
          locationInfo = `
            <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
              <p style="margin: 0; font-size: 0.9rem; color: #666;">
                <i class="fas fa-map-marker-alt"></i> 
                Showing ${experiences.length} experiences within 50km of your location. Sorted by distance.
              </p>
            </div>
          `;
        }

        feedContent.innerHTML = locationInfo + experiences
          .map((exp) => {
            const user =
              exp.userId === "user-main"
                ? DataLayer.load("currentUser")
                : DemoUsers.users[exp.userId];

            if (!user) return "";

            // Check if user has been to this place
            const hasBeenThere = userExperienceNames.includes(
              exp.name.toLowerCase()
            );
            const isFriend = FriendsSystem.isFriend(exp.userId);

            // Calculate prediction for current user
            let predictionHtml = "";
            if (personalityData && exp.userId !== "user-main") {
              const prediction = ActivitySystem.predictRating(
                personalityData.adjustmentFactor,
                exp,
                user.adjustmentFactor,
                exp.rawScore
              );

              predictionHtml = `
                <div class="prediction-card">
                  <div class="prediction-score">Predicted for you: ${prediction.prediction.toFixed(
                    1
                  )}/10</div>
                  <div class="prediction-confidence">Confidence: ${(
                    prediction.confidence * 100
                  ).toFixed(0)}%</div>
                </div>
              `;
            }

            // Add distance info for nearby filter
            let distanceInfo = "";
            if (filterType === "nearby" && exp.coordinates) {
              // Get user's current location to calculate distance
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                  (position) => {
                    const distance = calculateDistance(
                      position.coords.latitude, position.coords.longitude,
                      exp.coordinates.lat, exp.coordinates.lng
                    );
                    // Update the distance display for this experience
                    const distanceElement = document.getElementById(`distance-${exp.id}`);
                    if (distanceElement) {
                      distanceElement.textContent = `${distance.toFixed(1)}km away`;
                    }
                  }
                );
              }
              distanceInfo = `<div id="distance-${exp.id}" style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.3rem;">Calculating distance...</div>`;
            }

            // Add friend status and rate button
            let actionButtons = "";
            if (exp.userId !== "user-main") {
              if (!isFriend) {
                actionButtons += `
                  <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 6px 12px; margin-right: 0.5rem;"
                    onclick="FriendsSystem.addFriend(${exp.userId})">
                    <i class="fas fa-user-plus"></i> Add Friend
                  </button>
                `;
              } else {
                actionButtons += `
                  <span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color); display: inline-block; margin-right: 0.5rem;">
                    ✓ Friend
                  </span>
                `;
              }
            }

            if (!hasBeenThere) {
              actionButtons += `
                <button class="btn" style="font-size: 0.8rem; padding: 6px 12px;"
                  onclick="ratePlace('${exp.name.replace(/'/g, "\\'")}', '${exp.category.replace(/'/g, "\\'")}', '${exp.location.replace(/'/g, "\\'")}', '${exp.description ? exp.description.replace(/'/g, "\\'") : ""}')">
                  <i class="fas fa-star"></i> Rate This Place
                </button>
              `;
            } else {
              actionButtons += `
                <span style="background: #e8f5e8; color: #2e7d32; font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid #4caf50;">
                  ✓ Been There
                </span>
              `;
            }

            return `
              <div class="experience-card" style="
                border: 1px solid #eee; 
                border-radius: 12px; 
                padding: 1.5rem; 
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                transition: all 0.2s ease;
                margin-bottom: 1rem;
              " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <h4>${addCrownToPremiumUser(user.displayName, exp.userId)} ${isFriend ? '<span style="color: var(--primary-color);">★</span>' : ""}</h4>
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                      <span style="background: var(--secondary-color); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">
                        ${exp.category}
                      </span>
                      <span style="color: #666;">
                        <i class="fas fa-map-marker-alt"></i> ${exp.location}
                      </span>
                    </div>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.2rem;">
                      ${exp.name}
                    </h3>
                    <p style="margin: 0; color: #555; line-height: 1.5; font-size: 0.95rem;">
                      ${exp.description}
                    </p>
                    ${distanceInfo}
                  </div>
                  <div style="text-align: right; min-width: 80px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                      ${exp.adjustedScore.toFixed(1)}
                    </div>
                    <div style="font-size: 0.8rem; color: #666;">Rating</div>
                  </div>
                </div>
                
                ${predictionHtml}
                
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                  ${actionButtons}
                </div>
              </div>
            `;
          })
          .join("");
      },

      displayFilteredExperiences: (experiences, filterType) => {
        const personalityData = DataLayer.load("personalityScore");
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );

        // Sort by distance for nearby filter, otherwise by timestamp
        if (filterType === "nearby") {
          // Get user's current location and sort by distance
          getUserLocationWithFallback()
            .then((position) => {
              const userLat = position.coords.latitude;
              const userLng = position.coords.longitude;
              
              // Sort by distance
              experiences.sort((a, b) => {
                if (!a.coordinates || !b.coordinates) return 0;
                const distanceA = calculateDistance(
                  userLat, userLng,
                  a.coordinates.lat, a.coordinates.lng
                );
                const distanceB = calculateDistance(
                  userLat, userLng,
                  b.coordinates.lat, b.coordinates.lng
                );
                return distanceA - distanceB;
              });
              
              // Display the sorted experiences
              FeedSystem.displaySortedExperiences(experiences, filterType);
            })
            .catch((error) => {
              console.error('Error getting location for sorting:', error);
              // Fallback: sort by timestamp
              experiences.sort(
                (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
              );
              FeedSystem.displaySortedExperiences(experiences, filterType);
            });
          return; // Exit early since we're handling the display asynchronously
        } else {
          // Sort by timestamp (newest first) for non-nearby filters
          experiences.sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );
        }

        const feedContent = document.getElementById("feed-content");

        if (experiences.length === 0) {
          if (filterType === "nearby") {
            feedContent.innerHTML = `
              <div class="empty-state">
                <h3>No nearby experiences found</h3>
                <p>Try expanding your search radius or check if you have location access enabled.</p>
                <div style="margin-top: 1rem;">
                  <button class="btn btn-secondary" onclick="FeedSystem.setFilter('all')">
                    <i class="fas fa-globe"></i> Show All Experiences
                  </button>
                </div>
              </div>
            `;
          } else {
            feedContent.innerHTML = `
              <div class="empty-state">
                <h3>No activities found</h3>
                <p>Try adjusting your search or filters to see more results.</p>
              </div>
            `;
          }
          return;
        }

        // Add location info for nearby filter
        let locationInfo = "";
        if (filterType === "nearby") {
          locationInfo = `
            <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
              <p style="margin: 0; font-size: 0.9rem; color: #666;">
                <i class="fas fa-map-marker-alt"></i> 
                Showing ${experiences.length} experiences within 50km of your location. Sorted by distance.
              </p>
            </div>
          `;
        }

        feedContent.innerHTML = locationInfo + experiences
          .map((exp) => {
            const user =
              exp.userId === "user-main"
                ? DataLayer.load("currentUser")
                : DemoUsers.users[exp.userId];

            if (!user) return "";

            // Check if user has been to this place
            const hasBeenThere = userExperienceNames.includes(
              exp.name.toLowerCase()
            );
            const isFriend = FriendsSystem.isFriend(exp.userId);

            // Calculate prediction for current user
            let predictionHtml = "";
            if (personalityData && exp.userId !== "user-main") {
              const prediction = ActivitySystem.predictRating(
                personalityData.adjustmentFactor,
                exp,
                user.adjustmentFactor,
                exp.rawScore
              );

              predictionHtml = `
                <div class="prediction-card">
                  <div class="prediction-score">Predicted for you: ${prediction.prediction.toFixed(
                    1
                  )}/10</div>
                  <div class="prediction-confidence">Confidence: ${(
                    prediction.confidence * 100
                  ).toFixed(0)}%</div>
                </div>
              `;
            }

            // Add distance info for nearby filter
            let distanceInfo = "";
            if (filterType === "nearby" && exp.coordinates) {
              // Get user's current location to calculate distance
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                  (position) => {
                    const distance = calculateDistance(
                      position.coords.latitude, position.coords.longitude,
                      exp.coordinates.lat, exp.coordinates.lng
                    );
                    // Update the distance display for this experience
                    const distanceElement = document.getElementById(`distance-${exp.id}`);
                    if (distanceElement) {
                      distanceElement.textContent = `${distance.toFixed(1)}km away`;
                    }
                  }
                );
              }
              distanceInfo = `<div id="distance-${exp.id}" style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.3rem;">Calculating distance...</div>`;
            }

            // Add friend status and rate button
            let actionButtons = "";
            if (exp.userId !== "user-main") {
              if (!isFriend) {
                actionButtons += `
                  <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 6px 12px; margin-right: 0.5rem;"
                          onclick="FriendsSystem.addFriend(${exp.userId})">
                    Add Friend
                  </button>
                `;
              } else {
                actionButtons += `
                  <span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color); display: inline-block; margin-right: 0.5rem;">✓ Friend</span>
                `;
              }

              if (!hasBeenThere) {
                actionButtons += `
                  <button class="btn" style="font-size: 0.8rem; padding: 6px 12px;"
                          onclick="fillActivityForm('${exp.name}', '${exp.category}', '${exp.location}', '${exp.description.replace(/'/g, "\\'")}')">
                    Rate This Place
                  </button>
                `;
              }
            }

            return `
              <div class="feed-item">
                <div class="feed-header">
                  <div class="feed-avatar">${user.avatar}</div>
                  <div class="feed-user-info">
                    <h4>${addCrownToPremiumUser(user.displayName, exp.userId)} ${isFriend ? '<span style="color: var(--primary-color);">★</span>' : ""}</h4>
                    <div class="personality-type">${user.personalityType || "Unknown Type"}</div>
                    <div class="feed-timestamp" title="${formatFullDate(exp.timestamp)}" style="cursor: help;">
                  ${new Date(exp.timestamp).toLocaleDateString()}
                </div>
                  </div>
                </div>
                <div class="feed-content">
                  <h3>${exp.name} ${hasBeenThere ? '<span style="color: var(--primary-color);">✓ Visited</span>' : ""}</h3>
                  <div class="activity-category">${exp.category} • ${exp.location}</div>
                  ${exp.description ? `<p style="margin: 0.5rem 0; color: #666;">"${exp.description}"</p>` : ""}
                  <div class="feed-rating">Rated: ${exp.adjustedScore}/10</div>
                  <div style="font-size: 0.9rem; color: #888; margin-top: 0.5rem;">
                    Social Intensity: ${exp.socialIntensity.toFixed(1)}/10 |
                    Noise Level: ${exp.noiseLevel.toFixed(1)}/10 |
                    Crowd Size: ${exp.crowdSize.toFixed(1)}/10
                  </div>
                  ${distanceInfo}
                  ${predictionHtml}
                  ${actionButtons ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">${actionButtons}</div>` : ""}
                </div>
              </div>
            `;
          })
          .join("");
      },

      displayFeed: () => {
        const personalityData = DataLayer.load("personalityScore");
        const allExperiences = ActivitySystem.getAllExperiences();
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );

        let filteredExperiences = [...allExperiences];

        // Apply search filter
        if (FeedSystem.searchTerm) {
          filteredExperiences = filteredExperiences.filter(
            (exp) =>
              exp.name.toLowerCase().includes(FeedSystem.searchTerm) ||
              exp.category.toLowerCase().includes(FeedSystem.searchTerm) ||
              exp.location.toLowerCase().includes(FeedSystem.searchTerm) ||
              (DemoUsers.users[exp.userId] &&
                DemoUsers.users[exp.userId].displayName
                  .toLowerCase()
                  .includes(FeedSystem.searchTerm))
          );
        }

        // Apply category filters
        if (FeedSystem.currentFilter === "similar" && personalityData) {
          const similarUsers = ActivitySystem.findSimilarUsers(
            personalityData.adjustmentFactor
          )
            .slice(0, 3)
            .map((sim) => sim.user.id);
          filteredExperiences = filteredExperiences.filter((exp) =>
            similarUsers.includes(exp.userId)
          );
        } else if (FeedSystem.currentFilter === "high-rated") {
          filteredExperiences = filteredExperiences.filter(
            (exp) => exp.adjustedScore >= 7.5
          );
        } else if (FeedSystem.currentFilter === "recent") {
          const oneWeekAgo = new Date();
          oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
          filteredExperiences = filteredExperiences.filter(
            (exp) =>
              new Date(exp.timestamp) > oneWeekAgo ||
              exp.userId === "user-main"
          );
        } else if (FeedSystem.currentFilter === "nearby") {
          // Get user's current location and filter by actual distance
          getUserLocationWithFallback()
            .then((position) => {
              const userLat = position.coords.latitude;
              const userLng = position.coords.longitude;
              
              // Filter experiences by actual distance (within 50km)
              const nearbyExperiences = filteredExperiences.filter((exp) => {
                if (!exp.coordinates) return false;
                
                const distance = calculateDistance(
                  userLat, userLng,
                  exp.coordinates.lat, exp.coordinates.lng
                );
                
                return distance <= 50; // Within 50km
              });
              
              // Sort by distance
              nearbyExperiences.sort((a, b) => {
                const distanceA = calculateDistance(
                  userLat, userLng,
                  a.coordinates.lat, a.coordinates.lng
                );
                const distanceB = calculateDistance(
                  userLat, userLng,
                  b.coordinates.lat, b.coordinates.lng
                );
                return distanceA - distanceB;
              });
              
              // Update the feed with nearby experiences
              FeedSystem.displayFilteredExperiences(nearbyExperiences, "nearby");
            })
            .catch((error) => {
              console.error('Error getting location for nearby filter:', error);
              // Fallback: show experiences with location data
              const locationExperiences = filteredExperiences.filter(
                (exp) => exp.location && exp.location !== "Not specified"
              );
              FeedSystem.displayFilteredExperiences(locationExperiences, "nearby");
            });
          return; // Exit early since we're handling the display asynchronously
        }

        // Sort by timestamp (newest first)
        filteredExperiences.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        const feedContent = document.getElementById("feed-content");

        if (filteredExperiences.length === 0) {
          feedContent.innerHTML = `
        <div class="empty-state">
          <h3>No activities found</h3>
          <p>Try adjusting your search or filters to see more results.</p>
        </div>
      `;
          return;
        }

        feedContent.innerHTML = filteredExperiences
          .map((exp) => {
            const user =
              exp.userId === "user-main"
                ? DataLayer.load("currentUser")
                : DemoUsers.users[exp.userId];

            if (!user) return "";

            // Check if user has been to this place
            const hasBeenThere = userExperienceNames.includes(
              exp.name.toLowerCase()
            );
            const isFriend = FriendsSystem.isFriend(exp.userId);

            // Calculate prediction for current user
            let predictionHtml = "";
            if (personalityData && exp.userId !== "user-main") {
              const prediction = ActivitySystem.predictRating(
                personalityData.adjustmentFactor,
                exp,
                user.adjustmentFactor,
                exp.rawScore
              );

              predictionHtml = `
          <div class="prediction-card">
            <div class="prediction-score">Predicted for you: ${prediction.prediction.toFixed(
                1
              )}/10</div>
            <div class="prediction-confidence">Confidence: ${(
                  prediction.confidence * 100
                ).toFixed(0)}%</div>
          </div>
        `;
            }

            // Add friend status and rate button
            let actionButtons = "";
            if (exp.userId !== "user-main") {
              if (!isFriend) {
                actionButtons += `
            <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 6px 12px; margin-right: 0.5rem;"
                    onclick="FriendsSystem.addFriend(${exp.userId})">
              Add Friend
            </button>
          `;
              } else {
                actionButtons += `
                  <span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color); display: inline-block; margin-right: 0.5rem;">✓ Friend</span>
          `;
              }

              if (!hasBeenThere) {
                actionButtons += `
            <button class="btn" style="font-size: 0.8rem; padding: 6px 12px;"
                    onclick="fillActivityForm('${exp.name}', '${exp.category
                  }', '${exp.location}', '${exp.description.replace(
                    /'/g,
                    "\\'"
                  )}')">
              Rate This Place
            </button>
          `;
              }
            }

            return `
        <div class="feed-item">
          <div class="feed-header">
            <div class="feed-avatar">${user.avatar}</div>
            <div class="feed-user-info">
              <h4>${addCrownToPremiumUser(user.displayName, exp.userId)} ${isFriend ? '<span style="color: var(--primary-color);">★</span>' : ""
              }</h4>
              <div class="personality-type">${user.personalityType || "Unknown Type"
              }</div>
              <div class="feed-timestamp" title="${formatFullDate(exp.timestamp)}" style="cursor: help;">
                ${new Date(exp.timestamp).toLocaleDateString()}
              </div>
            </div>
          </div>
          <div class="feed-content">
            <h3>${exp.name} ${hasBeenThere
                ? '<span style="color: var(--primary-color);">✓ Visited</span>'
                : ""
              }</h3>
            <div class="activity-category">${exp.category} • ${exp.location
              }</div>
            ${exp.description
                ? `<p style="margin: 0.5rem 0; color: #666;">"${exp.description}"</p>`
                : ""
              }
            <div class="feed-rating">Rated: ${exp.adjustedScore}/10</div>
            <div style="font-size: 0.9rem; color: #888; margin-top: 0.5rem;">
              Social Intensity: ${exp.socialIntensity.toFixed(1)}/10 |
              Noise Level: ${exp.noiseLevel.toFixed(1)}/10 |
              Crowd Size: ${exp.crowdSize.toFixed(1)}/10
            </div>
            ${predictionHtml}
            ${actionButtons
                ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">${actionButtons}</div>`
                : ""
              }
          </div>
        </div>
      `;
          })
          .join("");
      },
    };
   

    // Weather API integration for activity recommendations
    const WeatherSystem = {
      // Get weather data for a specific location and date
      async getWeatherData(lat, lng, date) {
        try {
          console.log(`🌤️ Fetching weather for: lat=${lat}, lng=${lng}, date=${date}`);
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&timezone=auto&start_date=${date}&end_date=${date}`;
          console.log(`🌤️ Weather API URL: ${url}`);
          
          const response = await fetch(url);
          console.log(`🌤️ Weather API response status: ${response.status}`);
          
          if (!response.ok) {
            throw new Error(`Weather API responded with status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log(`🌤️ Weather API response data:`, data);
          
          if (data.daily && data.daily.time && data.daily.time.length > 0) {
            const index = 0; // First (and only) day
            
            // Validate that all required fields exist
            if (data.daily.temperature_2m_max && 
                data.daily.temperature_2m_min && 
                data.daily.precipitation_probability_max && 
                data.daily.weathercode) {
              
              const weatherData = {
                maxTemp: data.daily.temperature_2m_max[index],
                minTemp: data.daily.temperature_2m_min[index],
                precipitation: data.daily.precipitation_probability_max[index],
                weatherCode: data.daily.weathercode[index],
                date: data.daily.time[index]
              };
              console.log(`🌤️ Parsed weather data:`, weatherData);
              return weatherData;
            } else {
              console.log(`🌤️ Missing required weather fields in API response`);
              return null;
            }
          }
          console.log(`🌤️ No weather data found in response`);
          return null;
        } catch (error) {
          console.error('🌤️ Error fetching weather data from Open-Meteo:', error);
        }
      },

      // Get weather for multiple days
      async getWeatherForDays(lat, lng, dates) {
        try {
          console.log(`🌤️ Getting weather for ${dates.length} days`);
          const weatherPromises = dates.map(date => this.getWeatherData(lat, lng, date));
          const results = await Promise.all(weatherPromises);
          console.log(`🌤️ Weather results:`, results);
          
          // Filter out null results and ensure we have valid data
          const validResults = results.filter(result => result !== null);
          console.log(`🌤️ Valid weather results:`, validResults);
          
          return validResults;
        } catch (error) {
          console.error(`🌤️ Error getting weather for multiple days:`, error);
          return [];
        }
      },

      // Get weather description from WMO code
      getWeatherDescription(code) {
        const weatherCodes = {
          0: "Clear sky",
          1: "Mainly clear",
          2: "Partly cloudy",
          3: "Overcast",
          45: "Foggy",
          48: "Depositing rime fog",
          51: "Light drizzle",
          53: "Moderate drizzle",
          55: "Dense drizzle",
          56: "Light freezing drizzle",
          57: "Dense freezing drizzle",
          61: "Slight rain",
          63: "Moderate rain",
          65: "Heavy rain",
          66: "Light freezing rain",
          67: "Heavy freezing rain",
          71: "Slight snow",
          73: "Moderate snow",
          75: "Heavy snow",
          77: "Snow grains",
          80: "Slight rain showers",
          81: "Moderate rain showers",
          82: "Violent rain showers",
          85: "Slight snow showers",
          86: "Heavy snow showers",
          95: "Thunderstorm",
          96: "Thunderstorm with slight hail",
          99: "Thunderstorm with heavy hail"
        };
        return weatherCodes[code] || "Unknown";
      },

      // Get activity weather suitability score (0-10)
      getActivityWeatherScore(activity, weather) {
        if (!weather) return 5; // Neutral if no weather data
        
        const activityType = activity.category?.toLowerCase() || '';
        const temp = (weather.maxTemp + weather.minTemp) / 2;
        const precipitation = weather.precipitation;
        const isRainy = weather.weatherCode >= 51 && weather.weatherCode <= 67;
        const isSnowy = weather.weatherCode >= 71 && weather.weatherCode <= 86;
        const isStormy = weather.weatherCode >= 95;
        
        let score = 5; // Base score
        
        // Temperature considerations
        if (activityType.includes('outdoor') || activityType.includes('park') || activityType.includes('hiking')) {
          if (temp >= 15 && temp <= 25) score += 3; // Perfect outdoor weather
          else if (temp >= 10 && temp <= 30) score += 1; // Acceptable
          else score -= 2; // Too hot/cold
        }
        
        // Precipitation considerations
        if (activityType.includes('outdoor') || activityType.includes('park') || activityType.includes('hiking')) {
          if (precipitation < 20) score += 3; // Low chance of rain - clear weather bonus
          else if (precipitation < 50) score += 0; // Moderate chance
          else score -= 3; // High chance of rain
        }
        
        // Indoor activities are less affected by weather
        if (activityType.includes('indoor') || activityType.includes('museum') || activityType.includes('cafe') || activityType.includes('restaurant')) {
          // Indoor activities are neutral to weather - no bonus for rain
          score += 0; // Neutral
        }
        
        // General weather bonuses/penalties
        if (precipitation < 20 && !isRainy && !isSnowy) score += 2; // Strong bonus for clear weather
        if (isRainy) score -= 1; // Penalty for rainy weather
        if (isStormy) score -= 2;
        if (temp < -10 || temp > 35) score -= 1;
        
        return Math.max(0, Math.min(10, score)); // Clamp between 0-10
      },

      // Get best weather day from multiple options
      async getBestWeatherDay(lat, lng, dates, activities) {
        // Validate that we have dates to process
        if (!dates || dates.length === 0) {
          console.error(`🌤️ No dates provided to getBestWeatherDay`);
          return null;
        }
        
        const weatherData = await this.getWeatherForDays(lat, lng, dates);
        const scores = [];
        
        for (let i = 0; i < dates.length; i++) {
          const weather = weatherData[i];
          
          // Skip if no weather data for this day
          if (!weather) {
            continue;
          }
          
          let dayScore = 0;
          
          // Calculate average weather score for all activities
          for (const activity of activities) {
            dayScore += this.getActivityWeatherScore(activity, weather);
          }
          
          const finalScore = dayScore / activities.length;
          
          // Ensure the date is one of the input dates
          if (!dates.includes(dates[i])) {
            console.error(`🌤️ Date ${dates[i]} is not in input dates:`, dates);
            continue;
          }
          
          scores.push({
            date: dates[i],
            weather: weather,
            score: finalScore,
            weatherDescription: weather ? this.getWeatherDescription(weather.weatherCode) : 'Unknown'
          });
        }
        
        // Check if we have any valid scores
        if (scores.length === 0) {
          console.log(`🌤️ No valid weather scores found`);
          return null;
        }
        
        // Find the best day
        const bestDay = scores.reduce((best, current) => 
          current.score > best.score ? current : best
        );
        

        
        // Validate bestDay has weather data
        if (!bestDay || !bestDay.weather) {
          console.log(`🌤️ Best day has no weather data`);
          return null;
        }
        
        // Ensure the selected date is one of the input dates
        if (!dates.includes(bestDay.date)) {
          console.error(`🌤️ Selected date ${bestDay.date} is not in input dates:`, dates);
          return null;
        }
        
        // Generate reason for selection
        const temp = (bestDay.weather.maxTemp + bestDay.weather.minTemp) / 2;
        const precipitation = bestDay.weather.precipitation;
        const weatherCode = bestDay.weather.weatherCode;
        
        let reason = '';
        
        // Temperature-based reasoning
        if (temp >= 15 && temp <= 25) {
          reason += 'Perfect temperature for outdoor activities';
        } else if (temp >= 10 && temp <= 30) {
          reason += 'Comfortable temperature range';
        } else if (temp < 10) {
          reason += 'Cooler weather, good for indoor activities';
        } else {
          reason += 'Warm weather, suitable for various activities';
        }
        
        // Precipitation-based reasoning
        if (precipitation < 20) {
          reason += ' with very low chance of rain';
        } else if (precipitation < 50) {
          reason += ' with moderate weather conditions';
        } else {
          reason += ' despite higher precipitation chance';
        }
        
        // Weather condition reasoning
        if (weatherCode >= 0 && weatherCode <= 3) {
          reason += '. Clear to partly cloudy skies provide ideal conditions.';
        } else if (weatherCode >= 51 && weatherCode <= 67) {
          reason += '. Rainy weather is perfect for indoor activities.';
        } else if (weatherCode >= 71 && weatherCode <= 86) {
          reason += '. Snowy conditions are great for winter activities.';
        } else {
          reason += '. Weather conditions are suitable for your planned activities.';
        }
        
        return {
          ...bestDay,
          reason: reason
        };
      }
    };

    // AI Itinerary Generator
    const AIItineraryGenerator = {
      generateItinerary: async (groupData, tripDetails) => {
        const prompt = `You are an expert trip planner. Based on the following group information and trip details, create a detailed day-by-day itinerary.

Group Information:
- Group Name: ${groupData.name}
- Group Description: ${groupData.description}
- Group Size: ${groupData.members.length} people
- Members and their personality types:
${groupData.members
            .map(
              (member) =>
                `  • ${addCrownToPremiumUser(member.displayName, member.userId)}: ${member.personalityType} (Adjustment Factor: ${member.adjustmentFactor})`
            )
            .join("\n")}

Trip Details:
- Duration: ${tripDetails.duration} days
- Location: ${tripDetails.location}
- Budget Level: ${tripDetails.budget}
- Interests: ${tripDetails.interests}
- Special Requirements: ${tripDetails.requirements || "None"}

Based on the group's personality mix and preferences, create EXACTLY ${tripDetails.duration} days (no more, no less) that balances social activities for extroverts and quieter experiences for introverts. 

IMPORTANT SCHEDULING RULES:
1. Account for travel time between activities (typically 15-45 minutes depending on distance)
2. If an activity takes 2 hours and starts at 9:00 AM, the next activity should start no earlier than 11:30 AM (2 hours + 30 minutes travel time)
3. Include realistic travel times in the duration field
4. Don't schedule activities too close together - allow buffer time for travel and preparation
5. Consider opening hours and peak times for venues

Include specific venue suggestions, timing, and explain why each activity suits the group's energy levels.

Return your response in the following JSON format:
{
  "overview": "Brief overview of the itinerary approach",
  "tripDetails": {
    "duration": ${tripDetails.duration},
    "location": "${tripDetails.location}",
    "budget": "${tripDetails.budget}",
    "interests": "${tripDetails.interests}",
    "requirements": "${tripDetails.requirements || ""}"
  },
  "days": [
    {
      "day": 1,
      "theme": "Day theme",
      "activities": [
        {
          "time": "9:00 AM",
          "activity": "Activity name",
          "location": "Venue/Location",
          "duration": "2 hours",
          "description": "Brief description",
          "energyLevel": "low/medium/high",
          "socialIntensity": "low/medium/high",
          "whyThisWorks": "Explanation for this group"
        }
      ]
    }
  ],
  "tips": ["Tip 1", "Tip 2", "Tip 3"]
}

IMPORTANT: Create exactly ${tripDetails.duration} days in the "days" array, numbered from 1 to ${tripDetails.duration}.

Only return the JSON, no additional text.`;

        try {
          const payload = {
            messages: [{ role: "user", content: prompt }],
          };

          const response = await fetch(
            "https://ai.hackclub.com/chat/completions",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          const content = data.choices[0].message.content;

          // Clean and parse the response - handle <think> tags and code blocks
          let cleanedContent = content
            .replace(/```json\n?|\n?```/g, "")
            .trim();

          // Remove <think> tags and everything before the first {
          if (cleanedContent.includes("<think>")) {
            const jsonStart = cleanedContent.indexOf("{");
            if (jsonStart !== -1) {
              cleanedContent = cleanedContent.substring(jsonStart);
            }
          }

          // Remove any trailing </think> or similar tags
          const jsonEnd = cleanedContent.lastIndexOf("}");
          if (jsonEnd !== -1) {
            cleanedContent = cleanedContent.substring(0, jsonEnd + 1);
          }

          return JSON.parse(cleanedContent);
        } catch (error) {
          console.error("AI Itinerary Generation Error:", error);
          throw new Error("Failed to generate itinerary. Please try again.");
        }
      },
    };

    // Enhanced Groups System with AI Premium Features


    function showAIPremiumModal(groupId) {
      if (!AI_PREMIUM_ENABLED) {
        NotificationSystem.show(
          "Premium features are currently disabled.",
          "warning"
        );
        return;
      }

      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      const modalHtml = `
    <div id="ai-premium-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeAIPremiumModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-robot"></i> AI Premium Trip Planner
          </h2>
          <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">
            PREMIUM
          </div>
        </div>
        <div class="modal-body">
          <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);">✨ AI-Powered Group Itinerary</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #666;">
              Our AI will analyze your group's personality types and create a personalized day-by-day itinerary 
              that balances everyone's energy preferences and interests.
            </p>
          </div>

          <form id="ai-trip-form" onsubmit="generateAIItinerary(event, ${groupId})">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group">
                <label for="trip-duration">Trip Duration *</label>
                <select id="trip-duration" class="form-control" required onchange="handleTripDurationChange()">
                  <option value="">Select duration</option>
                  <option value="1">1 Day</option>
                  <option value="2">2 Days</option>
                  <option value="3">3 Days</option>
                  <option value="4">4 Days</option>
                  <option value="5">5 Days</option>
                  <option value="7">1 Week</option>
                  <option value="custom">Custom Duration</option>
                </select>
                <input type="number" id="custom-duration" class="form-control" 
                       placeholder="Enter number of days" min="1" max="30" 
                       style="display: none; margin-top: 0.5rem;">
              </div>
              <div class="form-group">
                <label for="trip-budget">Budget Level *</label>
                <select id="trip-budget" class="form-control" required>
                  <option value="">Select budget</option>
                  <option value="budget">Budget-Friendly</option>
                  <option value="moderate">Moderate</option>
                  <option value="premium">Premium</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="trip-location">Location/City *</label>
              <input type="text" id="trip-location" class="form-control" 
                     placeholder="e.g., New York City, Paris, Tokyo" required>
            </div>

            <div class="form-group">
              <label for="trip-interests">Group Interests *</label>
              <textarea id="trip-interests" class="form-control" rows="3" 
                        placeholder="e.g., museums, nightlife, food tours, outdoor activities, shopping, historical sites..." required></textarea>
            </div>

            <div class="form-group">
              <label for="trip-requirements">Special Requirements (Optional)</label>
              <textarea id="trip-requirements" class="form-control" rows="2" 
                        placeholder="e.g., dietary restrictions, accessibility needs, transportation preferences..."></textarea>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 12px 24px;">
                <i class="fas fa-magic"></i> Generate AI Itinerary
              </button>
              <button type="button" class="btn btn-secondary" onclick="closeAIPremiumModal()">Cancel</button>
            </div>
          </form>

          <div id="ai-loading" class="ai-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>AI is crafting your perfect itinerary...</p>
          </div>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("ai-premium-modal", closeAIPremiumModal);
    }

    function closeAIPremiumModal() {
      const modal = document.getElementById("ai-premium-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function handleTripDurationChange() {
      const durationSelect = document.getElementById("trip-duration");
      const customDurationInput = document.getElementById("custom-duration");
      
      if (durationSelect.value === "custom") {
        customDurationInput.style.display = "block";
        customDurationInput.required = true;
      } else {
        customDurationInput.style.display = "none";
        customDurationInput.required = false;
      }
    }

    async function generateAIItinerary(event, groupId) {
      event.preventDefault();

      let duration = document.getElementById("trip-duration").value;
      if (duration === "custom") {
        duration = document.getElementById("custom-duration").value;
        if (!duration || duration < 1 || duration > 30) {
          NotificationSystem.show("Please enter a valid custom duration (1-30 days)", "error");
          return;
        }
      }
      const budget = document.getElementById("trip-budget").value;
      const location = document.getElementById("trip-location").value;
      const interests = document.getElementById("trip-interests").value;
      const requirements = document.getElementById("trip-requirements").value;

      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      // Show loading state
      document.getElementById("ai-trip-form").style.display = "none";
      document.getElementById("ai-loading").style.display = "block";

      const tripDetails = {
        duration,
        budget,
        location,
        interests,
        requirements,
      };

      // Retry logic - try up to 3 times
      let lastError = null;
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          console.log(`AI Itinerary generation attempt ${attempt}/3`);
          
          const itinerary = await AIItineraryGenerator.generateItinerary(
            group,
            tripDetails
          );

          // Save itinerary to group
          const groupIndex = groups.findIndex((g) => g.id === groupId);
          if (groupIndex !== -1) {
            groups[groupIndex].aiItinerary = {
              ...itinerary,
              tripDetails,
              generatedAt: new Date().toISOString(),
            };
            DataLayer.save("groups", groups);
          }

          closeAIPremiumModal();
          GroupsSystem.displayGroups();
          NotificationSystem.show(
            "AI Itinerary generated successfully!",
            "success"
          );

          // Scroll to the group with the new itinerary
          setTimeout(() => {
            const groupCard = document.querySelector(
              `[data-group-id="${groupId}"]`
            );
            if (groupCard) {
              groupCard.scrollIntoView({ behavior: "smooth" });
            }
          }, 500);
          
          return; // Success - exit the function
          
        } catch (error) {
          console.error(`AI Itinerary generation attempt ${attempt}/3 failed:`, error);
          lastError = error;
          
          // If this is not the last attempt, wait a bit before retrying
          if (attempt < 3) {
            console.log(`Retrying in 2 seconds...`);
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
        }
      }

      // All attempts failed
      console.error("All AI Itinerary generation attempts failed:", lastError);
      NotificationSystem.show(
        "Failed to generate itinerary after 3 attempts. Please try again later.",
        "error"
      );

      // Reset form
      document.getElementById("ai-loading").style.display = "none";
      document.getElementById("ai-trip-form").style.display = "block";
    }

    function renderAIItinerary(group) {
      if (!group.aiItinerary) return "";

      const itinerary = group.aiItinerary;

      return `
    <div class="ai-itinerary-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(31, 59, 115, 0.05) 0%, rgba(74, 144, 226, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(31, 59, 115, 0.2);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <h4 style="margin: 0; color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-robot"></i> AI Generated Itinerary
        </h4>
        <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
          PREMIUM
        </div>
      </div>
      
      <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; font-size: 0.8rem;">
          <div><strong>Duration:</strong> ${itinerary.tripDetails.duration} days</div>
          <div><strong>Location:</strong> ${itinerary.tripDetails.location.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ')}</div>
          <div><strong>Budget:</strong> ${itinerary.tripDetails.budget.charAt(0).toUpperCase() + itinerary.tripDetails.budget.slice(1).toLowerCase()}</div>
        </div>
      </div>

      <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
        <p style="margin: 0; font-style: italic; color: #666; font-size: 0.9rem;">${itinerary.overview
        }</p>
      </div>

      <div class="itinerary-timeline" style="position: relative;">
        ${itinerary.days
          .map(
            (day, index) => `
          <div class="day-card" style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid var(--secondary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <div style="width: 40px; height: 40px; background: var(--primary-gradient); color: var(--inverted-text-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${day.day}
              </div>
              <div>
                <h5 style="margin: 0; color: #333;">Day ${day.day}</h5>
                <div style="color: var(--secondary-color); font-weight: bold; font-size: 0.9rem;">${day.theme
              }</div>
              </div>
            </div>
            
            <div class="activities-list">
              ${day.activities
                .map(
                  (activity, activityIndex) => `
    <div class="activity-item" style="display: flex; gap: 1rem; padding: 1rem; background: rgba(31, 59, 115, 0.05); border-radius: 8px; margin-bottom: 0.8rem; position: relative;">
      <div style="width: 60px; text-align: center; font-weight: bold; color: var(--secondary-color); flex-shrink: 0;">
        ${activity.time}
      </div>
      <div style="flex: 1;">
        <div style="font-weight: bold; margin-bottom: 0.3rem;">${activity.activity
                    }</div>
        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.3rem;">
          📍 ${activity.location} • ⏱️ ${activity.duration}
        </div>
        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">${activity.description
                    }</div>
        <div style="display: flex; gap: 1rem; font-size: 0.7rem;">
          <span style="background: ${activity.energyLevel === "high"
                      ? "#ff6b6b"
                      : activity.energyLevel === "medium"
                        ? "#ffd43b"
                        : "#51cf66"
                    }; color: white; padding: 0.2rem 0.5rem; border-radius: 10px;">
            Energy: ${activity.energyLevel}
          </span>
          <span style="background: ${activity.socialIntensity === "high"
                      ? "#ff6b6b"
                      : activity.socialIntensity === "medium"
                        ? "#ffd43b"
                        : "#51cf66"
                    }; color: white; padding: 0.2rem 0.5rem; border-radius: 10px;">
            Social: ${activity.socialIntensity}
          </span>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--secondary-color); font-style: italic;">
          💡 ${activity.whyThisWorks}
        </div>
      </div>
      <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.3rem;">
        <button onclick="showAIEditModal(${group.id}, ${index}, ${activityIndex})" 
                style="background: var(--secondary-color); color: var(--inverted-text-color); border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;" 
                title="Edit activity">
          ✏️
        </button>
        <button onclick="deleteActivity(${group.id}, ${index}, ${activityIndex})" 
                style="background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;" 
                title="Delete activity">
          🗑️
        </button>
      </div>
    </div>
  `
                )
                .join("")}
            </div>
          </div>
        `
          )
          .join("")}
      </div>

      <div style="background: white; padding: 1rem; border-radius: 10px; margin-top: 1rem;">
        <h5 style="margin: 0 0 0.8rem 0; color: var(--secondary-color);">💡 AI Tips for Your Group</h5>
        <ul style="margin: 0; padding-left: 1.2rem;">
          ${itinerary.tips
          .map(
            (tip) =>
              `<li style="margin-bottom: 0.3rem; color: #666; font-size: 0.9rem;">${tip}</li>`
          )
          .join("")}
        </ul>
      </div>

      <div style="text-align: center; margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
  <button class="btn" onclick="showAIAssistantModal(${group.id})" 
          style="font-size: 0.8rem; padding: 6px 12px; background: var(--primary-gradient); color: var(--inverted-text-color);">
    <i class="fas fa-robot"></i> AI Assistant
  </button>
  <button class="btn btn-secondary" onclick="regenerateItinerary(${group.id
        })" style="font-size: 0.8rem; padding: 6px 12px;">
    <i class="fas fa-redo"></i> Regenerate
  </button>
</div>
    </div>
  `;
    }

    async function renderGroupScheduling(group) {
      const currentUser = DataLayer.load("currentUser");
      const currentUserId = currentUser.id;
      
      // Check if all group members have premium access
      const allMembersHavePremium = group.members.every(member => {
        if (member.userId === currentUser.id) {
          return currentUser.isPremium;
        } else {
          const demoUser = DemoUsers.users[member.userId];
          return demoUser ? demoUser.isPremium : false;
        }
      });
      
      // Initialize availability if not exists
      if (!group.availability) {
        group.availability = {};
      }
      
      // Get current week dates (next 7 days)
      const weekDates = [];
      const today = new Date();
      console.log('Today is:', today.toISOString().split('T')[0], '(', today.toLocaleDateString('en-US', { weekday: 'long' }), ')');
      console.log('Today raw:', today);
      console.log('Today getTime():', today.getTime());
      console.log('Today getDate():', today.getDate());
      console.log('Today getMonth():', today.getMonth());
      console.log('Today getFullYear():', today.getFullYear());
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        
        // Ensure we're getting the correct day name by using the date object directly
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const fullDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        // Use local date methods to avoid timezone issues
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        const dayInfo = {
          date: date,
          dayName: dayName,
          fullDate: fullDate,
          dateString: dateString
        };
        weekDates.push(dayInfo);
        console.log(`Day ${i}: ${dayInfo.dayName} (${dayInfo.dateString}) - ${date.toLocaleDateString('en-US', { weekday: 'long' })}`);
      }

      // Count available members for each day
      const availabilityCounts = weekDates.map(weekDate => {
        const availableMembers = group.members.filter(member => {
          const memberAvailability = group.availability[member.userId] || [];
          return memberAvailability.includes(weekDate.dateString);
        });
        return {
          ...weekDate,
          availableCount: availableMembers.length,
          totalCount: group.members.length
        };
      });
      
      // Debug: Log availability counts for each day
      console.log('Availability counts by day:');
      availabilityCounts.forEach(day => {
        console.log(`${day.dayName} (${day.dateString}): ${day.availableCount}/${day.totalCount} votes`);
      });
      
      // Debug: Log current user's availability
      const currentUserAvailability = group.availability[currentUser.id] || [];
      console.log('Current user availability:', currentUserAvailability);
      console.log('All group availability:', group.availability);
      
      // Debug: Check what each selected date corresponds to
      console.log('Week dates generated:');
      weekDates.forEach((day, index) => {
        console.log(`Day ${index}: ${day.dayName} (${day.dateString}) - ${day.date.toLocaleDateString('en-US', { weekday: 'long' })}`);
      });
      
      currentUserAvailability.forEach(dateString => {
        const dayInfo = weekDates.find(day => day.dateString === dateString);
        if (dayInfo) {
          console.log(`Selected date ${dateString} corresponds to ${dayInfo.dayName} (${dayInfo.fullDate})`);
        } else {
          console.log(`Selected date ${dateString} not found in week dates`);
        }
      });
      console.log('Group members:', group.members.map(m => ({ id: m.userId, name: m.displayName })));
      
      // Debug: Log each member's availability
      group.members.forEach(member => {
        const memberAvailability = group.availability[member.userId] || [];
        console.log(`Member ${member.displayName} (${member.userId}) availability:`, memberAvailability);
      });

      // Find best meeting day (most members available)
      // First, filter to only days that have at least 1 vote
      const daysWithVotes = availabilityCounts.filter(day => day.availableCount > 0);
      
      // If no days have votes, return null or default
      if (daysWithVotes.length === 0) {
        return `
          <div class="group-scheduling-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(160, 200, 240, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(74, 144, 226, 0.2);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
              <h4 style="margin: 0; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-alt"></i> Group Scheduling
              </h4>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                  PREMIUM
                </div>
                ${allMembersHavePremium ? `
                  <button class="btn btn-secondary" onclick="showAvailabilityModal(${group.id})" style="font-size: 0.8rem; padding: 8px 16px;">
                    <i class="fas fa-edit"></i> Set My Availability
                  </button>
                ` : ''}
              </div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
              <h5 style="margin: 0 0 1rem 0; color: var(--primary-color);">This Week's Availability</h5>
              <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                ${availabilityCounts.map(day => `
                  <div style="
                    text-align: center; 
                    padding: 0.8rem 0.5rem; 
                    border-radius: 8px; 
                    border: 2px solid #e0e0e0;
                    background: white;
                    position: relative;
                  ">
                    <div style="font-weight: bold; font-size: 0.9rem; color: var(--primary-color);">${day.dayName}</div>
                    <div style="font-size: 0.8rem; color: #666; margin: 0.3rem 0;">${day.fullDate}</div>
                    <div style="font-size: 0.7rem; color: #666;">
                      ${day.availableCount}/${day.totalCount}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 10px; border-left: 4px solid var(--warning-color);">
              <h5 style="margin: 0 0 0.5rem 0; color: var(--warning-color);">
                <i class="fas fa-info-circle"></i> No Availability Set
              </h5>
              <p style="margin: 0; font-size: 0.9rem; color: #666;">
                No members have set their availability for this week. Please set your availability to see recommendations.
              </p>
            </div>
          </div>
        `;
      }
      
      // Find the maximum availability count among days with votes
      const maxAvailability = Math.max(...daysWithVotes.map(day => day.availableCount));
      
      // Find all days that have the maximum availability count
      const tiedDays = daysWithVotes.filter(day => day.availableCount === maxAvailability);
      
      // Select the first tied day as the initial best day
      let bestDay = tiedDays[0];
      
      // Debug logging to understand what's happening
      console.log('Days with votes:', daysWithVotes.map(d => `${d.dayName}: ${d.availableCount}`));
      console.log('Tied days:', tiedDays.map(d => `${d.dayName}: ${d.availableCount}`));
      console.log('Selected best day:', bestDay.dayName);

      // Store tie information for display
      const wasTie = tiedDays.length > 1;
      const tieCount = tiedDays.length;

      // If there are ties, use weather to break the tie
      if (tiedDays.length > 1) {
        try {
          // Get location from group activities, user location, or group center
          let lat, lng;
          
          // Try to get location from first activity
          const firstActivity = group.activities && group.activities.length > 0 ? group.activities[0] : null;
          if (firstActivity && firstActivity.coordinates) {
            lat = firstActivity.coordinates.lat;
            lng = firstActivity.coordinates.lng;
          } else {
            // Try to get location from current user
            const currentUser = DataLayer.load("currentUser");
            if (currentUser && currentUser.location) {
              lat = currentUser.location.lat;
              lng = currentUser.location.lng;
            } else {
              // Calculate group center from member locations
              const memberLocations = group.members.map(member => {
                if (member.userId === currentUser.id) {
                  return currentUser.location;
                } else {
                  const demoUser = DemoUsers.users[member.userId];
                  return demoUser ? demoUser.location : null;
                }
              }).filter(loc => loc !== null);
              
              if (memberLocations.length > 0) {
                const avgLat = memberLocations.reduce((sum, loc) => sum + loc.lat, 0) / memberLocations.length;
                const avgLng = memberLocations.reduce((sum, loc) => sum + loc.lng, 0) / memberLocations.length;
                lat = avgLat;
                lng = avgLng;
              } else {
                // Fallback to Waterloo if no location data available
                lat = 43.4643;
                lng = -80.5204;
              }
            }
          }
          
          const tiedDates = tiedDays.map(day => day.dateString);
          
          console.log('Weather tie-breaker: evaluating dates:', tiedDates);
          console.log('Tied days for weather evaluation:', tiedDays.map(d => `${d.dayName} (${d.dateString}): ${d.availableCount} votes`));
          
          // Use group activities or create default activities for weather comparison
          let activitiesForWeather = group.activities || [];
          if (activitiesForWeather.length === 0) {
            activitiesForWeather = [
              { name: "Outdoor Activity", category: "Outdoor", coordinates: null },
              { name: "Park Visit", category: "Outdoor", coordinates: null },
              { name: "Restaurant", category: "Restaurant", coordinates: null },
              { name: "Cafe", category: "Cafe", coordinates: null }
            ];
          }
          
          const weatherBestDay = await WeatherSystem.getBestWeatherDay(lat, lng, tiedDates, activitiesForWeather);
          
          if (weatherBestDay) {
            console.log('Weather system selected:', weatherBestDay.date);
            bestDay = availabilityCounts.find(day => day.dateString === weatherBestDay.date) || bestDay;
            bestDay.weatherInfo = weatherBestDay;
            console.log('Final best day after weather:', bestDay.dayName);
          } else {
            console.log('No weather data available, keeping original selection:', bestDay.dayName);
          }
        } catch (error) {
          console.error('Error getting weather data for tie-breaking:', error);
        }
      }

      return `
        <div class="group-scheduling-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(160, 200, 240, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(74, 144, 226, 0.2);">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h4 style="margin: 0; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-calendar-alt"></i> Group Scheduling
            </h4>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                PREMIUM
              </div>
              ${allMembersHavePremium ? `
                <button class="btn btn-secondary" onclick="showAvailabilityModal(${group.id})" style="font-size: 0.8rem; padding: 8px 16px;">
                  <i class="fas fa-edit"></i> Set My Availability
                </button>
              ` : `
                <button class="btn btn-secondary" onclick="showPremiumUpgradeModal()" style="font-size: 0.8rem; padding: 8px 16px;">
                  <i class="fas fa-crown"></i> All Members Need Premium
                </button>
              `}
            </div>
          </div>
          
          ${allMembersHavePremium ? `
            <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
              <h5 style="margin: 0 0 1rem 0; color: var(--primary-color);">This Week's Availability</h5>
              <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                ${availabilityCounts.map(day => {
                  const isAvailable = (group.availability[currentUserId] || []).includes(day.dateString);
                  const availabilityPercent = (day.availableCount / day.totalCount) * 100;
                  const isBestDay = day.dateString === bestDay.dateString && day.availableCount > 0;
                  const wasTied = wasTie && day.availableCount === bestDay.availableCount && day.availableCount > 0;
                  
                  return `
                    <div style="
                      text-align: center; 
                      padding: 0.8rem 0.5rem; 
                      border-radius: 8px; 
                      border: 2px solid ${isBestDay ? 'var(--success-color)' : wasTied ? 'var(--warning-color)' : '#e0e0e0'};
                      background: ${isAvailable ? 'rgba(74, 144, 226, 0.1)' : 'white'};
                      position: relative;
                      ${isBestDay ? 'box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);' : wasTied ? 'box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);' : ''}
                    ">
                      <div style="font-weight: bold; font-size: 0.9rem; color: var(--primary-color);">${day.dayName}</div>
                      <div style="font-size: 0.8rem; color: #666; margin: 0.3rem 0;">${day.fullDate}</div>
                      <div style="font-size: 0.7rem; color: ${availabilityPercent >= 80 ? 'var(--success-color)' : availabilityPercent >= 50 ? 'var(--warning-color)' : '#666'};">
                        ${day.availableCount}/${day.totalCount}
                      </div>
                      ${isAvailable ? '<div style="position: absolute; top: 2px; right: 2px; color: var(--secondary-color); font-size: 0.6rem;">✓</div>' : ''}
                      ${isBestDay ? '<div style="position: absolute; bottom: -7px; left: 50%; transform: translateX(-50%); background: var(--success-color); color: white; padding: 1px 4px; border-radius: 4px; font-size: 0.6rem;">BEST</div>' : ''}
                      ${wasTied && !isBestDay ? '<div style="position: absolute; bottom: -7px; left: 50%; transform: translateX(-50%); background: var(--warning-color); color: white; padding: 1px 4px; border-radius: 4px; font-size: 0.6rem;">TIED</div>' : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          ` : `
            <div style="background: white; padding: 2rem; border-radius: 10px; margin-bottom: 1rem; text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">👑</div>
              <h5 style="margin: 0 0 1rem 0; color: var(--primary-color);">Premium Feature</h5>
              <p style="margin: 0 0 1.5rem 0; color: #666; font-size: 0.9rem; line-height: 1.5;">
                All group members need Premium to use Group Scheduling. This ensures everyone can coordinate their availability together!
              </p>
              <div style="margin-top: 1rem; padding: 1rem; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                <h6 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">Group Members Premium Status:</h6>
                ${group.members.map(member => {
                  const isPremium = member.userId === currentUser.id ? 
                    currentUser.isPremium : 
                    (DemoUsers.users[member.userId] ? DemoUsers.users[member.userId].isPremium : false);
                  return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; font-size: 0.8rem;">
                      <span>${addCrownToPremiumUser(member.displayName, member.userId)}</span>
                      <span style="color: ${isPremium ? 'var(--success-color)' : 'var(--warning-color)'}; font-weight: bold;">
                        ${isPremium ? '✓ Premium' : '✗ Free'}
                      </span>
                    </div>
                  `;
                }).join('')}
              </div>
              <button class="btn" onclick="showPremiumUpgradeModal()" style="background: var(--primary-gradient); margin-top: 1rem;">
                <i class="fas fa-crown"></i> Upgrade to Premium
              </button>
            </div>
          `}
          
          ${allMembersHavePremium ? `
            ${bestDay.availableCount > 0 ? `
              <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid var(--success-color);">
                <h5 style="margin: 0 0 0.5rem 0; color: var(--success-color);">
                  <i class="fas fa-check-circle"></i> Recommended Meeting Day
                </h5>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">
                  <strong>${bestDay.dayName}, ${bestDay.fullDate}</strong> - ${bestDay.availableCount} out of ${bestDay.totalCount} members available
                  
                </p>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                  Available members: ${group.members.filter(member => {
                    const memberAvailability = group.availability[member.userId] || [];
                    return memberAvailability.includes(bestDay.dateString);
                  }).map(member => addCrownToPremiumUser(member.displayName, member.userId)).join(', ')}
                </div>
                ${bestDay.weatherInfo ? `
                  <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(74, 144, 226, 0.1); border-radius: 5px; font-size: 0.8rem;">
                                    <div style="margin-bottom: 0.5rem; font-weight: bold; color: var(--primary-color);">
                  <i class="fas fa-cloud-sun"></i> Weather Tie-Breaker Applied
                </div>
                <div style="margin-bottom: 0.3rem; font-size: 0.75rem; color: #666;">
                  ${tieCount} days had the same availability (${bestDay.availableCount}/${bestDay.totalCount}). 
                  This day was selected based on weather conditions for your group's activities.
                </div>
                    <div style="font-size: 0.8rem;">
                      <strong>Weather Forecast:</strong> ${bestDay.weatherInfo.weatherDescription} | 
                      High: ${bestDay.weatherInfo.weather.maxTemp}°C | 
                      Low: ${bestDay.weatherInfo.weather.minTemp}°C | 
                      Rain: ${bestDay.weatherInfo.weather.precipitation}%
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : `
              <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid var(--warning-color);">
                <h5 style="margin: 0 0 0.5rem 0; color: var(--warning-color);">
                  <i class="fas fa-exclamation-triangle"></i> No Common Availability
                </h5>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">
                  No day this week works for everyone. Set your availability to find the best time!
                </p>
              </div>
            `}


          ` : ''}
        </div>
      `;
    }

    // Function to update user's location
    async function updateUserLocation() {
      try {
        const location = await getUserLocation();
        NotificationSystem.show("Location updated successfully!", "success");
        // Refresh the profile page to show updated location
        showPage("profile");
      } catch (error) {
        NotificationSystem.show("Could not get your location. Please check your browser permissions.", "warning");
        console.error("Error updating location:", error);
      }
    }

    // Function to get user's current location
    function getUserLocation() {
      return new Promise(async (resolve, reject) => {
        try {
          const position = await getUserLocationWithFallback();
          const location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          // Update current user's location
          const currentUser = DataLayer.load("currentUser");
          currentUser.location = location;
          DataLayer.save("currentUser", currentUser);
          
          resolve(location);
        } catch (error) {
          reject(error);
        }
      });
    }



    // Function to recommend activities based on weather
    async function recommendActivitiesForWeather(group) {
      console.log(`🌤️ Starting weather recommendations for group:`, group.id);
      
      // If no activities, create general activity recommendations based on weather
      let activitiesToUse = group.activities || [];
      if (activitiesToUse.length === 0) {
        console.log(`🌤️ No activities found, creating general recommendations`);
        activitiesToUse = [
          { name: "Outdoor Activity", category: "Outdoor", coordinates: null },
          { name: "Indoor Activity", category: "Indoor", coordinates: null },
          { name: "Restaurant", category: "Restaurant", coordinates: null },
          { name: "Cafe", category: "Cafe", coordinates: null },
          { name: "Entertainment", category: "Entertainment", coordinates: null }
        ];
      }
      
      try {
        // Get location from group activities, user location, or group center
        let lat, lng;
        
        // Try to get location from first activity
        const firstActivity = group.activities && group.activities.length > 0 ? group.activities[0] : null;
        console.log(`🌤️ First activity:`, firstActivity);
        
        if (firstActivity && firstActivity.coordinates) {
          lat = firstActivity.coordinates.lat;
          lng = firstActivity.coordinates.lng;
          console.log(`🌤️ Using activity coordinates: lat=${lat}, lng=${lng}`);
        } else {
          // Try to get location from current user
          const currentUser = DataLayer.load("currentUser");
          console.log(`🌤️ Current user:`, currentUser);
          
          if (currentUser && currentUser.location) {
            lat = currentUser.location.lat;
            lng = currentUser.location.lng;
            console.log(`🌤️ Using user location: lat=${lat}, lng=${lng}`);
          } else {
            // Calculate group center from member locations
            const memberLocations = group.members.map(member => {
              if (member.userId === currentUser.id) {
                return currentUser.location;
              } else {
                const demoUser = DemoUsers.users[member.userId];
                return demoUser ? demoUser.location : null;
              }
            }).filter(loc => loc !== null);
            
            console.log(`🌤️ Member locations:`, memberLocations);
            
            if (memberLocations.length > 0) {
              const avgLat = memberLocations.reduce((sum, loc) => sum + loc.lat, 0) / memberLocations.length;
              const avgLng = memberLocations.reduce((sum, loc) => sum + loc.lng, 0) / memberLocations.length;
              lat = avgLat;
              lng = avgLng;
              console.log(`🌤️ Using group center: lat=${lat}, lng=${lng}`);
            } else {
              // Fallback to Waterloo if no location data available
              lat = 43.4643;
              lng = -80.5204;
              console.log(`🌤️ Using fallback Waterloo: lat=${lat}, lng=${lng}`);
            }
          }
        }
        
        // Get weather for today and next few days
        const today = new Date();
        const dates = [];
        for (let i = 0; i < 3; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          dates.push(date.toISOString().split('T')[0]);
        }
        
        console.log(`🌤️ Getting weather for dates:`, dates);
        const weatherData = await WeatherSystem.getWeatherForDays(lat, lng, dates);
        console.log(`🌤️ Weather data received:`, weatherData);
        
        // Check if weatherData is valid
        if (!weatherData || !Array.isArray(weatherData) || weatherData.length === 0) {
          console.log(`🌤️ No valid weather data received`);
          return null;
        }
        
        const recommendations = [];
        
        for (let i = 0; i < weatherData.length; i++) {
          const weather = weatherData[i];
          console.log(`🌤️ Processing weather for day ${i}:`, weather);
          
          if (!weather) {
            console.log(`🌤️ No weather data for day ${i}`);
            continue;
          }
          
          // Score each activity for this weather
          const activityScores = activitiesToUse.map(activity => ({
            activity: activity,
            score: WeatherSystem.getActivityWeatherScore(activity, weather),
            weather: weather
          }));
          
          console.log(`🌤️ Activity scores for day ${i}:`, activityScores);
          
          // Sort by score and get top 2
          activityScores.sort((a, b) => b.score - a.score);
          const topActivities = activityScores.slice(0, 2);
          
          console.log(`🌤️ Top activities for day ${i}:`, topActivities);
          
          if (topActivities.length > 0 && weather) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const recommendation = {
              date: date,
              dateString: date.toISOString().split('T')[0],
              activities: topActivities,
              weather: weather
            };
            recommendations.push(recommendation);
            console.log(`🌤️ Added recommendation for day ${i}:`, recommendation);
          } else {
            console.log(`🌤️ Skipping recommendation for day ${i} - no activities or invalid weather data`);
          }
        }
        
        console.log(`🌤️ Final recommendations:`, recommendations);
        return recommendations;
      } catch (error) {
        console.error('Error getting weather-based recommendations:', error);
        return null;
      }
    }

    function showAvailabilityModal(groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      const currentUser = DataLayer.load("currentUser");
      
      // Check if all group members have premium access
      const allMembersHavePremium = group.members.every(member => {
        if (member.userId === currentUser.id) {
          return currentUser.isPremium;
        } else {
          const demoUser = DemoUsers.users[member.userId];
          return demoUser ? demoUser.isPremium : false;
        }
      });

      // Check if all members have premium
      if (!allMembersHavePremium) {
        showPremiumUpgradeModal();
        return;
      }
      const currentUserId = currentUser.id;
      
      // Initialize availability if not exists
      if (!group.availability) {
        group.availability = {};
      }
      
      // Get current week dates (next 7 days)
      const weekDates = [];
      const today = new Date();
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        
        // Ensure we're getting the correct day name by using the date object directly
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const fullDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        // Use local date methods to avoid timezone issues
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        weekDates.push({
          date: date,
          dayName: dayName,
          fullDate: fullDate,
          dateString: dateString
        });
      }

      // Get current user's availability
      const currentAvailability = group.availability[currentUserId] || [];

      const modalHtml = `
        <div id="availability-modal" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeAvailabilityModal()">&times;</button>
            <div class="modal-header">
              <h2 style="color: var(--primary-color);">📅 Set Your Availability</h2>
            </div>
            <div class="modal-body">
              <p style="margin-bottom: 1.5rem; color: #666; font-size: 0.9rem;">
                Select the days when you're available to meet with the group. This helps find the best time for everyone.
              </p>
              
              <form id="availability-form" onsubmit="saveAvailability(event, ${groupId})">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                  ${weekDates.map(day => {
                    const isSelected = currentAvailability.includes(day.dateString);
                    return `
                      <div style="
                        border: 2px solid ${isSelected ? 'var(--primary-color)' : '#e0e0e0'};
                        border-radius: 12px;
                        padding: 1rem;
                        background: ${isSelected ? 'rgba(74, 144, 226, 0.1)' : 'white'};
                        cursor: pointer;
                        transition: all 0.2s ease;
                        text-align: center;
                      " onclick="toggleDaySelection('${day.dateString}')">
                        <input type="checkbox" 
                               id="day-${day.dateString}" 
                               value="${day.dateString}" 
                               ${isSelected ? 'checked' : ''} 
                               style="display: none;">
                        <div style="font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem;">
                          ${day.dayName}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                          ${day.fullDate}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: ${isSelected ? 'var(--primary-color)' : '#999'};">
                          ${isSelected ? '✓ Available' : 'Click to select'}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                  <button type="submit" class="btn" style="background: var(--primary-gradient);">
                    <i class="fas fa-save"></i> Save Availability
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="closeAvailabilityModal()">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("availability-modal", closeAvailabilityModal);
    }

    function closeAvailabilityModal() {
      const modal = document.getElementById("availability-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function toggleDaySelection(dateString) {
      const checkbox = document.getElementById(`day-${dateString}`);
      const dayDiv = checkbox.parentElement;
      
      if (checkbox.checked) {
        checkbox.checked = false;
        dayDiv.style.borderColor = '#e0e0e0';
        dayDiv.style.background = 'white';
        dayDiv.querySelector('div:last-child').textContent = 'Click to select';
        dayDiv.querySelector('div:last-child').style.color = '#999';
      } else {
        checkbox.checked = true;
        dayDiv.style.borderColor = 'var(--primary-color)';
        dayDiv.style.background = 'rgba(74, 144, 226, 0.1)';
        dayDiv.querySelector('div:last-child').textContent = '✓ Available';
        dayDiv.querySelector('div:last-child').style.color = 'var(--primary-color)';
      }
    }

    async function saveAvailability(event, groupId) {
      event.preventDefault();
      
      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      const currentUser = DataLayer.load("currentUser");
      const currentUserId = currentUser.id;
      
      // Get selected dates
      const selectedDates = [];
      const checkboxes = document.querySelectorAll('#availability-form input[type="checkbox"]:checked');
      checkboxes.forEach(checkbox => {
        selectedDates.push(checkbox.value);
      });

      // Store expansion state before updating
      const content = document.getElementById(`group-content-${groupId}`);
      const wasExpanded = content && content.style.maxHeight !== "0px" && content.style.maxHeight !== "";

      // Update availability
      if (!groups[groupIndex].availability) {
        groups[groupIndex].availability = {};
      }
      groups[groupIndex].availability[currentUserId] = selectedDates;
      
      DataLayer.save("groups", groups);
      closeAvailabilityModal();
      
      // Update only the specific group content instead of re-rendering all groups
      await GroupsSystem.updateGroupContent(groupId);
      
      // Restore expansion state if it was expanded - use a longer delay to ensure all async updates are complete
      if (wasExpanded) {
        setTimeout(() => {
          const newContent = document.getElementById(`group-content-${groupId}`);
          const newIcon = document.getElementById(`expand-icon-${groupId}`);
          if (newContent && newIcon) {
            // Force a recalculation of the height
            newContent.style.maxHeight = "none";
            requestAnimationFrame(() => {
              newContent.style.maxHeight = newContent.scrollHeight + "px";
              newIcon.style.transform = "rotate(180deg)";
            });
          }
        }, 200); // Increased delay to ensure all async updates are complete
      }
      
      NotificationSystem.show("Availability updated successfully!", "success");
    }

    function regenerateItinerary(groupId) {
      if (
        confirm(
          "Are you sure you want to regenerate the itinerary? This will replace the current one."
        )
      ) {
        showAIPremiumModal(groupId);
      }
    }
    function showAIEditModal(groupId, dayIndex, activityIndex) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      const activity = group.aiItinerary.days[dayIndex].activities[activityIndex];

      const modalHtml = `
    <div id="ai-edit-modal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeAIEditModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color);">✏️ Edit Activity</h2>
        </div>
        <div class="modal-body">
          <form id="ai-edit-form" onsubmit="updateActivity(event, ${groupId}, ${dayIndex}, ${activityIndex})">
            <div class="form-group">
              <label for="edit-activity-name">Activity Name *</label>
              <input type="text" id="edit-activity-name" class="form-control" value="${activity.activity}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-location">Location *</label>
              <input type="text" id="edit-activity-location" class="form-control" value="${activity.location}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-time">Time *</label>
              <input type="text" id="edit-activity-time" class="form-control" value="${activity.time}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-duration">Duration *</label>
              <input type="text" id="edit-activity-duration" class="form-control" value="${activity.duration}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-description">Description</label>
              <textarea id="edit-activity-description" class="form-control" rows="3">${activity.description}</textarea>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="closeAIEditModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("ai-edit-modal", closeAIEditModal);
    }

    function closeAIEditModal() {
      const modal = document.getElementById("ai-edit-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    async function updateActivity(event, groupId, dayIndex, activityIndex) {
      event.preventDefault();

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      // Store expansion state before updating
      const content = document.getElementById(`group-content-${groupId}`);
      const wasExpanded = content && content.style.maxHeight !== "0px" && content.style.maxHeight !== "";

      const activity = groups[groupIndex].aiItinerary.days[dayIndex].activities[activityIndex];

      activity.activity = document.getElementById("edit-activity-name").value;
      activity.location = document.getElementById("edit-activity-location").value;
      activity.time = document.getElementById("edit-activity-time").value;
      activity.duration = document.getElementById("edit-activity-duration").value;
      activity.description = document.getElementById("edit-activity-description").value;

      DataLayer.save("groups", groups);
      closeAIEditModal();
      
      // Update only the specific group content instead of re-rendering all groups
      await GroupsSystem.updateGroupContent(groupId);
      
      // Restore expansion state if it was expanded
      if (wasExpanded) {
        setTimeout(() => {
          const newContent = document.getElementById(`group-content-${groupId}`);
          const newIcon = document.getElementById(`expand-icon-${groupId}`);
          if (newContent && newIcon) {
            newContent.style.maxHeight = newContent.scrollHeight + "px";
            newIcon.style.transform = "rotate(180deg)";
          }
        }, 100); // Small delay to ensure DOM is updated
      }
      
      NotificationSystem.show("Activity updated successfully!", "success");
    }

    function parseDuration(durationStr) {
      // Parse duration strings like "2 hours", "30 minutes", "1.5 hours"
      const match = durationStr.match(/(\d+(?:\.\d+)?)\s*(hour|minute|hr|min)s?/i);
      if (!match) return 60; // Default to 1 hour if can't parse
      
      const value = parseFloat(match[1]);
      const unit = match[2].toLowerCase();
      
      if (unit.includes('hour') || unit.includes('hr')) {
        return value * 60; // Convert to minutes
      } else if (unit.includes('minute') || unit.includes('min')) {
        return value;
      }
      return 60; // Default
    }

    function addMinutesToTime(timeStr, minutesToAdd) {
      // Parse time like "9:00 AM" and add minutes
      const [time, period] = timeStr.split(' ');
      let [hours, minutes] = time.split(':').map(Number);
      
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      
      const totalMinutes = hours * 60 + minutes + minutesToAdd;
      const newHours = Math.floor(totalMinutes / 60);
      const newMinutes = totalMinutes % 60;
      
      let displayHours = newHours;
      let newPeriod = 'AM';
      
      if (newHours >= 12) {
        newPeriod = 'PM';
        if (newHours > 12) displayHours = newHours - 12;
      }
      if (displayHours === 0) displayHours = 12;
      
      return `${displayHours}:${newMinutes.toString().padStart(2, '0')} ${newPeriod}`;
    }

    function rescheduleActivities(activities) {
      if (activities.length === 0) return activities;
      
      const rescheduled = [];
      let currentTime = activities[0].time;
      
      for (let i = 0; i < activities.length; i++) {
        const activity = { ...activities[i] };
        activity.time = currentTime;
        rescheduled.push(activity);
        
        // Calculate next start time
        const durationMinutes = parseDuration(activity.duration);
        const travelTime = 30; // Assume 30 minutes travel time between activities
        const totalTime = durationMinutes + travelTime;
        
        if (i < activities.length - 1) {
          currentTime = addMinutesToTime(currentTime, totalTime);
        }
      }
      
      return rescheduled;
    }

    async function deleteActivity(groupId, dayIndex, activityIndex) {
      if (!confirm("Are you sure you want to delete this activity?")) return;

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      // Store expansion state before updating
      const content = document.getElementById(`group-content-${groupId}`);
      const wasExpanded = content && content.style.maxHeight !== "0px" && content.style.maxHeight !== "";

      // Remove the activity
      groups[groupIndex].aiItinerary.days[dayIndex].activities.splice(activityIndex, 1);

      // Reschedule remaining activities for this day
      if (groups[groupIndex].aiItinerary.days[dayIndex].activities.length > 0) {
        groups[groupIndex].aiItinerary.days[dayIndex].activities = 
          rescheduleActivities(groups[groupIndex].aiItinerary.days[dayIndex].activities);
      }

      DataLayer.save("groups", groups);
      
      // Update only the specific group content instead of re-rendering all groups
      await GroupsSystem.updateGroupContent(groupId);
      
      // Restore expansion state if it was expanded
      if (wasExpanded) {
        setTimeout(() => {
          const newContent = document.getElementById(`group-content-${groupId}`);
          const newIcon = document.getElementById(`expand-icon-${groupId}`);
          if (newContent && newIcon) {
            newContent.style.maxHeight = newContent.scrollHeight + "px";
            newIcon.style.transform = "rotate(180deg)";
          }
        }, 100); // Small delay to ensure DOM is updated
      }
      
      NotificationSystem.show("Activity deleted and schedule updated!", "success");
    }

    function showAIAssistantModal(groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      const modalHtml = `
    <div id="ai-assistant-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeAIAssistantModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-robot"></i> AI Assistant
          </h2>
        </div>
        <div class="modal-body">
          <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);">🤖 Ask me to modify your itinerary!</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #666;">
              Examples: "Make day 2 more relaxing", "Replace the museum with outdoor activities", "Add more food options"
            </p>
          </div>

          <form id="ai-assistant-form" onsubmit="handleAIAssistantRequest(event, ${groupId})">
            <div class="form-group">
              <label for="ai-request">What would you like me to change? *</label>
              <textarea id="ai-request" class="form-control" rows="4" 
                        placeholder="e.g., Make the first day less crowded, add more restaurants, replace nightlife with quiet activities..." required></textarea>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 12px 24px;">
                <i class="fas fa-magic"></i> Apply Changes
              </button>
              <button type="button" class="btn btn-secondary" onclick="closeAIAssistantModal()">Cancel</button>
            </div>
          </form>

          <div id="ai-assistant-loading" class="ai-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>AI is updating your itinerary...</p>
          </div>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("ai-assistant-modal", closeAIAssistantModal);
    }

    function closeAIAssistantModal() {
      const modal = document.getElementById("ai-assistant-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function showGroupLocationRecommendations(groupId) {
      const recommendations = getGroupLocationRecommendations(groupId);
      if (!recommendations || recommendations.recommendations.length === 0) {
        NotificationSystem.show("No nearby places found for this group.", "warning");
        return;
      }

      const modalHtml = `
        <div id="group-location-modal" class="modal">
          <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeGroupLocationModal()">&times;</button>
            <div class="modal-header">
              <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-map-marker-alt"></i> Places Near Your Group
              </h2>
            </div>
            <div class="modal-body">
              <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);">📍 Group Center</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">
                  Based on the average location of all group members in Waterloo, Ontario
                </p>
              </div>

              <div style="display: grid; gap: 1rem;">
                ${recommendations.recommendations.map((place, index) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #eee; border-radius: 8px; background: white;">
                    <div style="flex: 1;">
                      <div style="font-weight: bold; margin-bottom: 0.3rem; color: var(--primary-color);">${place.name}</div>
                      <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.3rem;">${place.category} • ${place.location}</div>
                      <div style="font-size: 0.8rem; color: #888;">
                        <i class="fas fa-map-marker-alt"></i> ${place.distanceFromGroup.toFixed(1)} km from group center
                      </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                      <div style="text-align: center; margin-right: 1rem;">
                        <div style="font-size: 0.9rem; font-weight: bold; color: var(--secondary-color);">${place.adjustedScore.toFixed(1)}</div>
                        <div style="font-size: 0.7rem; color: #666;">Rating</div>
                      </div>
                      <button class="btn" style="font-size: 0.8rem; padding: 6px 12px;" 
                              onclick="fillActivityForm('${place.name}', '${place.category}', '${place.location}', '${place.description}')">
                        Rate This Place
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>

              <div style="text-align: center; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeGroupLocationModal()">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("group-location-modal", closeGroupLocationModal);
    }

    function closeGroupLocationModal() {
      const modal = document.getElementById("group-location-modal");
      if (modal) {
        modal.remove();
        // Remove any remaining event listeners
        document.removeEventListener('keydown', (event) => {
          if (event.key === 'Escape') closeGroupLocationModal();
        });
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function showPremiumUpgradeModal() {
      const modalHtml = `
        <div id="premium-upgrade-modal" class="modal">
          <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closePremiumUpgradeModal()">&times;</button>
            <div class="modal-header">
              <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-crown"></i> Upgrade to Premium
              </h2>
            </div>
            <div class="modal-body">
              <div style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: center;">
                <h3 style="margin: 0 0 1rem 0;">✨ Premium Features</h3>
                <div style="display: grid; gap: 1rem; text-align: left;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-infinity"></i>
                    <span><strong>Unlimited Groups</strong> - Create as many groups as you want</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-robot"></i>
                    <span><strong>AI Trip Planner</strong> - Get personalized itineraries</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-magic"></i>
                    <span><strong>AI Assistant</strong> - Modify plans with AI help</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-line"></i>
                    <span><strong>Advanced Analytics</strong> - Detailed group insights</span>
                  </div>
                </div>
              </div>

              <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; padding: 12px 24px; font-weight: bold;">
                  <i class="fas fa-crown"></i> Upgrade Now - $9.99/month
                </button>
                <button type="button" class="btn btn-secondary" onclick="closePremiumUpgradeModal()">Maybe Later</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("premium-upgrade-modal", closePremiumUpgradeModal);
    }

    function closePremiumUpgradeModal() {
      const modal = document.getElementById("premium-upgrade-modal");
      if (modal) {
        modal.remove();
        // Remove any remaining event listeners
        document.removeEventListener('keydown', (event) => {
          if (event.key === 'Escape') closePremiumUpgradeModal();
        });
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function fillActivityForm(name, category, location, description) {
      // Close the modal first
      closeGroupLocationModal();
      
      // Navigate to activities page
      showPage("activities");
      
      // Fill the form after a short delay to ensure the page is loaded
      setTimeout(() => {
        const nameInput = document.getElementById("activity-name");
        const categoryInput = document.getElementById("activity-category");
        const locationInput = document.getElementById("activity-location");
        const descriptionInput = document.getElementById("activity-description");
        
        if (nameInput) nameInput.value = name;
        if (categoryInput) categoryInput.value = category;
        if (locationInput) locationInput.value = location;
        if (descriptionInput) descriptionInput.value = description;
        
        NotificationSystem.show("Form filled with place details! Complete your rating.", "success");
      }, 300);
    }

    async function handleAIAssistantRequest(event, groupId) {
      event.preventDefault();

      const request = document.getElementById("ai-request").value;
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      // Show loading state
      document.getElementById("ai-assistant-form").style.display = "none";
      document.getElementById("ai-assistant-loading").style.display = "block";

      try {
        const prompt = `You are an expert trip planner. I have an existing itinerary and need you to modify it based on a specific request.

Current Group Information:
- Group Name: ${group.name}
- Group Description: ${group.description}
- Members and their personality types:
${group.members
            .map(
              (member) =>
                `  • ${addCrownToPremiumUser(member.displayName, member.userId)}: ${member.personalityType} (Adjustment Factor: ${member.adjustmentFactor})`
            )
            .join("\n")}

Current Itinerary:
${JSON.stringify(group.aiItinerary, null, 2)}

User Request: "${request}"

IMPORTANT INSTRUCTIONS:
1. If the user requests changes to duration, location, or budget, update the tripDetails accordingly
2. If the user asks for a different number of days, create exactly that many days (no more, no less)
3. Maintain the same JSON structure and format
4. Keep the balance for the group's personality mix
5. Return the COMPLETE modified itinerary including updated tripDetails if needed

SCHEDULING RULES:
- Account for travel time between activities (15-45 minutes)
- If an activity takes 2 hours and starts at 9:00 AM, next activity should start no earlier than 11:30 AM
- Include realistic travel times in duration fields
- Don't schedule activities too close together
- Consider opening hours and peak times

Only return the JSON, no additional text.`;

        const payload = {
          messages: [{ role: "user", content: prompt }],
        };

        const response = await fetch("https://ai.hackclub.com/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content;

        // Clean and parse the response
        let cleanedContent = content.replace(/```json\n?|\n?```/g, "").trim();

        if (cleanedContent.includes("<think>")) {
          const jsonStart = cleanedContent.indexOf("{");
          if (jsonStart !== -1) {
            cleanedContent = cleanedContent.substring(jsonStart);
          }
        }

        const jsonEnd = cleanedContent.lastIndexOf("}");
        if (jsonEnd !== -1) {
          cleanedContent = cleanedContent.substring(0, jsonEnd + 1);
        }

        const updatedItinerary = JSON.parse(cleanedContent);

        // Update the group's itinerary
        const groupIndex = groups.findIndex((g) => g.id === groupId);
        if (groupIndex !== -1) {
          // Preserve existing tripDetails if the AI didn't update them
          const preservedTripDetails = updatedItinerary.tripDetails || group.aiItinerary.tripDetails;
          
          groups[groupIndex].aiItinerary = {
            ...updatedItinerary,
            tripDetails: preservedTripDetails,
            generatedAt: group.aiItinerary.generatedAt,
            lastModified: new Date().toISOString(),
          };
          DataLayer.save("groups", groups);
        }

        closeAIAssistantModal();
        GroupsSystem.displayGroups();
        NotificationSystem.show("Itinerary updated successfully!", "success");

      } catch (error) {
        console.error("Error updating itinerary:", error);
        NotificationSystem.show("Failed to update itinerary. Please try again.", "error");

        // Reset form
        document.getElementById("ai-assistant-loading").style.display = "none";
        document.getElementById("ai-assistant-form").style.display = "block";
      }
    }

    // Add CSS for AI Premium features
    const aiPremiumStyles = document.createElement("style");
    aiPremiumStyles.textContent = `
  .ai-loading {
    text-align: center;
    padding: 3rem 1rem;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .itinerary-timeline::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 60px;
    bottom: 20px;
    width: 2px;
    background: var(--primary-gradient);
    z-index: 0;
  }

  .day-card {
    position: relative;
    z-index: 1;
  }

  .activity-item:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-small);
    transition: all 0.2s ease;
  }

  @media (max-width: 768px) {
    .ai-itinerary-section {
      margin: 1rem -1rem;
      border-radius: 0;
    }
    
    .day-card {
      margin: 0 -0.5rem 1rem;
      border-radius: 8px;
    }
    
    .activity-item {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .activity-item > div:first-child {
      width: auto;
      text-align: left;
    }
  }
`;
    document.head.appendChild(aiPremiumStyles);

    // Groups System
    const GroupsSystem = {
      // Group limits for non-premium users
      FREE_GROUP_LIMIT: 3,
      
      init: () => {
        // Small delay to ensure DOM elements are loaded
        setTimeout(() => {
        GroupsSystem.displayGroups();
        }, 100);
      },

      // Check if user can create more groups
      canCreateGroup: () => {
        if (AI_PREMIUM_ENABLED) return true; // Premium users have unlimited groups
        
        const groups = DataLayer.load("groups", []);
        const currentMonth = new Date().getFullYear() + "-" + (new Date().getMonth() + 1);
        
        // Count groups created this month
        const groupsThisMonth = groups.filter(group => {
          const groupDate = new Date(group.createdAt);
          const groupMonth = groupDate.getFullYear() + "-" + (groupDate.getMonth() + 1);
          return groupMonth === currentMonth;
        });
        
        return groupsThisMonth.length < GroupsSystem.FREE_GROUP_LIMIT;
      },

      // Get group usage info
      getGroupUsage: () => {
        const groups = DataLayer.load("groups", []);
        const currentMonth = new Date().getFullYear() + "-" + (new Date().getMonth() + 1);
        
        // Count groups created this month
        const groupsThisMonth = groups.filter(group => {
          const groupDate = new Date(group.createdAt);
          const groupMonth = groupDate.getFullYear() + "-" + (groupDate.getMonth() + 1);
          return groupMonth === currentMonth;
        });
        
        return {
          current: groupsThisMonth.length,
          limit: AI_PREMIUM_ENABLED ? "∞" : GroupsSystem.FREE_GROUP_LIMIT,
          isPremium: AI_PREMIUM_ENABLED,
          canCreate: GroupsSystem.canCreateGroup()
        };
      },

      createGroup: (name, description, members) => {
        const currentUser = DataLayer.load("currentUser");
        const personalityData = DataLayer.load("personalityScore");

        if (!personalityData) {
          NotificationSystem.show(
            "Please complete the personality assessment first!",
            "warning"
          );
          return;
        }

        // Check group creation limit for non-premium users
        if (!GroupsSystem.canCreateGroup()) {
          const usage = GroupsSystem.getGroupUsage();
          NotificationSystem.show(
            `You've reached your monthly limit of ${usage.current}/${usage.limit} groups. Upgrade to Premium for unlimited groups!`,
            "warning"
          );
          return;
        }

        // Ensure current user has location data
        if (!currentUser.location) {
          console.log(`🌤️ Current user has no location, attempting to get it...`);
          // Try to get user's location if not already set
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                currentUser.location = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
                DataLayer.save("currentUser", currentUser);
                console.log(`🌤️ Updated current user location:`, currentUser.location);
              },
              (error) => {
                console.log(`🌤️ Could not get user location:`, error.message);
                // Keep default location
              }
            );
          }
        }

        const group = {
          id: Date.now(),
          name: name.trim(),
          description: description.trim(),
          createdBy: currentUser.id,
          createdAt: new Date().toISOString(),
          members: [
            {
              userId: currentUser.id,
              displayName: currentUser.displayName,
              personalityType: currentUser.personalityType,
              adjustmentFactor: personalityData.adjustmentFactor,
              avatar: currentUser.avatar,
              importance: 1.0,
              location: currentUser.location || { lat: 43.4643, lng: -80.5204 }, // Waterloo default
            },
            ...members.map(member => ({
              ...member,
              location: DemoUsers.users[member.userId]?.location || { lat: 43.4643, lng: -80.5204 }
            })),
          ],
        };

        DataLayer.push("groups", group);
        GroupsSystem.displayGroups();
        closeModal();
      },

      deleteGroup: (groupId) => {
        if (confirm("Are you sure you want to delete this group?")) {
          DataLayer.remove("groups", (group) => group.id === groupId);
          GroupsSystem.displayGroups();
        }
      },

      getGroupRecommendations: (group) => {
        const allExperiences = ActivitySystem.getAllExperiences();
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );

        // Calculate group center for location-based scoring
        const groupCenter = calculateGroupCenter(group);

        const recommendations = [];

        // Group experiences by name to avoid duplicates
        const experienceGroups = {};
        allExperiences.forEach((exp) => {
          const key = exp.name.toLowerCase();
          if (!experienceGroups[key]) {
            experienceGroups[key] = [];
          }
          experienceGroups[key].push(exp);
        });

        Object.entries(experienceGroups).forEach(([name, experiences]) => {
          let groupScore = 0;
          let individualScores = [];
          let totalWeight = 0;
          let hasValidPredictions = false;

          group.members.forEach((member) => {
            let memberScore = 0;
            let memberPredictions = 0;

            experiences.forEach((exp) => {
              const ratingUser = DemoUsers.users[exp.userId];
              if (ratingUser) {
                const prediction = ActivitySystem.predictRating(
                  member.adjustmentFactor,
                  exp,
                  ratingUser.adjustmentFactor,
                  exp.rawScore
                );
                memberScore += prediction.prediction * prediction.confidence;
                memberPredictions++;
                hasValidPredictions = true;
              }
            });

            if (memberPredictions > 0) {
              const avgMemberScore = memberScore / memberPredictions;
              individualScores.push({
                member: member,
                score: avgMemberScore,
              });
              groupScore += avgMemberScore * member.importance;
              totalWeight += member.importance;
            }
          });

          if (hasValidPredictions && totalWeight > 0) {
            const finalGroupScore = groupScore / totalWeight;
            const scoreVariance = GroupsSystem.calculateVariance(
              individualScores.map((s) => s.score)
            );
            const confidence = Math.max(0.1, 1 - scoreVariance / 10);

            // Calculate location score
            let locationScore = 1.0; // Default score for experiences without coordinates
            if (experiences[0].coordinates) {
              const distance = calculateDistance(
                groupCenter.lat, groupCenter.lng,
                experiences[0].coordinates.lat, experiences[0].coordinates.lng
              );
              // Score based on distance: closer = higher score
              // 0km = 1.0, 25km = 0.5, 50km+ = 0.1
              locationScore = Math.max(0.1, 1 - (distance / 50));
            }

            // Combine personality score with location score (70% personality, 30% location)
            const combinedScore = (finalGroupScore * 0.7) + (locationScore * 0.3);

            recommendations.push({
              experience: experiences[0],
              groupScore: combinedScore,
              confidence: confidence,
              individualScores: individualScores,
              variance: scoreVariance,
              locationScore: locationScore,
              distanceFromGroup: experiences[0].coordinates ? 
                calculateDistance(groupCenter.lat, groupCenter.lng, 
                               experiences[0].coordinates.lat, experiences[0].coordinates.lng) : null
            });
          }
        });

        return recommendations.sort(
          (a, b) => b.groupScore * b.confidence - a.groupScore * a.confidence
        );
      },

      calculateVariance: (scores) => {
        if (scores.length === 0) return 0;
        const mean =
          scores.reduce((sum, score) => sum + score, 0) / scores.length;
        const variance =
          scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) /
          scores.length;
        return Math.sqrt(variance);
      },

      displayGroups: () => {
        const groups = DataLayer.load("groups", []);
        const groupsContent = document.getElementById("groups-content");

        // Update group usage display
        const usage = GroupsSystem.getGroupUsage();
        const usageText = document.getElementById("group-usage-text");
        console.log("Usage text element found:", !!usageText, "Usage:", usage);
        if (usageText) {
          usageText.textContent = `${usage.current}/${usage.limit}`;
          console.log("Updated usage text to:", `${usage.current}/${usage.limit}`);
          
          // Change color based on usage
          if (usage.isPremium) {
            usageText.style.background = "var(--primary-color)";
            usageText.style.color = "white";
          } else if (usage.current >= usage.limit) {
            usageText.style.background = "#f44336";
          } else if (usage.current >= usage.limit * 0.8) {
            usageText.style.background = "#FF9800";
          } else {
            usageText.style.background = "var(--primary-color)";
          }
        } else {
          console.log("Usage text element not found!");
        }

        // Update premium status display
        const premiumStatusText = document.getElementById("premium-status-text");
        if (premiumStatusText) {
          if (usage.isPremium) {
            premiumStatusText.innerHTML = "Premium - Unlimited Groups";
          } else {
            premiumStatusText.innerHTML = '<a href="#" onclick="showPremiumUpgradeModal()" style="color: var(--secondary-color); text-decoration: none;">Upgrade to Premium for unlimited groups</a>';
          }
        }

        // Update create button state
        const createBtn = document.getElementById("create-group-btn");
        if (createBtn) {
          if (!usage.canCreate) {
            createBtn.style.background = "#f44336";
            createBtn.style.cursor = "not-allowed";
            createBtn.onclick = () => {
              NotificationSystem.show(
                `You've reached your monthly limit of ${usage.current}/${usage.limit} groups. Upgrade to Premium for unlimited groups!`,
                "warning"
              );
            };
          } else {
            createBtn.style.background = "";
            createBtn.style.cursor = "pointer";
            createBtn.onclick = () => showCreateGroupModal();
          }
        }

        if (groups.length === 0) {
          groupsContent.innerHTML = `
      <div class="empty-state">
        <h3>No groups yet</h3>
        <p>Create your first group to start planning activities with friends!</p>
      </div>
    `;
          return;
        }

        groupsContent.innerHTML = groups
          .map((group) => {
            const recommendations =
              GroupsSystem.getGroupRecommendations(group);
            const topRecommendations = recommendations.slice(0, 3);

            // Initialize votes if not exists
            if (!group.votes) group.votes = {};

            // Find most voted activity
            let mostVoted = null;
            let maxVotes = 0;
            Object.entries(group.votes).forEach(([activityName, votes]) => {
              if (votes.length > maxVotes) {
                maxVotes = votes.length;
                mostVoted = activityName;
              }
            });

            return `
        <div class="group-card" data-group-id="${group.id}" style="
          border: 1px solid #eee; 
          border-radius: 16px; 
          margin-bottom: 1.5rem; 
          background: white;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          overflow: hidden;
          transition: all 0.2s ease;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
          
          <!-- Collapsible Header -->
          <div class="group-header" onclick="GroupsSystem.toggleGroupExpansion(${group.id})" style="
            padding: 1.5rem; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: var(--secondary-gradient);
            color: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          ">
            <div style="flex: 1;">
              <h3 style="margin: 0; font-size: 1.4rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">${group.name}</h3>
              <p style="margin: 0.5rem 0 0 0; opacity: 0.95; font-size: 1rem; line-height: 1.4;">${group.description}</p>
              <div style="display: flex; gap: 1.5rem; margin-top: 0.8rem; font-size: 0.9rem; opacity: 0.9;">
                <span style="display: flex; align-items: center; gap: 0.3rem;"><i class="fas fa-users"></i> ${group.members.length} members</span>
                <span style="display: flex; align-items: center; gap: 0.3rem; cursor: help;" 
                      title="${formatFullDate(group.createdAt)}">
                  <i class="fas fa-calendar"></i> ${new Date(group.createdAt).toLocaleDateString()}
                </span>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <i class="fas fa-chevron-down" id="expand-icon-${group.id}" style="
                transition: transform 0.2s ease; 
                font-size: 1.2rem; 
                opacity: 0.9;
                padding: 0.5rem;
                border-radius: 50%;
                background: rgba(255,255,255,0.5);
              "></i>
            </div>
          </div>

          <!-- Expandable Content -->
          <div class="group-content" id="group-content-${group.id}" style="
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease;
            background: white;
          ">
            <div style="padding: 1.5rem;">
              
              <!-- Action Buttons -->
              <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                ${AI_PREMIUM_ENABLED
                  ? `<button class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color);" onclick="showAIPremiumModal(${group.id})">
                      <i class="fa-solid fa-crown"></i> AI Trip Planner
                    </button>`
                  : ""
                }
                <button class="btn btn-info" onclick="showGroupLocationRecommendations(${group.id})" style="background: var(--info-color);">
                  <i class="fas fa-map-marker-alt"></i> Find Places Near Group
                </button>
                <button class="btn btn-secondary" onclick="GroupsSystem.editGroup(${group.id})">
                  <i class="fas fa-edit"></i> Edit Group
                </button>
                <button class="btn btn-danger" onclick="GroupsSystem.deleteGroup(${group.id})">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>

              <!-- Members Section -->
              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--primary-color);">
                  <i class="fas fa-users"></i> Group Members
                </h4>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                  ${group.members
                    .map(
                      (member) => `
                    <div style="
                      display: flex; 
                      align-items: center; 
                      gap: 0.5rem; 
                      padding: 0.5rem 0.8rem; 
                      background: #f8f9fa; 
                      border-radius: 20px; 
                      font-size: 0.9rem;
                      border: 1px solid #e9ecef;
                    ">
                      <div style="
                        width: 25px; 
                        height: 25px; 
                        border-radius: 50%; 
                        background: var(--secondary-color); 
                        color: white; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 0.8rem;
                      ">${member.avatar}</div>
                      <span style="font-weight: 500;">${addCrownToPremiumUser(member.displayName, member.userId)}</span>
                      <span style="color: #666; font-size: 0.8rem;">(${member.personalityType})</span>
                    </div>
                  `
                    )
                    .join("")}
                </div>
              </div>

              <!-- Group Scheduling Section -->
              <div id="scheduling-placeholder-${group.id}" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(160, 200, 240, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(74, 144, 226, 0.2);">
                <div style="text-align: center; color: #666;">
                  <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                  <p>Loading scheduling information...</p>
                </div>
              </div>

              <!-- AI Itinerary Section -->
              ${renderAIItinerary(group)}

              <!-- Recommendations Section -->
              ${topRecommendations.length > 0 && !group.aiItinerary
                ? `
                <div style="margin-top: 1.5rem;">
                  <h4 style="margin-bottom: 1rem; color: var(--primary-color);">
                    <i class="fas fa-star"></i> Top Recommendations
                  </h4>
                  <div class="activity-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    ${topRecommendations
                      .map((rec) => {
                        const activityName = rec.experience.name;
                        const votes = group.votes[activityName] || [];
                        const currentUserId = DataLayer.load("currentUser").id;
                        const hasVoted = votes.includes(currentUserId);
                        const isMostVoted =
                          mostVoted === activityName && maxVotes > 0;

                        return `
                        <div class="activity-card ${isMostVoted ? "most-voted" : ""
                          }" style="
                          border: 1px solid #eee; 
                          border-radius: 12px; 
                          padding: 1.5rem; 
                          background: white;
                          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                          transition: all 0.2s ease;
                          ${isMostVoted ? 'border: 2px solid var(--secondary-color);' : ''}
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                          
                          <div style="background: var(--secondary-gradient); color: white; padding: 0.8rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-radius: 12px 12px 0 0;">
                            <div style="font-weight: bold; font-size: 1.1rem;">Combined Score: ${rec.groupScore.toFixed(1)}/10</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Confidence: ${(rec.confidence * 100).toFixed(0)}%</div>
                          </div>
                          
                          <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">${rec.experience.name}</div>
                          <div style="color: #666; margin-bottom: 0.5rem;">
                            ${rec.experience.category} • ${rec.experience.location}
                            ${rec.distanceFromGroup ? ` • <i class="fas fa-map-marker-alt"></i> ${rec.distanceFromGroup.toFixed(1)}km away` : ''}
                          </div>
                          ${rec.experience.description
                            ? `<p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0; line-height: 1.4;">${rec.experience.description}</p>`
                            : ""
                          }

                          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                            <strong style="font-size: 0.9rem;">Individual Predictions:</strong>
                            ${rec.individualScores
                            .map(
                              (score) => `
                              <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; margin-top: 0.3rem;">
                                <span>${addCrownToPremiumUser(score.member.displayName, score.member.userId)}</span>
                                <span style="font-weight: bold; color: ${score.score >= 7
                                  ? "#4CAF50"
                                  : score.score >= 5
                                    ? "#FF9800"
                                    : "#f44336"
                                }">${score.score.toFixed(1)}/10</span>
                              </div>
                            `
                            )
                            .join("")}
                            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                              Group Compatibility: 
                              <span style="font-weight: bold; color: ${rec.variance <= 1.5
                            ? "#4CAF50"
                            : rec.variance <= 3
                              ? "#FF9800"
                              : "#f44336"
                          }">
                                ${rec.variance <= 1.5
                            ? "High"
                            : rec.variance <= 3
                              ? "Medium"
                              : "Low"
                          }
                              </span>
                            </div>
                            
                            <!-- Voting section -->
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                              <button class="vote-button ${hasVoted ? "voted" : ""
                          }" 
                                      onclick="GroupsSystem.voteForActivity(${group.id}, '${activityName.replace(/'/g, "\\'")}')" style="
                                background: ${hasVoted ? 'var(--success-color)' : 'var(--primary-color)'}; 
                                color: white; 
                                border: none; 
                                padding: 0.5rem 1rem; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 0.9rem;
                                transition: all 0.2s ease;
                              ">
                                ${hasVoted ? "✓ Voted" : "Vote for this"}
                              </button>
                              <div class="vote-count" style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                                ${votes.length} vote${votes.length !== 1 ? "s" : ""}
                                ${votes.length > 0
                            ? `(${votes
                              .map((userId) => {
                                const member = group.members.find(
                                  (m) => m.userId === userId
                                );
                                return member ? addCrownToPremiumUser(member.displayName, member.userId) : "Unknown";
                              })
                              .join(", ")})`
                            : ""
                          }
                              </div>
                            </div>
                          </div>
                        </div>
                      `;
                      })
                      .join("")}
                  </div>
                </div>
              `
                : '<p style="color: #666; text-align: center; padding: 2rem;">No recommendations available yet. More community data needed!</p>'
              }
            </div>
          </div>
        </div>
      `;
          })
          .join("");
          
        // Load scheduling sections asynchronously after groups are rendered
        setTimeout(() => {
          groups.forEach(group => {
            const placeholder = document.getElementById(`scheduling-placeholder-${group.id}`);
            if (placeholder) {
              renderGroupScheduling(group).then(schedulingHtml => {
                placeholder.outerHTML = schedulingHtml;
                

              }).catch(error => {
                console.error('Error rendering group scheduling:', error);
                placeholder.innerHTML = '<p style="color: #666; text-align: center;">Unable to load scheduling information.</p>';
              });
            }
          });
        }, 100);
      },
    };

    //GroupsSystem object
    GroupsSystem.voteForActivity = function (groupId, activityName) {
      console.log('Voting for activity:', activityName, 'in group:', groupId);
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) {
        console.error('Group not found:', groupId);
        return;
      }

      // Initialize votes if not exists
      if (!group.votes) group.votes = {};

      const currentUserId = DataLayer.load("currentUser").id;

      // Remove user's vote from all other activities first
      Object.entries(group.votes).forEach(([activity, votes]) => {
        if (activity !== activityName) { // Only remove from other activities, not the current one
        const voteIndex = votes.indexOf(currentUserId);
        if (voteIndex > -1) {
          votes.splice(voteIndex, 1);
          }
        }
      });

      // Initialize the current activity's votes array if it doesn't exist
      if (!group.votes[activityName]) group.votes[activityName] = [];

      // Toggle vote for the current activity (add if not voted, remove if already voted)
      const currentVoteIndex = group.votes[activityName].indexOf(currentUserId);
      if (currentVoteIndex > -1) {
        // Remove vote if already voted
        group.votes[activityName].splice(currentVoteIndex, 1);
      } else {
        // Add vote if not voted
        group.votes[activityName].push(currentUserId);
      }

      // Update groups data
      DataLayer.save("groups", groups);
      
      // Update only the specific group's content instead of refreshing everything
      console.log('Updating group content for:', groupId);
      GroupsSystem.updateGroupContent(groupId);
    };

    GroupsSystem.updateGroupContent = async function (groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      // Get the current group content element
      const groupContent = document.getElementById(`group-content-${groupId}`);
      if (!groupContent) return;

      // Check if the group is currently expanded
      const isExpanded = groupContent.style.maxHeight !== "0px" && groupContent.style.maxHeight !== "";

      // Generate the new content for this specific group
      const recommendations = GroupsSystem.getGroupRecommendations(group);
      const recommendationsHtml = recommendations
        .slice(0, 3)
        .map((rec) => {
          const activityName = rec.experience.name;
          const votes = group.votes && group.votes[activityName] ? group.votes[activityName] : [];
          const hasVoted = votes.includes(DataLayer.load("currentUser").id);
          const maxVotes = Math.max(...Object.values(group.votes || {}).map(v => v.length));
          const mostVoted = Object.entries(group.votes || {}).find(([name, votes]) => votes.length === maxVotes)?.[0];
          const isMostVoted = mostVoted === activityName && maxVotes > 0;

          return `
            <div class="activity-card ${isMostVoted ? "most-voted" : ""}" style="
              border: 1px solid #eee; 
              border-radius: 12px; 
              padding: 1.5rem; 
              background: white;
              box-shadow: 0 2px 8px rgba(0,0,0,0.05);
              transition: all 0.2s ease;
              ${isMostVoted ? 'border: 2px solid var(--secondary-color);' : ''}
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
              
              <div style="background: var(--secondary-gradient); color: white; padding: 0.8rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-radius: 12px 12px 0 0;">
                <div style="font-weight: bold; font-size: 1.1rem;">Combined Score: ${rec.groupScore.toFixed(1)}/10</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">Confidence: ${(rec.confidence * 100).toFixed(0)}%</div>
              </div>
              
              <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">${rec.experience.name}</div>
              <div style="color: #666; margin-bottom: 0.5rem;">
                ${rec.experience.category} • ${rec.experience.location}
                ${rec.distanceFromGroup ? ` • <i class="fas fa-map-marker-alt"></i> ${rec.distanceFromGroup.toFixed(1)}km away` : ''}
              </div>
              ${rec.experience.description
                ? `<p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0; line-height: 1.4;">${rec.experience.description}</p>`
                : ""
              }

              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                <strong style="font-size: 0.9rem;">Individual Predictions:</strong>
                ${rec.individualScores
                .map(
                  (score) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; margin-top: 0.3rem;">
                                                    <span>${addCrownToPremiumUser(score.member.displayName, score.member.userId)}</span>
                    <span style="font-weight: bold; color: ${score.score >= 7
                      ? "#4CAF50"
                      : score.score >= 5
                        ? "#FF9800"
                        : "#f44336"
                    }">${score.score.toFixed(1)}/10</span>
                  </div>
                `
                )
                .join("")}
                <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                  Group Compatibility: 
                  <span style="font-weight: bold; color: ${rec.variance <= 1.5
                ? "#4CAF50"
                : rec.variance <= 3
                  ? "#FF9800"
                  : "#f44336"
              }">
                    ${rec.variance <= 1.5
                ? "High"
                : rec.variance <= 3
                  ? "Medium"
                  : "Low"
              }
                  </span>
                </div>
                
                <!-- Voting section -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                  <button class="vote-button ${hasVoted ? "voted" : ""}" 
                          onclick="GroupsSystem.voteForActivity(${group.id}, '${activityName.replace(/'/g, "\\'")}')" style="
                    background: ${hasVoted ? 'var(--success-color)' : 'var(--primary-color)'}; 
                    color: white; 
                    border: none; 
                    padding: 0.5rem 1rem; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 0.9rem;
                    transition: all 0.2s ease;
                  ">
                    ${hasVoted ? "✓ Voted" : "Vote for this"}
                  </button>
                  <div class="vote-count" style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                    ${votes.length} vote${votes.length !== 1 ? "s" : ""}
                    ${votes.length > 0
                ? `(${votes
                  .map((userId) => {
                    const member = group.members.find(
                      (m) => m.userId === userId
                    );
                    return member ? addCrownToPremiumUser(member.displayName, member.userId) : "Unknown";
                  })
                  .join(", ")})`
                : ""
              }
                  </div>
                </div>
              </div>
            </div>
          `;
        })
        .join("");

      // Find the recommendations container within this group
      const recommendationsContainer = groupContent.querySelector('.activity-grid');
      if (recommendationsContainer) {
        recommendationsContainer.innerHTML = recommendationsHtml;
      }

      // Update AI itinerary section if it exists
      const aiItinerarySection = groupContent.querySelector('.ai-itinerary-section');
      if (aiItinerarySection && group.aiItinerary) {
        aiItinerarySection.innerHTML = renderAIItinerary(group);
      }

      // Update group scheduling section if it exists
      const groupSchedulingSection = groupContent.querySelector('.group-scheduling-section');
      if (groupSchedulingSection) {
        // Render the scheduling section asynchronously
        renderGroupScheduling(group).then(schedulingHtml => {
          groupSchedulingSection.innerHTML = schedulingHtml;
          
          // After updating the scheduling section, recalculate the height if expanded
          if (isExpanded) {
            // Use requestAnimationFrame to ensure DOM updates are complete
            requestAnimationFrame(() => {
              groupContent.style.maxHeight = groupContent.scrollHeight + "px";
            });
          }
        }).catch(error => {
          console.error('Error rendering group scheduling:', error);
          groupSchedulingSection.innerHTML = '<p style="color: #666;">Unable to load scheduling information.</p>';
          
          // Even if there's an error, still recalculate height if expanded
          if (isExpanded) {
            requestAnimationFrame(() => {
              groupContent.style.maxHeight = groupContent.scrollHeight + "px";
            });
          }
        });
      } else {
        // If no scheduling section to update, still recalculate height if expanded
        if (isExpanded) {
          requestAnimationFrame(() => {
            groupContent.style.maxHeight = groupContent.scrollHeight + "px";
          });
        }
      }
    };

    GroupsSystem.toggleGroupExpansion = function (groupId) {
      const content = document.getElementById(`group-content-${groupId}`);
      const icon = document.getElementById(`expand-icon-${groupId}`);
      
      if (content.style.maxHeight === "0px" || content.style.maxHeight === "") {
        // Expand
        content.style.maxHeight = content.scrollHeight + "px";
        icon.style.transform = "rotate(180deg)";
      } else {
        // Collapse
        content.style.maxHeight = "0px";
        icon.style.transform = "rotate(0deg)";
      }
    };

    GroupsSystem.editGroup = function (groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      const friends = FriendsSystem.getFriends();
      const currentMembers = group.members.filter(
        (m) => m.userId !== DataLayer.load("currentUser").id
      );

      const modalHtml = `
    <div id="edit-group-modal" class="modal" onclick="handleEditModalBackdropClick(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
        <div class="modal-header">
          <h2>Edit Group</h2>
        </div>
        <div class="modal-body">
          <form id="edit-group-form" onsubmit="handleEditGroup(event, ${groupId})">
            <div class="form-group">
              <label for="edit-group-name">Group Name *</label>
              <input type="text" id="edit-group-name" class="form-control" value="${group.name
        }" required>
            </div>
            <div class="form-group">
              <label for="edit-group-description">Description</label>
              <textarea id="edit-group-description" class="form-control">${group.description
        }</textarea>
            </div>
            <div class="form-group">
              <label>Current Members</label>
              <div style="margin-bottom: 1rem;">
                ${currentMembers
          .map(
            (member) => `
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #eee; border-radius: 8px;">
                    <input type="checkbox" id="keep-member-${member.userId}" checked>
                    <div class="feed-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">${member.avatar}</div>
                    <span>${addCrownToPremiumUser(member.displayName, member.userId)} (${member.personalityType})</span>
                  </div>
                `
          )
          .join("")}
              </div>
              <label>Add New Members</label>
              ${friends
          .filter(
            (friend) => !group.members.some((m) => m.userId === friend.id)
          )
          .map(
            (friend) => `
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #eee; border-radius: 8px;">
                  <input type="checkbox" id="add-member-${friend.id}">
                  <div class="feed-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">${friend.avatar}</div>
                  <span>${addCrownToPremiumUser(friend.displayName, friend.id)} (${friend.personalityType})</span>
                </div>
              `
          )
          .join("")}
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      // Prevent body scrolling when modal is open
      document.body.classList.add('modal-open');
    };

    // Modal system for creating groups
    function showCreateGroupModal() {
      // Get friends list
      const friends = FriendsSystem.getFriends();

      if (friends.length === 0) {
        NotificationSystem.show(
          "Add some friends first before creating a group!",
          "warning"
        );
        showPage("feed");
        return;
      }

      const modalHtml = `
    <div id="group-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-header">
          <h2>Create New Group</h2>
        </div>
        <div class="modal-body">
          <form id="group-form" onsubmit="handleCreateGroup(event)">
            <div class="form-group">
              <label for="group-name">Group Name *</label>
              <input type="text" id="group-name" class="form-control" placeholder="e.g., Friday Night Crew, Study Group" required>
            </div>
            <div class="form-group">
              <label for="group-description">Description</label>
              <textarea id="group-description" class="form-control" placeholder="What's this group about?"></textarea>
            </div>
            <div class="form-group">
              <label>Add Friends to Group *</label>
              <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">Select friends to add to your group:</p>
              ${friends
          .map(
            (friend) => `
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid #eee; border-radius: 8px;">
                    <input type="checkbox" id="member-${friend.id}" value="${friend.id
              }">
                    <div class="feed-avatar" style="width: 35px; height: 35px; font-size: 1rem;">${friend.avatar
              }</div>
                    <div style="flex: 1;">
                      <strong>${addCrownToPremiumUser(friend.displayName, friend.id)}</strong>
                      <div style="font-size: 0.8rem; color: var(--secondary-color);">${friend.personalityType
              }</div>
                      <div style="font-size: 0.8rem; color: #888;">AF: ${friend.adjustmentFactor.toFixed(
                2
              )}</div>
                    </div>
                  </div>
              `
          )
          .join("")}
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Create Group</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
    }
    function handleCreateGroup(event) {
      event.preventDefault();

      const name = document.getElementById("group-name").value;
      const description = document.getElementById("group-description").value;

      // Get selected friends
      const selectedMembers = [];
      const friends = FriendsSystem.getFriends();
      friends.forEach((friend) => {
        const checkbox = document.getElementById(`member-${friend.id}`);
        if (checkbox && checkbox.checked) {
          selectedMembers.push({
            userId: friend.id,
            displayName: friend.displayName,
            personalityType: friend.personalityType,
            adjustmentFactor: friend.adjustmentFactor, // Fixed: was user.adjustmentFactor
            avatar: friend.avatar, // Fixed: was user.avatar
            importance: 1.0,
          });
        }
      });

      if (selectedMembers.length === 0) {
        NotificationSystem.show(
          "Please select at least one member to add to the group.",
          "warning"
        );
        return;
      }

      GroupsSystem.createGroup(name, description, selectedMembers);
    }

    // Experiences Modal System
    function showExperiencesModal() {
      const userExperiences = DataLayer.load("userExperiences", []);
      
      const modalHtml = `
        <div id="experiences-modal" class="modal">
          <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeExperiencesModal()">&times;</button>
            <div class="modal-header">
              <h2>Your Experiences</h2>
              <p style="margin: 0; color: #666;">Manage and edit your shared experiences</p>
            </div>
            <div class="modal-body">
              ${userExperiences.length === 0 ? `
                <div style="text-align: center; padding: 3rem 1rem;">
                  <div style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;">📝</div>
                  <h3 style="color: #666; margin-bottom: 0.5rem;">No Experiences Yet</h3>
                  <p style="color: #888; margin-bottom: 2rem;">Start sharing your experiences to see them here!</p>
                  <button class="btn" onclick="closeExperiencesModal(); showPage('activities');">
                    <i class="fas fa-plus-circle"></i> Add Your First Experience
                  </button>
                </div>
              ` : `
                <div style="display: grid; gap: 1.5rem;">
                  ${userExperiences.map((experience, index) => `
                    <div class="experience-card" style="
                      border: 1px solid #eee; 
                      border-radius: 12px; 
                      padding: 1.5rem; 
                      background: white;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                      transition: all 0.2s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                      
                      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                          <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.2rem;">
                            ${experience.name}
                          </h3>
                          <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <span style="background: var(--secondary-color); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">
                              ${experience.category}
                            </span>
                            <span style="color: #666;">
                              <i class="fas fa-map-marker-alt"></i> ${experience.location}
                            </span>
                          </div>
                          <p style="margin: 0; color: #555; line-height: 1.5; font-size: 0.95rem;">
                            ${experience.description}
                          </p>
                        </div>
                        <div style="text-align: right; min-width: 80px;">
                          <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                            ${experience.adjustedScore.toFixed(1)}
                          </div>
                          <div style="font-size: 0.8rem; color: #666;">Rating</div>
                        </div>
                      </div>
                      
                      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Energy</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.energy}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Social</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.social}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Comfort</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.comfort}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Overwhelm</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.overwhelm}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Return</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.return}/10</div>
                        </div>
                      </div>
                      
                      <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="editExperience(${index})" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteExperience(${index})" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
                  <button class="btn" onclick="closeExperiencesModal(); showPage('activities');">
                    <i class="fas fa-plus-circle"></i> Add New Experience
                  </button>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML("beforeend", modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("experiences-modal", closeExperiencesModal);
    }

    function closeExperiencesModal() {
      const modal = document.getElementById("experiences-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function editExperience(index) {
      const userExperiences = DataLayer.load("userExperiences", []);
      const experience = userExperiences[index];
      
      if (!experience) return;
      
      const modalHtml = `
        <div id="edit-experience-modal" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeEditExperienceModal()">&times;</button>
            <div class="modal-header">
              <h2>Edit Experience</h2>
            </div>
            <div class="modal-body">
              <form id="edit-experience-form" onsubmit="handleEditExperience(event, ${index})">
                <div class="form-group">
                  <label for="edit-name">Experience Name *</label>
                  <input type="text" id="edit-name" class="form-control" value="${experience.name}" required>
                </div>
                <div class="form-group">
                  <label for="edit-category">Category *</label>
                  <select id="edit-category" class="form-control" required>
                    <option value="Restaurant" ${experience.category === 'Restaurant' ? 'selected' : ''}>Restaurant</option>
                    <option value="Bar/Pub" ${experience.category === 'Bar/Pub' ? 'selected' : ''}>Bar/Pub</option>
                    <option value="Cafe" ${experience.category === 'Cafe' ? 'selected' : ''}>Cafe</option>
                    <option value="Museum/Gallery" ${experience.category === 'Museum/Gallery' ? 'selected' : ''}>Museum/Gallery</option>
                    <option value="Library/Study" ${experience.category === 'Library/Study' ? 'selected' : ''}>Library/Study</option>
                    <option value="Park/Outdoor" ${experience.category === 'Park/Outdoor' ? 'selected' : ''}>Park/Outdoor</option>
                    <option value="Entertainment" ${experience.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                    <option value="Shopping" ${experience.category === 'Shopping' ? 'selected' : ''}>Shopping</option>
                    <option value="Other" ${experience.category === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="edit-location">Location *</label>
                  <input type="text" id="edit-location" class="form-control" value="${experience.location}" required>
                </div>
                <div class="form-group">
                  <label for="edit-description">Description *</label>
                  <textarea id="edit-description" class="form-control" rows="3" required>${experience.description}</textarea>
                </div>
                
                <div style="margin: 2rem 0;">
                  <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Rate Your Experience</h4>
                                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                     <div class="form-group">
                       <label for="edit-energy">Energy Level (1-10)</label>
                       <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.energy}" oninput="updateSliderValue(this, 'slider-energy')" id="edit-energy">
                       <div style="text-align: center; font-weight: bold; color: var(--primary-color);" id="slider-energy">${experience.responses.energy}</div>
                     </div>
                     <div class="form-group">
                       <label for="edit-social">Social Interaction (1-10)</label>
                       <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.social}" oninput="updateSliderValue(this, 'slider-social')" id="edit-social">
                       <div style="text-align: center; font-weight: bold; color: var(--primary-color);" id="slider-social">${experience.responses.social}</div>
                     </div>
                     <div class="form-group">
                       <label for="edit-comfort">Comfort Level (1-10)</label>
                       <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.comfort}" oninput="updateSliderValue(this, 'slider-comfort')" id="edit-comfort">
                       <div style="text-align: center; font-weight: bold; color: var(--primary-color);" id="slider-comfort">${experience.responses.comfort}</div>
                     </div>
                     <div class="form-group">
                       <label for="edit-overwhelm">Overwhelm Level (1-10)</label>
                       <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.overwhelm}" oninput="updateSliderValue(this, 'slider-overwhelm')" id="edit-overwhelm">
                       <div style="text-align: center; font-weight: bold; color: var(--primary-color);" id="slider-overwhelm">${experience.responses.overwhelm}</div>
                     </div>
                     <div class="form-group">
                       <label for="edit-return">Would Return (1-10)</label>
                       <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.return}" oninput="updateSliderValue(this, 'slider-return')" id="edit-return">
                       <div style="text-align: center; font-weight: bold; color: var(--primary-color);" id="slider-return">${experience.responses.return}</div>
                     </div>
                   </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                  <button type="submit" class="btn">Save Changes</button>
                  <button type="button" class="btn btn-secondary" onclick="closeEditExperienceModal()">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML("beforeend", modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("edit-experience-modal", closeEditExperienceModal);
    }

    function closeEditExperienceModal() {
      const modal = document.getElementById("edit-experience-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function handleEditExperience(event, index) {
      event.preventDefault();
      
      const userExperiences = DataLayer.load("userExperiences", []);
      const experience = userExperiences[index];
      
      if (!experience) return;
      
      // Update experience data
      experience.name = document.getElementById("edit-name").value;
      experience.category = document.getElementById("edit-category").value;
      experience.location = document.getElementById("edit-location").value;
      experience.description = document.getElementById("edit-description").value;
      experience.responses.energy = parseInt(document.getElementById("edit-energy").value);
      experience.responses.social = parseInt(document.getElementById("edit-social").value);
      experience.responses.comfort = parseInt(document.getElementById("edit-comfort").value);
      experience.responses.overwhelm = parseInt(document.getElementById("edit-overwhelm").value);
      experience.responses.return = parseInt(document.getElementById("edit-return").value);
      
      // Recalculate scores
      const rawScore = (experience.responses.energy + experience.responses.social + experience.responses.comfort + experience.responses.return) / 4;
      const personalityData = DataLayer.load("personalityScore");
      const adjustmentFactor = personalityData ? personalityData.adjustmentFactor : 1.0;
      const adjustedScore = rawScore * adjustmentFactor;
      
      experience.rawScore = rawScore;
      experience.adjustedScore = adjustedScore;
      
      // Save updated experiences
      DataLayer.save("userExperiences", userExperiences);
      
      // Close modal and show success message
      closeEditExperienceModal();
      closeExperiencesModal();
      NotificationSystem.show("Experience updated successfully!", "success");
      
      // Refresh the page data
      updateDashboard();
      updateProfile();
    }

    function deleteExperience(index) {
      if (confirm("Are you sure you want to delete this experience? This action cannot be undone.")) {
        const userExperiences = DataLayer.load("userExperiences", []);
        userExperiences.splice(index, 1);
        DataLayer.save("userExperiences", userExperiences);
        
        closeExperiencesModal();
        NotificationSystem.show("Experience deleted successfully!", "success");
        
        // Refresh the page data
        updateDashboard();
        updateProfile();
      }
    }

    // Updated showCreateGroupModal to limit to 3-6 friends displayed
    function showCreateGroupModal() {
      const friends = FriendsSystem.getFriends();

      if (friends.length === 0) {
        NotificationSystem.show(
          "Add some friends first before creating a group!",
          "warning"
        );
        showPage("feed");
        return;
      }

      // Limit to first 6 friends for better UI
      const displayFriends = friends.slice(0, 6);

      const modalHtml = `
    <div id="group-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-header">
          <h2>Create New Group</h2>
        </div>
        <div class="modal-body">
          <form id="group-form" onsubmit="handleCreateGroup(event)">
            <div class="form-group">
              <label for="group-name">Group Name *</label>
              <input type="text" id="group-name" class="form-control" placeholder="e.g., Friday Night Crew, Study Group" required>
            </div>
            <div class="form-group">
              <label for="group-description">Description</label>
              <textarea id="group-description" class="form-control" placeholder="What's this group about?"></textarea>
            </div>
            <div class="form-group">
              <label>Add Friends to Group *</label>
              <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">Select friends to add to your group:</p>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.8rem;">
                ${displayFriends
          .map(
            (friend) => `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; border: 1px solid #eee; border-radius: 8px;">
                      <input type="checkbox" id="member-${friend.id}" value="${friend.id
              }">
                      <div class="feed-avatar" style="width: 35px; height: 35px; font-size: 1rem;">${friend.avatar
              }</div>
                                          <div style="flex: 1;">
                      <strong>${addCrownToPremiumUser(friend.displayName, friend.id)}</strong>
                      <div style="font-size: 0.8rem; color: var(--secondary-color);">${friend.personalityType
              }</div>
                      <div style="font-size: 0.8rem; color: #888;">AF: ${friend.adjustmentFactor.toFixed(
                2
              )}</div>
                    </div>
                    </div>
                `
          )
          .join("")}
              </div>
              ${friends.length > 6
          ? `<p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem; font-style: italic;">Showing first 6 friends. You can add more after creating the group.</p>`
          : ""
        }
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Create Group</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      
      // Add ESC and click-outside functionality
      addModalListeners("group-modal", closeModal);
    }

    // Enhanced closeModal function
    function closeModal() {
      const modal = document.getElementById("group-modal");
      if (modal) {
        modal.style.animation = "fadeOut 0.3s ease forwards";
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
          }
        }, 300);
      }
    }

    const fadeOutStyle = document.createElement("style");
    fadeOutStyle.textContent = `
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
`;
    document.head.appendChild(fadeOutStyle);
    function closeModal() {
      const modal = document.getElementById("group-modal");
      if (modal) {
        modal.remove();
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    // Recommendation System
    const RecommendationSystem = {
      displayRecommendations: () => {
        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) return "";

        const recommendations = ActivitySystem.getRecommendations(
          personalityData.adjustmentFactor
        );
        const friends = FriendsSystem.getFriends();

        if (recommendations.length === 0) {
          if (friends.length === 0) {
            return `
          <div style="margin-bottom: 2rem;">
            <h3>No Recommendations Yet</h3>
            <p style="color: #666;">Add friends to get personalized recommendations based on places they've visited!</p>

          </div>
        `;
          } else {
            return `
          <div style="margin-bottom: 2rem;">
            <h3>No New Recommendations</h3>
            <p style="color: #666;">Your friends haven't shared new places recently. Check the community feed for more experiences!</p>
          </div>
        `;
          }
        }

        return `
      <div style="margin-bottom: 2rem;">
        <h3>Recommended For You (From Friends)</h3>
        <p style="color: #666; margin-bottom: 1rem;">Based on places your friends have visited and enjoyed</p>
        <div class="activity-grid">
          ${recommendations
            .slice(0, 4)
            .map(
              (rec) => `
            <div class="activity-card" style="border: 2px solid var(--secondary-color);">
                              <div style="background: var(--secondary-gradient); color: white; padding: 0.5rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-radius: 15px 15px 0 0;">
                <div style="font-weight: bold;">Recommended: ${rec.predictedScore.toFixed(
                1
              )}/10</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Confidence: ${(
                  rec.confidence * 100
                ).toFixed(0)}%</div>
              </div>
              <div class="activity-title">${rec.experience.name}</div>
              <div class="activity-category">${rec.experience.category} • ${rec.experience.location
                }</div>
              <div class="activity-details">
                ${rec.experience.description
                  ? `<p style="margin: 0.5rem 0; color: #666;">"${rec.experience.description}"</p>`
                  : ""
                }
                <div style="font-size: 0.9rem; color: #888; margin-top: 0.5rem;">
                  Social Intensity: ${rec.experience.socialIntensity.toFixed(
                  1
                )}/10 |
                  Noise Level: ${rec.experience.noiseLevel.toFixed(1)}/10 |
                  Crowd Size: ${rec.experience.crowdSize.toFixed(1)}/10
                </div>
              </div>
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                  Recommended by friends:
                </div>
                ${rec.predictions
                  .slice(0, 2)
                  .map(
                    (p) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; margin-bottom: 0.3rem;">
                    <span>${addCrownToPremiumUser(p.user.displayName, p.user.id)} (${p.user.personalityType})</span>
                    <span style="font-weight: bold;">${p.experience.adjustedScore}/10</span>
                  </div>
                `
                  )
                  .join("")}
                <div style="text-align: center; margin-top: 1rem;">
                  <button class="btn" style="font-size: 0.9rem; padding: 8px 16px;"
                          onclick="fillActivityForm('${rec.experience.name
                }', '${rec.experience.category}', '${rec.experience.location
                }', '${rec.experience.description.replace(/'/g, "\\'")}')">
                    Rate This Place
                  </button>
                </div>
              </div>
            </div>
          `
            )
            .join("")}
        </div>
      </div>
    `;
      },
    };
    // Similar Users System
    const SimilarUsersSystem = {
      displaySimilarUsers: () => {
        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) return "";

        const similarUsers = ActivitySystem.findSimilarUsers(
          personalityData.adjustmentFactor
        );
        const friends = FriendsSystem.getFriends();
        const friendIds = FriendsSystem.getFriendIds();

        // Filter out users who are already friends
        const nonFriendUsers = similarUsers.filter(
          (sim) => !friendIds.includes(sim.user.id)
        );

        return `
      <div style="margin-bottom: 2rem;">
        <h3>Users Similar to You</h3>
        <p style="color: #666; margin-bottom: 1rem;">Connect with people who have similar social energy preferences</p>

        ${friends.length > 0
            ? `
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(118, 191, 255, 0.08); border-radius: 10px;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--header-text);">Your Friends (${friends.length
            })</h4>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${friends
              .map(
                (friend) => `
                <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">
                  <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">
                    ${friend.avatar}
                  </div>
                  ${addCrownToPremiumUser(friend.displayName, friend.id)}
                  <button 
                    onclick="FriendsSystem.removeFriend(${friend.id})"
                    style="background: none; border: none; color: #999; cursor: pointer; font-size: 1rem; margin-left: 0.3rem; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;"
                    onmouseover="this.style.backgroundColor='var(--primary-color)'; this.style.color='white';"
                    onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';"
                    title="Remove friend">
                    ×
                  </button>
                </div>
              `
              )
              .join("")}
            </div>
          </div>
        `
            : ""
          }

        <div class="similar-users-grid">
          ${nonFriendUsers
            .slice(0, 6)
            .map((sim) => {
              const userExperiences = DemoUsers.experiences.filter(
                (exp) => exp.userId === sim.user.id
              );
              return `
              <div class="similar-user-card">
                <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${sim.user.avatar}
                  </div>
                  <div style="text-align: left;">
                    <div style="font-weight: bold;">${addCrownToPremiumUser(sim.user.displayName, sim.user.id)
                }</div>
                    <div style="font-size: 0.8rem; color: var(--highlight);">${sim.user.personalityType
                }</div>
                  </div>
                </div>
                <div class="similarity-score">
                  ${(sim.similarity * 100).toFixed(0)}% Similar
                </div>    
                <div style="font-size: 0.8rem; color: #666; margin: 0.8rem 0;">
                  AF: ${sim.user.adjustmentFactor.toFixed(2)}
                </div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem;">
                  "${sim.user.bio}"
                </div>
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">
                  ${userExperiences.length} experiences posted
                </div>
                <div style="text-align: center;">
                  ${FriendsSystem.isFriend(sim.user.id)
                    ? '<span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color); display: inline-block;">✓ Friend</span>'
                    : `<button class="btn" style="font-size: 0.8rem; padding: 6px 12px;" onclick="FriendsSystem.addFriend(${sim.user.id})">Add Friend</button>`
                  }
                </div>
              </div>
            `;
            })
            .join("")}
        </div>

        ${nonFriendUsers.length === 0
            ? `
          <div style="text-align: center; color: #666; font-style: italic;">
            You're already friends with all similar users!
          </div>
        `
            : ""
          }
      </div>
    `;
      },
    };

    function updateDashboard() {
      const personalityData = DataLayer.load("personalityScore");
      const personalityType = DataLayer.load("personalityType");
      const currentUser = DataLayer.load("currentUser");

      if (
        personalityData &&
        personalityType &&
        DataLayer.exists("currentUser")
      ) {
        document.getElementById("user-avatar").textContent =
          currentUser.avatar;
        document.getElementById(
          "welcome-message"
        ).innerHTML = `Welcome back, <strong>${currentUser.displayName}</strong>! You're a ${personalityType.type}`;

        const userExperiences = DataLayer.load("userExperiences", []);
        const groups = DataLayer.load("groups", []);

        document.getElementById("dashboard-content").innerHTML = `
      <div style="margin-bottom: 2rem;">
        <h2>Your Social Energy Profile</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${personalityData.adjustmentFactor.toFixed(
          2
        )}</div>
            <div class="stat-label">Adjustment Factor</div>
          </div>
          <div class="stat-card" onclick="showExperiencesModal()" style="cursor: pointer;">
            <div class="stat-value">${userExperiences.length}</div>
            <div class="stat-label">Experiences</div>
          </div>
          <div class="stat-card" onclick="showPage('groups')" style="cursor: pointer;">
            <div class="stat-value">${groups.length}</div>
            <div class="stat-label">Groups</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${personalityType.type}</div>
            <div class="stat-label">Personality Type</div>
          </div>
        </div>
        <p style="font-style: italic; color: #666; margin: 1.5rem 0; text-align: center;">"${personalityType.description
          }"</p>
        <div class="action-buttons">
          <button class="btn" onclick="showPage('activities')"><i class="fas fa-plus-circle"></i> Add Experience</button>
          <button class="btn btn-secondary" onclick="showPage('feed')"><i class="fas fa-users"></i> Explore Community</button>
          <button class="btn btn-info" onclick="getLocationBasedRecommendations()" style="background: var(--info-color);">
            <i class="fas fa-map-marker-alt"></i> Find Places Near Me
          </button>
        </div>
      </div>

      ${RecommendationSystem.displayRecommendations()}
      ${SimilarUsersSystem.displaySimilarUsers()}
    `;
      }
    }

    function updateProfile() {
      const personalityData = DataLayer.load("personalityScore");
      const personalityType = DataLayer.load("personalityType");
      const userExperiences = DataLayer.load("userExperiences", []);
      const groups = DataLayer.load("groups", []);
      const currentUser = DataLayer.load("currentUser");

      const profileContent = document.getElementById("profile-content");

      if (!personalityData) {
        profileContent.innerHTML = `
      <div class="centered">
        <p style="padding: 1.2rem;">Complete the personality assessment to see your profile.</p>
        <button class="btn" onclick="showPage('assessment')">Take Assessment</button>
      </div>
    `;
        return;
      }

      const avgRating =
        userExperiences.length > 0
          ? userExperiences.reduce(
            (sum, exp) => sum + parseFloat(exp.adjustedScore),
            0
          ) / userExperiences.length
          : 0;

      // Get recommendations for profile
      const recommendations = ActivitySystem.getRecommendations(
        personalityData.adjustmentFactor
      );
      const unratedRecommendations = recommendations.filter(
        (rec) =>
          !userExperiences.some(
            (userExp) =>
              userExp.name.toLowerCase() === rec.experience.name.toLowerCase()
          )
      );

      // Get similar users
      const similarUsers = ActivitySystem.findSimilarUsers(
        personalityData.adjustmentFactor
      );

      profileContent.innerHTML = `
    <div class="user-info" style="margin-bottom: 2rem;">
      <div class="avatar" style="width: 80px; height: 80px; font-size: 2rem;">${currentUser.avatar
        }</div>
      <div>
        <h2 style="margin: 0;">${personalityType.type}</h2>
        <div style="color: var(--secondary-color); font-weight: bold; margin: 0.5rem 0;">Adjustment Factor: ${personalityData.adjustmentFactor.toFixed(
          2
        )}</div>
        <div style="color: #666; font-style: italic;">"${personalityType.description
        }"</div>
      </div>
    </div>

    <div class="location-info" style="margin-bottom: 2rem; padding: 1rem; background: rgba(74, 144, 226, 0.1); border-radius: 10px;">
      <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">
        <i class="fas fa-map-marker-alt"></i> Your Location
      </h4>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="flex: 1;">
          <div style="font-size: 0.9rem; color: #666;">
            ${currentUser.location ? 
              `Latitude: ${currentUser.location.lat.toFixed(4)}, Longitude: ${currentUser.location.lng.toFixed(4)}` : 
              'Location not set'
            }
          </div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 0.2rem;">
            This location is used for weather-based activity recommendations
          </div>
        </div>
        <button class="btn btn-secondary" onclick="updateUserLocation()" style="font-size: 0.8rem; padding: 8px 16px;">
          <i class="fas fa-location-arrow"></i> Update Location
        </button>
      </div>
    </div>

    <div class="stats-grid" style="margin-bottom: 2rem;">
      <div class="stat-card" onclick="showExperiencesModal()" style="cursor: pointer;">
        <div class="stat-value">${userExperiences.length}</div>
        <div class="stat-label">Experiences</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${avgRating > 0 ? avgRating.toFixed(1) : "0.0"
        }</div>
        <div class="stat-label">Avg Rating</div>
      </div>
      <div class="stat-card" onclick="showPage('groups')" style="cursor: pointer;">
        <div class="stat-value">${groups.length}</div>
        <div class="stat-label">Groups</div>
      </div>
      <div class="stat-card" onclick="getLocationBasedRecommendations()" style="cursor: pointer;">
        <div class="stat-value">${unratedRecommendations.length}</div>
        <div class="stat-label">New Recommendations</div>
      </div>
    </div>

    ${userExperiences.length > 0
          ? `
    <div class="card" style="margin-bottom: 2rem;">
      <h3>Your Experiences</h3>
      <div style="max-height: 400px; overflow-y: auto;">
        ${userExperiences
            .map(
              (exp) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #eee; border-radius: 10px; margin-bottom: 0.5rem;">
              <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 0.2rem;">${exp.name
                }</div>
                <div style="color: var(--secondary-color); font-size: 0.9rem; margin-bottom: 0.2rem;">${exp.category
                } • ${exp.location}</div>
                ${exp.description
                  ? `<div style="color: #666; font-size: 0.8rem; margin-bottom: 0.2rem;">"${exp.description}"</div>`
                  : ""
                }
                <div style="color: #888; font-size: 0.8rem;">
                  <span title="${formatFullDate(exp.timestamp)}" style="cursor: help;">
                    ${new Date(exp.timestamp).toLocaleDateString()}
                  </span> •
                  Social: ${exp.socialIntensity.toFixed(1)}/10 •
                  Noise: ${exp.noiseLevel.toFixed(1)}/10 •
                  Crowd: ${exp.crowdSize.toFixed(1)}/10
                </div>
              </div>
              <div style="text-align: right; margin-left: 1rem;">
                <div style="font-weight: bold; font-size: 1.3rem; color: var(--secondary-color);">${exp.adjustedScore
                }/10</div>
                <div style="font-size: 0.8rem; color: #888;">Raw: ${exp.rawScore
                }/10</div>
              </div>
            </div>
        `
            )
            .join("")}
      </div>
    </div>`
          : `
    <div class="card" style="margin-bottom: 2rem;">
      <h3>Your Experiences</h3>
      <div class="empty-state">
        <p>You haven't added any experiences yet.</p>
        <button class="btn" onclick="showPage('activities')">Add Your First Experience</button>
      </div>
    </div>`
        }

    <div class="card" style="margin-bottom: 2rem;">
      <h3>Personality Breakdown</h3>
      <div style="margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>Introversion</span>
          <span>Ambivert</span>
          <span>Extroversion</span>
        </div>
        <div style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; position: relative;">
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 100%; background: #ccc;"></div>
          <div style="width: ${((personalityData.adjustmentFactor + 1) / 2) * 100
        }%; height: 100%; background: var(--primary-gradient); border-radius: 10px; position: relative;">
            <div style="position: absolute; right: -10px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: white; border: 3px solid var(--secondary-color); border-radius: 50%;"></div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 0.5rem; font-weight: bold; color: var(--secondary-color);">
          ${personalityData.adjustmentFactor.toFixed(2)}
        </div>
      </div>
    </div>

            <div class="card" style="margin-bottom: 2rem;">
          <h3>Most Compatible Users</h3>
          <div class="similar-users-grid">
            ${similarUsers
          .slice(0, 3)
          .map(
            (sim) => `
                <div style="text-align: center; padding: 1rem; border: 1px solid #eee; border-radius: 10px;">
                  <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto 0.5rem;">
                    ${sim.user.avatar}
                  </div>
                  <div style="font-weight: bold; margin-bottom: 0.2rem;">${addCrownToPremiumUser(sim.user.displayName, sim.user.id)
              }</div>
                  <div style="font-size: 0.8rem; color: var(--secondary-color); margin-bottom: 0.3rem;">${sim.user.personalityType
              }</div>
                  <div style="font-size: 0.8rem; color: #4CAF50; font-weight: bold;">${(
                sim.similarity * 100
              ).toFixed(0)}% Match</div>
                    ${FriendsSystem.isFriend(sim.user.id)
                ? '<span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color); display: inline-block; margin-top: 0.5rem;">✓ Friend</span>'
                : `<button class="btn" style="margin-top: 0.5rem; font-size: 0.8rem; padding: 6px 12px;" onclick="FriendsSystem.addFriend(${sim.user.id})">Add Friend</button>`
              }
                </div>
            `
          )
          .join("")}
          </div>
        </div>

    <div class="action-buttons">
      <button class="btn" onclick="showPage('activities')"><i class="fas fa-plus-circle"></i> Add Experience</button>
      <button class="btn btn-secondary" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
      <button class="btn btn-secondary" onclick="showPage('groups')"><i class="fas fa-users"></i> Groups</button>
    </div>
  `;
    }

    // UI Management
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll(".page").forEach((page) => {
        page.classList.add("hidden");
      });

      // Update active navigation
      document.querySelectorAll(".nav-links a").forEach((link) => {
        link.classList.remove("active");
      });
      const navElement = document.getElementById(`nav-${pageId}`);
      if (navElement) {
        navElement.classList.add("active");
      }

      // Show selected page
      document.getElementById(pageId).classList.remove("hidden");

      // Page-specific initialization
      switch (pageId) {
        case "dashboard":
          updateDashboard();
          break;
        case "assessment":
          PersonalityAssessment.init();
          break;
        case "activities":
          if (!DataLayer.exists("personalityScore")) {
            NotificationSystem.show(
              "Please complete the personality assessment first!",
              "warning"
            );
            showPage("assessment");
            return;
          }
          // Initialize location functionality immediately
          setTimeout(() => {
            initializeLocationAutocomplete();
            // Prompt user for location permission if not already granted
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  console.log("Location permission granted");
                  // Pre-fill location field with current location
                  reverseGeocodeAndFillLocation(position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                  console.log("Location permission denied or unavailable:", error.message);
                  // Add 1 second delay before showing any notification
                  setTimeout(() => {
                    // Show a helpful message to the user
                    // NotificationSystem.show(
                    //   "Location access denied. You can still manually enter your location.",
                    //   "info"
                    // );
                  }, 1000);
                }
              );
            }
          }, 100);
          break;
        case "feed":
          FeedSystem.init();
          break;
        case "groups":
          GroupsSystem.init();
          // Also update usage display immediately
          setTimeout(() => {
            const usage = GroupsSystem.getGroupUsage();
            const usageText = document.getElementById("group-usage-text");
            const premiumStatusText = document.getElementById("premium-status-text");
            
            if (usageText) {
              usageText.textContent = `${usage.current}/${usage.limit}`;
              if (usage.isPremium) {
                usageText.style.background = "var(--primary-color)";
                usageText.style.color = "white";
              } else {
                usageText.style.background = "var(--primary-color)";
                usageText.style.color = "white";
              }
            }
            
            if (premiumStatusText) {
              if (usage.isPremium) {
                premiumStatusText.innerHTML = "Premium - Unlimited Groups";
              } else {
                premiumStatusText.innerHTML = '<a href="#" onclick="showPremiumUpgradeModal()" style="color: var(--secondary-color); text-decoration: none;">Upgrade to Premium for unlimited groups</a>';
              }
            }
          }, 50);
          break;
        case "profile":
          updateProfile();
          break;
      }
    }

    function nextQuestion() {
      PersonalityAssessment.currentQuestion++;

      if (
        PersonalityAssessment.currentQuestion >=
        PersonalityAssessment.questions.length
      ) {
        PersonalityAssessment.showResults();
      } else {
        PersonalityAssessment.displayQuestion();
        document.getElementById("next-btn").disabled = true;
      }
    }

    function completeAssessment() {
      showPage("dashboard");
    }

    function updateSliderValue(slider, targetId) {
      document.getElementById(targetId).textContent = slider.value;
    }

    function resetActivityForm() {
      document.getElementById("activity-form").reset();

      // Reset all sliders to 5
      ActivitySystem.ratingQuestions.forEach((question) => {
        const slider = document.getElementById(`rating-${question.id}`);
        const display = document.getElementById(`slider-${question.id}`);
        if (slider && display) {
          slider.value = 5;
          display.textContent = "5";
        }
      });
    }

    // Function to get location-based recommendations
    function getLocationBasedRecommendations() {
      locationFound = false; // Reset flag at start

      NotificationSystem.show("Getting your location for nearby recommendations...", "info");

      getUserLocationWithFallback()
        .then((position) => {
          locationFound = true; // Set flag when location is found
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          // Get all experiences from the community
          const allExperiences = ActivitySystem.getAllExperiences();
          const userExperiences = DataLayer.load("userExperiences", []);
          const friends = FriendsSystem.getFriends();
          const friendIds = friends.map(friend => friend.id);
          
          // Filter experiences that are within 50km of user's location
          const nearbyExperiences = allExperiences.filter(exp => {
            if (!exp.coordinates) return false;
            
            const distance = calculateDistance(lat, lng, exp.coordinates.lat, exp.coordinates.lng);
            return distance <= 50; // Within 50km
          });
          
          // Sort by distance and rating
          nearbyExperiences.sort((a, b) => {
            const distanceA = calculateDistance(lat, lng, a.coordinates.lat, a.coordinates.lng);
            const distanceB = calculateDistance(lat, lng, b.coordinates.lat, b.coordinates.lng);
            
            // Prioritize by rating first, then distance
            if (Math.abs(a.adjustedScore - b.adjustedScore) > 1) {
              return b.adjustedScore - a.adjustedScore; // Higher rating first
            }
            return distanceA - distanceB; // Closer distance first
          });
          
          // Get top 10 nearby experiences
          const topNearbyExperiences = nearbyExperiences.slice(0, 10);
          
          if (topNearbyExperiences.length === 0) {
            // No nearby experiences found
            const modalHtml = `
              <div id="nearby-modal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                  <button class="modal-close" onclick="closeNearbyModal()">&times;</button>
                  <div class="modal-header">
                    <h2><i class="fas fa-map-marker-alt"></i> Places Near You</h2>
                    <p style="margin: 0; color: #666;">Based on your current location</p>
                  </div>
                  <div class="modal-body">
                    <div style="text-align: center; padding: 3rem 1rem;">
                      <div style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;">📍</div>
                      <h3 style="color: #666; margin-bottom: 0.5rem;">No Nearby Experiences Yet</h3>
                      <p style="color: #888; margin-bottom: 2rem;">
                        No places have been rated by the community within 50km of your location. 
                        Be the first to share experiences in your area!
                      </p>
                      <button class="btn" onclick="closeNearbyModal(); showPage('activities');">
                        <i class="fas fa-plus-circle"></i> Add Your First Experience
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            document.body.insertAdjacentHTML("beforeend", modalHtml);
            addModalListeners("nearby-modal", closeNearbyModal);
            NotificationSystem.show("No nearby experiences found. Be the first to share!", "info");
            return;
          }
          
          // Create a modal to show nearby recommendations
          const modalHtml = `
            <div id="nearby-modal" class="modal">
              <div class="modal-content" style="max-width: 600px;">
                <button class="modal-close" onclick="closeNearbyModal()">&times;</button>
                <div class="modal-header">
                  <h2><i class="fas fa-map-marker-alt"></i> Places Near You</h2>
                  <p style="margin: 0; color: #666;">Rated by friends and community within 50km</p>
                </div>
                <div class="modal-body">
                  <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">
                      <i class="fas fa-info-circle"></i> 
                      Showing ${topNearbyExperiences.length} places rated by the community near your location.
                    </p>
                  </div>
                  
                  <div style="display: grid; gap: 1rem;">
                    ${topNearbyExperiences.map((exp, index) => {
                      const distance = calculateDistance(lat, lng, exp.coordinates.lat, exp.coordinates.lng);
                      const user = DemoUsers.users[exp.userId];
                      const isFriend = friendIds.includes(exp.userId);
                      const hasVisited = userExperiences.some(userExp => 
                        userExp.name.toLowerCase() === exp.name.toLowerCase()
                      );
                      
                      return `
                        <div style="border: 1px solid #eee; border-radius: 8px; padding: 1rem; background: white;">
                          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                              <div style="font-weight: bold; margin-bottom: 0.3rem; font-size: 1.1rem;">
                                ${exp.name} ${hasVisited ? '<span style="color: var(--primary-color);">✓ Visited</span>' : ''}
                              </div>
                              <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                                ${exp.category} • ${exp.location} • ${distance.toFixed(1)}km away
                              </div>
                              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.8rem;">
                                <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">
                                  ${user ? user.avatar : '?'}
                                </div>
                                <span>${addCrownToPremiumUser(user ? user.displayName : 'Unknown', exp.userId)}</span>
                                ${isFriend ? '<span style="color: var(--primary-color);">★</span>' : ''}
                                <span style="color: #888;">• Rated ${exp.adjustedScore}/10</span>
                              </div>
                              ${exp.description ? `<p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0; font-style: italic;">"${exp.description}"</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                              <div style="font-weight: bold; color: ${exp.adjustedScore >= 7 ? '#4CAF50' : exp.adjustedScore >= 5 ? '#FF9800' : '#f44336'}; font-size: 1.2rem;">
                                ${exp.adjustedScore}/10
                              </div>
                            </div>
                          </div>
                          <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn" style="font-size: 0.8rem; padding: 6px 12px; flex: 1;" 
                                    onclick="closeNearbyModal(); fillActivityForm('${exp.name}', '${exp.category}', '${exp.location}', 'Found through location-based search')">
                              Rate This Place
                            </button>
                                                         <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 6px 12px;" 
                                     data-user-id="${exp.userId}" data-experience-name="${exp.name}" onclick="closeNearbyModal(); showExperienceDetailsFromButton(this);">
                               View Details
                             </button>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                  
                  <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn" onclick="closeNearbyModal(); showPage('activities');">
                      <i class="fas fa-plus-circle"></i> Add Your Own Experience
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML("beforeend", modalHtml);
          
          // Add ESC and click-outside functionality
          addModalListeners("nearby-modal", closeNearbyModal);
          
          NotificationSystem.show(`Found ${topNearbyExperiences.length} nearby places rated by the community!`, "success");
        })
        .catch((error) => {
          console.error('Location error:', error);
          // Add 1 second delay before showing error
          setTimeout(() => {
            // Only show error if location wasn't found
            if (!locationFound) {
              let message = 'Unable to get your location: ';
              if (error.code) {
                switch(error.code) {
                  case error.PERMISSION_DENIED:
                    message += 'Please allow location access to find nearby places.';
                    break;
                  case error.POSITION_UNAVAILABLE:
                    message += 'Location information is unavailable.';
                    break;
                  case error.TIMEOUT:
                    message += 'Location request timed out.';
                    break;
                  default:
                    message += 'An unknown error occurred.';
                    break;
                }
              } else {
                message += error.message || 'An unknown error occurred.';
              }
              NotificationSystem.show(message, "error");
            }
          }, 1000);
        });
    }

    function closeNearbyModal() {
      const modal = document.getElementById("nearby-modal");
      if (modal) {
        modal.remove();
        // Remove any remaining event listeners
        document.removeEventListener('keydown', (event) => {
          if (event.key === 'Escape') closeNearbyModal();
        });
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    // Function to show detailed experience information
    function showExperienceDetails(userId, experienceName) {
      console.log('🔍 Looking for experience:', { userId, experienceName });
      
      // Find the experience in all experiences
      const allExperiences = ActivitySystem.getAllExperiences();
      console.log('🔍 All experiences:', allExperiences);
      
      // Try different matching strategies
      let experience = allExperiences.find(exp => 
        String(exp.userId) === String(userId) && exp.name === experienceName
      );
      
      // If not found, try partial name matching
      if (!experience) {
        experience = allExperiences.find(exp => 
          String(exp.userId) === String(userId) && 
          exp.name.toLowerCase().includes(experienceName.toLowerCase())
        );
      }
      
      // If still not found, try just by name
      if (!experience) {
        experience = allExperiences.find(exp => 
          exp.name === experienceName
        );
      }
      
      console.log('🔍 Found experience:', experience);
      
      if (!experience) {
        console.log('❌ Experience not found. Available experiences:', allExperiences.map(exp => ({ userId: exp.userId, name: exp.name })));
        NotificationSystem.show("Experience details not found.", "error");
        return;
      }

      const user = DemoUsers.users[userId];
      const friends = FriendsSystem.getFriends();
      const isFriend = friends.some(friend => friend.id === userId);
      
      // Map the experience data to the expected format
      const mappedExperience = {
        ...experience,
        energyLevel: experience.responses?.energy || 0,
        socialSatisfaction: experience.responses?.social || 0,
        comfortLevel: experience.responses?.comfort || 0,
        overwhelmLevel: experience.responses?.overwhelm || 0,
        returnLikelihood: experience.responses?.return || 0
      };
      
      // Calculate confidence based on rating consistency
      const ratings = [
        mappedExperience.energyLevel,
        mappedExperience.socialSatisfaction,
        mappedExperience.comfortLevel,
        mappedExperience.overwhelmLevel,
        mappedExperience.returnLikelihood
      ];
      
      const averageRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
      const variance = ratings.reduce((sum, rating) => sum + Math.pow(rating - averageRating, 2), 0) / ratings.length;
      const confidence = Math.max(0.1, Math.min(1.0, 1 - (variance / 25))); // Higher variance = lower confidence
      
      mappedExperience.confidence = confidence;
      
      const modalHtml = `
        <div id="experience-details-modal" class="modal">
          <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeExperienceDetailsModal()">&times;</button>
            <div class="modal-header">
              <h2><i class="fas fa-star"></i> Experience Details</h2>
              <p style="margin: 0; color: #666;">Detailed rating and experience information</p>
            </div>
            <div class="modal-body">
              <!-- User Info Section -->
              <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${user ? user.avatar : '?'}
                  </div>
                  <div>
                    <div style="font-weight: bold; font-size: 1.1rem;">
                      ${addCrownToPremiumUser(user ? user.displayName : 'Unknown', userId)}
                      ${isFriend ? '<span style="color: var(--primary-color);">★</span>' : ''}
                    </div>
                    <div style="font-size: 0.9rem; color: #666;">
                      ${user ? user.personalityType : 'Unknown Type'} • ${new Date(mappedExperience.timestamp).toLocaleDateString()}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Experience Basic Info -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h3 style="margin: 0 0 1rem 0; color: var(--primary-color);">${mappedExperience.name}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <strong>Category:</strong> ${mappedExperience.category}
                  </div>
                  <div>
                    <strong>Location:</strong> ${mappedExperience.location}
                  </div>
                  <div>
                    <strong>Overall Rating:</strong> 
                    <span style="font-weight: bold; color: ${mappedExperience.adjustedScore >= 7 ? '#4CAF50' : mappedExperience.adjustedScore >= 5 ? '#FF9800' : '#f44336'};">
                      ${mappedExperience.adjustedScore}/10
                    </span>
                  </div>
                  <div>
                    <strong>Confidence:</strong> ${(mappedExperience.confidence * 100).toFixed(0)}%
                  </div>
                </div>
                ${mappedExperience.description ? `
                  <div style="margin-top: 1rem; padding: 1rem; background: rgba(74, 144, 226, 0.05); border-radius: 8px;">
                    <strong>Description:</strong>
                    <p style="margin: 0.5rem 0 0 0; font-style: italic; color: #666;">"${mappedExperience.description}"</p>
                  </div>
                ` : ''}
              </div>

              <!-- Detailed Rating Breakdown -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                  <i class="fas fa-chart-bar"></i> Detailed Rating Breakdown
                </h4>
                
                <div style="display: grid; gap: 1rem;">
                  <!-- Energy Level -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Energy Level:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.energyLevel >= 7 ? '#4CAF50' : mappedExperience.energyLevel >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.energyLevel}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.energyLevel * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Social Satisfaction -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Social Satisfaction:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.socialSatisfaction >= 7 ? '#4CAF50' : mappedExperience.socialSatisfaction >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.socialSatisfaction}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.socialSatisfaction * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Comfort Level -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Comfort Level:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.comfortLevel >= 7 ? '#4CAF50' : mappedExperience.comfortLevel >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.comfortLevel}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.comfortLevel * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Overwhelm Level -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Overwhelm Level:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.overwhelmLevel >= 7 ? '#f44336' : mappedExperience.overwhelmLevel >= 5 ? '#FF9800' : '#4CAF50'};">
                        ${mappedExperience.overwhelmLevel}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.overwhelmLevel * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Return Likelihood -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Return Likelihood:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.returnLikelihood >= 7 ? '#4CAF50' : mappedExperience.returnLikelihood >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.returnLikelihood}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.returnLikelihood * 10}%;"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Environment Metrics -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                  <i class="fas fa-users"></i> Environment Metrics
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <strong>Social Intensity:</strong> ${mappedExperience.socialIntensity.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Noise Level:</strong> ${mappedExperience.noiseLevel.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Crowd Size:</strong> ${mappedExperience.crowdSize.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Activity Type:</strong> ${mappedExperience.activityType || 'Not specified'}
                  </div>
                </div>
              </div>

              <!-- Personality Adjustment -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                  <i class="fas fa-brain"></i> Personality Adjustment
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <strong>Raw Score:</strong> ${mappedExperience.rawScore.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Adjustment Factor:</strong> ${user ? user.adjustmentFactor.toFixed(2) : 'Unknown'}
                  </div>
                  <div>
                    <strong>Personality Type:</strong> ${user ? user.personalityType : 'Unknown'}
                  </div>
                  <div>
                    <strong>Adjusted Score:</strong> 
                    <span style="font-weight: bold; color: ${mappedExperience.adjustedScore >= 7 ? '#4CAF50' : mappedExperience.adjustedScore >= 5 ? '#FF9800' : '#f44336'};">
                      ${mappedExperience.adjustedScore}/10
                    </span>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" onclick="closeExperienceDetailsModal(); fillActivityForm('${mappedExperience.name}', '${mappedExperience.category}', '${mappedExperience.location}', 'Found through experience details')">
                  <i class="fas fa-star"></i> Rate This Place Too
                </button>
                <button class="btn btn-secondary" onclick="closeExperienceDetailsModal();">
                  <i class="fas fa-times"></i> Close
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML("beforeend", modalHtml);
      addModalListeners("experience-details-modal", closeExperienceDetailsModal);
    }

    function closeExperienceDetailsModal() {
      const modal = document.getElementById("experience-details-modal");
      if (modal) {
        modal.remove();
      }
      document.body.classList.remove('modal-open');
    }

    // Helper function to get experience details from button data attributes
    function showExperienceDetailsFromButton(button) {
      const userId = button.getAttribute('data-user-id');
      const experienceName = button.getAttribute('data-experience-name');
      showExperienceDetails(userId, experienceName);
    }

    // Function to use current location
    function useCurrentLocation() {
      locationFound = false; // Reset flag at start
      const locationInput = document.getElementById("activity-location");
      const useLocationBtn = document.getElementById("use-current-location-btn");
      
      if (!locationInput || !useLocationBtn) return;

      // Show loading state
      useLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
      useLocationBtn.disabled = true;

      getUserLocationWithFallback()
        .then((position) => {
          locationFound = true; // Set flag when location is found
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          // Use the reverse geocoding function
          reverseGeocodeAndFillLocation(lat, lng);
          
          // Reset button
          useLocationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use Current Location';
          useLocationBtn.disabled = false;
        })
        .catch((error) => {
          console.error('Error getting location:', error);
          // Add 1 second delay before showing error
          setTimeout(() => {
            // Only show error if location wasn't found
            if (!locationFound) {
              let message = 'Unable to get your location: ';
              if (error.code) {
                switch(error.code) {
                  case error.PERMISSION_DENIED:
                    message += 'Please allow location access in your browser settings.';
                    break;
                  case error.POSITION_UNAVAILABLE:
                    message += 'Location information is unavailable.';
                    break;
                  case error.TIMEOUT:
                    message += 'Location request timed out.';
                    break;
                  default:
                    message += 'An unknown error occurred.';
                    break;
                }
              } else {
                message += error.message || 'An unknown error occurred.';
              }
              
              NotificationSystem.show(message, "error");
              locationInput.value = "";
            }
          }, 1000);
          
          // Reset button
          useLocationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use Current Location';
          useLocationBtn.disabled = false;
        });
    }

    // Notification system
    // Global variable to track if location was successfully found
    let locationFound = false;

    // Helper function to get user location (with demo user fallback)
    async function getUserLocationWithFallback() {
      const currentUser = DataLayer.load("currentUser");
      console.log('📍 Current user for location:', currentUser);
      
      // If current user is a demo user, use their predefined location
      if (currentUser && currentUser.id && DemoUsers.users[currentUser.id]) {
        const demoUser = DemoUsers.users[currentUser.id];
        if (demoUser && demoUser.location) {
          console.log(`📍 Using demo user location for ${demoUser.displayName}:`, demoUser.location);
          return {
            coords: {
              latitude: demoUser.location.lat,
              longitude: demoUser.location.lng
            }
          };
        }
      }
      
      // If current user has a saved location, use that
      if (currentUser && currentUser.location) {
        console.log(`📍 Using saved location for ${currentUser.displayName}:`, currentUser.location);
        return {
          coords: {
            latitude: currentUser.location.lat,
            longitude: currentUser.location.lng
          }
        };
      }
      
      // Check if we're in a demo environment (no real user)
      if (!currentUser || !currentUser.id) {
        console.log(`📍 No current user found, using default Waterloo location`);
        return {
          coords: {
            latitude: 43.4643, // Waterloo University District
            longitude: -80.5204
          }
        };
      }
      
      // Otherwise, try to get real location
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error("Geolocation is not supported by this browser."));
          return;
        }
        
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000 // 5 minutes
        });
      });
    }
    
    const NotificationSystem = {
  show: (message, type = "info", duration = 3000) => {
    // Remove any existing notifications first
    const existingNotifications = document.querySelectorAll('[style*="position: fixed"][style*="bottom: 20px"][style*="right: 20px"]');
    existingNotifications.forEach(notification => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    });
    
    const notification = document.createElement("div");
    notification.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      z-index: 10000;
      transform: translateX(100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 350px;
      min-width: 280px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    `;

    // Set background and icon based on type
    let icon;
    let bgColor = "var(--background-alt-color)"
    
    switch (type) {
      case "success":
        notification.style.borderLeft = "4px solid #10b981";
        icon = `<svg width="20" height="20" fill="var(--success-color)" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>`;
        break;
      case "error":
        notification.style.borderLeft = "4px solid var(--error-color)";
        icon = `<svg width="20" height="20" fill="#ef4444" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>`;
        break;
      case "warning":
        notification.style.borderLeft = "4px solid var(--warning-color)";
        icon = `<svg width="20" height="20" fill="#f59e0b" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>`;
        break;
      default:
        notification.style.borderLeft = "4px solid #3b82f6";
        icon = `<svg width="20" height="20" fill="var(--info-color)" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>`;
    }

    notification.style.backgroundColor = bgColor;

    // Create icon element
    const iconEl = document.createElement("div");
    iconEl.innerHTML = icon;
    iconEl.style.cssText = `
      flex-shrink: 0;
      margin-top: 1px;
    `;

    // Create content container
    const contentEl = document.createElement("div");
    contentEl.style.cssText = `
      flex: 1;
      line-height: 1.5;
    `;

    // Create message element
    const messageEl = document.createElement("div");
    messageEl.innerHTML = message;
    messageEl.style.cssText = `
      color: var(--primary-color);
      font-weight: 500;
    `;

    // Create close button
    const closeBtn = document.createElement("button");
    closeBtn.innerHTML = `<svg width="16" height="16" fill="var(--muted-text-color)" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
    </svg>`;
    closeBtn.style.cssText = `
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      margin: -4px -4px -4px 4px;
      border-radius: 6px;
      transition: all 0.2s ease;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      
    `;

    // Add hover effect to close button
    closeBtn.addEventListener("mouseenter", () => {
      closeBtn.style.backgroundColor = "#f3f4f6";
      closeBtn.querySelector('svg').setAttribute('fill', '#6b7280');
    });
    closeBtn.addEventListener("mouseleave", () => {
      closeBtn.style.backgroundColor = "transparent";
      closeBtn.querySelector('svg').setAttribute('fill', '#9ca3af');
    });

    // Function to remove notification
    const removeNotification = () => {
      notification.style.transform = "translateX(100%)";
      notification.style.opacity = "0";
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    };

    // Close button click handler
    closeBtn.addEventListener("click", removeNotification);

    // Append elements
    contentEl.appendChild(messageEl);
    notification.appendChild(iconEl);
    notification.appendChild(contentEl);
    notification.appendChild(closeBtn);
    document.body.appendChild(notification);

    // Animate in
    requestAnimationFrame(() => {
      notification.style.transform = "translateX(0)";
      notification.style.opacity = "1";
    });

    // Auto-remove after duration
    const autoRemoveTimer = setTimeout(removeNotification, duration);

    // Clear timer if manually closed
    closeBtn.addEventListener("click", () => {
      clearTimeout(autoRemoveTimer);
    });

    // Add pause on hover
    notification.addEventListener("mouseenter", () => {
      clearTimeout(autoRemoveTimer);
    });

    notification.addEventListener("mouseleave", () => {
      setTimeout(removeNotification, 1000); // Give 1 second after mouse leave
    });
  },
};
    // Function to reverse geocode coordinates and fill location field
    function reverseGeocodeAndFillLocation(lat, lng) {
      const locationInput = document.getElementById("activity-location");
      if (!locationInput) return;

      // Show loading state
      locationInput.value = "Getting your location...";
      locationInput.disabled = true;

      // Use OpenStreetMap Nominatim for reverse geocoding (free service)
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`)
        .then(response => response.json())
        .then(data => {
          if (data.display_name) {
            // Extract city/area name from the full address
            const addressParts = data.display_name.split(', ');
            let locationName = addressParts[0]; // Start with the most specific part
            
            // Try to find a more meaningful location name
            if (addressParts.length > 1) {
              // Look for city, town, or district
              for (let i = 1; i < Math.min(4, addressParts.length); i++) {
                const part = addressParts[i];
                if (part.includes('City') || part.includes('Town') || part.includes('District') || 
                    part.includes('Neighborhood') || part.includes('Area')) {
                  locationName = part;
                  break;
                }
              }
            }
            
            locationInput.value = locationName;
            NotificationSystem.show(
              `Location detected: ${locationName}`,
              "success"
            );
          } else {
            locationInput.value = "Location detected (coordinates)";
          }
        })
        .catch(error => {
          console.error('Error reverse geocoding:', error);
          // Add 1 second delay before showing any error notification
          setTimeout(() => {
            // Could show error notification here if needed
          }, 1000);
          locationInput.value = "Location detected (coordinates)";
        })
        .finally(() => {
          locationInput.disabled = false;
        });
    }

    // Location autocomplete functionality
    function initializeLocationAutocomplete() {
  // Function to get user's current location
  function getCurrentLocation() {
    locationFound = false; // Reset flag at start
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error('Geolocation is not supported by this browser.'));
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          locationFound = true; // Set flag when location is found
          resolve({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        },
        (error) => {
          // Add 1 second delay before rejecting
          setTimeout(() => {
            // Only show error if location wasn't found
            if (!locationFound) {
          let message = 'Unable to retrieve location: ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              message += 'User denied the request for Geolocation.';
              break;
            case error.POSITION_UNAVAILABLE:
              message += 'Location information is unavailable.';
              break;
            case error.TIMEOUT:
              message += 'The request to get user location timed out.';
              break;
            default:
              message += 'An unknown error occurred.';
              break;
          }
          reject(new Error(message));
            }
          }, 1000);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000 // 5 minutes
        }
      );
    });
  }

  // Function to reverse geocode coordinates to address
  function reverseGeocode(lat, lng) {
    if (typeof google !== "undefined" && google.maps && google.maps.Geocoder) {
      const geocoder = new google.maps.Geocoder();
      return new Promise((resolve, reject) => {
        geocoder.geocode(
          { location: { lat: lat, lng: lng } },
          (results, status) => {
            if (status === 'OK' && results[0]) {
              resolve(results[0].formatted_address);
            } else {
              reject(new Error('Geocoder failed: ' + status));
            }
          }
        );
      });
    } else {
      // Fallback using a free geocoding service (OpenStreetMap Nominatim)
      return fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(response => response.json())
        .then(data => {
          if (data.display_name) {
            return data.display_name;
          } else {
            throw new Error('Unable to reverse geocode location');
          }
        });
    }
  }

  // Check if Google Maps API is available
  if (typeof google !== "undefined" && google.maps && google.maps.places) {
    const locationInput = document.getElementById("activity-location");
    if (locationInput) {
      // Set up autocomplete with bias towards user's location
      getCurrentLocation().then(userLocation => {
        const autocomplete = new google.maps.places.Autocomplete(
          locationInput,
          {
            types: ["establishment", "geocode"],
            fields: ["name", "formatted_address", "place_id"],
          }
        );

        // Bias results towards user's current location
        const circle = new google.maps.Circle({
          center: userLocation,
          radius: 50000 // 50km radius
        });
        autocomplete.setBounds(circle.getBounds());

        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (place.formatted_address) {
            locationInput.value = place.formatted_address;
          }
        });

        // Add a button or option to use current location
        const useCurrentLocationBtn = document.createElement("button");
        useCurrentLocationBtn.type = "button";
        useCurrentLocationBtn.textContent = "Use Current Location";
        useCurrentLocationBtn.style.cssText = `
          margin-left: 8px;
          padding: 8px 12px;
          background: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        `;
        
        useCurrentLocationBtn.addEventListener("click", async () => {
          try {
            useCurrentLocationBtn.textContent = "Getting location...";
            useCurrentLocationBtn.disabled = true;
            
            const location = await getCurrentLocation();
            const address = await reverseGeocode(location.lat, location.lng);
            locationInput.value = address;
            
            useCurrentLocationBtn.textContent = "Use Current Location";
            useCurrentLocationBtn.disabled = false;
          } catch (error) {
            console.error('Error getting current location:', error);
            alert(error.message);
            useCurrentLocationBtn.textContent = "Use Current Location";
            useCurrentLocationBtn.disabled = false;
          }
        });

        // Insert button after the input field
        locationInput.parentNode.insertBefore(useCurrentLocationBtn, locationInput.nextSibling);

      }).catch(error => {
        console.warn('Could not get user location for autocomplete bias:', error);
        
        // Set up autocomplete without location bias
        const autocomplete = new google.maps.places.Autocomplete(
          locationInput,
          {
            types: ["establishment", "geocode"],
            fields: ["name", "formatted_address", "place_id"],
          }
        );

        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (place.formatted_address) {
            locationInput.value = place.formatted_address;
          }
        });
      });
    }
  } else {
    // Fallback: Simple location suggestions with current location option
    const locationInput = document.getElementById("activity-location");
    if (locationInput) {
      const commonLocations = [
        "Use Current Location",
        "Downtown",
        "City Center",
        "University District",
        "Arts District",
        "Entertainment District",
        "Shopping District",
        "Financial District",
        "Old Town",
        "Midtown",
        "Uptown",
        "Suburbs",
        "Waterfront",
        "North Side",
        "South Side",
        "East Side",
        "West Side",
      ];

      locationInput.addEventListener("input", (e) => {
        const value = e.target.value.toLowerCase();
        if (value.length > 0) {
          const matches = commonLocations.filter((loc) =>
            loc.toLowerCase().includes(value)
          );

          // Create simple dropdown (basic implementation)
          let dropdown = document.getElementById("location-dropdown");
          if (dropdown) dropdown.remove();

          if (matches.length > 0 && matches.length < commonLocations.length) {
            dropdown = document.createElement("div");
            dropdown.id = "location-dropdown";
            dropdown.style.cssText = `
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              max-height: 200px;
              overflow-y: auto;
              z-index: 1000;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            `;

            matches.slice(0, 5).forEach((match) => {
              const option = document.createElement("div");
              option.style.cssText = `
                padding: 12px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
              `;
              option.textContent = match;
              option.addEventListener("mouseenter", () => {
                option.style.background = "#f5f5f5";
              });
              option.addEventListener("mouseleave", () => {
                option.style.background = "white";
              });
              option.addEventListener("click", async () => {
                if (match === "Use Current Location") {
                  try {
                    option.textContent = "Getting location...";
                    const location = await getCurrentLocation();
                    const address = await reverseGeocode(location.lat, location.lng);
                    locationInput.value = address;
                  } catch (error) {
                    console.error('Error getting current location:', error);
                    alert(error.message);
                    locationInput.value = "";
                  }
                } else {
                  locationInput.value = match;
                }
                dropdown.remove();
              });
              dropdown.appendChild(option);
            });

            locationInput.parentNode.style.position = "relative";
            locationInput.parentNode.appendChild(dropdown);
          }
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("location-dropdown");
        if (
          dropdown &&
          !locationInput.contains(e.target) &&
          !dropdown.contains(e.target)
        ) {
          dropdown.remove();
        }
      });
    }
  }
}
    // Initialize app
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize demo data in memory to make the app feel populated
      const demoExperiences = DemoUsers.experiences.map((exp) => ({
        ...exp,
      }));

      showPage("dashboard");
    });

    // Keyboard shortcuts for power users
    document.addEventListener("keydown", (event) => {
      // Escape to close modals
      if (event.key === "Escape") {
        // Check for experiences modals first
        const experiencesModal = document.getElementById("experiences-modal");
        const editExperienceModal = document.getElementById("edit-experience-modal");
        
        if (editExperienceModal) {
          closeEditExperienceModal();
        } else if (experiencesModal) {
          closeExperiencesModal();
        } else {
          // Check for AI modals and close them using their specific functions
          const aiPremiumModal = document.getElementById("ai-premium-modal");
          const aiAssistantModal = document.getElementById("ai-assistant-modal");
          const aiEditModal = document.getElementById("ai-edit-modal");
          
          if (aiPremiumModal) {
            closeAIPremiumModal();
          } else if (aiAssistantModal) {
            closeAIAssistantModal();
          } else if (aiEditModal) {
            // If there's a closeAIEditModal function, call it
            if (typeof closeAIEditModal === 'function') {
              closeAIEditModal();
            } else {
              aiEditModal.remove();
            }
          }
          
          // Also try the generic closeModal function as fallback
          if (typeof closeModal === 'function') {
            closeModal();
          }
        }
      }
      
      // Enter key to click appropriate buttons based on current page
      if (event.key === "Enter") {
        // Check which page is currently visible
        const allPages = document.querySelectorAll('.page');
        let currentPage = null;
        
        allPages.forEach(page => {
          if (!page.classList.contains("hidden")) {
            currentPage = page.id;
          }
        });
        
        // Handle different pages
        if (currentPage === "dashboard") {
          // Look for "Start Assessment" button on dashboard
          const startAssessmentBtn = document.querySelector('button[onclick="showPage(\'assessment\')"]');
          if (startAssessmentBtn && startAssessmentBtn.offsetParent !== null) {
            startAssessmentBtn.click();
          }
        } else if (currentPage === "profile") {
          // Look for "Take Assessment" button on profile
          const takeAssessmentBtn = document.querySelector('button[onclick="showPage(\'assessment\')"]');
          console.log('Profile page - Found assessment button:', takeAssessmentBtn);
          console.log('Button visible:', takeAssessmentBtn && takeAssessmentBtn.offsetParent !== null);
          
          if (takeAssessmentBtn && takeAssessmentBtn.offsetParent !== null) {
            takeAssessmentBtn.click();
          } else {
            // Fallback: look for any button with "Take Assessment" text
            const allButtons = document.querySelectorAll('button');
            const assessmentBtn = Array.from(allButtons).find(btn => 
              btn.textContent.includes('Take Assessment') && btn.offsetParent !== null
            );
            console.log('Fallback - Found assessment button:', assessmentBtn);
            if (assessmentBtn) {
              assessmentBtn.click();
            }
          }
        } else if (currentPage === "results") {
          // Look for "Continue to Dashboard" button on results page
          const continueBtn = document.querySelector('button[onclick="completeAssessment()"]');
          if (continueBtn && continueBtn.offsetParent !== null) {
            continueBtn.click();
          }
        }
      }
    });

    // Enhanced activity submission with notifications
    const EnhancedActivitySystem = {
      submitWithNotification: (event) => {
        try {
          ActivitySystem.submitNewExperience(event);
          NotificationSystem.show(
            "Experience added successfully!",
            "success"
          );
        } catch (error) {
          console.error("Failed to submit experience:", error);
          NotificationSystem.show(
            "Failed to add experience. Please try again.",
            "error"
          );
        }
      },
    };

    // Error handling wrapper
    function safeExecute(fn, errorMessage = "An error occurred") {
      try {
        return fn();
      } catch (error) {
        console.error(errorMessage, error);
        NotificationSystem.show(
          errorMessage + ". Please try again.",
          "error"
        );
        return null;
      }
    }

    // Data export functionality (for demo purposes)
    function exportUserData() {
      const userData = {
        personality: DataLayer.load("personalityScore"),
        personalityType: DataLayer.load("personalityType"),
        experiences: DataLayer.load("userExperiences", []),
        groups: DataLayer.load("groups", []),
        friends: DataLayer.load("friends", []),
        exportDate: new Date().toISOString(),
      };

      const dataStr = JSON.stringify(userData, null, 2);
      const dataBlob = new Blob([dataStr], { type: "application/json" });

      const link = document.createElement("a");
      link.href = URL.createObjectURL(dataBlob);
      link.download = "social-energy-data.json";
      link.click();
    }

    // Final initialization
    console.log("Social Energy App initialized successfully!");
    console.log("Use Alt+1-6 for quick navigation between pages");
    console.log("Demo includes:", {
      users: Object.keys(DemoUsers.users).length,
      experiences: DemoUsers.experiences.length,
      features: [
        "Personality Assessment",
        "Activity Tracking",
        "Social Feed",
        "Group Planning",
        "Personalized Recommendations",
      ],
    });
  </script>
</body>
</html>