<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Senergy</title>
  <link rel="icon" href="public/logo-icon-blue.png" type="image/png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="src/css/main.css" />
</head>

<body>
  <div class="container">
    <nav class="navbar">
      <div class="logo">
        <img src="public/logo-icon-blue.png" alt="Social Energy"
          style="width: 50px; height: 50px; border-radius: 6px" />
        Senergy
      </div>
      <ul class="nav-links">
        <li>
          <a href="#" onclick="showPage('dashboard')" id="nav-dashboard">Dashboard</a>
        </li>
        <li>
          <a href="#" onclick="showPage('assessment')" id="nav-assessment">Assessment</a>
        </li>
        <li>
          <a href="#" onclick="showPage('activities')" id="nav-activities">Add Experience</a>
        </li>
        <li>
          <a href="#" onclick="showPage('feed')" id="nav-feed">Community</a>
        </li>
        <li>
          <a href="#" onclick="showPage('groups')" id="nav-groups">Groups</a>
        </li>

        <li>
          <a href="#" onclick="showPage('profile')" id="nav-profile">Profile</a>
        </li>

      </ul>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page hidden">
      <div class="card">
        <div class="user-info">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <div class="welcome-text" id="welcome-message">
              Welcome! Take the personality assessment to get started.
            </div>
          </div>
        </div>

        <div id="dashboard-content" class="centered">
          <h2>Discover Your Perfect Social Experiences</h2>
          <p style="padding: 1.2rem">
            Find activities that match your energy preferences and connect
            with like-minded people.
          </p>
          <button class="btn" onclick="showPage('assessment')">
            <i class="fas fa-play-circle"></i> Start Assessment
          </button>
        </div>
      </div>
    </div>

    <!-- Personality Assessment Page -->
    <div id="assessment" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Personality Assessment</h2>
          <p>
            Answer these questions to help us understand your social energy
            preferences.
          </p>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
          <div class="progress-info">
            <span id="progress-text">Question 1 of 10</span>
            <span>Understanding your energy</span>
          </div>
        </div>

        <div id="question-container">
          <!-- Questions will be dynamically inserted here -->
        </div>

        <div class="centered">
          <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>
            Next Question <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Assessment Results -->
    <div id="results" class="page hidden">
      <div class="card">
        <div class="personality-result">
          <h2>Your Personality Profile</h2>
          <div class="personality-score" id="personality-score">0.0</div>
          <div class="personality-type" id="personality-type">Ambivert</div>
          <p class="personality-description" id="personality-description">
            You have a balanced approach to social energy.
          </p>
          <button class="btn" onclick="completeAssessment()">
            <i class="fas fa-tachometer-alt"></i> Continue to Dashboard
          </button>
        </div>
      </div>
    </div>

    <!-- Activities Page -->
    <div id="activities" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Add Your Experience</h2>
          <p>
            Share a recent social experience and rate how it affected your
            energy levels.
          </p>
        </div>

        <form id="activity-form" onsubmit="ActivitySystem.submitNewExperience(event)">
          <div class="form-group">
            <label for="activity-name"><i class="fas fa-map-marker-alt"></i> Place/Activity Name
              *</label>
            <input type="text" id="activity-name" class="form-control"
              placeholder="e.g., The Coffee Bean, Central Park, Downtown Nightclub" required />
          </div>

          <div class="form-group">
            <label for="activity-category"><i class="fas fa-tag"></i> Category *</label>
            <select id="activity-category" class="form-control" required>
              <option value="">Select category...</option>
              <option value="Restaurant">Restaurant</option>
              <option value="Bar/Pub">Bar/Pub</option>
              <option value="Nightclub">Nightclub</option>
              <option value="Cafe">Cafe</option>
              <option value="Park/Outdoor">Park/Outdoor</option>
              <option value="Museum/Gallery">Museum/Gallery</option>
              <option value="Shopping">Shopping</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Sports/Fitness">Sports/Fitness</option>
              <option value="Library/Study">Library/Study</option>
              <option value="Event/Party">Event/Party</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="activity-location"><i class="fas fa-location-dot"></i> Location *</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="text" id="activity-location" class="form-control" required
                placeholder="e.g., Downtown, Brooklyn, Central Mall" style="flex: 1;" />
              <button type="button" id="use-current-location-btn" class="btn btn-secondary"
                style="white-space: nowrap; padding: 14px 16px; font-size: 0.9rem;" onclick="useCurrentLocation()">
                <i class="fas fa-crosshairs"></i> Use Current Location
              </button>
            </div>
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
              <i class="fas fa-info-circle"></i> We'll use your location to provide better recommendations and help
              others find places near you.
            </div>
          </div>

          <div class="form-group">
            <label for="activity-description"><i class="fas fa-align-left"></i> Description (Optional)</label>
            <textarea id="activity-description" class="form-control"
              placeholder="Describe the atmosphere, what you did, who you were with..."></textarea>
          </div>

          <div class="form-group">
            <label><i class="fas fa-star"></i> Rate Your Experience:</label>
            <div class="rating-questions" id="new-activity-rating">
              <div class="rating-question">
                <label>How energized did you feel?</label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-energy')" id="rating-energy" />
                <div class="slider-value" id="slider-energy">5</div>
              </div>
              <div class="rating-question">
                <label>How satisfied were you with the social interaction?
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-social')" id="rating-social" />
                <div class="slider-value" id="slider-social">5</div>
              </div>
              <div class="rating-question">
                <label>How comfortable did you feel in this environment?
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-comfort')" id="rating-comfort" />
                <div class="slider-value" id="slider-comfort">5</div>
              </div>
              <div class="rating-question">
                <label>How overwhelming was the environment? (Rate higher if it felt more overwhelming)
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-overwhelm')" id="rating-overwhelm" />
                <div class="slider-value" id="slider-overwhelm">5</div>
              </div>
              <div class="rating-question">
                <label>How likely are you to return? </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-return')" id="rating-return" />
                <div class="slider-value" id="slider-return">5</div>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button type="submit" class="btn">
              <i class="fas fa-plus-circle"></i> Add Experience
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetActivityForm()">
              <i class="fas fa-eraser"></i> Clear Form
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Community Feed Page -->
    <div id="feed" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Community</h2>
          <p>
            Discover activities and connect with people in your community.
          </p>
        </div>

        <!-- Community Navigation Tabs -->
        <div class="community-nav-tabs">
          <button class="btn active" onclick="CommunitySystem.showSection('activities')" id="activities-tab">
            <i class="fas fa-star"></i> Activities
          </button>
          <button class="btn btn-secondary" onclick="CommunitySystem.showSection('friendship')" id="friendship-tab"
            style="position: relative;">
            <i class="fas fa-users"></i> Friendship
            <span id="friend-request-badge" style="
              display: none;
              background: #ff4757;
              color: white;
              border-radius: 50%;
              width: 25px;
              height: 25px;
              font-size: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: absolute;
              top: -8px;
              right: -8px;
              font-weight: bold;
              border: 2px solid white;
            ">0</span>
          </button>
        </div>

        <!-- Activities Section -->
        <div id="activities-section" class="community-section">
          <div class="search-box">
            <input type="text" class="search-input" id="feed-search"
              placeholder="Search activities, places, or users..." onkeyup="FeedSystem.filterFeed()" />
            <span class="search-icon"><i class="fas fa-search"></i></span>
          </div>

          <div class="filter-container">
            <div class="filter-dropdown">
              <button class="filter-dropdown-btn" onclick="toggleFilterDropdown('activities-filter')">
                <span id="activities-filter-text">All Activities</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="filter-dropdown-menu" id="activities-filter-menu">
                <div class="filter-dropdown-item active"
                  onclick="selectFilter('activities', 'all', 'All Activities', this)">
                  <i class="fas fa-list"></i> All Activities
                </div>
                <div class="filter-dropdown-item"
                  onclick="selectFilter('activities', 'similar', 'Similar Users', this)">
                  <i class="fas fa-users"></i> Similar Users
                </div>
                <div class="filter-dropdown-item" onclick="selectFilter('activities', 'high-rated', 'Top Rated', this)">
                  <i class="fas fa-star"></i> Top Rated
                </div>
                <div class="filter-dropdown-item" onclick="selectFilter('activities', 'recent', 'Recent', this)">
                  <i class="fas fa-clock"></i> Recent
                </div>
                <div class="filter-dropdown-item" onclick="selectFilter('activities', 'nearby', 'Near Me', this)">
                  <i class="fas fa-map-marker-alt"></i> Near Me
                </div>
              </div>
            </div>
          </div>

          <div id="feed-content">
            <!-- Feed items will be dynamically inserted here -->
          </div>

          <!-- Load More Button -->
          <div id="load-more-container" style="text-align: center; margin-top: 2rem; display: none;">
            <button id="load-more-btn" class="btn btn-secondary" onclick="FeedSystem.loadNextPage()">
              <i class="fas fa-plus"></i> Load More Activities
            </button>
          </div>
        </div>

        <!-- Friendship Section -->
        <div id="friendship-section" class="community-section" style="display: none;">
          <div class="search-box">
            <input type="text" class="search-input" id="friendship-search"
              placeholder="Search users by name, username, or personality type..."
              onkeyup="FriendsDiscoverySystem.filterUsers()" />
            <span class="search-icon"><i class="fas fa-search"></i></span>
          </div>

          <div class="filter-container">
            <div class="filter-dropdown">
              <button class="filter-dropdown-btn" onclick="toggleFilterDropdown('friendship-filter')">
                <span id="friendship-filter-text">All Users</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="filter-dropdown-menu" id="friendship-filter-menu">
                <div class="filter-dropdown-item active" onclick="selectFilter('friendship', 'all', 'All Users', this)">
                  <i class="fas fa-users"></i> All Users
                </div>
                <div class="filter-dropdown-item"
                  onclick="selectFilter('friendship', 'similar', 'Similar to You', this)">
                  <i class="fas fa-user-friends"></i> Similar to You
                </div>
                <div class="filter-dropdown-item" onclick="selectFilter('friendship', 'friends', 'My Friends', this)">
                  <i class="fas fa-heart"></i> My Friends
                </div>
                <div class="filter-dropdown-item"
                  onclick="selectFilter('friendship', 'requests', 'Friend Requests', this)">
                  <i class="fas fa-user-plus"></i> Friend Requests
                </div>
              </div>
            </div>
          </div>

          <div id="friendship-content">
            <!-- Friendship content will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Groups Page -->
    <div id="groups" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Group Planning</h2>
          <p>
            Create groups with friends and find activities that work for
            everyone's energy preferences.
          </p>
        </div>

        <div class="centered">
          <button class="btn" onclick="showCreateGroupModal()" id="create-group-btn">
            <i class="fas fa-users"></i> Create New Group
          </button>
        </div>

        <!-- Group Usage Display -->
        <div id="group-usage-display" style="
          background: rgba(74, 144, 226, 0.1); 
          padding: 1rem; 
          border-radius: 10px; 
          margin: 1rem 0; 
          text-align: center;
        ">
          <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-users" style="color: var(--secondary-color);"></i>
              <span style="font-weight: bold;">Groups This Month:</span>
              <span id="group-usage-text" style="
                background: var(--primary-color); 
                color: white; 
                padding: 0.2rem 0.6rem; 
                border-radius: 12px; 
                font-size: 0.9rem;
              ">Loading...</span>
            </div>
            <div id="premium-status-display" style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-crown" style="color: #FFD700;"></i>
              <span id="premium-status-text" style="font-size: 0.9rem; color: #666;">Loading...</span>
            </div>
          </div>
        </div>

        <div id="groups-content">
          <!-- Groups will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- Login Page -->
    <div id="login" class="page">
      <div id="login-content">
        <!-- Professional Minimalistic Login Flow -->
        <div id="login-form-container" class="auth-container">
          <div class="auth-header">
            <h2>Welcome back</h2>
            <p>Sign in to your account to continue</p>
          </div>

          <!-- Step 1: Email Input -->
          <div id="login-step-1" class="auth-step">
            <div class="form-group">
              <input type="email" id="login-email" class="auth-input" placeholder="Email address" required>
            </div>

            <button type="button" class="auth-btn-primary" onclick="handleEmailContinue()">
              Continue
            </button>

            <div class="auth-divider">
              <span>or</span>
            </div>

            <div class="oauth-buttons">
              <button type="button" class="oauth-btn google-btn" onclick="handleGoogleSignIn()">
                <svg width="18" height="18" viewBox="0 0 24 24">
                  <path fill="#4285F4"
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                  <path fill="#34A853"
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                  <path fill="#FBBC05"
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                  <path fill="#EA4335"
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Google
              </button>

              <button type="button" class="oauth-btn github-btn" onclick="handleGitHubSignIn()">
                <svg width="18" height="18" viewBox="0 0 24 24">
                  <path fill="currentColor"
                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                </svg>
                GitHub
              </button>
            </div>

            <div class="auth-footer">
              <p>Don't have an account? <a href="#" onclick="showRegisterForm()">Sign up</a></p>
            </div>
          </div>

          <!-- Step 2: Password Input -->
          <div id="login-step-2" class="auth-step" style="display: none;">
            <div class="auth-back">
              <button type="button" class="back-btn" onclick="backToEmailStep()">
                <i class="fas fa-arrow-left"></i>
              </button>
              <div class="back-info">
                <span id="login-email-display"></span>
              </div>
            </div>

            <div class="form-group">
              <div class="password-input-wrapper">
                <input type="password" id="login-password" class="auth-input" placeholder="Password" required>
                <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('login-password')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>

            <button type="button" class="auth-btn-primary" onclick="handlePasswordContinue()">
              Sign in
            </button>

            <div class="auth-footer">
              <p><a href="#" onclick="showForgotPassword()">Forgot your password?</a></p>
            </div>
          </div>

          <!-- Forgot Password Form -->
          <div id="forgot-password-container" class="auth-container" style="display: none;">
            <div class="auth-header">
              <h2>Reset your password</h2>
              <p>Enter your email address and we'll send you a link to reset your password</p>
            </div>

            <div class="auth-back">
              <button type="button" class="back-btn" onclick="backToLoginStep()">
                <i class="fas fa-arrow-left"></i>
              </button>
              <div class="back-info">
                <span>Back to sign in</span>
              </div>
            </div>

            <div style="margin-bottom: 1rem;">
              <label for="forgot-email"
                style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color);">Email</label>
              <input type="email" id="forgot-email" class="auth-input" placeholder="Enter your email address" required
                onkeypress="handleForgotPasswordKeyPress(event)">
            </div>

            <button type="button" class="auth-btn-primary" onclick="handleForgotPassword()">
              Send reset link
            </button>

            <div class="auth-footer">
              <p>Remember your password? <a href="#" onclick="backToLoginStep()">Sign in</a></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Register Form -->
      <div id="register-form-container" class="auth-container" style="display: none;">
        <div class="auth-header">
          <h2>Create account</h2>
          <p>Join Senergy to start your journey</p>
        </div>

        <form id="register-form" onsubmit="event.preventDefault();">
          <!-- First Name and Last Name side by side -->
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <label for="register-firstName"
                style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color);">First
                name</label>
              <input type="text" id="register-firstName" class="auth-input" placeholder="Your first name" required
                onkeypress="handleRegisterKeyPress(event)">
            </div>
            <div style="flex: 1;">
              <label for="register-lastName"
                style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color);">Last
                name</label>
              <input type="text" id="register-lastName" class="auth-input" placeholder="Your last name" required
                onkeypress="handleRegisterKeyPress(event)">
            </div>
          </div>

          <!-- Email field -->
          <div style="margin-bottom: 1rem;">
            <label for="register-email"
              style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color);">Email</label>
            <input type="email" id="register-email" class="auth-input" placeholder="Your email address" required
              onkeypress="handleRegisterKeyPress(event)">
          </div>

          <!-- Continue button -->
          <button type="button" class="auth-btn-primary" onclick="handleRegisterContinue()">
            Continue
          </button>

          <!-- OR separator -->
          <div class="auth-divider">
            <span>OR</span>
          </div>

          <!-- Social login buttons -->
          <div class="oauth-buttons">
            <button type="button" class="oauth-btn google-btn" onclick="handleGoogleSignIn()">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                <path fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                <path fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                <path fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
              </svg>
              Google
            </button>

            <button type="button" class="oauth-btn github-btn" onclick="handleGitHubSignIn()">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path fill="currentColor"
                  d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
              </svg>
              GitHub
            </button>
          </div>

          <div class="auth-footer">
            <p>Already have an account? <a href="#" onclick="showLoginForm()">Sign in</a></p>
          </div>
        </form>

        <!-- Password Step (hidden initially) -->
        <div id="register-password-step" class="auth-container" style="display: none;">
          <div class="auth-back">
            <button type="button" class="back-btn" onclick="backToRegisterStep()">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="back-info">
              <span id="register-email-display"></span>
            </div>
          </div>

          <div style="margin-bottom: 1rem;">
            <label for="register-password"
              style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color);">Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="register-password" class="auth-input" placeholder="Create a password" required
                minlength="6" onkeypress="handleRegisterPasswordKeyPress(event)"
                oninput="checkPasswordStrength(this.value)">
              <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('register-password')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="password-strength">
              <div class="password-strength-bar">
                <div class="password-strength-fill" id="password-strength-fill"></div>
              </div>
              <div class="password-strength-text" id="password-strength-text">Password strength</div>
            </div>
          </div>

          <button type="button" class="auth-btn-primary" onclick="handleRegisterPasswordContinue()">
            Continue
          </button>

          <div class="auth-footer">
            <p>Already have an account? <a href="#" onclick="showLoginForm()">Sign in</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Friends Page -->
  <div id="friends" class="page hidden">
    <div class="card">
      <div class="card-header">
        <h2>Friends & Discovery</h2>
        <p>Connect with other users and discover people with similar social energy preferences.</p>
      </div>

      <div class="search-box">
        <input type="text" class="search-input" id="friends-search"
          placeholder="Search users by name, username, or personality type..."
          onkeyup="FriendsDiscoverySystem.filterUsers()" />
        <span class="search-icon"><i class="fas fa-search"></i></span>
      </div>

      <div class="filter-tabs">
        <button class="filter-tab active" onclick="FriendsDiscoverySystem.setFilter('all')">
          All Users
        </button>
        <button class="filter-tab" onclick="FriendsDiscoverySystem.setFilter('similar')">
          Similar to You
        </button>
        <button class="filter-tab" onclick="FriendsDiscoverySystem.setFilter('friends')">
          My Friends
        </button>
        <button class="filter-tab" onclick="FriendsDiscoverySystem.setFilter('requests')">
          Friend Requests
        </button>
      </div>

      <div id="friends-content">
        <!-- Friends and user discovery content will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <!-- Profile Page -->
  <div id="profile" class="page hidden">
    <div class="card">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Your Profile</h2>
        <button class="btn btn-danger" onclick="handleLogout()" style="font-size: 0.9rem; padding: 8px 16px;">
          <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
      </div>
      <div id="profile-content">
        <!-- Profile content will be dynamically inserted here -->
      </div>
    </div>
  </div>
  </div>
  <!-- JavaScript remains unchanged -->
  <script type="module">

    
    import DataLayer from './src/js/back-end/Data/DataLayer.js';
    import GroupsSystem from './src/js/back-end/System/GroupsSystem.js';

    import {FirebaseWriteLogger, wrapWrite, wrapRead} from './src/js/back-end/Logging.js';
    import {showPage,nextQuestion, updateNavigationVisibility} from './src/js/front-end/UIManagement.js';
    import { getAuthManager, getUserManager, getFriendsManager } from './src/js/back-end/firebase/initFirebase.js';

   
   
    // Filter dropdown functionality
    function toggleFilterDropdown(filterId) {
      const menu = document.getElementById(filterId + '-menu');
      const btn = document.querySelector(`[onclick="toggleFilterDropdown('${filterId}')"]`);

      // Close all other dropdowns
      document.querySelectorAll('.filter-dropdown-menu').forEach(m => {
        if (m !== menu) {
          m.classList.remove('show');
          m.previousElementSibling.classList.remove('active');
        }
      });

      // Toggle current dropdown
      menu.classList.toggle('show');
      btn.classList.toggle('active');
    }

    function selectFilter(type, filter, text, clickedElement) {
      // Update button text
      const textElement = document.getElementById(type + '-filter-text');
      if (textElement) {
        textElement.textContent = text;
      }

      // Update active state
      const menu = document.getElementById(type + '-filter-menu');
      menu.querySelectorAll('.filter-dropdown-item').forEach(item => {
        item.classList.remove('active');
      });

      // Use the passed element or fallback to event.target
      const targetElement = clickedElement || (typeof event !== 'undefined' ? event.target : null);
      if (targetElement) {
        const dropdownItem = targetElement.closest('.filter-dropdown-item');
        if (dropdownItem) {
          dropdownItem.classList.add('active');
        }
      }

      // Close dropdown
      menu.classList.remove('show');
      menu.previousElementSibling.classList.remove('active');

      // Call appropriate filter function
      if (type === 'activities') {
        if (typeof FeedSystem !== 'undefined' && FeedSystem.setFilter) {
          FeedSystem.setFilter(filter);
        }
      } else if (type === 'friendship') {
        if (typeof FriendsDiscoverySystem !== 'undefined' && FriendsDiscoverySystem.setFilter) {
          FriendsDiscoverySystem.setFilter(filter);
        }
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function (event) {
      if (!event.target.closest('.filter-dropdown')) {
        document.querySelectorAll('.filter-dropdown-menu').forEach(menu => {
          menu.classList.remove('show');
        });
        document.querySelectorAll('.filter-dropdown-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      }
    });

    // Function to handle rating a place from the community feed
    function ratePlace(name, category, location, description) {
      // Pre-fill the activity form
      document.getElementById("activity-name").value = name;
      document.getElementById("activity-category").value = category;
      document.getElementById("activity-location").value = location;
      document.getElementById("activity-description").value = description;

      // Switch to the activities page
      showPage("activities");

      // Scroll to the form
      document
        .getElementById("activity-form")
        .scrollIntoView({ behavior: "smooth" });
    }

    // Function to edit user's own experience
    function editUserExperience(experienceId) {
      // Find the experience in user's experiences
      const userExperiences = DataLayer.load("userExperiences", []);

      // Debug logging
      console.log('🔍 Looking for experience with ID:', experienceId);
      console.log('🔍 Available experiences:', userExperiences.map(exp => ({ id: exp.id, name: exp.name })));

      // Try multiple ways to find the experience
      let experience = userExperiences.find(exp => exp.id === experienceId || exp.name === experienceId);

      // If not found, try string comparison for IDs
      if (!experience) {
        experience = userExperiences.find(exp => String(exp.id) === String(experienceId) || exp.name === experienceId);
      }

      // If still not found, try to find by name if the ID looks like a timestamp
      if (!experience && !isNaN(experienceId)) {
        // The ID might be a timestamp, try to find by name from the experience card
        const experienceCard = document.querySelector(`[onclick*="editUserExperience('${experienceId}')"]`);
        if (experienceCard) {
          const nameElement = experienceCard.querySelector('h3');
          if (nameElement) {
            const name = nameElement.textContent.split('✓')[0].trim();
            experience = userExperiences.find(exp => exp.name === name);
          }
        }
      }

      if (experience) {
        console.log('✅ Found experience:', experience);

        // Find the index of the experience in the array
        const experienceIndex = userExperiences.findIndex(exp => exp.id === experience.id);

        if (experienceIndex !== -1) {
          // Use the existing editExperience function to open the edit modal
          editExperience(experienceIndex);
        } else {
          console.error('❌ Could not find experience index');
          NotificationSystem.show('Error: Could not find experience to edit.', 'error');
        }
      } else {
        console.error('❌ Experience not found with ID:', experienceId);
        console.error('❌ Available experiences:', userExperiences.map(exp => ({ id: exp.id, name: exp.name })));

        // Try to provide more helpful error message
        const experienceCard = document.querySelector(`[onclick*="editUserExperience('${experienceId}')"]`);
        if (experienceCard) {
          const nameElement = experienceCard.querySelector('h3');
          if (nameElement) {
            const name = nameElement.textContent.split('✓')[0].trim();
            NotificationSystem.show(`Experience "${name}" not found in your saved experiences. It may have been deleted or you may need to refresh the page.`, 'error');
          } else {
            NotificationSystem.show('Experience not found. Please try refreshing the page.', 'error');
          }
        } else {
          NotificationSystem.show('Experience not found. Please try refreshing the page.', 'error');
        }
      }
    }

    
   
    // Personality assessment system
    const PersonalityAssessment = {
      questions: [
        { text: "Large parties energize me", weight: 3 },
        {
          text: "I prefer quiet, intimate gatherings",
          weight: 3,
          reverse: true,
        },
        {
          text: "I need alone time after social events",
          weight: 2,
          reverse: true,
        },
        { text: "I'm comfortable being the center of attention", weight: 2 },
        {
          text: "I prefer deep conversations over small talk",
          weight: 2,
          reverse: true,
        },
        { text: "I enjoy spontaneous social activities", weight: 1 },
        { text: "I recharge by being around people", weight: 3 },
        { text: "I think out loud when making decisions", weight: 1 },
        { text: "I'm energized by new social environments", weight: 2 },
        { text: "I prefer working in teams vs alone", weight: 1 },
      ],

      // questions: [
      //   { text: "Large parties energize me", weight: 3 },
      // ],

      currentQuestion: 0,
      responses: [],

      init: () => {
        PersonalityAssessment.currentQuestion = 0;
        PersonalityAssessment.responses = [];
        PersonalityAssessment.displayQuestion();

        // Add keyboard event listener for assessment navigation
        document.addEventListener("keydown", PersonalityAssessment.handleKeyboard);
      },

      displayQuestion: () => {
        const container = document.getElementById("question-container");
        const question =
          PersonalityAssessment.questions[
          PersonalityAssessment.currentQuestion
          ];

        container.innerHTML = `
      <div class="question-container">
        <div class="question-text">${question.text}</div>
        <div class="scale-labels">
          <span>Strongly Disagree</span>
          <span>Strongly Agree</span>
        </div>
        <div class="radio-group">
          ${[1, 2, 3, 4, 5]
            .map(
              (value) => `
              <div class="radio-item" onclick="document.getElementById('q${value}').click()">
                <input type="radio" name="question" value="${value}" id="q${value}" onchange="PersonalityAssessment.selectAnswer(${value})">
                <label for="q${value}">${value}</label>
              </div>
            `
            )
            .join("")}
        </div>
      </div>
    `;

        // Update progress
        const progress =
          ((PersonalityAssessment.currentQuestion + 1) /
            PersonalityAssessment.questions.length) *
          100;
        document.getElementById("progress-fill").style.width = `${progress}%`;
        document.getElementById("progress-text").textContent = `Question ${PersonalityAssessment.currentQuestion + 1
          } of ${PersonalityAssessment.questions.length}`;
      },

      selectAnswer: (value) => {
        PersonalityAssessment.responses[
          PersonalityAssessment.currentQuestion
        ] = value;
        document.getElementById("next-btn").disabled = false;
      },

      handleKeyboard: (event) => {
        // Only handle keyboard events if we're on the assessment page
        if (document.getElementById("assessment").classList.contains("hidden")) {
          return;
        }

        const key = event.key;

        // Handle number keys 1-5 for radio button selection
        if (key >= "1" && key <= "5") {
          const value = parseInt(key);
          document.getElementById(`q${value}`).click();
          PersonalityAssessment.selectAnswer(value);
        }

        // Handle Enter key for next button
        if (key === "Enter") {
          const nextBtn = document.getElementById("next-btn");
          if (!nextBtn.disabled) {
            nextQuestion();
          }
        }
      },

      calculateScore: () => {
        let weightedSum = 0;
        let totalWeight = 0;

        PersonalityAssessment.questions.forEach((question, index) => {
          let response = PersonalityAssessment.responses[index];
          if (question.reverse) {
            response = 6 - response;
          }
          weightedSum += response * question.weight;
          totalWeight += question.weight;
        });

        const rawScore = weightedSum / totalWeight;
        const adjustmentFactor = Math.max(
          -1,
          Math.min(1, (rawScore - 2.5) / 2.5)
        );

        return {
          rawScore,
          adjustmentFactor,
        };
      },

      getPersonalityType: (adjustmentFactor) => {
        if (adjustmentFactor <= -0.6)
          return {
            type: "Strong Introvert",
            description:
              "You recharge through solitude and prefer quieter, more intimate social settings.",
          };
        if (adjustmentFactor <= -0.2)
          return {
            type: "Moderate Introvert",
            description:
              "You enjoy social interaction but need quiet time to recharge your energy.",
          };
        if (adjustmentFactor <= 0.2)
          return {
            type: "Ambivert",
            description:
              "You have a balanced approach to social energy and can adapt to various situations.",
          };
        if (adjustmentFactor <= 0.6)
          return {
            type: "Moderate Extrovert",
            description:
              "You're energized by social interaction and enjoy group activities.",
          };
        return {
          type: "Strong Extrovert",
          description:
            "You thrive in social situations and gain energy from being around others.",
        };
      },

      showResults: async () => {
        const scores = PersonalityAssessment.calculateScore();
        const personality = PersonalityAssessment.getPersonalityType(
          scores.adjustmentFactor
        );

        document.getElementById("personality-score").textContent =
          scores.adjustmentFactor.toFixed(1);
        document.getElementById("personality-type").textContent =
          personality.type;
        document.getElementById("personality-description").textContent =
          personality.description;

        // Save results locally
        DataLayer.save("personalityScore", scores);
        DataLayer.save("personalityType", personality);

        console.log('Personality assessment completed:', {
          scores,
          personality,
          currentUser: getCurrentUser()?.uid
        });

        // Force reload the data to ensure it's available
        const reloadedScores = DataLayer.load("personalityScore");
        const reloadedType = DataLayer.load("personalityType");
        console.log('Reloaded data:', { reloadedScores, reloadedType });

        // Update current user locally
        let currentUser = DataLayer.load("currentUser");
        if (!currentUser) {
          currentUser = {
            id: "user-main",
            username: "you",
            displayName: "You",
          };
        }

        currentUser.adjustmentFactor = scores.adjustmentFactor;
        currentUser.personalityType = personality.type;
        currentUser.avatar = personality.type.charAt(0);

        // Save to Firebase if user is authenticated
        if (getCurrentUser() && getAuthManager()) {
          try {
            const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

            await wrapWrite(
              updateDoc(doc(getAuthManager().db, 'users', getCurrentUser().uid), {
                adjustmentFactor: scores.adjustmentFactor,
                personalityType: personality.type,
                avatar: personality.type.charAt(0),
                updatedAt: serverTimestamp()
              }),
              'updateDoc',
              `users/${getCurrentUser().uid}`,
              { adjustmentFactor: scores.adjustmentFactor, personalityType: personality.type }
            );

            console.log('Personality assessment saved to Firebase');
          } catch (error) {
            console.error('Error saving personality assessment to Firebase:', error);
          }
        }

        // Try to get user's actual location if geolocation is available
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              currentUser.location = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              DataLayer.save("currentUser", currentUser);

              // Save location to Firebase if user is authenticated
              if (getCurrentUser() && getAuthManager()) {
                try {
                  const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

                  await wrapWrite(
                    updateDoc(doc(getAuthManager().db, 'users', getCurrentUser().uid), {
                      location: {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                      },
                      updatedAt: serverTimestamp()
                    }),
                    'updateDoc',
                    `users/${getCurrentUser().uid}`,
                    { location: { lat: position.coords.latitude, lng: position.coords.longitude } }
                  );
                } catch (error) {
                  console.error('Error saving location to Firebase:', error);
                }
              }
            },
            (error) => {
              console.log("Could not get user location:", error.message);
              // Don't set a default location - let user update manually
            }
          );
        }

        DataLayer.save("currentUser", currentUser);

        // Remove the assessment tab completely
        const assessmentTab = document.querySelector(
          "li:has([onclick=\"showPage('assessment')\"])"
        );
        if (assessmentTab) {
          assessmentTab.remove();
        }

        showPage("results");
      },
    };

    
    // Helper functions for edit modal
    function closeEditModal() {
      console.log('Closing edit modal');
      const modal = document.getElementById("edit-group-modal");
      if (modal) {
        console.log('Modal found, removing with animation');
        modal.style.animation = "fadeOut 0.3s ease forwards";
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
            console.log('Modal removed from DOM');
          }
        }, 300);
      } else {
        console.log('Modal not found');
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function handleEditModalBackdropClick(event) {
      console.log('Modal backdrop clicked:', event.target);
      if (event.target.classList.contains('modal')) {
        console.log('Closing edit modal via backdrop click');
        closeEditModal();
      }
    }

    async function handleEditGroup(event, groupId) {
      event.preventDefault();

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      const name = document.getElementById("edit-group-name").value.trim();
      const description = document
        .getElementById("edit-group-description")
        .value.trim();

      // Update basic info
      groups[groupIndex].name = name;
      groups[groupIndex].description = description;

      // Update members
      const currentUser = DataLayer.load("currentUser");
      const personalityData = DataLayer.load("personalityScore");

      let newMembers = [
        {
          userId: currentUser.id,
          displayName: currentUser.displayName,
          personalityType: currentUser.personalityType,
          adjustmentFactor: personalityData.adjustmentFactor,
          avatar: currentUser.avatar,
          importance: 1.0,
        },
      ];

      // Keep existing members that are checked
      groups[groupIndex].members.forEach((member) => {
        if (member.userId !== currentUser.id) {
          const keepCheckbox = document.getElementById(
            `keep-member-${member.userId}`
          );
          if (keepCheckbox && keepCheckbox.checked) {
            newMembers.push(member);
          }
        }
      });

      // Add new members that are checked
      const friends = FriendsSystem.getFriends();
      friends.forEach((friend) => {
        const addCheckbox = document.getElementById(
          `add-member-${friend.id}`
        );
        if (addCheckbox && addCheckbox.checked) {
          newMembers.push({
            userId: friend.id,
            displayName: friend.displayName,
            personalityType: friend.personalityType,
            adjustmentFactor: friend.adjustmentFactor,
            avatar: friend.avatar,
            importance: 1.0,
          });
        }
      });

      groups[groupIndex].members = newMembers;
      DataLayer.save("groups", groups);

      // Save to Firebase
      try {
        const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        await updateDoc(doc(getAuthManager().db, 'groups', groupId), {
          name: name,
          description: description,
          members: newMembers.map(m => m.userId),
          memberDetails: newMembers,
          updatedAt: serverTimestamp()
        });
        console.log('Group updated in Firebase');
      } catch (error) {
        console.error('Error updating group in Firebase:', error);
      }

      closeEditModal();
      GroupsSystem.displayGroups();
      NotificationSystem.show("Group updated successfully!", "success");
    }
   
   
    
    // Function to format date with full month name
    function formatFullDate(dateString) {
      const date = new Date(dateString);
      const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      const month = months[date.getMonth()];
      const day = date.getDate();
      const year = date.getFullYear();
      return `${month} ${day}, ${year}`;
    }

    // Helper function to add ESC and click-outside functionality to modals
    function addModalListeners(modalId, closeFunction) {
      // Prevent body scrolling when modal opens
      document.body.classList.add('modal-open');

      // Add ESC key listener
      const handleEscKey = (event) => {
        if (event.key === 'Escape') {
          closeFunction();
          document.removeEventListener('keydown', handleEscKey);
        }
      };
      document.addEventListener('keydown', handleEscKey);

      // Add click outside to close
      const modal = document.getElementById(modalId);
      if (modal) {
        // Simple click outside detection
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeFunction();
            document.removeEventListener('keydown', handleEscKey);
          }
        });
      }
    }

    
    
   
    // Feed System
   
    // Weather API integration for activity recommendations
    const WeatherSystem = {
      // Get weather data for a specific location and date
      async getWeatherData(lat, lng, date) {
        try {
          console.log(`🌤️ Fetching weather for: lat=${lat}, lng=${lng}, date=${date}`);
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&timezone=auto&start_date=${date}&end_date=${date}`;
          console.log(`🌤️ Weather API URL: ${url}`);

          const response = await fetch(url);
          console.log(`🌤️ Weather API response status: ${response.status}`);

          if (!response.ok) {
            throw new Error(`Weather API responded with status: ${response.status}`);
          }

          const data = await response.json();
          console.log(`🌤️ Weather API response data:`, data);

          if (data.daily && data.daily.time && data.daily.time.length > 0) {
            const index = 0; // First (and only) day

            // Validate that all required fields exist
            if (data.daily.temperature_2m_max &&
              data.daily.temperature_2m_min &&
              data.daily.precipitation_probability_max &&
              data.daily.weathercode) {

              const weatherData = {
                maxTemp: data.daily.temperature_2m_max[index],
                minTemp: data.daily.temperature_2m_min[index],
                precipitation: data.daily.precipitation_probability_max[index],
                weatherCode: data.daily.weathercode[index],
                date: data.daily.time[index]
              };
              console.log(`🌤️ Parsed weather data:`, weatherData);
              return weatherData;
            } else {
              console.log(`🌤️ Missing required weather fields in API response`);
              return null;
            }
          }
          console.log(`🌤️ No weather data found in response`);
          return null;
        } catch (error) {
          console.error('🌤️ Error fetching weather data from Open-Meteo:', error);
        }
      },

      // Get weather for multiple days
      async getWeatherForDays(lat, lng, dates) {
        try {
          console.log(`🌤️ Getting weather for ${dates.length} days`);
          const weatherPromises = dates.map(date => this.getWeatherData(lat, lng, date));
          const results = await Promise.all(weatherPromises);
          console.log(`🌤️ Weather results:`, results);

          // Filter out null results and ensure we have valid data
          const validResults = results.filter(result => result !== null);
          console.log(`🌤️ Valid weather results:`, validResults);

          return validResults;
        } catch (error) {
          console.error(`🌤️ Error getting weather for multiple days:`, error);
          return [];
        }
      },

      // Get weather description from WMO code
      getWeatherDescription(code) {
        const weatherCodes = {
          0: "Clear sky",
          1: "Mainly clear",
          2: "Partly cloudy",
          3: "Overcast",
          45: "Foggy",
          48: "Depositing rime fog",
          51: "Light drizzle",
          53: "Moderate drizzle",
          55: "Dense drizzle",
          56: "Light freezing drizzle",
          57: "Dense freezing drizzle",
          61: "Slight rain",
          63: "Moderate rain",
          65: "Heavy rain",
          66: "Light freezing rain",
          67: "Heavy freezing rain",
          71: "Slight snow",
          73: "Moderate snow",
          75: "Heavy snow",
          77: "Snow grains",
          80: "Slight rain showers",
          81: "Moderate rain showers",
          82: "Violent rain showers",
          85: "Slight snow showers",
          86: "Heavy snow showers",
          95: "Thunderstorm",
          96: "Thunderstorm with slight hail",
          99: "Thunderstorm with heavy hail"
        };
        return weatherCodes[code] || "Unknown";
      },

      // Get activity weather suitability score (0-10)
      getActivityWeatherScore(activity, weather) {
        if (!weather) return 5; // Neutral if no weather data

        const activityType = activity.category?.toLowerCase() || '';
        const temp = (weather.maxTemp + weather.minTemp) / 2;
        const precipitation = weather.precipitation;
        const isRainy = weather.weatherCode >= 51 && weather.weatherCode <= 67;
        const isSnowy = weather.weatherCode >= 71 && weather.weatherCode <= 86;
        const isStormy = weather.weatherCode >= 95;

        let score = 5; // Base score

        // Temperature considerations
        if (activityType.includes('outdoor') || activityType.includes('park') || activityType.includes('hiking')) {
          if (temp >= 15 && temp <= 25) score += 3; // Perfect outdoor weather
          else if (temp >= 10 && temp <= 30) score += 1; // Acceptable
          else score -= 2; // Too hot/cold
        }

        // Precipitation considerations
        if (activityType.includes('outdoor') || activityType.includes('park') || activityType.includes('hiking')) {
          if (precipitation < 20) score += 3; // Low chance of rain - clear weather bonus
          else if (precipitation < 50) score += 0; // Moderate chance
          else score -= 3; // High chance of rain
        }

        // Indoor activities are less affected by weather
        if (activityType.includes('indoor') || activityType.includes('museum') || activityType.includes('cafe') || activityType.includes('restaurant')) {
          // Indoor activities are neutral to weather - no bonus for rain
          score += 0; // Neutral
        }

        // General weather bonuses/penalties
        if (precipitation < 20 && !isRainy && !isSnowy) score += 2; // Strong bonus for clear weather
        if (isRainy) score -= 1; // Penalty for rainy weather
        if (isStormy) score -= 2;
        if (temp < -10 || temp > 35) score -= 1;

        return Math.max(0, Math.min(10, score)); // Clamp between 0-10
      },

      // Get best weather day from multiple options
      async getBestWeatherDay(lat, lng, dates, activities) {
        // Validate that we have dates to process
        if (!dates || dates.length === 0) {
          console.error(`🌤️ No dates provided to getBestWeatherDay`);
          return null;
        }

        const weatherData = await this.getWeatherForDays(lat, lng, dates);
        const scores = [];

        for (let i = 0; i < dates.length; i++) {
          const weather = weatherData[i];

          // Skip if no weather data for this day
          if (!weather) {
            continue;
          }

          let dayScore = 0;

          // Calculate average weather score for all activities
          for (const activity of activities) {
            dayScore += this.getActivityWeatherScore(activity, weather);
          }

          const finalScore = dayScore / activities.length;

          // Ensure the date is one of the input dates
          if (!dates.includes(dates[i])) {
            console.error(`🌤️ Date ${dates[i]} is not in input dates:`, dates);
            continue;
          }

          scores.push({
            date: dates[i],
            weather: weather,
            score: finalScore,
            weatherDescription: weather ? this.getWeatherDescription(weather.weatherCode) : 'Unknown'
          });
        }

        // Check if we have any valid scores
        if (scores.length === 0) {
          console.log(`🌤️ No valid weather scores found`);
          return null;
        }

        // Find the best day
        const bestDay = scores.reduce((best, current) =>
          current.score > best.score ? current : best
        );



        // Validate bestDay has weather data
        if (!bestDay || !bestDay.weather) {
          console.log(`🌤️ Best day has no weather data`);
          return null;
        }

        // Ensure the selected date is one of the input dates
        if (!dates.includes(bestDay.date)) {
          console.error(`🌤️ Selected date ${bestDay.date} is not in input dates:`, dates);
          return null;
        }

        // Generate reason for selection
        const temp = (bestDay.weather.maxTemp + bestDay.weather.minTemp) / 2;
        const precipitation = bestDay.weather.precipitation;
        const weatherCode = bestDay.weather.weatherCode;

        let reason = '';

        // Temperature-based reasoning
        if (temp >= 15 && temp <= 25) {
          reason += 'Perfect temperature for outdoor activities';
        } else if (temp >= 10 && temp <= 30) {
          reason += 'Comfortable temperature range';
        } else if (temp < 10) {
          reason += 'Cooler weather, good for indoor activities';
        } else {
          reason += 'Warm weather, suitable for various activities';
        }

        // Precipitation-based reasoning
        if (precipitation < 20) {
          reason += ' with very low chance of rain';
        } else if (precipitation < 50) {
          reason += ' with moderate weather conditions';
        } else {
          reason += ' despite higher precipitation chance';
        }

        // Weather condition reasoning
        if (weatherCode >= 0 && weatherCode <= 3) {
          reason += '. Clear to partly cloudy skies provide ideal conditions.';
        } else if (weatherCode >= 51 && weatherCode <= 67) {
          reason += '. Rainy weather is perfect for indoor activities.';
        } else if (weatherCode >= 71 && weatherCode <= 86) {
          reason += '. Snowy conditions are great for winter activities.';
        } else {
          reason += '. Weather conditions are suitable for your planned activities.';
        }

        return {
          ...bestDay,
          reason: reason
        };
      }
    };

    // AI Itinerary Generator
    const AIItineraryGenerator = {
      generateItinerary: async (groupData, tripDetails) => {
        const prompt = `You are an expert trip planner. Based on the following group information and trip details, create a detailed day-by-day itinerary.

Group Information:
- Group Name: ${groupData.name}
- Group Description: ${groupData.description}
- Group Size: ${groupData.members.length} people
- Members and their personality types:
${groupData.members
            .map(
              (member) =>
                `  • ${addCrownToPremiumUser(member.displayName, member.userId)}: ${member.personalityType} (Adjustment Factor: ${member.adjustmentFactor})`
            )
            .join("\n")}

Trip Details:
- Duration: ${tripDetails.duration} days
- Location: ${tripDetails.location}
- Budget Level: ${tripDetails.budget}
- Interests: ${tripDetails.interests}
- Special Requirements: ${tripDetails.requirements || "None"}

Based on the group's personality mix and preferences, create EXACTLY ${tripDetails.duration} days (no more, no less) that balances social activities for extroverts and quieter experiences for introverts. 

IMPORTANT SCHEDULING RULES:
1. Account for travel time between activities (typically 15-45 minutes depending on distance)
2. If an activity takes 2 hours and starts at 9:00 AM, the next activity should start no earlier than 11:30 AM (2 hours + 30 minutes travel time)
3. Include realistic travel times in the duration field
4. Don't schedule activities too close together - allow buffer time for travel and preparation
5. Consider opening hours and peak times for venues

Include specific venue suggestions, timing, and explain why each activity suits the group's energy levels.

Return your response in the following JSON format:
{
  "overview": "Brief overview of the itinerary approach",
  "tripDetails": {
    "duration": ${tripDetails.duration},
    "location": "${tripDetails.location}",
    "budget": "${tripDetails.budget}",
    "interests": "${tripDetails.interests}",
    "requirements": "${tripDetails.requirements || ""}"
  },
  "days": [
    {
      "day": 1,
      "theme": "Day theme",
      "activities": [
        {
          "time": "9:00 AM",
          "activity": "Activity name",
          "location": "Venue/Location",
          "duration": "2 hours",
          "description": "Brief description",
          "energyLevel": "low/medium/high",
          "socialIntensity": "low/medium/high",
          "whyThisWorks": "Explanation for this group"
        }
      ]
    }
  ],
  "tips": ["Tip 1", "Tip 2", "Tip 3"]
}

IMPORTANT: Create exactly ${tripDetails.duration} days in the "days" array, numbered from 1 to ${tripDetails.duration}.

Only return the JSON, no additional text.`;

        try {
          const payload = {
            messages: [{ role: "user", content: prompt }],
          };

          const response = await fetch(
            "https://ai.hackclub.com/chat/completions",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          const content = data.choices[0].message.content;

          // Clean and parse the response - handle <think> tags and code blocks
          let cleanedContent = content
            .replace(/```json\n?|\n?```/g, "")
            .trim();

          // Remove <think> tags and everything before the first {
          if (cleanedContent.includes("<think>")) {
            const jsonStart = cleanedContent.indexOf("{");
            if (jsonStart !== -1) {
              cleanedContent = cleanedContent.substring(jsonStart);
            }
          }

          // Remove any trailing </think> or similar tags
          const jsonEnd = cleanedContent.lastIndexOf("}");
          if (jsonEnd !== -1) {
            cleanedContent = cleanedContent.substring(0, jsonEnd + 1);
          }

          return JSON.parse(cleanedContent);
        } catch (error) {
          console.error("AI Itinerary Generation Error:", error);
          throw new Error("Failed to generate itinerary. Please try again.");
        }
      },
    };


    function showAIPremiumModal(groupId) {
      if (!AI_PREMIUM_ENABLED) {
        NotificationSystem.show(
          "Premium features are currently disabled.",
          "warning"
        );
        return;
      }

      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      const currentUser = DataLayer.load("currentUser");

      // Check if all group members have premium access
      const allMembersHavePremium = group.members.every(member => {
        if (member.userId === currentUser.id) {
          return currentUser.isPremium;
        } else {
          // Demo users removed - Firebase only
          return false;
        }
      });

      // Check if any members have premium access
      const anyMembersHavePremium = group.members.some(member => {
        if (member.userId === currentUser.id) {
          return currentUser.isPremium;
        } else {
          // Demo users removed - Firebase only
          return false;
        }
      });

      // If no members have premium, show upgrade modal
      if (!anyMembersHavePremium) {
        showPremiumUpgradeModal();
        return;
      }

      // If not all members have premium, show upgrade modal
      if (!allMembersHavePremium) {
        showPremiumUpgradeModal();
        return;
      }

      const modalHtml = `
    <div id="ai-premium-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeAIPremiumModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-robot"></i> AI Premium Trip Planner
          </h2>
          <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">
            PREMIUM
          </div>
        </div>
        <div class="modal-body">
          <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);">✨ AI-Powered Group Itinerary</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #666;">
              Our AI will analyze your group's personality types and create a personalized day-by-day itinerary 
              that balances everyone's energy preferences and interests.
            </p>
          </div>

          <form id="ai-trip-form" onsubmit="generateAIItinerary(event, ${groupId})">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group">
                <label for="trip-duration">Trip Duration *</label>
                <select id="trip-duration" class="form-control" required onchange="handleTripDurationChange()">
                  <option value="">Select duration</option>
                  <option value="1">1 Day</option>
                  <option value="2">2 Days</option>
                  <option value="3">3 Days</option>
                  <option value="4">4 Days</option>
                  <option value="5">5 Days</option>
                  <option value="7">1 Week</option>
                  <option value="custom">Custom Duration</option>
                </select>
                <input type="number" id="custom-duration" class="form-control" 
                       placeholder="Enter number of days" min="1" max="30" 
                       style="display: none; margin-top: 0.5rem;">
              </div>
              <div class="form-group">
                <label for="trip-budget">Budget Level *</label>
                <select id="trip-budget" class="form-control" required>
                  <option value="">Select budget</option>
                  <option value="budget">Budget-Friendly</option>
                  <option value="moderate">Moderate</option>
                  <option value="premium">Premium</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="trip-location">Location/City *</label>
              <input type="text" id="trip-location" class="form-control" 
                     placeholder="e.g., New York City, Paris, Tokyo" required>
            </div>

            <div class="form-group">
              <label for="trip-interests">Group Interests *</label>
              <textarea id="trip-interests" class="form-control" rows="3" 
                        placeholder="e.g., museums, nightlife, food tours, outdoor activities, shopping, historical sites..." required></textarea>
            </div>

            <div class="form-group">
              <label for="trip-requirements">Special Requirements (Optional)</label>
              <textarea id="trip-requirements" class="form-control" rows="2" 
                        placeholder="e.g., dietary restrictions, accessibility needs, transportation preferences..."></textarea>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 12px 24px;">
                <i class="fas fa-magic"></i> Generate AI Itinerary
              </button>
              <button type="button" class="btn btn-secondary" onclick="closeAIPremiumModal()">Cancel</button>
            </div>
          </form>

          <div id="ai-loading" class="ai-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>AI is crafting your perfect itinerary...</p>
          </div>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // Prevent body scrolling when modal is open
      document.body.classList.add('modal-open');

      // Add ESC and click-outside functionality
      addModalListeners("ai-premium-modal", closeAIPremiumModal);
    }

    function closeAIPremiumModal() {
      const modal = document.getElementById("ai-premium-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function handleTripDurationChange() {
      const durationSelect = document.getElementById("trip-duration");
      const customDurationInput = document.getElementById("custom-duration");

      if (durationSelect.value === "custom") {
        customDurationInput.style.display = "block";
        customDurationInput.required = true;
      } else {
        customDurationInput.style.display = "none";
        customDurationInput.required = false;
      }
    }

    async function generateAIItinerary(event, groupId) {
      event.preventDefault();

      let duration = document.getElementById("trip-duration").value;
      if (duration === "custom") {
        duration = document.getElementById("custom-duration").value;
        if (!duration || duration < 1 || duration > 30) {
          NotificationSystem.show("Please enter a valid custom duration (1-30 days)", "error");
          return;
        }
      }
      const budget = document.getElementById("trip-budget").value;
      const location = document.getElementById("trip-location").value;
      const interests = document.getElementById("trip-interests").value;
      const requirements = document.getElementById("trip-requirements").value;

      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      // Show loading state
      document.getElementById("ai-trip-form").style.display = "none";
      document.getElementById("ai-loading").style.display = "block";

      const tripDetails = {
        duration,
        budget,
        location,
        interests,
        requirements,
      };

      // Retry logic - try up to 3 times
      let lastError = null;
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          console.log(`AI Itinerary generation attempt ${attempt}/3`);

          const itinerary = await AIItineraryGenerator.generateItinerary(
            group,
            tripDetails
          );

          // Save itinerary to group
          const groupIndex = groups.findIndex((g) => g.id === groupId);
          if (groupIndex !== -1) {
            groups[groupIndex].aiItinerary = {
              ...itinerary,
              tripDetails,
              generatedAt: new Date().toISOString(),
            };
            DataLayer.save("groups", groups);

            // Save to Firebase
            try {
              const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              await wrapWrite(
                updateDoc(doc(getAuthManager().db, 'groups', groupId), {
                  aiItinerary: {
                    ...itinerary,
                    tripDetails,
                    generatedAt: serverTimestamp()
                  },
                  updatedAt: serverTimestamp()
                }),
                'updateDoc',
                `groups/${groupId}`,
                { aiItinerary: true }
              );
              console.log('AI Itinerary saved to Firebase');
            } catch (error) {
              console.error('Error saving AI itinerary to Firebase:', error);
            }
          }

          closeAIPremiumModal();
          GroupsSystem.displayGroups();
          NotificationSystem.show(
            "AI Itinerary generated successfully!",
            "success"
          );

          // Scroll to the group with the new itinerary
          setTimeout(() => {
            const groupCard = document.querySelector(
              `[data-group-id="${groupId}"]`
            );
            if (groupCard) {
              groupCard.scrollIntoView({ behavior: "smooth" });
            }
          }, 500);

          return; // Success - exit the function

        } catch (error) {
          console.error(`AI Itinerary generation attempt ${attempt}/3 failed:`, error);
          lastError = error;

          // If this is not the last attempt, wait a bit before retrying
          if (attempt < 3) {
            console.log(`Retrying in 2 seconds...`);
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
        }
      }

      // All attempts failed
      console.error("All AI Itinerary generation attempts failed:", lastError);
      NotificationSystem.show(
        "Failed to generate itinerary after 3 attempts. Please try again later.",
        "error"
      );

      // Reset form
      document.getElementById("ai-loading").style.display = "none";
      document.getElementById("ai-trip-form").style.display = "block";
    }

    function renderAIItinerary(group) {
      if (!group.aiItinerary) return "";

      const itinerary = group.aiItinerary;

      return `
    <div class="ai-itinerary-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(31, 59, 115, 0.05) 0%, rgba(74, 144, 226, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(31, 59, 115, 0.2);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <h4 style="margin: 0; color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-robot"></i> AI Generated Itinerary
        </h4>
        <button class="btn btn-secondary" onclick="GroupsSystem.saveItineraryToFirebase('${group.id}')" style="font-size: 0.8rem; padding: 6px 12px;">
          <i class="fas fa-save"></i> Save
        </button>
      </div>
      
      <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; font-size: 0.8rem;">
          <div><strong>Duration:</strong> ${itinerary.tripDetails.duration} days</div>
          <div><strong>Location:</strong> ${itinerary.tripDetails.location.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ')}</div>
          <div><strong>Budget:</strong> ${itinerary.tripDetails.budget.charAt(0).toUpperCase() + itinerary.tripDetails.budget.slice(1).toLowerCase()}</div>
        </div>
      </div>

      <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
        <p style="margin: 0; font-style: italic; color: #666; font-size: 0.9rem;">${itinerary.overview
        }</p>
      </div>

      <div class="itinerary-timeline" style="position: relative;">
        ${itinerary.days
          .map(
            (day, index) => `
          <div class="day-card" style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid var(--secondary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <div style="width: 40px; height: 40px; background: var(--primary-gradient); color: var(--inverted-text-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${day.day}
              </div>
              <div>
                <h5 style="margin: 0; color: #333;">Day ${day.day}</h5>
                <div style="color: var(--secondary-color); font-weight: bold; font-size: 0.9rem;">${day.theme
              }</div>
              </div>
            </div>
            
            <div class="activities-list">
              ${day.activities
                .map(
                  (activity, activityIndex) => `
    <div class="activity-item" style="display: flex; gap: 1rem; padding: 1rem; background: rgba(31, 59, 115, 0.05); border-radius: 8px; margin-bottom: 0.8rem; position: relative;">
      <div style="width: 60px; text-align: center; font-weight: bold; color: var(--secondary-color); flex-shrink: 0;">
        ${activity.time}
      </div>
      <div style="flex: 1;">
        <div style="font-weight: bold; margin-bottom: 0.3rem;">${activity.activity
                    }</div>
        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.3rem;">
          📍 ${activity.location} • ⏱️ ${activity.duration}
        </div>
        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">${activity.description
                    }</div>
        <div style="display: flex; gap: 1rem; font-size: 0.7rem;">
          <span style="background: ${activity.energyLevel === "high"
                      ? "#ff6b6b"
                      : activity.energyLevel === "medium"
                        ? "#ffd43b"
                        : "#51cf66"
                    }; color: white; padding: 0.2rem 0.5rem; border-radius: 10px;">
            Energy: ${activity.energyLevel}
          </span>
          <span style="background: ${activity.socialIntensity === "high"
                      ? "#ff6b6b"
                      : activity.socialIntensity === "medium"
                        ? "#ffd43b"
                        : "#51cf66"
                    }; color: white; padding: 0.2rem 0.5rem; border-radius: 10px;">
            Social: ${activity.socialIntensity}
          </span>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--secondary-color); font-style: italic;">
          💡 ${activity.whyThisWorks}
        </div>
      </div>
      <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.3rem;">
        <button onclick="showAIEditModal(${group.id}, ${index}, ${activityIndex})" 
                style="background: var(--secondary-color); color: var(--inverted-text-color); border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;" 
                title="Edit activity">
          ✏️
        </button>
        <button onclick="deleteActivity(${group.id}, ${index}, ${activityIndex})" 
                style="background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;" 
                title="Delete activity">
          🗑️
        </button>
      </div>
    </div>
  `
                )
                .join("")}
            </div>
          </div>
        `
          )
          .join("")}
      </div>

      <div style="background: white; padding: 1rem; border-radius: 10px; margin-top: 1rem;">
        <h5 style="margin: 0 0 0.8rem 0; color: var(--secondary-color);">💡 AI Tips for Your Group</h5>
        <ul style="margin: 0; padding-left: 1.2rem;">
          ${itinerary.tips
          .map(
            (tip) =>
              `<li style="margin-bottom: 0.3rem; color: #666; font-size: 0.9rem;">${tip}</li>`
          )
          .join("")}
        </ul>
      </div>

      <div style="text-align: center; margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
  <button class="btn" onclick="showAIAssistantModal(${group.id})" 
          style="font-size: 0.8rem; padding: 6px 12px; background: var(--primary-gradient); color: var(--inverted-text-color);">
    <i class="fas fa-robot"></i> AI Assistant
  </button>
  <button class="btn btn-secondary" onclick="regenerateItinerary(${group.id
        })" style="font-size: 0.8rem; padding: 6px 12px;">
    <i class="fas fa-redo"></i> Regenerate
  </button>
</div>
    </div>
  `;
    }

    async function renderGroupScheduling(group) {
      const currentUser = DataLayer.load("currentUser");
      const currentUserId = currentUser.id;

      // Check if all group members have premium access
      const allMembersHavePremium = group.members.every(member => {
        if (member.userId === currentUser.id) {
          return currentUser.isPremium;
        } else {
          // Demo users removed - Firebase only
          return false;
        }
      });

      // Check if any members have premium access
      const anyMembersHavePremium = group.members.some(member => {
        if (member.userId === currentUser.id) {
          return currentUser.isPremium;
        } else {
          // Demo users removed - Firebase only
          return false;
        }
      });

      // If no members have premium, don't show the scheduling section at all
      if (!anyMembersHavePremium) {
        return "";
      }

      // If not all members have premium, show upgrade message
      if (!allMembersHavePremium) {
        return `
          <div class="group-scheduling-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(160, 200, 240, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(74, 144, 226, 0.2);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
              <h4 style="margin: 0; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-alt"></i> Group Scheduling
              </h4>
            </div>
            <div style="background: white; padding: 2rem; border-radius: 10px; margin-bottom: 1rem; text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 1rem;"><i class="fas fa-crown"></i></div>
              <h5 style="margin: 0 0 1rem 0; color: var(--primary-color);">Premium Feature</h5>
              <p style="margin: 0 0 1.5rem 0; color: #666; font-size: 0.9rem; line-height: 1.5;">
                All group members need Premium to use Group Scheduling. This ensures everyone can coordinate their availability together!
              </p>
              <div style="margin-top: 1rem; padding: 1rem; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                <h6 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">Group Members Premium Status:</h6>
                ${group.members.map(member => {
          const isPremium = member.userId === currentUser.id ?
            currentUser.isPremium :
            false; // Demo users removed - Firebase only
          return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; font-size: 0.8rem;">
                      <span>${addCrownToPremiumUser(member.displayName, member.userId)}</span>
                      <span style="color: ${isPremium ? 'var(--success-color)' : 'var(--warning-color)'}; font-weight: bold;">
                        ${isPremium ? '✓ Premium' : '✗ Free'}
                      </span>
                    </div>
                  `;
        }).join('')}
              </div>
              <button class="btn" onclick="showPremiumUpgradeModal()" style="background: var(--primary-gradient); margin-top: 1rem;">
                <i class="fas fa-crown"></i> Upgrade to Premium
              </button>
            </div>
          </div>
        `;
      }

      // Initialize availability if not exists
      if (!group.availability) {
        group.availability = {};
      }

      // Get current week dates (next 7 days)
      const weekDates = [];
      const today = new Date();
      console.log('Today is:', today.toISOString().split('T')[0], '(', today.toLocaleDateString('en-US', { weekday: 'long' }), ')');
      console.log('Today raw:', today);
      console.log('Today getTime():', today.getTime());
      console.log('Today getDate():', today.getDate());
      console.log('Today getMonth():', today.getMonth());
      console.log('Today getFullYear():', today.getFullYear());

      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);

        // Ensure we're getting the correct day name by using the date object directly
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const fullDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Use local date methods to avoid timezone issues
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;

        const dayInfo = {
          date: date,
          dayName: dayName,
          fullDate: fullDate,
          dateString: dateString
        };
        weekDates.push(dayInfo);
        console.log(`Day ${i}: ${dayInfo.dayName} (${dayInfo.dateString}) - ${date.toLocaleDateString('en-US', { weekday: 'long' })}`);
      }

      // Count available members for each day
      const availabilityCounts = weekDates.map(weekDate => {
        const availableMembers = group.members.filter(member => {
          const memberAvailability = group.availability[member.userId] || [];
          return memberAvailability.includes(weekDate.dateString);
        });
        return {
          ...weekDate,
          availableCount: availableMembers.length,
          totalCount: group.members.length
        };
      });

      // Debug: Log availability counts for each day
      console.log('Availability counts by day:');
      availabilityCounts.forEach(day => {
        console.log(`${day.dayName} (${day.dateString}): ${day.availableCount}/${day.totalCount} votes`);
      });

      // Debug: Log current user's availability
      const currentUserAvailability = group.availability[currentUser.id] || [];
      console.log('Current user availability:', currentUserAvailability);
      console.log('All group availability:', group.availability);

      // Debug: Check what each selected date corresponds to
      console.log('Week dates generated:');
      weekDates.forEach((day, index) => {
        console.log(`Day ${index}: ${day.dayName} (${day.dateString}) - ${day.date.toLocaleDateString('en-US', { weekday: 'long' })}`);
      });

      currentUserAvailability.forEach(dateString => {
        const dayInfo = weekDates.find(day => day.dateString === dateString);
        if (dayInfo) {
          console.log(`Selected date ${dateString} corresponds to ${dayInfo.dayName} (${dayInfo.fullDate})`);
        } else {
          console.log(`Selected date ${dateString} not found in week dates`);
        }
      });
      console.log('Group members:', group.members.map(m => ({ id: m.userId, name: m.displayName })));

      // Debug: Log each member's availability
      group.members.forEach(member => {
        const memberAvailability = group.availability[member.userId] || [];
        console.log(`Member ${member.displayName} (${member.userId}) availability:`, memberAvailability);
      });

      // Find best meeting day (most members available)
      // First, filter to only days that have at least 1 vote
      const daysWithVotes = availabilityCounts.filter(day => day.availableCount > 0);

      // If no days have votes, return null or default
      if (daysWithVotes.length === 0) {
        return `
          <div class="group-scheduling-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(160, 200, 240, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(74, 144, 226, 0.2);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
              <h4 style="margin: 0; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-alt"></i> Group Scheduling
              </h4>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                  PREMIUM
                </div>
                ${allMembersHavePremium ? `
                  <button class="btn btn-secondary" onclick="showAvailabilityModal(${group.id})" style="font-size: 0.8rem; padding: 8px 16px;">
                    <i class="fas fa-edit"></i> Set My Availability
                  </button>
                ` : ''}
              </div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
              <h5 style="margin: 0 0 1rem 0; color: var(--primary-color);">This Week's Availability</h5>
              <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                ${availabilityCounts.map(day => `
                  <div style="
                    text-align: center; 
                    padding: 0.8rem 0.5rem; 
                    border-radius: 8px; 
                    border: 2px solid #e0e0e0;
                    background: white;
                    position: relative;
                  ">
                    <div style="font-weight: bold; font-size: 0.9rem; color: var(--primary-color);">${day.dayName}</div>
                    <div style="font-size: 0.8rem; color: #666; margin: 0.3rem 0;">${day.fullDate}</div>
                    <div style="font-size: 0.7rem; color: #666;">
                      ${day.availableCount}/${day.totalCount}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 10px; border-left: 4px solid var(--warning-color);">
              <h5 style="margin: 0 0 0.5rem 0; color: var(--warning-color);">
                <i class="fas fa-info-circle"></i> No Availability Set
              </h5>
              <p style="margin: 0; font-size: 0.9rem; color: #666;">
                No members have set their availability for this week. Please set your availability to see recommendations.
              </p>
            </div>
          </div>
        `;
      }

      // Find the maximum availability count among days with votes
      const maxAvailability = Math.max(...daysWithVotes.map(day => day.availableCount));

      // Find all days that have the maximum availability count
      const tiedDays = daysWithVotes.filter(day => day.availableCount === maxAvailability);

      // Select the first tied day as the initial best day
      let bestDay = tiedDays[0];

      // Debug logging to understand what's happening
      console.log('Days with votes:', daysWithVotes.map(d => `${d.dayName}: ${d.availableCount}`));
      console.log('Tied days:', tiedDays.map(d => `${d.dayName}: ${d.availableCount}`));
      console.log('Selected best day:', bestDay.dayName);

      // Store tie information for display
      const wasTie = tiedDays.length > 1;
      const tieCount = tiedDays.length;

      // If there are ties, use weather to break the tie
      if (tiedDays.length > 1) {
        try {
          // Get location from group activities, user location, or group center
          let lat, lng;

          // Try to get location from first activity
          const firstActivity = group.activities && group.activities.length > 0 ? group.activities[0] : null;
          if (firstActivity && firstActivity.coordinates) {
            lat = firstActivity.coordinates.lat;
            lng = firstActivity.coordinates.lng;
          } else {
            // Try to get location from current user
            const currentUser = DataLayer.load("currentUser");
            if (currentUser && currentUser.location) {
              lat = currentUser.location.lat;
              lng = currentUser.location.lng;
            } else {
              // Calculate group center from member locations
              const memberLocations = group.members.map(member => {
                if (member.userId === currentUser.id) {
                  return currentUser.location;
                } else {
                  // Demo users removed - Firebase only
                  return null;
                }
              }).filter(loc => loc !== null);

              if (memberLocations.length > 0) {
                const avgLat = memberLocations.reduce((sum, loc) => sum + loc.lat, 0) / memberLocations.length;
                const avgLng = memberLocations.reduce((sum, loc) => sum + loc.lng, 0) / memberLocations.length;
                lat = avgLat;
                lng = avgLng;
              } else {
                // Fallback to Waterloo if no location data available
                lat = 43.4643;
                lng = -80.5204;
              }
            }
          }

          const tiedDates = tiedDays.map(day => day.dateString);

          console.log('Weather tie-breaker: evaluating dates:', tiedDates);
          console.log('Tied days for weather evaluation:', tiedDays.map(d => `${d.dayName} (${d.dateString}): ${d.availableCount} votes`));

          // Use group activities or create default activities for weather comparison
          let activitiesForWeather = group.activities || [];
          if (activitiesForWeather.length === 0) {
            activitiesForWeather = [
              { name: "Outdoor Activity", category: "Outdoor", coordinates: null },
              { name: "Park Visit", category: "Outdoor", coordinates: null },
              { name: "Restaurant", category: "Restaurant", coordinates: null },
              { name: "Cafe", category: "Cafe", coordinates: null }
            ];
          }

          const weatherBestDay = await WeatherSystem.getBestWeatherDay(lat, lng, tiedDates, activitiesForWeather);

          if (weatherBestDay) {
            console.log('Weather system selected:', weatherBestDay.date);
            bestDay = availabilityCounts.find(day => day.dateString === weatherBestDay.date) || bestDay;
            bestDay.weatherInfo = weatherBestDay;
            console.log('Final best day after weather:', bestDay.dayName);
          } else {
            console.log('No weather data available, keeping original selection:', bestDay.dayName);
          }
        } catch (error) {
          console.error('Error getting weather data for tie-breaking:', error);
        }
      }

      return `
        <div class="group-scheduling-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(160, 200, 240, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(74, 144, 226, 0.2);">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h4 style="margin: 0; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-calendar-alt"></i> Group Scheduling
            </h4>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                PREMIUM
              </div>
              ${allMembersHavePremium ? `
                <button class="btn btn-secondary" onclick="showAvailabilityModal(${group.id})" style="font-size: 0.8rem; padding: 8px 16px;">
                  <i class="fas fa-edit"></i> Set My Availability
                </button>
              ` : ''}
            </div>
          </div>
          
          ${allMembersHavePremium ? `
            <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
              <h5 style="margin: 0 0 1rem 0; color: var(--primary-color);">This Week's Availability</h5>
              <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                ${availabilityCounts.map(day => {
        const isAvailable = (group.availability[currentUserId] || []).includes(day.dateString);
        const availabilityPercent = (day.availableCount / day.totalCount) * 100;
        const isBestDay = day.dateString === bestDay.dateString && day.availableCount > 0;
        const wasTied = wasTie && day.availableCount === bestDay.availableCount && day.availableCount > 0;

        return `
                    <div style="
                      text-align: center; 
                      padding: 0.8rem 0.5rem; 
                      border-radius: 8px; 
                      border: 2px solid ${isBestDay ? 'var(--success-color)' : wasTied ? 'var(--warning-color)' : '#e0e0e0'};
                      background: ${isAvailable ? 'rgba(74, 144, 226, 0.1)' : 'white'};
                      position: relative;
                      ${isBestDay ? 'box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);' : wasTied ? 'box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);' : ''}
                    ">
                      <div style="font-weight: bold; font-size: 0.9rem; color: var(--primary-color);">${day.dayName}</div>
                      <div style="font-size: 0.8rem; color: #666; margin: 0.3rem 0;">${day.fullDate}</div>
                      <div style="font-size: 0.7rem; color: ${availabilityPercent >= 80 ? 'var(--success-color)' : availabilityPercent >= 50 ? 'var(--warning-color)' : '#666'};">
                        ${day.availableCount}/${day.totalCount}
                      </div>
                      ${isAvailable ? '<div style="position: absolute; top: 2px; right: 2px; color: var(--secondary-color); font-size: 0.6rem;">✓</div>' : ''}
                      ${isBestDay ? '<div style="position: absolute; bottom: -7px; left: 50%; transform: translateX(-50%); background: var(--success-color); color: white; padding: 1px 4px; border-radius: 4px; font-size: 0.6rem;">BEST</div>' : ''}
                      ${wasTied && !isBestDay ? '<div style="position: absolute; bottom: -7px; left: 50%; transform: translateX(-50%); background: var(--warning-color); color: white; padding: 1px 4px; border-radius: 4px; font-size: 0.6rem;">TIED</div>' : ''}
                    </div>
                  `;
      }).join('')}
              </div>
            </div>
          ` : `
            <div style="background: white; padding: 2rem; border-radius: 10px; margin-bottom: 1rem; text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 1rem;"><i class="fas fa-crown"></i></div>
              <h5 style="margin: 0 0 1rem 0; color: var(--primary-color);">Premium Feature</h5>
              <p style="margin: 0 0 1.5rem 0; color: #666; font-size: 0.9rem; line-height: 1.5;">
                All group members need Premium to use Group Scheduling. This ensures everyone can coordinate their availability together!
              </p>
              <div style="margin-top: 1rem; padding: 1rem; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                <h6 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">Group Members Premium Status:</h6>
                ${group.members.map(member => {
        const isPremium = member.userId === currentUser.id ?
          currentUser.isPremium :
          false; // Demo users removed - Firebase only
        return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; font-size: 0.8rem;">
                      <span>${addCrownToPremiumUser(member.displayName, member.userId)}</span>
                      <span style="color: ${isPremium ? 'var(--success-color)' : 'var(--warning-color)'}; font-weight: bold;">
                        ${isPremium ? '✓ Premium' : '✗ Free'}
                      </span>
                    </div>
                  `;
      }).join('')}
              </div>
              <button class="btn" onclick="showPremiumUpgradeModal()" style="background: var(--primary-gradient); margin-top: 1rem;">
                <i class="fas fa-crown"></i> Upgrade to Premium
              </button>
            </div>
          `}
          
          ${allMembersHavePremium ? `
            ${bestDay.availableCount > 0 ? `
              <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid var(--success-color);">
                <h5 style="margin: 0 0 0.5rem 0; color: var(--success-color);">
                  <i class="fas fa-check-circle"></i> Recommended Meeting Day
                </h5>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">
                  <strong>${bestDay.dayName}, ${bestDay.fullDate}</strong> - ${bestDay.availableCount} out of ${bestDay.totalCount} members available
                  
                </p>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                  Available members: ${group.members.filter(member => {
        const memberAvailability = group.availability[member.userId] || [];
        return memberAvailability.includes(bestDay.dateString);
      }).map(member => addCrownToPremiumUser(member.displayName, member.userId)).join(', ')}
                </div>
                ${bestDay.weatherInfo ? `
                  <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(74, 144, 226, 0.1); border-radius: 5px; font-size: 0.8rem;">
                                    <div style="margin-bottom: 0.5rem; font-weight: bold; color: var(--primary-color);">
                  <i class="fas fa-cloud-sun"></i> Weather Tie-Breaker Applied
                </div>
                <div style="margin-bottom: 0.3rem; font-size: 0.75rem; color: #666;">
                  ${tieCount} days had the same availability (${bestDay.availableCount}/${bestDay.totalCount}). 
                  This day was selected based on weather conditions for your group's activities.
                </div>
                    <div style="font-size: 0.8rem;">
                      <strong>Weather Forecast:</strong> ${bestDay.weatherInfo.weatherDescription} | 
                      High: ${bestDay.weatherInfo.weather.maxTemp}°C | 
                      Low: ${bestDay.weatherInfo.weather.minTemp}°C | 
                      Rain: ${bestDay.weatherInfo.weather.precipitation}%
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : `
              <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid var(--warning-color);">
                <h5 style="margin: 0 0 0.5rem 0; color: var(--warning-color);">
                  <i class="fas fa-exclamation-triangle"></i> No Common Availability
                </h5>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">
                  No day this week works for everyone. Set your availability to find the best time!
                </p>
              </div>
            `}


          ` : ''}
        </div>
      `;
    }

    // Manual handler to fetch and persist user's location
    async function handleUpdateUserLocation() {
      try {
        const location = await getUserLocation();
        // Persist to Firebase as well
        await updateUserLocation(location);
        NotificationSystem.show("Location updated successfully!", "success");
        // Refresh the profile page to show updated location
        showPage("profile");
      } catch (error) {
        NotificationSystem.show("Could not get your location. Please check your browser permissions.", "warning");
        console.error("Error updating location:", error);
      }
    }

    // Function to get user's current location
    function getUserLocation() {
      return new Promise(async (resolve, reject) => {
        try {
          const position = await getUserLocationWithFallback();
          const location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          // Update current user's location
          const currentUser = DataLayer.load("currentUser");
          currentUser.location = location;
          DataLayer.save("currentUser", currentUser);

          resolve(location);
        } catch (error) {
          reject(error);
        }
      });
    }



    // Function to recommend activities based on weather
    async function recommendActivitiesForWeather(group) {
      console.log(`🌤️ Starting weather recommendations for group:`, group.id);

      // If no activities, create general activity recommendations based on weather
      let activitiesToUse = group.activities || [];
      if (activitiesToUse.length === 0) {
        console.log(`🌤️ No activities found, creating general recommendations`);
        activitiesToUse = [
          { name: "Outdoor Activity", category: "Outdoor", coordinates: null },
          { name: "Indoor Activity", category: "Indoor", coordinates: null },
          { name: "Restaurant", category: "Restaurant", coordinates: null },
          { name: "Cafe", category: "Cafe", coordinates: null },
          { name: "Entertainment", category: "Entertainment", coordinates: null }
        ];
      }

      try {
        // Get location from group activities, user location, or group center
        let lat, lng;

        // Try to get location from first activity
        const firstActivity = group.activities && group.activities.length > 0 ? group.activities[0] : null;
        console.log(`🌤️ First activity:`, firstActivity);

        if (firstActivity && firstActivity.coordinates) {
          lat = firstActivity.coordinates.lat;
          lng = firstActivity.coordinates.lng;
          console.log(`🌤️ Using activity coordinates: lat=${lat}, lng=${lng}`);
        } else {
          // Try to get location from current user
          const currentUser = DataLayer.load("currentUser");
          console.log(`🌤️ Current user:`, currentUser);

          if (currentUser && currentUser.location) {
            lat = currentUser.location.lat;
            lng = currentUser.location.lng;
            console.log(`🌤️ Using user location: lat=${lat}, lng=${lng}`);
          } else {
            // Calculate group center from member locations
            const memberLocations = group.members.map(member => {
              if (member.userId === currentUser.id) {
                return currentUser.location;
              }
            }).filter(loc => loc !== null);

            console.log(`🌤️ Member locations:`, memberLocations);

            if (memberLocations.length > 0) {
              const avgLat = memberLocations.reduce((sum, loc) => sum + loc.lat, 0) / memberLocations.length;
              const avgLng = memberLocations.reduce((sum, loc) => sum + loc.lng, 0) / memberLocations.length;
              lat = avgLat;
              lng = avgLng;
              console.log(`🌤️ Using group center: lat=${lat}, lng=${lng}`);
            } else {
              // Fallback to Waterloo if no location data available
              lat = 43.4643;
              lng = -80.5204;
              console.log(`🌤️ Using fallback Waterloo: lat=${lat}, lng=${lng}`);
            }
          }
        }

        // Get weather for today and next few days
        const today = new Date();
        const dates = [];
        for (let i = 0; i < 3; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          dates.push(date.toISOString().split('T')[0]);
        }

        console.log(`🌤️ Getting weather for dates:`, dates);
        const weatherData = await WeatherSystem.getWeatherForDays(lat, lng, dates);
        console.log(`🌤️ Weather data received:`, weatherData);

        // Check if weatherData is valid
        if (!weatherData || !Array.isArray(weatherData) || weatherData.length === 0) {
          console.log(`🌤️ No valid weather data received`);
          return null;
        }

        const recommendations = [];

        for (let i = 0; i < weatherData.length; i++) {
          const weather = weatherData[i];
          console.log(`🌤️ Processing weather for day ${i}:`, weather);

          if (!weather) {
            console.log(`🌤️ No weather data for day ${i}`);
            continue;
          }

          // Score each activity for this weather
          const activityScores = activitiesToUse.map(activity => ({
            activity: activity,
            score: WeatherSystem.getActivityWeatherScore(activity, weather),
            weather: weather
          }));

          console.log(`🌤️ Activity scores for day ${i}:`, activityScores);

          // Sort by score and get top 2
          activityScores.sort((a, b) => b.score - a.score);
          const topActivities = activityScores.slice(0, 2);

          console.log(`🌤️ Top activities for day ${i}:`, topActivities);

          if (topActivities.length > 0 && weather) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const recommendation = {
              date: date,
              dateString: date.toISOString().split('T')[0],
              activities: topActivities,
              weather: weather
            };
            recommendations.push(recommendation);
            console.log(`🌤️ Added recommendation for day ${i}:`, recommendation);
          } else {
            console.log(`🌤️ Skipping recommendation for day ${i} - no activities or invalid weather data`);
          }
        }

        console.log(`🌤️ Final recommendations:`, recommendations);
        return recommendations;
      } catch (error) {
        console.error('Error getting weather-based recommendations:', error);
        return null;
      }
    }

    function showAvailabilityModal(groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      const currentUser = DataLayer.load("currentUser");

      // Check if all group members have premium access
      const allMembersHavePremium = group.members.every(member => {
        if (member.userId === currentUser.id) {
          return currentUser.isPremium;
        } else {
          // Demo users removed - Firebase only
          return false;
        }
      });

      // Check if all members have premium
      if (!allMembersHavePremium) {
        showPremiumUpgradeModal();
        return;
      }
      const currentUserId = currentUser.id;

      // Initialize availability if not exists
      if (!group.availability) {
        group.availability = {};
      }

      // Get current week dates (next 7 days)
      const weekDates = [];
      const today = new Date();

      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);

        // Ensure we're getting the correct day name by using the date object directly
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const fullDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Use local date methods to avoid timezone issues
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;

        weekDates.push({
          date: date,
          dayName: dayName,
          fullDate: fullDate,
          dateString: dateString
        });
      }

      // Get current user's availability
      const currentAvailability = group.availability[currentUserId] || [];

      const modalHtml = `
        <div id="availability-modal" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeAvailabilityModal()">&times;</button>
            <div class="modal-header">
              <h2 style="color: var(--primary-color);">📅 Set Your Availability</h2>
            </div>
            <div class="modal-body">
              <p style="margin-bottom: 1.5rem; color: #666; font-size: 0.9rem;">
                Select the days when you're available to meet with the group. This helps find the best time for everyone.
              </p>
              
              <form id="availability-form" onsubmit="saveAvailability(event, ${groupId})">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                  ${weekDates.map(day => {
        const isSelected = currentAvailability.includes(day.dateString);
        return `
                      <div style="
                        border: 2px solid ${isSelected ? 'var(--primary-color)' : '#e0e0e0'};
                        border-radius: 12px;
                        padding: 1rem;
                        background: ${isSelected ? 'rgba(74, 144, 226, 0.1)' : 'white'};
                        cursor: pointer;
                        transition: all 0.2s ease;
                        text-align: center;
                      " onclick="toggleDaySelection('${day.dateString}')">
                        <input type="checkbox" 
                               id="day-${day.dateString}" 
                               value="${day.dateString}" 
                               ${isSelected ? 'checked' : ''} 
                               style="display: none;">
                        <div style="font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem;">
                          ${day.dayName}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                          ${day.fullDate}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: ${isSelected ? 'var(--primary-color)' : '#999'};">
                          ${isSelected ? '✓ Available' : 'Click to select'}
                        </div>
                      </div>
                    `;
      }).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                  <button type="submit" class="btn" style="background: var(--primary-gradient);">
                    <i class="fas fa-save"></i> Save Availability
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="closeAvailabilityModal()">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // Add ESC and click-outside functionality
      addModalListeners("availability-modal", closeAvailabilityModal);
    }

    function closeAvailabilityModal() {
      const modal = document.getElementById("availability-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function toggleDaySelection(dateString) {
      const checkbox = document.getElementById(`day-${dateString}`);
      const dayDiv = checkbox.parentElement;

      if (checkbox.checked) {
        checkbox.checked = false;
        dayDiv.style.borderColor = '#e0e0e0';
        dayDiv.style.background = 'white';
        dayDiv.querySelector('div:last-child').textContent = 'Click to select';
        dayDiv.querySelector('div:last-child').style.color = '#999';
      } else {
        checkbox.checked = true;
        dayDiv.style.borderColor = 'var(--primary-color)';
        dayDiv.style.background = 'rgba(74, 144, 226, 0.1)';
        dayDiv.querySelector('div:last-child').textContent = '✓ Available';
        dayDiv.querySelector('div:last-child').style.color = 'var(--primary-color)';
      }
    }
    async function saveAvailability(event, groupId) {
      event.preventDefault();

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      const currentUser = DataLayer.load("currentUser");
      const currentUserId = currentUser.id;

      // Get selected dates
      const selectedDates = [];
      const checkboxes = document.querySelectorAll('#availability-form input[type="checkbox"]:checked');
      checkboxes.forEach(checkbox => {
        selectedDates.push(checkbox.value);
      });

      // Store expansion state before updating
      const content = document.getElementById(`group-content-${groupId}`);
      const wasExpanded = content && content.style.maxHeight !== "0px" && content.style.maxHeight !== "";

      // Update availability
      if (!groups[groupIndex].availability) {
        groups[groupIndex].availability = {};
      }
      groups[groupIndex].availability[currentUserId] = selectedDates;

      DataLayer.save("groups", groups);
      closeAvailabilityModal();

      // Update only the specific group content instead of re-rendering all groups
      await GroupsSystem.updateGroupContent(groupId);

      // Restore expansion state if it was expanded - use a longer delay to ensure all async updates are complete
      if (wasExpanded) {
        setTimeout(() => {
          const newContent = document.getElementById(`group-content-${groupId}`);
          const newIcon = document.getElementById(`expand-icon-${groupId}`);
          if (newContent && newIcon) {
            // Force a recalculation of the height
            newContent.style.maxHeight = "none";
            requestAnimationFrame(() => {
              newContent.style.maxHeight = newContent.scrollHeight + "px";
              newIcon.style.transform = "rotate(180deg)";
            });
          }
        }, 200); // Increased delay to ensure all async updates are complete
      }

      NotificationSystem.show("Availability updated successfully!", "success");
    }

    function regenerateItinerary(groupId) {
      if (
        confirm(
          "Are you sure you want to regenerate the itinerary? This will replace the current one."
        )
      ) {
        showAIPremiumModal(groupId);
      }
    }
    function showAIEditModal(groupId, dayIndex, activityIndex) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      const activity = group.aiItinerary.days[dayIndex].activities[activityIndex];

      const modalHtml = `
    <div id="ai-edit-modal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeAIEditModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color);">✏️ Edit Activity</h2>
        </div>
        <div class="modal-body">
          <form id="ai-edit-form" onsubmit="updateActivity(event, ${groupId}, ${dayIndex}, ${activityIndex})">
            <div class="form-group">
              <label for="edit-activity-name">Activity Name *</label>
              <input type="text" id="edit-activity-name" class="form-control" value="${activity.activity}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-location">Location *</label>
              <input type="text" id="edit-activity-location" class="form-control" value="${activity.location}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-time">Time *</label>
              <input type="text" id="edit-activity-time" class="form-control" value="${activity.time}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-duration">Duration *</label>
              <input type="text" id="edit-activity-duration" class="form-control" value="${activity.duration}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-description">Description</label>
              <textarea id="edit-activity-description" class="form-control" rows="3">${activity.description}</textarea>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="closeAIEditModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // Prevent body scrolling when modal is open
      document.body.classList.add('modal-open');

      // Add ESC and click-outside functionality
      addModalListeners("ai-edit-modal", closeAIEditModal);
    }

    function closeAIEditModal() {
      const modal = document.getElementById("ai-edit-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    async function updateActivity(event, groupId, dayIndex, activityIndex) {
      event.preventDefault();

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      // Store expansion state before updating
      const content = document.getElementById(`group-content-${groupId}`);
      const wasExpanded = content && content.style.maxHeight !== "0px" && content.style.maxHeight !== "";

      const activity = groups[groupIndex].aiItinerary.days[dayIndex].activities[activityIndex];

      activity.activity = document.getElementById("edit-activity-name").value;
      activity.location = document.getElementById("edit-activity-location").value;
      activity.time = document.getElementById("edit-activity-time").value;
      activity.duration = document.getElementById("edit-activity-duration").value;
      activity.description = document.getElementById("edit-activity-description").value;

      DataLayer.save("groups", groups);
      closeAIEditModal();

      // Update only the specific group content instead of re-rendering all groups
      await GroupsSystem.updateGroupContent(groupId);

      // Restore expansion state if it was expanded
      if (wasExpanded) {
        setTimeout(() => {
          const newContent = document.getElementById(`group-content-${groupId}`);
          const newIcon = document.getElementById(`expand-icon-${groupId}`);
          if (newContent && newIcon) {
            newContent.style.maxHeight = newContent.scrollHeight + "px";
            newIcon.style.transform = "rotate(180deg)";
          }
        }, 100); // Small delay to ensure DOM is updated
      }

      NotificationSystem.show("Activity updated successfully!", "success");
    }

    function parseDuration(durationStr) {
      // Parse duration strings like "2 hours", "30 minutes", "1.5 hours"
      const match = durationStr.match(/(\d+(?:\.\d+)?)\s*(hour|minute|hr|min)s?/i);
      if (!match) return 60; // Default to 1 hour if can't parse

      const value = parseFloat(match[1]);
      const unit = match[2].toLowerCase();

      if (unit.includes('hour') || unit.includes('hr')) {
        return value * 60; // Convert to minutes
      } else if (unit.includes('minute') || unit.includes('min')) {
        return value;
      }
      return 60; // Default
    }

    function addMinutesToTime(timeStr, minutesToAdd) {
      // Parse time like "9:00 AM" and add minutes
      const [time, period] = timeStr.split(' ');
      let [hours, minutes] = time.split(':').map(Number);

      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;

      const totalMinutes = hours * 60 + minutes + minutesToAdd;
      const newHours = Math.floor(totalMinutes / 60);
      const newMinutes = totalMinutes % 60;

      let displayHours = newHours;
      let newPeriod = 'AM';

      if (newHours >= 12) {
        newPeriod = 'PM';
        if (newHours > 12) displayHours = newHours - 12;
      }
      if (displayHours === 0) displayHours = 12;

      return `${displayHours}:${newMinutes.toString().padStart(2, '0')} ${newPeriod}`;
    }

    function rescheduleActivities(activities) {
      if (activities.length === 0) return activities;

      const rescheduled = [];
      let currentTime = activities[0].time;

      for (let i = 0; i < activities.length; i++) {
        const activity = { ...activities[i] };
        activity.time = currentTime;
        rescheduled.push(activity);

        // Calculate next start time
        const durationMinutes = parseDuration(activity.duration);
        const travelTime = 30; // Assume 30 minutes travel time between activities
        const totalTime = durationMinutes + travelTime;

        if (i < activities.length - 1) {
          currentTime = addMinutesToTime(currentTime, totalTime);
        }
      }

      return rescheduled;
    }

    async function deleteActivity(groupId, dayIndex, activityIndex) {
      if (!confirm("Are you sure you want to delete this activity?")) return;

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      // Store expansion state before updating
      const content = document.getElementById(`group-content-${groupId}`);
      const wasExpanded = content && content.style.maxHeight !== "0px" && content.style.maxHeight !== "";

      // Remove the activity
      groups[groupIndex].aiItinerary.days[dayIndex].activities.splice(activityIndex, 1);

      // Reschedule remaining activities for this day
      if (groups[groupIndex].aiItinerary.days[dayIndex].activities.length > 0) {
        groups[groupIndex].aiItinerary.days[dayIndex].activities =
          rescheduleActivities(groups[groupIndex].aiItinerary.days[dayIndex].activities);
      }

      DataLayer.save("groups", groups);

      // Update only the specific group content instead of re-rendering all groups
      await GroupsSystem.updateGroupContent(groupId);

      // Restore expansion state if it was expanded
      if (wasExpanded) {
        setTimeout(() => {
          const newContent = document.getElementById(`group-content-${groupId}`);
          const newIcon = document.getElementById(`expand-icon-${groupId}`);
          if (newContent && newIcon) {
            newContent.style.maxHeight = newContent.scrollHeight + "px";
            newIcon.style.transform = "rotate(180deg)";
          }
        }, 100); // Small delay to ensure DOM is updated
      }

      NotificationSystem.show("Activity deleted and schedule updated!", "success");
    }

    function showAIAssistantModal(groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      const modalHtml = `
    <div id="ai-assistant-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeAIAssistantModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-robot"></i> AI Assistant
          </h2>
        </div>
        <div class="modal-body">
          <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);">🤖 Ask me to modify your itinerary!</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #666;">
              Examples: "Make day 2 more relaxing", "Replace the museum with outdoor activities", "Add more food options"
            </p>
          </div>

          <form id="ai-assistant-form" onsubmit="handleAIAssistantRequest(event, ${groupId})">
            <div class="form-group">
              <label for="ai-request">What would you like me to change? *</label>
              <textarea id="ai-request" class="form-control" rows="4" 
                        placeholder="e.g., Make the first day less crowded, add more restaurants, replace nightlife with quiet activities..." required></textarea>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 12px 24px;">
                <i class="fas fa-magic"></i> Apply Changes
              </button>
              <button type="button" class="btn btn-secondary" onclick="closeAIAssistantModal()">Cancel</button>
            </div>
          </form>

          <div id="ai-assistant-loading" class="ai-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>AI is updating your itinerary...</p>
          </div>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // Add ESC and click-outside functionality
      addModalListeners("ai-assistant-modal", closeAIAssistantModal);
    }

    function closeAIAssistantModal() {
      const modal = document.getElementById("ai-assistant-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    
    function closeGroupLocationModal() {
      const modal = document.getElementById("group-location-modal");
      if (modal) {
        modal.remove();
        // Remove any remaining event listeners
        document.removeEventListener('keydown', (event) => {
          if (event.key === 'Escape') closeGroupLocationModal();
        });
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function showPremiumUpgradeModal() {
      const modalHtml = `
        <div id="premium-upgrade-modal" class="modal">
          <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closePremiumUpgradeModal()">&times;</button>
            <div class="modal-header">
              <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-crown"></i> Upgrade to Premium
              </h2>
            </div>
            <div class="modal-body">
              <div style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: center;">
                <h3 style="margin: 0 0 1rem 0;">✨ Premium Features</h3>
                <div style="display: grid; gap: 1rem; text-align: left;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-infinity"></i>
                    <span><strong>Unlimited Groups</strong> - Create as many groups as you want</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-robot"></i>
                    <span><strong>AI Trip Planner</strong> - Get personalized itineraries</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-magic"></i>
                    <span><strong>AI Assistant</strong> - Modify plans with AI help</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-line"></i>
                    <span><strong>Advanced Analytics</strong> - Detailed group insights</span>
                  </div>
                </div>
              </div>

              <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; padding: 12px 24px; font-weight: bold;">
                  <i class="fas fa-crown"></i> Upgrade Now - $9.99/month
                </button>
                <button type="button" class="btn btn-secondary" onclick="closePremiumUpgradeModal()">Maybe Later</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Prevent body scrolling when modal is open
      document.body.classList.add('modal-open');

      // Add ESC and click-outside functionality
      addModalListeners("premium-upgrade-modal", closePremiumUpgradeModal);
    }

    function closePremiumUpgradeModal() {
      const modal = document.getElementById("premium-upgrade-modal");
      if (modal) {
        modal.remove();
        // Remove any remaining event listeners
        document.removeEventListener('keydown', (event) => {
          if (event.key === 'Escape') closePremiumUpgradeModal();
        });
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }



    async function handleAIAssistantRequest(event, groupId) {
      event.preventDefault();

      const request = document.getElementById("ai-request").value;
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      // Show loading state
      document.getElementById("ai-assistant-form").style.display = "none";
      document.getElementById("ai-assistant-loading").style.display = "block";

      try {
        const prompt = `You are an expert trip planner. I have an existing itinerary and need you to modify it based on a specific request.

Current Group Information:
- Group Name: ${group.name}
- Group Description: ${group.description}
- Members and their personality types:
${group.members
            .map(
              (member) =>
                `  • ${addCrownToPremiumUser(member.displayName, member.userId)}: ${member.personalityType} (Adjustment Factor: ${member.adjustmentFactor})`
            )
            .join("\n")}

Current Itinerary:
${JSON.stringify(group.aiItinerary, null, 2)}

User Request: "${request}"

IMPORTANT INSTRUCTIONS:
1. If the user requests changes to duration, location, or budget, update the tripDetails accordingly
2. If the user asks for a different number of days, create exactly that many days (no more, no less)
3. Maintain the same JSON structure and format
4. Keep the balance for the group's personality mix
5. Return the COMPLETE modified itinerary including updated tripDetails if needed

SCHEDULING RULES:
- Account for travel time between activities (15-45 minutes)
- If an activity takes 2 hours and starts at 9:00 AM, next activity should start no earlier than 11:30 AM
- Include realistic travel times in duration fields
- Don't schedule activities too close together
- Consider opening hours and peak times

Only return the JSON, no additional text.`;

        const payload = {
          messages: [{ role: "user", content: prompt }],
        };

        const response = await fetch("https://ai.hackclub.com/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content;

        // Clean and parse the response
        let cleanedContent = content.replace(/```json\n?|\n?```/g, "").trim();

        if (cleanedContent.includes("<think>")) {
          const jsonStart = cleanedContent.indexOf("{");
          if (jsonStart !== -1) {
            cleanedContent = cleanedContent.substring(jsonStart);
          }
        }

        const jsonEnd = cleanedContent.lastIndexOf("}");
        if (jsonEnd !== -1) {
          cleanedContent = cleanedContent.substring(0, jsonEnd + 1);
        }

        const updatedItinerary = JSON.parse(cleanedContent);

        // Update the group's itinerary
        const groupIndex = groups.findIndex((g) => g.id === groupId);
        if (groupIndex !== -1) {
          // Preserve existing tripDetails if the AI didn't update them
          const preservedTripDetails = updatedItinerary.tripDetails || group.aiItinerary.tripDetails;

          groups[groupIndex].aiItinerary = {
            ...updatedItinerary,
            tripDetails: preservedTripDetails,
            generatedAt: group.aiItinerary.generatedAt,
            lastModified: new Date().toISOString(),
          };
          DataLayer.save("groups", groups);
        }

        closeAIAssistantModal();
        GroupsSystem.displayGroups();
        NotificationSystem.show("Itinerary updated successfully!", "success");

      } catch (error) {
        console.error("Error updating itinerary:", error);
        NotificationSystem.show("Failed to update itinerary. Please try again.", "error");

        // Reset form
        document.getElementById("ai-assistant-loading").style.display = "none";
        document.getElementById("ai-assistant-form").style.display = "block";
      }
    }



    async function handleCreateGroup(event) {
      event.preventDefault();

      const name = document.getElementById("group-name").value;
      const description = document.getElementById("group-description").value;

      // Get selected friends
      const selectedMembers = [];
      const friends = await FriendsSystem.getFriends();

      if (!friends || !Array.isArray(friends)) {
        NotificationSystem.show('Error loading friends. Please try again.', 'error');
        return;
      }

      friends.forEach((friend) => {
        const checkbox = document.getElementById(`member-${friend.id}`);
        if (checkbox && checkbox.checked) {
          selectedMembers.push({
            userId: friend.id,
            displayName: friend.displayName,
            personalityType: friend.personalityType,
            adjustmentFactor: friend.adjustmentFactor, // Fixed: was user.adjustmentFactor
            avatar: friend.avatar, // Fixed: was user.avatar
            importance: 1.0,
          });
        }
      });

      if (selectedMembers.length === 0) {
        NotificationSystem.show(
          "Please select at least one member to add to the group.",
          "warning"
        );
        return;
      }

      GroupsSystem.createGroup(name, description, selectedMembers);
    }

    // Experiences Modal System
    function showExperiencesModal() {
      const userExperiences = DataLayer.load("userExperiences", []);
      console.log("SHOWING USERS!! ", userExperiences);

      const modalHtml = `
        <div id="experiences-modal" class="modal">
          <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeExperiencesModal()">&times;</button>
            <div class="modal-header">
              <h2>Your Experiences</h2>
              <p style="margin: 0; color: #666;">Manage and edit your shared experiences</p>
            </div>
            <div class="modal-body">
              ${userExperiences.length === 0 ? `
                <div style="text-align: center; padding: 3rem 1rem;">
                  <div style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;">📝</div>
                  <h3 style="color: #666; margin-bottom: 0.5rem;">No Experiences Yet</h3>
                  <p style="color: #888; margin-bottom: 2rem;">Start sharing your experiences to see them here!</p>
                  <button class="btn" onclick="closeExperiencesModal(); showPage('activities');">
                    <i class="fas fa-plus-circle"></i> Add Your First Experience
                  </button>
                </div>
              ` : `
                <div style="display: grid; gap: 1.5rem;">
                  ${userExperiences.map((experience, index) => `
                    <div class="experience-card" style="
                      border: 1px solid #eee; 
                      border-radius: 12px; 
                      padding: 1.5rem; 
                      background: white;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                      transition: all 0.2s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                      
                      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                          <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.2rem;">
                            ${experience.name}
                          </h3>
                          <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <span style="background: var(--secondary-color); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">
                              ${experience.category}
                            </span>
                            <span style="color: #666;">
                              <i class="fas fa-map-marker-alt"></i> ${experience.location}
                            </span>
                          </div>
                          <p style="margin: 0; color: #555; line-height: 1.5; font-size: 0.95rem;">
                            ${experience.description}
                          </p>
                        </div>
                        <div style="text-align: right; min-width: 80px;">
                          <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                            ${experience.rawScore.toFixed(1)}
                          </div>
                          <div style="font-size: 0.8rem; color: #666;">Rating</div>
                        </div>
                      </div>
                      
                      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Energy</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.energy}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Social</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.social}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Comfort</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.comfort}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Overwhelm</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.overwhelm}/10</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">Return</div>
                          <div style="font-weight: bold; color: var(--primary-color);">${experience.responses.return}/10</div>
                        </div>
                      </div>
                      
                      <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="editExperience(${index})" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteExperience(${index})" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
                  <button class="btn" onclick="closeExperiencesModal(); showPage('activities');">
                    <i class="fas fa-plus-circle"></i> Add New Experience
                  </button>
                </div>
              `}
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // Add ESC and click-outside functionality
      addModalListeners("experiences-modal", closeExperiencesModal);
    }

    function closeExperiencesModal() {
      const modal = document.getElementById("experiences-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    function editExperience(index) {
      const userExperiences = DataLayer.load("userExperiences", []);
      const experience = userExperiences[index];

      if (!experience) return;

      const modalHtml = `
        <div id="edit-experience-modal" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeEditExperienceModal()">&times;</button>
            <div class="modal-header">
              <h2>Edit Experience</h2>
            </div>
            <div class="modal-body">
              <form id="edit-experience-form" onsubmit="handleEditExperience(event, ${index})">
                <div class="form-group">
                  <label for="edit-name">Experience Name *</label>
                  <input type="text" id="edit-name" class="form-control" value="${experience.name}" required>
                </div>
                <div class="form-group">
                  <label for="edit-category">Category *</label>
                  <select id="edit-category" class="form-control" required>
                    <option value="Restaurant" ${experience.category === 'Restaurant' ? 'selected' : ''}>Restaurant</option>
                    <option value="Bar/Pub" ${experience.category === 'Bar/Pub' ? 'selected' : ''}>Bar/Pub</option>
                    <option value="Cafe" ${experience.category === 'Cafe' ? 'selected' : ''}>Cafe</option>
                    <option value="Museum/Gallery" ${experience.category === 'Museum/Gallery' ? 'selected' : ''}>Museum/Gallery</option>
                    <option value="Library/Study" ${experience.category === 'Library/Study' ? 'selected' : ''}>Library/Study</option>
                    <option value="Park/Outdoor" ${experience.category === 'Park/Outdoor' ? 'selected' : ''}>Park/Outdoor</option>
                    <option value="Entertainment" ${experience.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                    <option value="Shopping" ${experience.category === 'Shopping' ? 'selected' : ''}>Shopping</option>
                    <option value="Other" ${experience.category === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="edit-location">Location *</label>
                  <input type="text" id="edit-location" class="form-control" value="${experience.location}" required>
                </div>
                <div class="form-group">
                  <label for="edit-description">Description *</label>
                  <textarea id="edit-description" class="form-control" rows="3" required>${experience.description}</textarea>
                </div>
                
                <div style="margin: 2rem 0;">
                  <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Rate Your Experience</h4>
                  <div class="rating-questions">
                    <div class="rating-question">
                      <label>How energized did you feel?</label>
                      <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.energy}" oninput="updateSliderValue(this, 'edit-slider-energy')" id="edit-energy">
                      <div class="slider-value" id="edit-slider-energy">${experience.responses.energy}</div>
                    </div>
                    <div class="rating-question">
                      <label>How satisfied were you with the social interaction?</label>
                      <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.social}" oninput="updateSliderValue(this, 'edit-slider-social')" id="edit-social">
                      <div class="slider-value" id="edit-slider-social">${experience.responses.social}</div>
                    </div>
                    <div class="rating-question">
                      <label>How comfortable did you feel in this environment?</label>
                      <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.comfort}" oninput="updateSliderValue(this, 'edit-slider-comfort')" id="edit-comfort">
                      <div class="slider-value" id="edit-slider-comfort">${experience.responses.comfort}</div>
                    </div>
                    <div class="rating-question">
                      <label>How overwhelming was the environment? (Rate higher if it felt more overwhelming)</label>
                      <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.overwhelm}" oninput="updateSliderValue(this, 'edit-slider-overwhelm')" id="edit-overwhelm">
                      <div class="slider-value" id="edit-slider-overwhelm">${experience.responses.overwhelm}</div>
                    </div>
                    <div class="rating-question">
                      <label>How likely are you to return?</label>
                      <input type="range" class="rating-slider" min="1" max="10" value="${experience.responses.return}" oninput="updateSliderValue(this, 'edit-slider-return')" id="edit-return">
                      <div class="slider-value" id="edit-slider-return">${experience.responses.return}</div>
                    </div>
                  </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                  <button type="submit" class="btn">Save Changes</button>
                  <button type="button" class="btn btn-secondary" onclick="closeEditExperienceModal()">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // Add ESC and click-outside functionality
      addModalListeners("edit-experience-modal", closeEditExperienceModal);
    }

    function closeEditExperienceModal() {
      const modal = document.getElementById("edit-experience-modal");
      if (modal) modal.remove();
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    async function handleEditExperience(event, index) {
      console.log("CALLING HANDLE!!")
      let responses = {};
      let rawScore = 0;

      event.preventDefault();

      const userExperiences = DataLayer.load("userExperiences", []);
      const experience = userExperiences[index];

      if (!experience) return;

      // Update experience data
      experience.name = document.getElementById("edit-name").value.trim();
      experience.category = document.getElementById("edit-category").value;
      experience.location = document.getElementById("edit-location").value.trim();
      experience.description = document.getElementById("edit-description").value.trim();

      if (!experience.name || !experience.category || !experience.location) {
        NotificationSystem.show(
          "Please fill in all required fields including location.",
          "warning"
        );
        return;
      }

      ActivitySystem.ratingQuestions.forEach((question) => {
        let value = parseInt(document.getElementById(`edit-${question.id}`).value);

        responses[question.id] = value;

        rawScore += (!question.reverse) ? value * question.weight : (11 - value) * question.weight;
      });

      experience.responses = responses;
      experience.rawScore = rawScore;
      experience.socialIntensity = ActivitySystem.estimateSocialIntensity(experience.category, responses);
      experience.noiseLevel = ActivitySystem.estimateNoiseLevel(experience.category, responses);
      experience.crowdSize = ActivitySystem.estimateCrowdSize(experience.category, responses);

      // Save updated experiences locally
      DataLayer.save("userExperiences", userExperiences);

      // Also update the allExperiences in DataLayer if it exists
      const allExperiences = DataLayer.load("allExperiences", []);
      const updatedAllExperiences = allExperiences.map(exp => {
        if (exp.id === experience.id) {
          return { ...exp, ...experience };
        }
        return exp;
      });
      DataLayer.save("allExperiences", updatedAllExperiences);

      // Function to refresh all UI components
      const refreshAllUI = () => {
        // Clear all relevant caches to force a fresh load
        if (typeof CacheSystem !== 'undefined') {
          CacheSystem.clear('EXPERIENCES');

          // Clear feed cache if FeedSystem exists
          if (typeof FeedSystem !== 'undefined' && FeedSystem.store && FeedSystem.store.cacheKey) {
            CacheSystem.clear(FeedSystem.store.cacheKey);
            console.log('✅ Cleared feed cache:', FeedSystem.store.cacheKey);
          }

          // Clear any nearby experiences cache
          const currentUser = DataLayer.load('currentUser');
          if (currentUser && currentUser.id) {
            CacheSystem.clear(`NEARBY_${currentUser.id}`);
            console.log('✅ Cleared nearby experiences cache');
          }

          console.log('✅ Cleared all experience-related caches');
        }

        // Refresh all UI components
        updateDashboard();
        updateProfile();
        

        // Update feed if it exists
        if (typeof FeedSystem !== 'undefined' && FeedSystem.displayFeed) {
          FeedSystem.displayFeed();
        }

        // Refresh experiences modal if it's open
        const experiencesModal = document.getElementById('experiences-modal');
        if (experiencesModal) {
          console.log('✅ Refreshing experiences modal');
          closeExperiencesModal();
          setTimeout(() => {
            const freshData = DataLayer.load("userExperiences", []);
            console.log('🔍 Fresh data before modal refresh:', freshData);

            showExperiencesModal();
            
          }, 200);
        }

        // Refresh any other experience-related displays
        const currentPage = document.querySelector('.page:not(.hidden)');
        if (currentPage) {
          const currentPageId = currentPage.id;
          console.log('✅ Refreshing current page:', currentPageId);

          // Re-trigger page-specific updates
          if (typeof updateOnPageVisit === 'function') {
            updateOnPageVisit(currentPageId);
          }
        }
      };

      // Update Firebase if user is authenticated
      if (getCurrentUser() && getAuthManager() && experience.id) {
        try {
          const { doc, updateDoc, collection, query, where, getDocs, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          // Find the experience in Firebase and update it
          const experiencesCollection = collection(getAuthManager().db, 'experiences');
          const experienceQuery = query(
            experiencesCollection,
            where('userId', '==', getCurrentUser().uid),
            where('id', '==', experience.id)
          );

          const experienceSnapshot = await wrapRead(getDocs(experienceQuery), 'getDocs', 'experiences', { userId: getCurrentUser().uid, id: experience.id });

          if (!experienceSnapshot.empty) {
            const experienceDoc = experienceSnapshot.docs[0];
            await wrapWrite(
              updateDoc(doc(getAuthManager().db, 'experiences', experienceDoc.id), {
                name: experience.name,
                category: experience.category,
                location: experience.location,
                description: experience.description,
                responses: experience.responses,
                rawScore: experience.rawScore,
                socialIntensity: experience.socialIntensity,
                noiseLevel: experience.noiseLevel,
                crowdSize: experience.crowdSize,
                updatedAt: serverTimestamp()
              }),
              'updateDoc',
              `experiences/${experienceDoc.id}`,
              { reason: 'editExperience' }
            );
            console.log('Experience updated in Firebase');
          } else {
            // If we can't find by ID, try to find by other properties
            const fallbackQuery = query(
              experiencesCollection,
              where('userId', '==', getCurrentUser().uid),
              where('name', '==', experience.name),
              where('category', '==', experience.category)
            );

            const fallbackSnapshot = await wrapRead(getDocs(fallbackQuery), 'getDocs', 'experiences', { userId: getCurrentUser().uid, name: experience.name });
            if (!fallbackSnapshot.empty) {
              const experienceDoc = fallbackSnapshot.docs[0];
              await wrapWrite(
                updateDoc(doc(getAuthManager().db, 'experiences', experienceDoc.id), {
                  name: experience.name,
                  category: experience.category,
                  location: experience.location,
                  description: experience.description,
                  responses: experience.responses,
                  rawScore: experience.rawScore,
                  socialIntensity: experience.socialIntensity,
                  noiseLevel: experience.noiseLevel,
                  crowdSize: experience.crowdSize,
                  updatedAt: serverTimestamp()
                }),
                'updateDoc',
                `experiences/${experienceDoc.id}`,
                { reason: 'editExperienceFallback' }
              );
              console.log('Experience updated in Firebase (fallback method)');
            }
          }

          // Refresh UI AFTER Firebase update completes
          setTimeout(() => {
            refreshAllUI();

            // Force reload of user experiences from Firebase AFTER the update
            if (typeof loadUserExperiencesWithCache === 'function') {
              loadUserExperiencesWithCache().then(() => {
                console.log('✅ Reloaded experiences from Firebase');
                // Final UI refresh after reload
                setTimeout(() => {
                  refreshAllUI();
                }, 50);
              }).catch(error => {
                console.error('Error reloading experiences:', error);
              });
            }
          }, 100);

        } catch (error) {
          console.error('Error updating experience in Firebase:', error);
          NotificationSystem.show('Experience updated locally, but failed to sync with server.', 'warning');

          // Still refresh UI even if Firebase update failed
          setTimeout(() => {
            refreshAllUI();
          }, 100);
        }
      } else {
        // No Firebase update needed, refresh UI immediately
        setTimeout(() => {
          refreshAllUI();
        }, 100);
      }

      // Close modal and show success message
      closeEditExperienceModal();
      NotificationSystem.show("Experience updated successfully!", "success");
    }
    
    async function deleteExperience(index) {
      if (confirm("Are you sure you want to delete this experience? This action cannot be undone.")) {
        const userExperiences = DataLayer.load("userExperiences", []);
        const experienceToDelete = userExperiences[index];

        // Remove from local storage
        userExperiences.splice(index, 1);
        DataLayer.save("userExperiences", userExperiences);

        // Delete from Firebase if user is authenticated and experience has Firebase ID
        if (getCurrentUser() && getAuthManager() && experienceToDelete.id) {
          try {
            const { doc, deleteDoc, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

            // Find the experience in Firebase and delete it
            const experiencesCollection = collection(getAuthManager().db, 'experiences');
            const experienceQuery = query(
              experiencesCollection,
              where('userId', '==', getCurrentUser().uid),
              where('id', '==', experienceToDelete.id)
            );

            const experienceSnapshot = await wrapRead(getDocs(experienceQuery), 'getDocs', 'experiences', { userId: getAuthManager().auth.currentUser.uid, name });

            if (!experienceSnapshot.empty) {
              const experienceDoc = experienceSnapshot.docs[0];
              await wrapWrite(
                deleteDoc(doc(getAuthManager().db, 'experiences', experienceDoc.id)),
                'deleteDoc',
                `experiences/${experienceDoc.id}`,
                { reason: 'deleteExperience' }
              );
              console.log('Experience deleted from Firebase');
            } else {
              // If we can't find by ID, try to find by other properties
              const fallbackQuery = query(
                experiencesCollection,
                where('userId', '==', getCurrentUser().uid),
                where('name', '==', experienceToDelete.name),
                where('category', '==', experienceToDelete.category)
              );

              const fallbackSnapshot = await wrapRead(getDocs(fallbackQuery), 'getDocs', 'experiences', { userId: getAuthManager().auth.currentUser.uid, category });
              if (!fallbackSnapshot.empty) {
                const experienceDoc = fallbackSnapshot.docs[0];
                await wrapWrite(
                  deleteDoc(doc(getAuthManager().db, 'experiences', experienceDoc.id)),
                  'deleteDoc',
                  `experiences/${experienceDoc.id}`,
                  { reason: 'deleteExperienceFallback' }
                );
                console.log('Experience deleted from Firebase (fallback method)');
              }
            }
          } catch (error) {
            console.error('Error deleting experience from Firebase:', error);
            NotificationSystem.show('Experience deleted locally, but failed to sync with server.', 'warning');
          }
        }

        closeExperiencesModal();
        NotificationSystem.show("Experience deleted successfully!", "success");

        // Refresh the page data
        updateDashboard();
        updateProfile();
      }
    }

    // Updated showCreateGroupModal to limit to 3-6 friends displayed
    async function showCreateGroupModal() {
      const friends = await FriendsSystem.getFriends();

      if (!friends || friends.length === 0) {
        NotificationSystem.show(
          "Add some friends first before creating a group!",
          "warning"
        );
        showPage("feed");
        return;
      }

      // Limit to first 6 friends for better UI
      const displayFriends = friends.slice(0, 6);

      const modalHtml = `
    <div id="group-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-header">
          <h2>Create New Group</h2>
        </div>
        <div class="modal-body">
          <form id="group-form" onsubmit="handleCreateGroup(event).catch(error => {
            console.error('Error creating group:', error);
            NotificationSystem.show('Error creating group. Please try again.', 'error');
          })">
            <div class="form-group">
              <label for="group-name">Group Name *</label>
              <input type="text" id="group-name" class="form-control" placeholder="e.g., Friday Night Crew, Study Group" required>
            </div>
            <div class="form-group">
              <label for="group-description">Description</label>
              <textarea id="group-description" class="form-control" placeholder="What's this group about?"></textarea>
            </div>
            <div class="form-group">
              <label>Add Friends to Group *</label>
              <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">Select friends to add to your group:</p>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.8rem;">
                ${displayFriends
          .map(
            (friend) => `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; border: 1px solid #eee; border-radius: 8px;">
                      <input type="checkbox" id="member-${friend.id}" value="${friend.id
              }">
                      <div class="feed-avatar" style="width: 35px; height: 35px; font-size: 1rem;">${friend.avatar
              }</div>
                                          <div style="flex: 1;">
                      <strong>${addCrownToPremiumUser(friend.displayName, friend.id)}</strong>
                      <div style="font-size: 0.8rem; color: var(--secondary-color);">${friend.personalityType
              }</div>
                      <div style="font-size: 0.8rem; color: #888;">AF: ${friend.adjustmentFactor.toFixed(
                2
              )}</div>
                    </div>
                    </div>
                `
          )
          .join("")}
              </div>
              ${friends.length > 6
          ? `<p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem; font-style: italic;">Showing first 6 friends. You can add more after creating the group.</p>`
          : ""
        }
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Create Group</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // Add ESC and click-outside functionality
      addModalListeners("group-modal", closeModal);
    }

    // Enhanced closeModal function
    function closeModal() {
      const modal = document.getElementById("group-modal");
      if (modal) {
        modal.style.animation = "fadeOut 0.3s ease forwards";
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
          }
        }, 300);
      }
    }

    // Comprehensive caching system to reduce Firebase reads
    const CacheSystem = {
      // Cache durations in milliseconds (optimized for 1000+ users)
      CACHE_DURATIONS: {
        FRIENDS: 600000,        // 10 minutes (increased from 5)
        GROUPS: 900000,         // 15 minutes (increased from 10)
        FRIEND_REQUESTS: 300000, // 5 minutes (increased from 2)
        SIMILAR_USERS: 600000,  // 10 minutes (increased from 5)
        USER_PROFILES: 1800000, // 30 minutes (increased from 15)
        EXPERIENCES: 3600000,   // 60 minutes (increased from 30)
        LOCATIONS: 600000,      // 10 minutes (increased from 5)
        ACTIVITIES: 1800000,    // 30 minutes (new)
        RECOMMENDATIONS: 900000, // 15 minutes (new)
        FRIEND_STATUSES: 120000, // 2 minutes (short cache for status)
        ALL_USERS_BASIC: 300000  // 5 minutes (basic user data)
      },

      isInvalidating: false, // Prevent invalidation loops

      // Get cached data with timestamp validation
      get: (key, duration = 300000) => {
        const cache = DataLayer.load(`cache_${key}`, {});
        const now = Date.now();

        if (cache.timestamp && (now - cache.timestamp) < duration && cache.data) {
          console.log(`Using cached data for: ${key}`);
          return cache.data;
        }

        console.log(`Cache miss for: ${key}`);
        return null;
      },

      // Set cached data with timestamp
      set: (key, data) => {
        DataLayer.save(`cache_${key}`, {
          timestamp: Date.now(),
          data: data
        });
        console.log(`Cached data for: ${key}`);
      },

      // Clear specific cache
      clear: (key) => {
        DataLayer.remove(`cache_${key}`);
        console.log(`Cleared cache for: ${key}`);
      },

      // Clear all caches
      clearAll: () => {
        Object.keys(CacheSystem.CACHE_DURATIONS).forEach(key => {
          CacheSystem.clear(key);
        });
        console.log('Cleared all caches');
      },

      // Invalidate specific caches when data changes
      invalidateFriendsCache: () => {
        if (!CacheSystem.isInvalidating) {
          CacheSystem.isInvalidating = true;
          CacheSystem.clear('FRIENDS');
          CacheSystem.clear('SIMILAR_USERS'); // Friends list affects similar users
          CacheSystem.clear('FRIEND_REQUESTS');
          CacheSystem.clear('ALL_USERS_BASIC');
          // Reset friends system initialization flag
          if (typeof FriendsDiscoverySystem !== 'undefined') {
            FriendsDiscoverySystem.isInitialized = false;
          }
          CacheSystem.isInvalidating = false;
        }
      },

      invalidateGroupsCache: () => {
        if (!CacheSystem.isInvalidating) {
          CacheSystem.isInvalidating = true;
          CacheSystem.clear('GROUPS');
          CacheSystem.isInvalidating = false;
        }
      },

      invalidateUserCache: () => {
        if (!CacheSystem.isInvalidating) {
          CacheSystem.isInvalidating = true;
          CacheSystem.clear('SIMILAR_USERS');
          CacheSystem.clear('USER_PROFILES');
          CacheSystem.isInvalidating = false;
        }
      },

      // Batch operations to reduce Firebase calls
      batchUpdate: async (operations) => {
        try {
          const { writeBatch } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const batch = writeBatch(getAuthManager().db);
          // Log batch start (without awaiting a promise)
          FirebaseWriteLogger.log('writeBatch', 'batch', { operations: operations.length }, null, null);

          operations.forEach(op => {
            if (op.type === 'set') {
              batch.set(op.ref, op.data);
            } else if (op.type === 'update') {
              batch.update(op.ref, op.data);
            } else if (op.type === 'delete') {
              batch.delete(op.ref);
            }
          });

          await batch.commit();
          console.log(`Batch operation completed: ${operations.length} operations`);
        } catch (error) {
          console.error('Batch operation failed:', error);
        }
      },

      // Pagination for large datasets
      getPaginatedData: async (collectionName, pageSize = 20, lastDoc = null) => {
        try {
          const { collection, query, orderBy, limit, startAfter, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          let q = query(collection(getAuthManager().db, collectionName), orderBy('createdAt'), limit(pageSize));

          if (lastDoc) {
            q = query(q, startAfter(lastDoc));
          }

          const snapshot = await wrapRead(getDocs(q), 'getDocs', collectionName, { pageSize, lastDoc: !!lastDoc });
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          return {
            data,
            lastDoc: snapshot.docs[snapshot.docs.length - 1],
            hasMore: snapshot.docs.length === pageSize
          };
        } catch (error) {
          console.error('Pagination error:', error);
          return { data: [], lastDoc: null, hasMore: false };
        }
      }
    };

    // Function to manage Firebase listeners based on current page
    function manageFirebaseListeners() {
      const currentPage = document.querySelector('.page:not(.hidden)').id;

      // Only initialize listeners for relevant pages to reduce reads
      if (currentPage === 'groups' && !realtimeListeners.groups) {
        initializeGroupUpdateListeners();
      } else if ((currentPage === 'friendship' || currentPage === 'dashboard') && !realtimeListeners.friendRequests) {
        initializeFriendRequestListeners();
      }
    }

    
    // Recommendation System
    const RecommendationSystem = {
      displayRecommendations: () => {
        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) return "";

        const recommendations = ActivitySystem.getRecommendations(
          personalityData.adjustmentFactor
        );
        const friends = []; // Fallback to empty array for now

        if (recommendations.length === 0) {
          if (friends.length === 0) {
            return `
          <div style="margin-bottom: 2rem;">
            <h3>No Recommendations Yet</h3>
            <p style="color: #666;">Add friends to get personalized recommendations based on places they've visited!</p>

          </div>
        `;
          } else {
            return `
          <div style="margin-bottom: 2rem;">
            <h3>No New Recommendations</h3>
            <p style="color: #666;">Your friends haven't shared new places recently. Check the community feed for more experiences!</p>
          </div>
        `;
          }
        }

        return `
      <div style="margin-bottom: 2rem;">
        <h3>Recommended For You (From Friends)</h3>
        <p style="color: #666; margin-bottom: 1rem;">Based on places your friends have visited and enjoyed</p>
        <div class="activity-grid">
          ${recommendations
            .slice(0, 4)
            .map(
              (rec) => `
            <div class="activity-card" style="border: 2px solid var(--secondary-color);">
                              <div style="background: var(--secondary-gradient); color: white; padding: 0.5rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-radius: 15px 15px 0 0;">
                <div style="font-weight: bold;">Recommended: ${rec.predictedScore.toFixed(
                1
              )}/10</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Confidence: ${(
                  rec.confidence * 100
                ).toFixed(0)}%</div>
              </div>
              <div class="activity-title">${rec.experience.name}</div>
              <div class="activity-category">${rec.experience.category} • ${rec.experience.location
                }</div>
              <div class="activity-details">
                ${rec.experience.description
                  ? `<p style="margin: 0.5rem 0; color: #666;">"${rec.experience.description}"</p>`
                  : ""
                }
                <div style="font-size: 0.9rem; color: #888; margin-top: 0.5rem;">
                  Social Intensity: ${rec.experience.socialIntensity.toFixed(
                  1
                )}/10 |
                  Noise Level: ${rec.experience.noiseLevel.toFixed(1)}/10 |
                  Crowd Size: ${rec.experience.crowdSize.toFixed(1)}/10
                </div>
              </div>
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                  Recommended by friends:
                </div>
                ${rec.predictions
                  .slice(0, 2)
                  .map(
                    (p) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; margin-bottom: 0.3rem;">
                    <span>${addCrownToPremiumUser(p.user.displayName, p.user.id)} (${p.user.personalityType})</span>
                    <span style="font-weight: bold;">${p.experience.adjustedScore}/10</span>
                  </div>
                `
                  )
                  .join("")}
                <div style="text-align: center; margin-top: 1rem;">
                  <button class="btn" style="font-size: 0.9rem; padding: 8px 16px;"
                          onclick="fillActivityForm('${rec.experience.name.replace(/'/g, "\\'")}', '${rec.experience.category.replace(/'/g, "\\'")}', '${rec.experience.location.replace(/'/g, "\\'")}', '${rec.experience.description ? rec.experience.description.replace(/'/g, "\\'") : ""}')">
                    Rate This Place
                  </button>
                </div>
              </div>  
            </div>
          `
            )
            .join("")}
        </div>
      </div>
    `;
      },
    };
    // Similar Users System
    const SimilarUsersSystem = {
      displaySimilarUsers: async () => {
        console.log('SimilarUsersSystem.displaySimilarUsers() called');
        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) {
          console.log('No personality data found, returning empty string');
          return "";
        }

        try {
          console.log('Finding similar users for adjustment factor:', personalityData.adjustmentFactor);
          const similarUsers = await ActivitySystem.findSimilarUsers(
            personalityData.adjustmentFactor
          );
          console.log('Found similar users:', similarUsers.length, similarUsers);

          // Get current friends
          console.log('Getting current friends...');
          const friends = await FriendsSystem.getFriends();
          const friendIds = friends.map(friend => friend.id);
          console.log('Current friends:', friends.length, friendIds);

          // Filter out users who are already friends
          const nonFriendUsers = similarUsers.filter(
            (user) => !friendIds.includes(user.id)
          );
          console.log('Non-friend users:', nonFriendUsers.length, nonFriendUsers);

          return `
      <div style="margin-bottom: 2rem;">
        <h3>Users Similar to You</h3>
        <p style="color: #666; margin-bottom: 1rem;">Connect with people who have similar social energy preferences</p>



        <div class="similar-users-grid">
          ${nonFriendUsers.length > 0
              ? nonFriendUsers
                .slice(0, 6)
                .map((user) => {
                  return `
              <div class="similar-user-card">
                <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                      ${user.avatar || user.displayName.charAt(0)}
                  </div>
                  <div style="text-align: left;">
                      <div style="font-weight: bold;">${addCrownToPremiumUser(user.displayName, user.id)}</div>
                      <div style="font-size: 0.8rem; color: var(--highlight);">${user.personalityType || 'Unknown'}</div>
                  </div>
                </div>
                <div class="similarity-score">
                    ${(user.similarityScore * 100).toFixed(0)}% Similar
                </div>    
                <div style="font-size: 0.8rem; color: #666; margin: 0.8rem 0;">
                    AF: ${user.adjustmentFactor.toFixed(2)}
                </div>
                  ${user.bio ? `<div style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem;">"${user.bio}"</div>` : ''}
                  <div style="text-align: center;">
                    ${(() => {
                      // Check pending status first
                      const hasPendingRequest = typeof FriendsDiscoverySystem !== 'undefined' &&
                        Array.isArray(FriendsDiscoverySystem.pendingRequests) &&
                        FriendsDiscoverySystem.pendingRequests.some(r => r.toUserId === user.id);

                      if (hasPendingRequest) {
                        return `<button class=\"btn\" data-pending-for=\"${user.id}\" style=\"font-size: 0.8rem; padding: 6px 12px; background: #fbbf24; color: #1f2937; border: 1px solid #f59e0b;\" onclick=\"FriendsDiscoverySystem.cancelPendingRequest('${user.id}')\"><i class=\"fas fa-clock\"></i> Pending</button>`;
                      } else {
                        return `<button class="btn" style="font-size: 0.8rem; padding: 6px 12px;" onclick="FriendsSystem.addFriend('${user.id}')">Add Friend</button>`;
                      }
                    })()}
                </div>
                </div>
              `;
                }).join("")
              : '<div style="grid-column: 1 / -1; color: #666; text-align: center; padding: 2rem;">No similar users found. Try expanding your search or check back later!</div>'
            }
                </div>
              </div>
            `;
        } catch (error) {
          console.error('Error displaying similar users:', error);
          return `
      <div style="margin-bottom: 2rem;">
        <h3>Users Similar to You</h3>
        <p style="color: #666; text-align: center; padding: 2rem;">Unable to load similar users at this time.</p>
      </div>
    `;
        }
      },
    };

    function updateDashboard() {
      const personalityData = DataLayer.load("personalityScore");
      const personalityType = DataLayer.load("personalityType");
      const currentUser = DataLayer.load("currentUser");

      console.log('updateDashboard called with:', { personalityData, personalityType, currentUser });

      // Check if user has completed personality assessment
      const hasCompletedAssessment = personalityData &&
        personalityType &&
        personalityData.adjustmentFactor !== undefined &&
        personalityType.type !== 'Not Set';

      console.log('hasCompletedAssessment:', hasCompletedAssessment);

      if (hasCompletedAssessment && DataLayer.exists("currentUser")) {
        document.getElementById("user-avatar").textContent =
          currentUser.avatar;
        document.getElementById(
          "welcome-message"
        ).innerHTML = `Welcome back, <strong>${currentUser.displayName}</strong>! You're a ${personalityType.type}`;

        const userExperiences = DataLayer.load("userExperiences", []);
        const groups = DataLayer.load("groups", []);

        // Set initial dashboard content without similar users
        document.getElementById("dashboard-content").innerHTML = `
      <div style="margin-bottom: 2rem;">
        <h2>Your Social Energy Profile</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${personalityData?.adjustmentFactor?.toFixed(2) || '0.00'}</div>
            <div class="stat-label">Adjustment Factor</div>
          </div>
          <div class="stat-card" onclick="showExperiencesModal()" style="cursor: pointer;">
            <div class="stat-value">${userExperiences.length}</div>
            <div class="stat-label">Experiences</div>
          </div>
          <div class="stat-card" onclick="showPage('groups')" style="cursor: pointer;">
            <div class="stat-value">${groups.length}</div>
            <div class="stat-label">Groups</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${personalityType.type}</div>
            <div class="stat-label">Personality Type</div>
          </div>
        </div>
        <p style="font-style: italic; color: #666; margin: 1.5rem 0; text-align: center;">"${personalityType?.description || 'You have a balanced approach to social energy.'}"</p>
        <div class="action-buttons">
          <button class="btn" onclick="showPage('activities')"><i class="fas fa-plus-circle"></i> Add Experience</button>
          <button class="btn btn-secondary" onclick="showPage('feed')"><i class="fas fa-users"></i> Explore Community</button>
          <button class="btn btn-info" onclick="getLocationBasedRecommendations()" style="background: var(--info-color);">
            <i class="fas fa-map-marker-alt"></i> Find Places Near Me
          </button>
        </div>
      </div>

              ${RecommendationSystem.displayRecommendations()}
      
      <div id="similar-users-container">
        <div style="text-align: center; padding: 2rem;">
          <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <p style="margin-top: 1rem; color: #666;">Loading similar users...</p>
        </div>
      </div>
    `;

        // Load similar users asynchronously
        SimilarUsersSystem.displaySimilarUsers()
          .then(similarUsersHtml => {
            const container = document.getElementById('similar-users-container');
            if (container) {
              container.innerHTML = similarUsersHtml;
            }
          })
          .catch(error => {
            console.error('Error loading similar users:', error);
            const container = document.getElementById('similar-users-container');
            if (container) {
              container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                  <p>Unable to load similar users at this time.</p>
                </div>
              `;
            }
          });
      } else {
        // User hasn't completed assessment yet
        document.getElementById("user-avatar").textContent = currentUser?.avatar || "?";
        document.getElementById("welcome-message").innerHTML =
          `Welcome, <strong>${currentUser?.displayName || 'User'}</strong>! Complete the personality assessment to get started.`;

        document.getElementById("dashboard-content").innerHTML = `
          <div style="margin-bottom: 2rem;">
            <h2>Get Started with Senergy</h2>
            <p style="padding: 1.2rem; text-align: center;">
              Take the personality assessment to discover your social energy preferences and get personalized recommendations.
            </p>
            <div class="action-buttons">
              <button class="btn" onclick="showPage('assessment')">
                <i class="fas fa-play-circle"></i> Start Assessment
              </button>
            </div>
          </div>
        `;
      }
    }

    // UI Management
  
    async function completeAssessment() {
      // Ensure personality data is properly loaded from Firebase if user is authenticated
      if (getCurrentUser() && getAuthManager()) {
        try {
          const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const userDoc = await getDoc(doc(getAuthManager().db, 'users', getCurrentUser().uid));

          if (userDoc.exists()) {
            const userData = userDoc.data();

            // Update local storage with Firebase data
            if (userData.adjustmentFactor !== undefined) {
              DataLayer.save('personalityScore', { adjustmentFactor: userData.adjustmentFactor });
              DataLayer.save('personalityType', { type: userData.personalityType });
            }

            // Update current user data
            let currentUser = DataLayer.load('currentUser') || {};
            currentUser.adjustmentFactor = userData.adjustmentFactor;
            currentUser.personalityType = userData.personalityType;
            currentUser.avatar = userData.avatar;
            DataLayer.save('currentUser', currentUser);

            console.log('Personality data synced from Firebase');
          }
        } catch (error) {
          console.error('Error syncing personality data from Firebase:', error);
        }
      }

      console.log('Completing assessment, redirecting to dashboard');

      // Update both dashboard and profile to ensure consistency
      updateDashboard();
      updateProfile();

      // Debug: Check what data is available
      const debugScores = DataLayer.load("personalityScore");
      const debugType = DataLayer.load("personalityType");
      const debugUser = DataLayer.load("currentUser");
      console.log('Debug data before dashboard:', { debugScores, debugType, debugUser });

      // Show success message
      NotificationSystem.show('Assessment completed successfully! Welcome to your personalized dashboard.', 'success');

      showPage("dashboard");
    }

    
    function closeNearbyModal() {
      const modal = document.getElementById("nearby-modal");
      if (modal) {
        modal.remove();
        // Remove any remaining event listeners
        document.removeEventListener('keydown', (event) => {
          if (event.key === 'Escape') closeNearbyModal();
        });
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
    }

    // Function to show detailed experience information
    function showExperienceDetails(userId, experienceName) {
      console.log('🔍 Looking for experience:', { userId, experienceName });

      // Find the experience in all experiences
      const allExperiences = ActivitySystem.getAllExperiences();
      console.log('🔍 All experiences:', allExperiences);

      // Try different matching strategies
      let experience = allExperiences.find(exp =>
        String(exp.userId) === String(userId) && exp.name === experienceName
      );

      // If not found, try partial name matching
      if (!experience) {
        experience = allExperiences.find(exp =>
          String(exp.userId) === String(userId) &&
          exp.name.toLowerCase().includes(experienceName.toLowerCase())
        );
      }

      // If still not found, try just by name
      if (!experience) {
        experience = allExperiences.find(exp =>
          exp.name === experienceName
        );
      }

      console.log('🔍 Found experience:', experience);

      if (!experience) {
        console.log('❌ Experience not found. Available experiences:', allExperiences.map(exp => ({ userId: exp.userId, name: exp.name })));
        NotificationSystem.show("Experience details not found.", "error");
        return;
      }

      const user = null; // Demo users removed - Firebase only
      const friends = FriendsSystem.getFriends();
      const isFriend = friends.some(friend => friend.id === userId);

      // Map the experience data to the expected format
      const mappedExperience = {
        ...experience,
        energyLevel: experience.responses?.energy || 0,
        socialSatisfaction: experience.responses?.social || 0,
        comfortLevel: experience.responses?.comfort || 0,
        overwhelmLevel: experience.responses?.overwhelm || 0,
        returnLikelihood: experience.responses?.return || 0
      };

      // Calculate confidence based on rating consistency
      const ratings = [
        mappedExperience.energyLevel,
        mappedExperience.socialSatisfaction,
        mappedExperience.comfortLevel,
        mappedExperience.overwhelmLevel,
        mappedExperience.returnLikelihood
      ];

      const averageRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
      const variance = ratings.reduce((sum, rating) => sum + Math.pow(rating - averageRating, 2), 0) / ratings.length;
      const confidence = Math.max(0.1, Math.min(1.0, 1 - (variance / 25))); // Higher variance = lower confidence

      mappedExperience.confidence = confidence;

      const modalHtml = `
        <div id="experience-details-modal" class="modal">
          <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeExperienceDetailsModal()">&times;</button>
            <div class="modal-header">
              <h2><i class="fas fa-star"></i> Experience Details</h2>
              <p style="margin: 0; color: #666;">Detailed rating and experience information</p>
            </div>
            <div class="modal-body">
              <!-- User Info Section -->
              <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${user ? user.avatar : '?'}
                  </div>
                  <div>
                    <div style="font-weight: bold; font-size: 1.1rem;">
                      ${addCrownToPremiumUser(user ? user.displayName : 'Unknown', userId)}
                      
                    </div>
                    <div style="font-size: 0.9rem; color: #666;">
                      ${user ? user.personalityType : 'Unknown Type'} • ${new Date(mappedExperience.timestamp).toLocaleDateString()}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Experience Basic Info -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h3 style="margin: 0 0 1rem 0; color: var(--primary-color);">${mappedExperience.name}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <strong>Category:</strong> ${mappedExperience.category}
                  </div>
                  <div>
                    <strong>Location:</strong> ${mappedExperience.location}
                  </div>
                  <div>
                    <strong>Overall Rating:</strong> 
                    <span style="font-weight: bold; color: ${mappedExperience.adjustedScore >= 7 ? '#4CAF50' : mappedExperience.adjustedScore >= 5 ? '#FF9800' : '#f44336'};">
                      ${mappedExperience.adjustedScore}/10
                    </span>
                  </div>
                  <div>
                    <strong>Confidence:</strong> ${(mappedExperience.confidence * 100).toFixed(0)}%
                  </div>
                </div>
                ${mappedExperience.description ? `
                  <div style="margin-top: 1rem; padding: 1rem; background: rgba(74, 144, 226, 0.05); border-radius: 8px;">
                    <strong>Description:</strong>
                    <p style="margin: 0.5rem 0 0 0; font-style: italic; color: #666;">"${mappedExperience.description}"</p>
                  </div>
                ` : ''}
              </div>

              <!-- Detailed Rating Breakdown -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                  <i class="fas fa-chart-bar"></i> Detailed Rating Breakdown
                </h4>
                
                <div style="display: grid; gap: 1rem;">
                  <!-- Energy Level -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Energy Level:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.energyLevel >= 7 ? '#4CAF50' : mappedExperience.energyLevel >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.energyLevel}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.energyLevel * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Social Satisfaction -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Social Satisfaction:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.socialSatisfaction >= 7 ? '#4CAF50' : mappedExperience.socialSatisfaction >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.socialSatisfaction}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.socialSatisfaction * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Comfort Level -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Comfort Level:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.comfortLevel >= 7 ? '#4CAF50' : mappedExperience.comfortLevel >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.comfortLevel}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.comfortLevel * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Overwhelm Level -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Overwhelm Level:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.overwhelmLevel >= 7 ? '#f44336' : mappedExperience.overwhelmLevel >= 5 ? '#FF9800' : '#4CAF50'};">
                        ${mappedExperience.overwhelmLevel}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.overwhelmLevel * 10}%;"></div>
                    </div>
                  </div>

                  <!-- Return Likelihood -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <strong>Return Likelihood:</strong>
                      <span style="font-weight: bold; color: ${mappedExperience.returnLikelihood >= 7 ? '#4CAF50' : mappedExperience.returnLikelihood >= 5 ? '#FF9800' : '#f44336'};">
                        ${mappedExperience.returnLikelihood}/10
                      </span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--secondary-gradient); height: 100%; width: ${mappedExperience.returnLikelihood * 10}%;"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Environment Metrics -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                  <i class="fas fa-users"></i> Environment Metrics
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <strong>Social Intensity:</strong> ${mappedExperience.socialIntensity.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Noise Level:</strong> ${mappedExperience.noiseLevel.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Crowd Size:</strong> ${mappedExperience.crowdSize.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Activity Type:</strong> ${mappedExperience.activityType || 'Not specified'}
                  </div>
                </div>
              </div>

              <!-- Personality Adjustment -->
              <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                  <i class="fas fa-brain"></i> Personality Adjustment
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <strong>Raw Score:</strong> ${mappedExperience.rawScore.toFixed(1)}/10
                  </div>
                  <div>
                    <strong>Adjustment Factor:</strong> ${user ? user.adjustmentFactor.toFixed(2) : 'Unknown'}
                  </div>
                  <div>
                    <strong>Personality Type:</strong> ${user ? user.personalityType : 'Unknown'}
                  </div>
                  <div>
                    <strong>Adjusted Score:</strong> 
                    <span style="font-weight: bold; color: ${mappedExperience.adjustedScore >= 7 ? '#4CAF50' : mappedExperience.adjustedScore >= 5 ? '#FF9800' : '#f44336'};">
                      ${mappedExperience.adjustedScore}/10
                    </span>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" onclick="closeExperienceDetailsModal(); fillActivityForm('${mappedExperience.name}', '${mappedExperience.category}', '${mappedExperience.location}', 'Found through experience details')">
                  <i class="fas fa-star"></i> Rate This Place Too
                </button>
                <button class="btn btn-secondary" onclick="closeExperienceDetailsModal();">
                  <i class="fas fa-times"></i> Close
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      addModalListeners("experience-details-modal", closeExperienceDetailsModal);
    }

    function closeExperienceDetailsModal() {
      const modal = document.getElementById("experience-details-modal");
      if (modal) {
        modal.remove();
      }
      document.body.classList.remove('modal-open');
    }

    // Helper function to get experience details from button data attributes
    function showExperienceDetailsFromButton(button) {
      const userId = button.getAttribute('data-user-id');
      const experienceName = button.getAttribute('data-experience-name');
      showExperienceDetails(userId, experienceName);
    }


    // Error handling wrapper
    function safeExecute(fn, errorMessage = "An error occurred") {
      try {
        return fn();
      } catch (error) {
        console.error(errorMessage, error);
        NotificationSystem.show(
          errorMessage + ". Please try again.",
          "error"
        );
        return null;
      }
    }

    // Data export functionality (for demo purposes)
    function exportUserData() {
      const userData = {
        personality: DataLayer.load("personalityScore"),
        personalityType: DataLayer.load("personalityType"),
        experiences: DataLayer.load("userExperiences", []),
        groups: DataLayer.load("groups", []),
        friends: DataLayer.load("friends", []),
        exportDate: new Date().toISOString(),
      };

      const dataStr = JSON.stringify(userData, null, 2);
      const dataBlob = new Blob([dataStr], { type: "application/json" });

      const link = document.createElement("a");
      link.href = URL.createObjectURL(dataBlob);
      link.download = "social-energy-data.json";
      link.click();
    }


    import {setCurrentUser,getCurrentUser} from './src/js/back-end/firebase/firebase-config.js';
    
    

   
    // Cursor-style login flow functions
    window.handleEmailContinue = async function () {
      const email = document.getElementById('login-email').value.trim();

      if (!email) {
        NotificationSystem.show('Please enter your email address.', 'warning');
        return;
      }

      if (!isValidEmail(email)) {
        NotificationSystem.show('Please enter a valid email address.', 'warning');
        return;
      }

      // Store email for password step
      window.loginEmail = email;

      // Show email in step 2
      document.getElementById('login-email-display').textContent = email;

      // Hide step 1, show step 2
      document.getElementById('login-step-1').style.display = 'none';
      document.getElementById('login-step-2').style.display = 'block';

      // Focus on password input
      setTimeout(() => {
        document.getElementById('login-password').focus();
      }, 100);
    }

    window.handlePasswordContinue = async function () {
      const password = document.getElementById('login-password').value;

      if (!password) {
        NotificationSystem.show('Please enter your password.', 'warning');
        return;
      }

      try {
        // Wait for Firebase to be initialized
        if (!getAuthManager()) {
          const initialized = await initializeFirebaseAuth();
          if (!initialized) {
            return;
          }
        }

        const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        await signInWithEmailAndPassword(getAuthManager().auth, window.loginEmail, password);
        NotificationSystem.show('Successfully signed in!', 'success');
      } catch (error) {
        console.error('Login error:', error);
        let message = 'Login failed. ';
        switch (error.code) {
          case 'auth/user-not-found':
            message += 'No account found with this email.';
            break;
          case 'auth/wrong-password':
            message += 'Incorrect password.';
            break;
          case 'auth/invalid-email':
            message += 'Invalid email address.';
            break;
          default:
            message += error.message;
        }
        NotificationSystem.show(message, 'error');
      }
    }

    window.backToEmailStep = function () {
      document.getElementById('login-step-2').style.display = 'none';
      document.getElementById('login-step-1').style.display = 'block';
      document.getElementById('login-password').value = '';
    }

    window.togglePasswordVisibility = function (inputId) {
      const input = document.getElementById(inputId);
      const toggle = input.parentElement.querySelector('.password-toggle-btn i');

      if (input.type === 'password') {
        input.type = 'text';
        toggle.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        toggle.className = 'fas fa-eye';
      }
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }



    window.handleGitHubSignIn = async function () {
      try {
        // Wait for Firebase to be initialized
        if (!getAuthManager()) {
          const initialized = await initializeFirebaseAuth();
          if (!initialized) {
            return;
          }
        }

        const { GithubAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { doc, setDoc, getDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const provider = new GithubAuthProvider();
        const result = await signInWithPopup(getAuthManager().auth, provider);
        const user = result.user;

        // Check if this is a new user
        const userDoc = await wrapRead(getDoc(doc(getAuthManager().db, 'users', user.uid)), 'getDoc', `users/${user.uid}`, {});

        if (!userDoc.exists()) {
          // Create new user profile
          const userData = {
            id: user.uid,
            username: user.email.split('@')[0], // Use email prefix as username
            displayName: user.displayName || user.email.split('@')[0],
            email: user.email,
            bio: '',
            avatar: user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase(),
            adjustmentFactor: 0, // Default neutral
            personalityType: 'Neutral',
            isPremium: false,
            location: null,
            isOnline: true,
            lastSeen: serverTimestamp(),
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };

          await wrapWrite(
            setDoc(doc(getAuthManager().db, 'users', user.uid), userData),
            'setDoc',
            `users/${user.uid}`,
            { created: true }
          );
          NotificationSystem.show('Account created successfully!', 'success');
        }

      } catch (error) {
        console.error('GitHub sign-in error:', error);
        let message = 'GitHub sign-in failed. ';
        switch (error.code) {
          case 'auth/popup-closed-by-user':
            message = 'Sign-in was cancelled.';
            break;
          case 'auth/popup-blocked':
            message = 'Sign-in popup was blocked. Please allow popups for this site.';
            break;
          default:
            message += error.message;
        }
        NotificationSystem.show(message, 'error');
      }
    }

    // Handle Google Sign In
    window.handleGoogleSignIn = async function () {
      try {
        // Wait for Firebase to be initialized
        if (!getAuthManager()) {
          const initialized = await initializeFirebaseAuth();
          if (!initialized) {
            return;
          }
        }

        const { GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { doc, setDoc, getDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(getAuthManager().auth, provider);
        const user = result.user;

        // Check if this is a new user
        const userDoc = await wrapRead(getDoc(doc(getAuthManager().db, 'users', user.uid)), 'getDoc', `users/${user.uid}`, {});

        if (!userDoc.exists()) {
          // Create new user profile
          const userData = {
            id: user.uid,
            username: user.email.split('@')[0], // Use email prefix as username
            displayName: user.displayName || user.email.split('@')[0],
            email: user.email,
            bio: '',
            avatar: user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase(),
            adjustmentFactor: 0, // Default neutral
            personalityType: 'Neutral',
            isPremium: false,
            location: null,
            isOnline: true,
            lastSeen: serverTimestamp(),
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };

          await wrapWrite(
            setDoc(doc(getAuthManager().db, 'users', user.uid), userData),
            'setDoc',
            `users/${user.uid}`,
            { created: true }
          );
          NotificationSystem.show('Account created successfully!', 'success');
        }

      } catch (error) {
        console.error('Google sign-in error:', error);
        let message = 'Google sign-in failed. ';
        switch (error.code) {
          case 'auth/popup-closed-by-user':
            message = 'Sign-in was cancelled.';
            break;
          case 'auth/popup-blocked':
            message = 'Sign-in popup was blocked. Please allow popups for this site.';
            break;
          default:
            message += error.message;
        }
        NotificationSystem.show(message, 'error');
      }
    }

    // Handle user logout
    window.handleLogout = async function () {
      try {
        // Cleanup real-time listeners before logout
        cleanupRealtimeListeners();



        if (getAuthManager() && getAuthManager().auth) {
          const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          await signOut(getAuthManager().auth);
          NotificationSystem.show('Successfully signed out!', 'success');
        }
      } catch (error) {
        console.error('Logout error:', error);
        NotificationSystem.show('Error signing out. Please try again.', 'error');
      }
    }

    // Form switching functions
    window.showRegisterForm = function () {
      document.getElementById('login-form-container').style.display = 'none';
      document.getElementById('register-form-container').style.display = 'block';
    }

    window.showLoginForm = function () {
      // Hide register form
      document.getElementById('register-form-container').style.display = 'none';

      // Show login form container
      document.getElementById('login-form-container').style.display = 'block';

      // Show login step 1, hide step 2 and forgot password
      document.getElementById('login-step-1').style.display = 'block';
      document.getElementById('login-step-2').style.display = 'none';
      document.getElementById('forgot-password-container').style.display = 'none';
    }

    // Handle first step of registration (name and email)
    window.handleRegisterContinue = async function () {
      const firstName = document.getElementById('register-firstName').value.trim();
      const lastName = document.getElementById('register-lastName').value.trim();
      const email = document.getElementById('register-email').value.trim();

      if (!firstName || !lastName) {
        NotificationSystem.show('Please fill in your first and last name.', 'warning');
        return;
      }

      // Enhanced email validation
      const emailValidation = validateRegistrationEmail(email);
      if (!emailValidation.valid) {
        NotificationSystem.show(emailValidation.message, 'warning');
        return;
      }

      // Store the data for the next step
      window.registerData = {
        firstName: firstName,
        lastName: lastName,
        email: email
      };

      // Show password step
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('register-password-step').style.display = 'block';
      document.getElementById('register-email-display').textContent = email;
    }

    // Handle second step of registration (password)
    window.handleRegisterPasswordContinue = async function () {
      const password = document.getElementById('register-password').value;

      if (!password) {
        NotificationSystem.show('Password is required.', 'warning');
        return;
      }

      if (password.length < 8) {
        NotificationSystem.show('Password must be at least 8 characters long.', 'warning');
        return;
      }

      // Check password strength
      const strengthFill = document.getElementById('password-strength-fill');
      if (strengthFill.classList.contains('strength-weak')) {
        NotificationSystem.show('Please choose a stronger password.', 'warning');
        return;
      }

      // Get stored data from first step
      const { firstName, lastName, email } = window.registerData || {};

      if (!firstName || !lastName || !email) {
        NotificationSystem.show('Please complete the first step.', 'warning');
        return;
      }

      try {
        // Wait for Firebase to be initialized
        if (!getAuthManager()) {
          const initialized = await initializeFirebaseAuth();
          if (!initialized) {
            return;
          }
        }

        const { createUserWithEmailAndPassword, updateProfile, sendEmailVerification } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Create Firebase auth user
        const userCredential = await createUserWithEmailAndPassword(getAuthManager().auth, email, password);
        const user = userCredential.user;

        // Send email verification with action code settings
        const actionCodeSettings = {
          url: window.location.origin + '/pitch/index.html',
          handleCodeInApp: false
        };

        await sendEmailVerification(user, actionCodeSettings);

        // Create display name from first and last name
        const displayName = `${firstName} ${lastName}`;
        const username = `${firstName.toLowerCase()}${lastName.toLowerCase()}${Math.floor(Math.random() * 1000)}`;

        // Update display name
        await updateProfile(user, { displayName });

        // Create user profile in Firestore
        const userProfile = {
          id: user.uid,
          username: username,
          displayName: displayName,
          firstName: firstName,
          lastName: lastName,
          email: email,
          bio: '',
          avatar: displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2),
          adjustmentFactor: 0.0, // Will be set after personality assessment
          personalityType: 'Not Set',
          isPremium: false,
          isOnline: true,
          emailVerified: false,
          lastSeen: serverTimestamp(),
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        await wrapWrite(
          setDoc(doc(getAuthManager().db, 'users', user.uid), userProfile),
          'setDoc',
          `users/${user.uid}`,
          { profileCreated: true }
        );

        // Show email verification modal
        showEmailVerificationModal(email);
      } catch (error) {
        console.error('Registration error:', error);
        let message = 'Registration failed. ';
        switch (error.code) {
          case 'auth/email-already-in-use':
            message += 'An account with this email already exists.';
            break;
          case 'auth/weak-password':
            message += 'Password should be at least 6 characters.';
            break;
          case 'auth/invalid-email':
            message += 'Invalid email address.';
            break;
          default:
            message += error.message;
        }
        NotificationSystem.show(message, 'error');
      }
    }

    // Go back to first step of registration
    function backToRegisterStep() {
      document.getElementById('register-password-step').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
    }

    // Handle Enter key press on first step of registration
    function handleRegisterKeyPress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleRegisterContinue();
      }
    }

    // Handle Enter key press on password step of registration
    function handleRegisterPasswordKeyPress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleRegisterPasswordContinue();
      }
    }

    // Handle Enter key press on forgot password form
    function handleForgotPasswordKeyPress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleForgotPassword();
      }
    }
    // Show email verification modal
    function showEmailVerificationModal(email) {
      const modalHtml = `
        <div id="email-verification-modal" class="modal">
          <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div class="modal-header">
              <h2 style="color: var(--primary-color); margin-bottom: 0.5rem;">
                <i class="fas fa-envelope" style="color: var(--secondary-color); margin-right: 0.5rem;"></i>
                Verify Your Email
              </h2>
              <p style="color: var(--text-color); margin: 0;">We've sent a verification link to your email</p>
            </div>
            
            <div class="modal-body" style="padding: 2rem 1rem;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 15px; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">📧</div>
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.3rem;">Check Your Email</h3>
                <p style="margin: 0; opacity: 0.9; font-size: 1rem;">${email}</p>
              </div>
              
              <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary-color);">
                <h4 style="margin: 0 0 1rem 0; color: var(--primary-color);">
                  <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                  What's Next?
                </h4>
                <ul style="text-align: left; margin: 0; padding-left: 1.5rem; color: var(--text-color);">
                  <li style="margin-bottom: 0.5rem;">Open the email we just sent you</li>
                  <li style="margin-bottom: 0.5rem;">Click the "Verify Email" button in the email</li>
                  <li style="margin-bottom: 0.5rem;">Come back here and click "I've Verified My Email"</li>
                </ul>
              </div>
              
              <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button type="button" class="btn" onclick="resendVerificationEmail()" style="background: var(--secondary-color); color: white;">
                  <i class="fas fa-redo" style="margin-right: 0.5rem;"></i>
                  Resend Email
                </button>
                <button type="button" class="btn btn-secondary" onclick="checkEmailVerification()">
                  <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
                  I've Verified My Email
                </button>
              </div>
            </div>
            
            <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee;">
              <p style="margin: 0; color: var(--secondary-color); font-size: 0.9rem;">
                <i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>
                Email verification helps keep your account secure
              </p>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Add modal listeners
      const modal = document.getElementById('email-verification-modal');
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeEmailVerificationModal();
        }
      });
    }

    // Close email verification modal
    function closeEmailVerificationModal() {
      const modal = document.getElementById('email-verification-modal');
      if (modal) {
        modal.remove();
      }
    }

    // Resend verification email
    async function resendVerificationEmail() {
      try {
        const { sendEmailVerification } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

        if (getAuthManager().auth.currentUser) {
          await sendEmailVerification(getAuthManager().auth.currentUser);
          NotificationSystem.show('Verification email sent!', 'success');
        } else {
          NotificationSystem.show('Please sign in first.', 'error');
        }
      } catch (error) {
        console.error('Error sending verification email:', error);
        NotificationSystem.show('Failed to send verification email.', 'error');
      }
    }

    // Check email verification status
    async function checkEmailVerification() {
      try {
        if (getAuthManager().auth.currentUser) {
          await getAuthManager().auth.currentUser.reload();

          if (getAuthManager().auth.currentUser.emailVerified) {
            // Update Firestore
            const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            await wrapWrite(
              updateDoc(doc(getAuthManager().db, 'users', getAuthManager().auth.currentUser.uid), {
                emailVerified: true,
                updatedAt: new Date()
              }),
              'updateDoc',
              `users/${getAuthManager().auth.currentUser.uid}`,
              { emailVerified: true }
            );

            closeEmailVerificationModal();
            NotificationSystem.show('Email verified successfully! Welcome to Catalyst!', 'success');

            // Redirect to dashboard
            showPage('dashboard');
          } else {
            NotificationSystem.show('Please check your email and click the verification link first.', 'warning');
          }
        } else {
          NotificationSystem.show('Please sign in first.', 'error');
        }
      } catch (error) {
        console.error('Error checking verification:', error);
        NotificationSystem.show('Failed to check verification status.', 'error');
      }
    }

    // Show forgot password form
    function showForgotPassword() {
      // Hide all login steps
      document.getElementById('login-step-1').style.display = 'none';
      document.getElementById('login-step-2').style.display = 'none';

      // Show forgot password form
      document.getElementById('forgot-password-container').style.display = 'block';
    }

    // Back to login step
    function backToLoginStep() {
      // Hide forgot password form
      document.getElementById('forgot-password-container').style.display = 'none';

      // Show login form (step 1)
      document.getElementById('login-step-1').style.display = 'block';
      document.getElementById('login-step-2').style.display = 'none';
    }

    // Handle forgot password
    window.handleForgotPassword = async function () {
      const email = document.getElementById('forgot-email').value.trim();

      if (!email) {
        NotificationSystem.show('Please enter your email address.', 'warning');
        return;
      }

      if (!isValidEmail(email)) {
        NotificationSystem.show('Please enter a valid email address.', 'warning');
        return;
      }

      try {
        if (!getAuthManager()) {
          const initialized = await initializeFirebaseAuth();
          if (!initialized) {
            return;
          }
        }

        console.log('Sending password reset email to:', email);
        console.log('Auth manager:', getAuthManager());

        const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

        // Add action code settings for better email delivery
        const actionCodeSettings = {
          url: window.location.origin + '/pitch/index.html',
          handleCodeInApp: false
        };

        await sendPasswordResetEmail(getAuthManager().auth, email, actionCodeSettings);

        console.log('Password reset email sent successfully');
        NotificationSystem.show('Password reset link sent to your email! Check your inbox and spam folder.', 'success');
        backToLoginStep();
      } catch (error) {
        console.error('Password reset error:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);

        let message = 'Failed to send reset link. ';
        switch (error.code) {
          case 'auth/user-not-found':
            message += 'No account found with this email address.';
            break;
          case 'auth/invalid-email':
            message += 'Invalid email address.';
            break;
          case 'auth/too-many-requests':
            message += 'Too many requests. Please try again later.';
            break;
          case 'auth/network-request-failed':
            message += 'Network error. Please check your connection.';
            break;
          default:
            message += `Error: ${error.message}`;
        }
        NotificationSystem.show(message, 'error');
      }
    }

    // Check password strength
    function checkPasswordStrength(password) {
      const strengthFill = document.getElementById('password-strength-fill');
      const strengthText = document.getElementById('password-strength-text');

      if (!password) {
        strengthFill.className = 'password-strength-fill';
        strengthText.textContent = 'Password strength';
        strengthText.className = 'password-strength-text';
        return;
      }

      let score = 0;
      let feedback = [];

      // Length check
      if (password.length >= 8) {
        score += 1;
      } else {
        feedback.push('At least 8 characters');
      }

      // Lowercase check
      if (/[a-z]/.test(password)) {
        score += 1;
      } else {
        feedback.push('Lowercase letter');
      }

      // Uppercase check
      if (/[A-Z]/.test(password)) {
        score += 1;
      } else {
        feedback.push('Uppercase letter');
      }

      // Number check
      if (/\d/.test(password)) {
        score += 1;
      } else {
        feedback.push('Number');
      }

      // Special character check
      if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        score += 1;
      } else {
        feedback.push('Special character');
      }

      // Determine strength level
      let strength, textClass, fillClass;

      if (score <= 1) {
        strength = 'Weak';
        textClass = 'text-weak';
        fillClass = 'strength-weak';
      } else if (score <= 2) {
        strength = 'Fair';
        textClass = 'text-fair';
        fillClass = 'strength-fair';
      } else if (score <= 3) {
        strength = 'Good';
        textClass = 'text-good';
        fillClass = 'strength-good';
      } else {
        strength = 'Strong';
        textClass = 'text-strong';
        fillClass = 'strength-strong';
      }

      // Update UI
      strengthFill.className = `password-strength-fill ${fillClass}`;
      strengthText.textContent = `${strength} password`;
      strengthText.className = `password-strength-text ${textClass}`;
    }

  

    // Enhanced email validation for registration
    function validateRegistrationEmail(email) {
      if (!email) {
        return { valid: false, message: 'Email is required.' };
      }

      if (!isValidEmail(email)) {
        return { valid: false, message: 'Please enter a valid email address.' };
      }

      // Check for common disposable email domains
      const disposableDomains = [
        'tempmail.org', 'guerrillamail.com', 'mailinator.com', '10minutemail.com',
        'throwaway.email', 'temp-mail.org', 'sharklasers.com', 'getairmail.com'
      ];

      const domain = email.split('@')[1];
      if (disposableDomains.includes(domain)) {
        return { valid: false, message: 'Please use a valid email address (no temporary emails).' };
      }

      return { valid: true, message: '' };
    }

    // Update user location in Firebase
    async function updateUserLocation(location) {
      console.log('updateUserLocation', location);
      if (!getCurrentUser() || !getAuthManager() || !location) return;

      // Validate location object
      if (!location.lat || !location.lng ||
        typeof location.lat !== 'number' ||
        typeof location.lng !== 'number') {
        console.warn('Invalid location data:', location);
        return;
      }

      try {
        const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        await wrapWrite(
          updateDoc(doc(getAuthManager().db, 'users', getCurrentUser().uid), {
            location: {
              lat: location.lat,
              lng: location.lng,
              accuracy: location.accuracy || null
            },
            lastLocationUpdate: serverTimestamp()
          }),
          'updateDoc',
          `users/${getCurrentUser().uid}`,
          { location }
        );

        console.log(`User location updated: ${location.lat}, ${location.lng}`);
      } catch (error) {
        console.error('Error updating user location:', error);
      }
    }


    // Profile editing functionality
    function showEditProfileModal() {
      const currentUser = DataLayer.load('currentUser');

      const modalHtml = `
        <div id="edit-profile-modal" class="modal">
          <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
            <div class="modal-header">
              <h2>Edit Profile</h2>
            </div>
            <div class="modal-body">
              <form id="edit-profile-form" onsubmit="handleEditProfile(event)">
                <div class="form-group">
                  <label for="edit-display-name">Display Name *</label>
                  <input type="text" id="edit-display-name" class="form-control" value="${currentUser?.displayName || ''}" required>
                </div>
                <div class="form-group">
                  <label for="edit-username">Username *</label>
                  <input type="text" id="edit-username" class="form-control" value="${currentUser?.username || ''}" required>
                </div>
                <div class="form-group">
                  <label for="edit-bio">Bio</label>
                  <textarea id="edit-bio" class="form-control" rows="3" placeholder="Tell us about yourself...">${currentUser?.bio || ''}</textarea>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                  <button type="submit" class="btn">Save Changes</button>
                  <button type="button" class="btn btn-secondary" onclick="closeEditProfileModal()">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
      addModalListeners("edit-profile-modal", closeEditProfileModal);
    }

    function closeEditProfileModal() {
      const modal = document.getElementById("edit-profile-modal");
      if (modal) modal.remove();
      document.body.classList.remove('modal-open');
    }

    async function handleEditProfile(event) {
      event.preventDefault();

      const displayName = document.getElementById('edit-display-name').value.trim();
      const username = document.getElementById('edit-username').value.trim();
      const bio = document.getElementById('edit-bio').value.trim();

      if (!displayName || !username) {
        NotificationSystem.show('Display name and username are required.', 'error');
        return;
      }

      try {
        const currentUser = DataLayer.load('currentUser');
        const updatedUser = {
          ...currentUser,
          displayName,
          username,
          bio: bio || null,
          avatar: displayName.charAt(0).toUpperCase()
        };

        // Update local data
        DataLayer.save('currentUser', updatedUser);

        // Update Firebase if authenticated
        if (getCurrentUser() && getAuthManager()) {
          const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          await updateDoc(doc(getAuthManager().db, 'users', getCurrentUser().uid), {
            displayName,
            username,
            bio: bio || null,
            avatar: displayName.charAt(0).toUpperCase(),
            updatedAt: serverTimestamp()
          });
        }

        closeEditProfileModal();
        NotificationSystem.show('Profile updated successfully!', 'success');

        // Refresh profile display
        updateProfile();
        updateDashboard();
      } catch (error) {
        console.error('Error updating profile:', error);
        NotificationSystem.show('Failed to update profile. Please try again.', 'error');
      }
    }

    

    // Comprehensive Firebase update function
    async function updateFromFirebase() {
      if (!getCurrentUser() || !getAuthManager()) return;

      try {
        const { collection, query, where, getDocs, getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Update user profile from Firebase
        const userDoc = await getDoc(doc(getAuthManager().db, 'users', getCurrentUser().uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const currentUser = DataLayer.load('currentUser') || {};

          // Update current user data
          const updatedUser = {
            ...currentUser,
            ...userData,
            id: getCurrentUser().uid
          };

          DataLayer.save('currentUser', updatedUser);
          console.log('User profile updated from Firebase');
        }

        // Load experiences from Firebase
        const experiencesCollection = collection(getAuthManager().db, 'experiences');
        const experiencesQuery = query(experiencesCollection, where('userId', '==', getCurrentUser().uid));
        const experiencesSnapshot = await getDocs(experiencesQuery);

        const userExperiences = [];
        experiencesSnapshot.forEach((doc) => {
          const experienceData = doc.data();
          userExperiences.push({
            id: experienceData.id || doc.id, // Preserve original ID if it exists, otherwise use Firebase doc ID
            firebaseId: doc.id, // Store Firebase document ID separately
            ...experienceData,
            timestamp: experienceData.createdAt?.toDate?.() || new Date()
          });
        });

        DataLayer.save('userExperiences', userExperiences);
        console.log('Experiences loaded from Firebase:', userExperiences.length);

        // Update FriendsDiscoverySystem if it exists
        if (typeof FriendsDiscoverySystem !== 'undefined') {
          await FriendsDiscoverySystem.loadAllUsersOptimized();
          await FriendsDiscoverySystem.loadCurrentFriends();
          await FriendsDiscoverySystem.loadFriendRequests();
          await FriendsDiscoverySystem.loadPendingRequests();
          FriendsDiscoverySystem.displayUsers();
        }

        // Update UI if on relevant pages
        if (document.getElementById('dashboard-content')) {
          updateDashboard();
        }
        if (document.getElementById('profile-content')) {
          updateProfile();
        }
        if (document.getElementById('feed-content')) {
          FeedSystem.displayFeed();
        }

        console.log('Firebase update completed');
      } catch (error) {
        console.error('Error updating from Firebase:', error);
      }
    }

    // Enhanced Friends System with Firebase
    const FirebaseFriendsSystem = {
      async addFriend(userId) {
        if (!getCurrentUser()) {
          NotificationSystem.show('Please sign in to add friends.', 'warning');
          return false;
        }

        try {
          const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          // Create friend request
          const requestData = {
            fromUserId: getCurrentUser().uid,
            toUserId: userId,
            status: 'pending',
            createdAt: serverTimestamp()
          };

          await addDoc(collection(getAuthManager().db, 'friendRequests'), requestData);

          NotificationSystem.show('Friend request sent!', 'success');
          return true;
        } catch (error) {
          console.error('Error adding friend:', error);
          NotificationSystem.show('Failed to send friend request.', 'error');
          return false;
        }
      },

      async getFriends() {
        if (!getCurrentUser()) return [];

        try {
          const { collection, query, where, getDocs, getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const friendsCollection = collection(getAuthManager().db, 'friends');
          const queries = [
            query(friendsCollection, where('user1Id', '==', getCurrentUser().uid)),
            query(friendsCollection, where('user2Id', '==', getCurrentUser().uid))
          ];

          const friends = [];
          const friendIds = new Set();

          for (const q of queries) {
            const querySnapshot = await getDocs(q);

            for (const docSnap of querySnapshot.docs) {
              const friendshipData = docSnap.data();
              const friendId = friendshipData.user1Id === getCurrentUser().uid
                ? friendshipData.user2Id
                : friendshipData.user1Id;

              if (!friendIds.has(friendId)) {
                friendIds.add(friendId);

                const friendDoc = await getDoc(doc(getAuthManager().db, 'users', friendId));
                if (friendDoc.exists()) {
                  friends.push({
                    id: friendDoc.id,
                    ...friendDoc.data()
                  });
                }
              }
            }
          }

          return friends;
        } catch (error) {
          console.error('Error getting friends:', error);
          return [];
        }
      },

      async isFriend(userId) {
        if (!getCurrentUser()) return false;

        try {
          const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const friendsCollection = collection(getAuthManager().db, 'friends');
          const queries = [
            query(friendsCollection, where('user1Id', '==', getCurrentUser().uid), where('user2Id', '==', userId)),
            query(friendsCollection, where('user1Id', '==', userId), where('user2Id', '==', getCurrentUser().uid))
          ];

          for (const q of queries) {
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
              return true;
            }
          }

          return false;
        } catch (error) {
          console.error('Error checking friendship:', error);
          return false;
        }
      }
    };


  </script>
  <script type="module" src="src/js/main.js"></script>
</body>

</html>