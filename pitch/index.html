<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Senergy</title>
  <link rel="icon" href="logo-icon-blue.png" type="image/png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #1f3b73;
      --primary-color-hover: #16305f;

      --secondary-color: #4a90e2;
      --secondary-color-hover: #3b7dd3;
      --background-color: #ffffff;
      --background-alt-color: #fafafa;

      --text-color: #1a1a1a;
      --muted-text-color: #555555; 
      --inverted-text-color: #ffffff;

      --border-color: #e0e0e0;            

      --primary-gradient: linear-gradient(135deg, #1f3b73, #4a90e2); 
      --secondary-gradient: linear-gradient(135deg, #4a90e2, #a0c8f0);
      --accent-gradient: linear-gradient(135deg, #7bede7, #7971f3);
      --background-gradient: linear-gradient(180deg, #ffffff, #fafafa);

      --shadow-small: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-large: 0 10px 15px rgba(0, 0, 0, 0.15);

      --border-radius-small: 4px;
      --border-radius-medium: 8px;
      --border-radius-large: 12px;

      --success-color: #27ae60;
      --error-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #3498db;

      --transition: all 0.3s ease;
      --blue-bg: rgba(74, 144, 226, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", "Inter", -apple-system, BlinkMacSystemFont,
        sans-serif;
      background: var(--background-color);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Modern navbar */
    .navbar {
      background: var(--background-color);
      padding: 1.2rem 2rem;
      margin: 2rem 0;
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-medium);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 20px;
      z-index: 100;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 800;

      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
      list-style: none;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--text-color);
      font-weight: 500;
      transition: var(--transition);
      position: relative;
      padding: 8px 0;
      font-size: 1rem;
    }

    .nav-links a::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 3px;
      background: var(--accent-gradient);
      border-radius: var(--border-radius-small);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(-50%);
    }

    .nav-links a:hover {
      color: var(--secondary-color);
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    .nav-links a.active {
      color: var(--secondary-color);
      font-weight: 600;
    }

    .nav-links a.active::after {
      width: 100%;
    }

    /* Card styling */
    .card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 2.5rem;
      margin-bottom: 2.5rem;
      box-shadow: var(--shadow-medium);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-large);
    }

    .card-header {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .card-header h2 {
      font-size: 1.8rem;
      color: var(--text-color);
      margin-bottom: 0.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .card-header p {
      color: var(--muted-text-color);
      max-width: 700px;
      margin: 0 auto;
    }

    .hidden {
      display: none;
    }

    /* Buttons */
    .btn {
      background: var(--primary-gradient);
      color: var(--inverted-text-color);
      border: none;
      padding: 14px 28px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow-small);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
      filter: brightness(1.1);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--background-alt-color);
      color: var(--text-color);
      border: 2px solid var(--border-color);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: var(--border-color);
      transform: translateY(-3px);
      box-shadow: var(--shadow-small);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--error-color) 0%, #c0392b 100%);
      color: var(--inverted-text-color);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color) 0%, #2ecc71 100%);
      color: var(--inverted-text-color);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info-color) 0%, #2980b9 100%);
      color: var(--inverted-text-color);
    }

    /* Personality assessment */
    .question-container {
      margin-bottom: 2.5rem;
      padding: 1.5rem;
      border-radius: var(--border-radius-large);
      background: var(--blue-bg);
    }

    .question-text {
      font-size: 1.3rem;
      margin-bottom: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
      text-align: center;
    }

    .scale-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0;
    }

    .scale-labels {
      display: flex;
      justify-content: space-between;
      width: 100%;
      font-size: 0.95rem;
      color: var(--muted-text-color);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .radio-group {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .radio-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      padding: 10px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .radio-item:hover {
      background: rgba(74, 144, 226, 0.1);
      transform: translateY(-5px);
      box-shadow: var(--shadow-small);
    }

    .radio-item input[type="radio"] {
      appearance: none;
      width: 24px;
      height: 24px;
      border: 2px solid var(--secondary-color);
      border-radius: 50%;
      position: relative;
      cursor: pointer;
      transition: var(--transition);
    }

    .radio-item input[type="radio"]:checked {
      background: var(--secondary-color);
    }

    .radio-item input[type="radio"]:checked::after {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--inverted-text-color);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .radio-item label {
      margin-top: 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--secondary-color);
    }

    .progress-container {
      margin: 2rem 0;
      padding: 0 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: rgba(74, 144, 226, 0.2);
      border-radius: var(--border-radius-small);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--secondary-gradient);
      border-radius: var(--border-radius-small);
      transition: width 0.5s ease;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--muted-text-color);
      font-weight: 500;
    }

    /* Results page */
    .personality-result {
      text-align: center;
      padding: 2rem;
    }

    .personality-score {
      font-size: 4rem;
      font-weight: 800;
      margin: 1.5rem 0;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .personality-type {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      font-weight: 700;
      color: var(--text-color);
    }

    .personality-description {
      max-width: 600px;
      margin: 0 auto 2rem;
      font-size: 1.1rem;
      color: var(--muted-text-color);
      line-height: 1.7;
    }

    /* Activity cards */
    .activity-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.8rem;
      margin-top: 2rem;
    }

    .activity-card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      box-shadow: var(--shadow-small);
      transition: var(--transition);
      cursor: pointer;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    .activity-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-large);
      border-color: var(--secondary-color);
    }

    .activity-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    .activity-category {
      color: var(--secondary-color);
      font-size: 0.95rem;
      margin-bottom: 1rem;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .activity-details {
      margin-bottom: 1.2rem;
      color: var(--muted-text-color);
      flex-grow: 1;
    }

    .rating-section {
      border-top: 1px solid var(--border-color);
      padding-top: 1.2rem;
      margin-top: 1.2rem;
    }

    .rating-questions {
      margin-bottom: 1.2rem;
    }

    .rating-question {
      margin-bottom: 1.5rem;
    }

    .rating-question label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 500;
      color: var(--text-color);
    }

    .rating-slider {
      width: 100%;
      height: 8px;
      border-radius: var(--border-radius-small);
      background: var(--border-color);
      outline: none;
      appearance: none;
    }

    .rating-slider::-webkit-slider-thumb {
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--secondary-gradient);
      cursor: pointer;
      box-shadow: var(--shadow-small);
      border: 2px solid var(--inverted-text-color);
    }

    .rating-slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary-gradient);
      cursor: pointer;
      box-shadow: var(--shadow-small);
      border: 2px solid var(--inverted-text-color);
    }

    .slider-value {
      text-align: center;
      font-weight: 700;
      color: var(--muted-text-color);
      margin-top: 0.8rem;
      font-size: 1.1rem;
    }

    .final-score {
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
      padding: 1.2rem;
      background: var(--primary-gradient);
      color: var(--inverted-text-color);
      border-radius: var(--border-radius-medium);
      margin-top: 1.5rem;
      box-shadow: var(--shadow-small);
    }

    /* User info */
    .user-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2.5rem;
      background: var(--blue-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius-large);
    }

    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--secondary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--inverted-text-color);
      font-size: 1.8rem;
      font-weight: 700;
      box-shadow: var(--shadow-small);
    }

    .welcome-text {
      font-size: 1.3rem;
      color: var(--text-color);
      font-weight: 500;
    }

    .welcome-text strong {
      font-weight: 700;
      color: var(--primary-color);
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.8rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .form-control {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-medium);
      font-size: 1rem;
      transition: var(--transition);
      background: var(--background-color);
      color: var(--text-color);
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(31, 59, 115, 0.2);
    }

    .form-control::placeholder {
      color: var(--muted-text-color);
    }

    .form-control select {
      cursor: pointer;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 120px;
    }

    /* Feed items */
    .feed-item {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      margin-bottom: 1.8rem;
      box-shadow: var(--shadow-small);
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .feed-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-medium);
    }

    .feed-header {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      margin-bottom: 1.2rem;
    }

    .feed-avatar {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--inverted-text-color);
      font-size: 1.3rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .feed-user-info h4 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.1rem;
    }

    .feed-user-info .personality-type {
      font-size: 0.85rem;
      color: var(--primary-color);
      margin: 0.3rem 0 0;
      font-weight: 600;
    }

    .feed-timestamp {
      font-size: 0.8rem;
      color: var(--muted-text-color);
      margin-top: 0.2rem;
    }

    .feed-content {
      margin-bottom: 1.2rem;
    }

    .feed-rating {
      display: inline-block;
      background: var(--primary-gradient);
      color: var(--inverted-text-color);
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 700;
      margin-bottom: 1.2rem;
      font-size: 0.95rem;
    }

    .similar-users-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .similar-user-card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      text-align: center;
      box-shadow: var(--shadow-small);
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .similar-user-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-medium);
    }

    .similarity-score {
      background: var(--accent-gradient);
      color: var(--inverted-text-color);
      padding: 0.4rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-top: 1rem;
      display: inline-block;
    }

    .group-card {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 1.8rem;
      margin-bottom: 1.8rem;
      box-shadow: var(--shadow-small);
      border: 1px solid var(--border-color);
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.2rem;
    }

    .group-members {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-bottom: 1.2rem;
    }

    .group-members>div:last-child {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* Voting system styles */
    .voting-section {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: var(--background-alt-color);
      border-radius: var(--border-radius-medium);
    }

    .vote-button {
      background: var(--border-color);
      color: var(--text-color);
      border: 2px solid transparent;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0 0.5rem 0.5rem 0;
    }

    .vote-button:hover {
      background: var(--muted-text-color);
      transform: translateY(-2px);
    }

    .vote-button.voted {
      background: var(--primary-color);
      color: var(--inverted-text-color);
      border-color: var(--primary-color);
    }

    .most-voted {
      border: 3px solid var(--error-color) !important;
      background: rgba(231, 76, 60, 0.1) !important;
      position: relative;
    }

    .most-voted::before {
      content: "üèÜ MOST VOTED";
      position: absolute;
      top: -10px;
      left: 10px;
      background: var(--error-color);
      color: var(--inverted-text-color);
      padding: 4px 12px;
      border-radius: var(--border-radius-medium);
      font-size: 0.7rem;
      font-weight: bold;
    }

    .vote-count {
      font-size: 0.8rem;
      color: var(--muted-text-color);
      margin-top: 0.5rem;
      font-weight: bold;
    }

    .edit-group-btn {
      background: var(--info-color);
      color: var(--inverted-text-color);
      border: none;
      padding: 14px 28px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin-right: 0.5rem;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow-small);
    }

    .edit-group-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
      filter: brightness(1.1);
    }

    .member-tag {
      background: rgba(31, 59, 115, 0.1);
      color: var(--primary-color);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .prediction-card {
      background: var(--blue-bg);
      border: 2px solid rgba(31, 59, 115, 0.15);
      border-radius: var(--border-radius-medium);
      padding: 1.2rem;
      margin: 1.2rem 0;
    }

    .prediction-score {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 0.5rem;
      background: var(--primary-color);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .prediction-confidence {
      text-align: center;
      font-size: 0.95rem;
      color: var(--muted-text-color);
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin: 1.5rem 0;
    }

    .stat-card {
      text-align: center;
      padding: 1.5rem;
      background: var(--blue-bg);
      border-radius: var(--border-radius-medium);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      background: rgba(74, 144, 226, 0.15);
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.95rem;
      color: var(--muted-text-color);
    }

    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 2rem;
    }

    .search-input {
      width: 100%;
      padding: 14px 50px 14px 20px;
      border: 2px solid var(--border-color);
      border-radius: 50px;
      font-size: 1rem;
      background: var(--background-color);
      color: var(--text-color);
      transition: var(--transition);
      font-family: inherit;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(31, 59, 115, 0.2);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary-color);
      font-size: 1.2rem;
    }

    .filter-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 0.9rem 1.8rem;
      border: 2px solid var(--primary-color);
      border-radius: 50px;
      background: transparent;
      color: var(--primary-color);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      font-size: 0.95rem;
    }

    .filter-tab.active {
      background: var(--primary-color);
      color: var(--inverted-text-color);
    }

    .filter-tab:hover:not(.active) {
      background: rgba(31, 59, 115, 0.1);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted-text-color);
    }

    .empty-state h3 {
      margin-bottom: 1rem;
      color: var(--text-color);
      font-size: 1.5rem;
    }

    .empty-state p {
      max-width: 500px;
      margin: 0 auto 1.5rem;
    }

    .centered {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    /* GROUPS */
    .modal {
      display: flex;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--background-color);
      border-radius: var(--border-radius-large);
      padding: 0;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow-large);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      padding: 2rem 2rem 1rem 2rem;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.8rem;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 25px;
      color: var(--muted-text-color);
      font-size: 35px;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      color: var(--text-color);
      background: rgba(0, 0, 0, 0.1);
      transform: rotate(90deg);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .activity-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 992px) {
      .navbar {
        flex-direction: column;
        gap: 1.2rem;
        padding: 1.5rem;
      }

      .nav-links {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }

      .card {
        padding: 1.8rem;
      }

      .radio-group {
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .activity-grid,
      .stats-grid,
      .similar-users-grid {
        grid-template-columns: 1fr;
      }

      .user-info {
        flex-direction: column;
        text-align: center;
      }

      .group-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <nav class="navbar">
      <div class="logo">
        <img src="logo-icon-blue.png" alt="Social Energy" style="width: 50px; height: 50px; border-radius: 6px" />
        Senergy
      </div>
      <ul class="nav-links">
        <li>
          <a href="#" onclick="showPage('dashboard')" id="nav-dashboard">Dashboard</a>
        </li>
        <li>
          <a href="#" onclick="showPage('assessment')" id="nav-assessment">Assessment</a>
        </li>
        <li>
          <a href="#" onclick="showPage('activities')" id="nav-activities">Add Experience</a>
        </li>
        <li>
          <a href="#" onclick="showPage('feed')" id="nav-feed">Community</a>
        </li>
        <li>
          <a href="#" onclick="showPage('groups')" id="nav-groups">Groups</a>
        </li>
        <li>
          <a href="#" onclick="showPage('profile')" id="nav-profile">Profile</a>
        </li>
      </ul>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page">
      <div class="card">
        <div class="user-info">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <div class="welcome-text" id="welcome-message">
              Welcome! Take the personality assessment to get started.
            </div>
          </div>
        </div>

        <div id="dashboard-content" class="centered">
          <h2>Discover Your Perfect Social Experiences</h2>
          <p style="padding: 1.2rem">
            Find activities that match your energy preferences and connect
            with like-minded people.
          </p>
          <button class="btn" onclick="showPage('assessment')">
            <i class="fas fa-play-circle"></i> Start Assessment
          </button>
        </div>
      </div>
    </div>

    <!-- Personality Assessment Page -->
    <div id="assessment" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Personality Assessment</h2>
          <p>
            Answer these questions to help us understand your social energy
            preferences.
          </p>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
          <div class="progress-info">
            <span id="progress-text">Question 1 of 10</span>
            <span>Understanding your energy</span>
          </div>
        </div>

        <div id="question-container">
          <!-- Questions will be dynamically inserted here -->
        </div>

        <div class="centered">
          <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>
            Next Question <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Assessment Results -->
    <div id="results" class="page hidden">
      <div class="card">
        <div class="personality-result">
          <h2>Your Personality Profile</h2>
          <div class="personality-score" id="personality-score">0.0</div>
          <div class="personality-type" id="personality-type">Ambivert</div>
          <p class="personality-description" id="personality-description">
            You have a balanced approach to social energy.
          </p>
          <button class="btn" onclick="completeAssessment()">
            <i class="fas fa-tachometer-alt"></i> Continue to Dashboard
          </button>
        </div>
      </div>
    </div>

    <!-- Activities Page -->
    <div id="activities" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Add Your Experience</h2>
          <p>
            Share a recent social experience and rate how it affected your
            energy levels.
          </p>
        </div>

        <form id="activity-form" onsubmit="ActivitySystem.submitNewExperience(event)">
          <div class="form-group">
            <label for="activity-name"><i class="fas fa-map-marker-alt"></i> Place/Activity Name
              *</label>
            <input type="text" id="activity-name" class="form-control"
              placeholder="e.g., The Coffee Bean, Central Park, Downtown Nightclub" required />
          </div>

          <div class="form-group">
            <label for="activity-category"><i class="fas fa-tag"></i> Category *</label>
            <select id="activity-category" class="form-control" required>
              <option value="">Select category...</option>
              <option value="Restaurant">Restaurant</option>
              <option value="Bar/Pub">Bar/Pub</option>
              <option value="Nightclub">Nightclub</option>
              <option value="Cafe">Cafe</option>
              <option value="Park/Outdoor">Park/Outdoor</option>
              <option value="Museum/Gallery">Museum/Gallery</option>
              <option value="Shopping">Shopping</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Sports/Fitness">Sports/Fitness</option>
              <option value="Library/Study">Library/Study</option>
              <option value="Event/Party">Event/Party</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="activity-location"><i class="fas fa-location-dot"></i> Location</label>
            <input type="text" id="activity-location" class="form-control"
              placeholder="e.g., Downtown, Brooklyn, Central Mall" />
          </div>

          <div class="form-group">
            <label for="activity-description"><i class="fas fa-align-left"></i> Description (Optional)</label>
            <textarea id="activity-description" class="form-control"
              placeholder="Describe the atmosphere, what you did, who you were with..."></textarea>
          </div>

          <div class="form-group">
            <label><i class="fas fa-star"></i> Rate Your Experience:</label>
            <div class="rating-questions" id="new-activity-rating">
              <div class="rating-question">
                <label>How energized did you feel?</label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-energy')" id="rating-energy" />
                <div class="slider-value" id="slider-energy">5</div>
              </div>
              <div class="rating-question">
                <label>How satisfied were you with the social interaction?
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-social')" id="rating-social" />
                <div class="slider-value" id="slider-social">5</div>
              </div>
              <div class="rating-question">
                <label>How comfortable did you feel in this environment?
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-comfort')" id="rating-comfort" />
                <div class="slider-value" id="slider-comfort">5</div>
              </div>
              <div class="rating-question">
                <label>How overwhelming was the environment? (Rate higher if it felt more overwhelming)
                </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-overwhelm')" id="rating-overwhelm" />
                <div class="slider-value" id="slider-overwhelm">5</div>
              </div>
              <div class="rating-question">
                <label>How likely are you to return? </label>
                <input type="range" class="rating-slider" min="1" max="10" value="5"
                  oninput="updateSliderValue(this, 'slider-return')" id="rating-return" />
                <div class="slider-value" id="slider-return">5</div>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button type="submit" class="btn">
              <i class="fas fa-plus-circle"></i> Add Experience
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetActivityForm()">
              <i class="fas fa-eraser"></i> Clear Form
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Community Feed Page -->
    <div id="feed" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Community Activity Feed</h2>
          <p>
            See what others in the community are experiencing and discover new
            places.
          </p>
        </div>

        <div class="search-box">
          <input type="text" class="search-input" id="feed-search" placeholder="Search activities, places, or users..."
            onkeyup="FeedSystem.filterFeed()" />
          <span class="search-icon"><i class="fas fa-search"></i></span>
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" onclick="FeedSystem.setFilter('all')">
            All Activities
          </button>
          <button class="filter-tab" onclick="FeedSystem.setFilter('similar')">
            Similar Users
          </button>
          <button class="filter-tab" onclick="FeedSystem.setFilter('high-rated')">
            Top Rated
          </button>
          <button class="filter-tab" onclick="FeedSystem.setFilter('recent')">
            Recent
          </button>
        </div>

        <div id="feed-content">
          <!-- Feed items will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- Groups Page -->
    <div id="groups" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Group Planning</h2>
          <p>
            Create groups with friends and find activities that work for
            everyone's energy preferences.
          </p>
        </div>

        <div class="centered">
          <button class="btn" onclick="showCreateGroupModal()">
            <i class="fas fa-users"></i> Create New Group
          </button>
        </div>

        <div id="groups-content">
          <!-- Groups will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- Profile Page -->
    <div id="profile" class="page hidden">
      <div class="card">
        <div class="card-header">
          <h2>Your Profile</h2>
        </div>
        <div id="profile-content">
          <!-- Profile content will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript remains unchanged -->
  <script>
    // Function to handle rating a place from the community feed
    function ratePlace(name, category, location, description) {
      // Pre-fill the activity form
      document.getElementById("activity-name").value = name;
      document.getElementById("activity-category").value = category;
      document.getElementById("activity-location").value = location;
      document.getElementById("activity-description").value = description;

      // Switch to the activities page
      showPage("activities");

      // Scroll to the form
      document
        .getElementById("activity-form")
        .scrollIntoView({ behavior: "smooth" });
    }

    // In-memory data storage (replaces localStorage)
    let appData = {
      personalityScore: null,
      personalityType: null,
      userExperiences: [],
      groups: [],
      friends: [], // Add friends array
      currentUser: {
        id: "user-main",
        username: "you",
        displayName: "You",
        avatar: "Y",
      },
    };

    const FriendsSystem = {
      addFriend: (userId) => {
        const user = DemoUsers.users[userId];
        if (!user) return false;

        const friends = DataLayer.load("friends", []);
        if (friends.some((friend) => friend.id === userId)) {
          NotificationSystem.show(
            "Already friends with this user!",
            "warning"
          );
          return false;
        }

        const friendData = {
          id: userId,
          username: user.username,
          displayName: user.displayName,
          personalityType: user.personalityType,
          adjustmentFactor: user.adjustmentFactor,
          avatar: user.avatar,
          addedAt: new Date().toISOString(),
        };

        DataLayer.push("friends", friendData);
        NotificationSystem.show(
          `Added ${user.displayName} as a friend!`,
          "success"
        );

        // Update the button immediately with animation
        FriendsSystem.updateFriendButton(userId, true);

        // Refresh current page to show updated recommendations
        const currentPage = document.querySelector(".page:not(.hidden)").id;
        if (currentPage === "dashboard" || currentPage === "profile") {
          showPage(currentPage);
        }

        return true;
      },

      updateFriendButton: (userId, isFriend) => {
        // Find all buttons for this user and update them
        const buttons = document.querySelectorAll(`[onclick*="FriendsSystem.addFriend(${userId})"]`);
        buttons.forEach(button => {
          if (isFriend) {
            // Animate the button change
            button.style.transition = 'all 0.3s ease';
            button.style.transform = 'scale(1.1)';
            button.style.color = 'white';
            
            // Reset transform after animation and update content
            setTimeout(() => {
              button.style.transform = 'scale(1)';
              // Clear button styling to avoid double styling
              button.style.background = 'transparent';
              button.style.border = 'none';
              button.style.padding = '0';
              button.style.margin = '0';
              button.style.boxShadow = 'none';
              button.style.cursor = 'default';
              button.onclick = null; // Remove click handler
              button.innerHTML = '<span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color);">‚úì Friend</span>';
            }, 300);
          } else {
            // Reset to original button styling
            button.innerHTML = 'Add Friend';
            button.style.background = '';
            button.style.color = '';
            button.style.border = '';
            button.style.padding = '';
            button.style.margin = '';
            button.style.boxShadow = '';
            button.style.transform = '';
            button.style.cursor = 'pointer';
            // Restore click handler - this will be handled by the page refresh
          }
        });
      },

      getFriends: () => {
        return DataLayer.load("friends", []);
      },

      getFriendIds: () => {
        return FriendsSystem.getFriends().map((friend) => friend.id);
      },

      isFriend: (userId) => {
        return FriendsSystem.getFriendIds().includes(userId);
      },

      removeFriend: (userId) => {
        const friends = DataLayer.load("friends", []);
        const friendToRemove = friends.find(friend => friend.id === userId);
        
        if (!friendToRemove) {
          NotificationSystem.show("Friend not found!", "error");
          return false;
        }

        DataLayer.remove("friends", (friend) => friend.id === userId);
        NotificationSystem.show(
          `Removed ${friendToRemove.displayName} from friends!`,
          "success"
        );

        // Update the button immediately
        FriendsSystem.updateFriendButton(userId, false);

        // Refresh current page to show updated recommendations
        const currentPage = document.querySelector(".page:not(.hidden)").id;
        if (currentPage === "dashboard" || currentPage === "profile") {
          showPage(currentPage);
        }

        return true;
      },
    };

    // Data layer - handles in-memory storage operations
    const DataLayer = {
      save: (key, data) => {
        appData[key] = JSON.parse(JSON.stringify(data));
      },

      load: (key, defaultValue = null) => {
        return appData[key] !== undefined
          ? JSON.parse(JSON.stringify(appData[key]))
          : defaultValue;
      },

      exists: (key) => {
        return appData[key] !== undefined && appData[key] !== null;
      },

      push: (key, item) => {
        if (!appData[key]) appData[key] = [];
        appData[key].push(JSON.parse(JSON.stringify(item)));
      },

      remove: (key, predicate) => {
        if (appData[key] && Array.isArray(appData[key])) {
          appData[key] = appData[key].filter((item) => !predicate(item));
        }
      },
    };

    // Personality assessment system
    const PersonalityAssessment = {
      questions: [
        { text: "Large parties energize me", weight: 3 },
        {
          text: "I prefer quiet, intimate gatherings",
          weight: 3,
          reverse: true,
        },
        {
          text: "I need alone time after social events",
          weight: 2,
          reverse: true,
        },
        { text: "I'm comfortable being the center of attention", weight: 2 },
        {
          text: "I prefer deep conversations over small talk",
          weight: 2,
          reverse: true,
        },
        { text: "I enjoy spontaneous social activities", weight: 1 },
        { text: "I recharge by being around people", weight: 3 },
        { text: "I think out loud when making decisions", weight: 1 },
        { text: "I'm energized by new social environments", weight: 2 },
        { text: "I prefer working in teams vs alone", weight: 1 },
      ],
      
      // questions: [
      //   { text: "Large parties energize me", weight: 3 },
      // ],

      currentQuestion: 0,
      responses: [],

      init: () => {
        PersonalityAssessment.currentQuestion = 0;
        PersonalityAssessment.responses = [];
        PersonalityAssessment.displayQuestion();
        
        // Add keyboard event listener for assessment navigation
        document.addEventListener("keydown", PersonalityAssessment.handleKeyboard);
      },

      displayQuestion: () => {
        const container = document.getElementById("question-container");
        const question =
          PersonalityAssessment.questions[
          PersonalityAssessment.currentQuestion
          ];

        container.innerHTML = `
      <div class="question-container">
        <div class="question-text">${question.text}</div>
        <div class="scale-labels">
          <span>Strongly Disagree</span>
          <span>Strongly Agree</span>
        </div>
        <div class="radio-group">
          ${[1, 2, 3, 4, 5]
            .map(
              (value) => `
              <div class="radio-item" onclick="document.getElementById('q${value}').click()">
                <input type="radio" name="question" value="${value}" id="q${value}" onchange="PersonalityAssessment.selectAnswer(${value})">
                <label for="q${value}">${value}</label>
              </div>
            `
            )
            .join("")}
        </div>
      </div>
    `;

        // Update progress
        const progress =
          ((PersonalityAssessment.currentQuestion + 1) /
            PersonalityAssessment.questions.length) *
          100;
        document.getElementById("progress-fill").style.width = `${progress}%`;
        document.getElementById("progress-text").textContent = `Question ${PersonalityAssessment.currentQuestion + 1
          } of ${PersonalityAssessment.questions.length}`;
      },

      selectAnswer: (value) => {
        PersonalityAssessment.responses[
          PersonalityAssessment.currentQuestion
        ] = value;
        document.getElementById("next-btn").disabled = false;
      },

      handleKeyboard: (event) => {
        // Only handle keyboard events if we're on the assessment page
        if (document.getElementById("assessment").classList.contains("hidden")) {
          return;
        }

        const key = event.key;
        
        // Handle number keys 1-5 for radio button selection
        if (key >= "1" && key <= "5") {
          const value = parseInt(key);
          document.getElementById(`q${value}`).click();
          PersonalityAssessment.selectAnswer(value);
        }
        
        // Handle Enter key for next button
        if (key === "Enter") {
          const nextBtn = document.getElementById("next-btn");
          if (!nextBtn.disabled) {
            nextQuestion();
          }
        }
      },

      calculateScore: () => {
        let weightedSum = 0;
        let totalWeight = 0;

        PersonalityAssessment.questions.forEach((question, index) => {
          let response = PersonalityAssessment.responses[index];
          if (question.reverse) {
            response = 6 - response;
          }
          weightedSum += response * question.weight;
          totalWeight += question.weight;
        });

        const rawScore = weightedSum / totalWeight;
        const adjustmentFactor = Math.max(
          -1,
          Math.min(1, (rawScore - 2.5) / 2.5)
        );

        return {
          rawScore,
          adjustmentFactor,
        };
      },

      getPersonalityType: (adjustmentFactor) => {
        if (adjustmentFactor <= -0.6)
          return {
            type: "Strong Introvert",
            description:
              "You recharge through solitude and prefer quieter, more intimate social settings.",
          };
        if (adjustmentFactor <= -0.2)
          return {
            type: "Moderate Introvert",
            description:
              "You enjoy social interaction but need quiet time to recharge your energy.",
          };
        if (adjustmentFactor <= 0.2)
          return {
            type: "Ambivert",
            description:
              "You have a balanced approach to social energy and can adapt to various situations.",
          };
        if (adjustmentFactor <= 0.6)
          return {
            type: "Moderate Extrovert",
            description:
              "You're energized by social interaction and enjoy group activities.",
          };
        return {
          type: "Strong Extrovert",
          description:
            "You thrive in social situations and gain energy from being around others.",
        };
      },

      showResults: () => {
        const scores = PersonalityAssessment.calculateScore();
        const personality = PersonalityAssessment.getPersonalityType(
          scores.adjustmentFactor
        );

        document.getElementById("personality-score").textContent =
          scores.adjustmentFactor.toFixed(1);
        document.getElementById("personality-type").textContent =
          personality.type;
        document.getElementById("personality-description").textContent =
          personality.description;

        // Save results
        DataLayer.save("personalityScore", scores);
        DataLayer.save("personalityType", personality);

        // Update current user
        let currentUser = DataLayer.load("currentUser");
        if (!currentUser) {
          currentUser = {
            id: "user-main",
            username: "you",
            displayName: "You",
          };
        }

        currentUser.adjustmentFactor = scores.adjustmentFactor;
        currentUser.personalityType = personality.type;
        currentUser.avatar = personality.type.charAt(0);
        DataLayer.save("currentUser", currentUser);

        // Remove the assessment tab completely
        const assessmentTab = document.querySelector(
          "li:has([onclick=\"showPage('assessment')\"])"
        );
        if (assessmentTab) {
          assessmentTab.remove();
        }

        showPage("results");
      },
    };

    // Demo users with sample data
    const DemoUsers = {
      users: {
        1: {
          id: 1,
          username: "alex_chen",
          displayName: "Alex Chen",
          adjustmentFactor: 0.8,
          personalityType: "Strong Extrovert",
          bio: "Love meeting new people and trying exciting venues!",
          avatar: "AC",
        },
        2: {
          id: 2,
          username: "sam_rivera",
          displayName: "Sam Rivera",
          adjustmentFactor: 0.3,
          personalityType: "Moderate Extrovert",
          bio: "Enjoy good company in comfortable settings.",
          avatar: "SR",
        },
        3: {
          id: 3,
          username: "jordan_park",
          displayName: "Jordan Park",
          adjustmentFactor: -0.2,
          personalityType: "Slight Introvert",
          bio: "Quality over quantity when it comes to social time.",
          avatar: "JP",
        },
        4: {
          id: 4,
          username: "riley_thompson",
          displayName: "Riley Thompson",
          adjustmentFactor: -0.5,
          personalityType: "Moderate Introvert",
          bio: "Love peaceful places and meaningful conversations.",
          avatar: "RT",
        },
        5: {
          id: 5,
          username: "casey_wu",
          displayName: "Casey Wu",
          adjustmentFactor: -0.9,
          personalityType: "Strong Introvert",
          bio: "Finding energy in quiet, contemplative spaces.",
          avatar: "CW",
        },
        6: {
          id: 6,
          username: "taylor_kim",
          displayName: "Taylor Kim",
          adjustmentFactor: 0.0,
          personalityType: "Ambivert",
          bio: "Adaptable to different social situations and moods.",
          avatar: "TK",
        },
      },

      // Sample experiences from demo users
      experiences: [
        {
          id: 1,
          userId: 1,
          name: "Rooftop Lounge 21",
          category: "Bar/Pub",
          location: "Downtown",
          description:
            "Amazing rooftop bar with live DJ and city views. Great crowd, everyone was dancing!",
          responses: {
            energy: 9,
            social: 8,
            comfort: 8,
            overwhelm: 3,
            return: 9,
          },
          rawScore: 8.4,
          adjustedScore: 9.6,
          timestamp: "2024-01-15T20:00:00Z",
          socialIntensity: 8.5,
          noiseLevel: 7.5,
          crowdSize: 8.0,
        },
        {
          id: 2,
          userId: 2,
          name: "The Coffee Corner",
          category: "Cafe",
          location: "University District",
          description:
            "Cozy cafe with great atmosphere for studying and casual meetings. Perfect background music.",
          responses: {
            energy: 7,
            social: 7,
            comfort: 8,
            overwhelm: 2,
            return: 8,
          },
          rawScore: 7.2,
          adjustedScore: 7.8,
          timestamp: "2024-01-16T14:00:00Z",
          socialIntensity: 3.5,
          noiseLevel: 2.5,
          crowdSize: 4.0,
        },
        {
          id: 3,
          userId: 3,
          name: "Modern Art Museum",
          category: "Museum/Gallery",
          location: "Arts District",
          description:
            "Beautiful contemporary art exhibition. Peaceful environment, perfect for reflection.",
          responses: {
            energy: 8,
            social: 6,
            comfort: 9,
            overwhelm: 1,
            return: 8,
          },
          rawScore: 8.0,
          adjustedScore: 7.6,
          timestamp: "2024-01-17T11:00:00Z",
          socialIntensity: 2.0,
          noiseLevel: 1.5,
          crowdSize: 3.0,
        },
        {
          id: 4,
          userId: 4,
          name: "Quiet Garden Restaurant",
          category: "Restaurant",
          location: "Suburbs",
          description:
            "Intimate restaurant with outdoor seating. Perfect for deep conversations with close friends.",
          responses: {
            energy: 8,
            social: 9,
            comfort: 9,
            overwhelm: 1,
            return: 9,
          },
          rawScore: 8.8,
          adjustedScore: 7.8,
          timestamp: "2024-01-18T18:00:00Z",
          socialIntensity: 4.0,
          noiseLevel: 2.0,
          crowdSize: 3.5,
        },
        {
          id: 5,
          userId: 5,
          name: "Central Library",
          category: "Library/Study",
          location: "Downtown",
          description:
            "Peaceful reading space with beautiful architecture. Perfect for solo work and reflection.",
          responses: {
            energy: 9,
            social: 5,
            comfort: 10,
            overwhelm: 1,
            return: 10,
          },
          rawScore: 8.4,
          adjustedScore: 6.6,
          timestamp: "2024-01-19T10:00:00Z",
          socialIntensity: 1.0,
          noiseLevel: 1.0,
          crowdSize: 2.0,
        },
        {
          id: 6,
          userId: 6,
          name: "Sports Bar Central",
          category: "Bar/Pub",
          location: "Entertainment District",
          description:
            "Lively sports bar with big screens and enthusiastic crowd. Great game night atmosphere!",
          responses: {
            energy: 7,
            social: 7,
            comfort: 6,
            overwhelm: 6,
            return: 7,
          },
          rawScore: 6.5,
          adjustedScore: 6.5,
          timestamp: "2024-01-20T19:00:00Z",
          socialIntensity: 7.0,
          noiseLevel: 8.0,
          crowdSize: 7.5,
        },
        {
          id: 7,
          userId: 1,
          name: "Underground Dance Club",
          category: "Nightclub",
          location: "City Center",
          description:
            "High-energy club with amazing sound system and packed dance floor. Pure energy!",
          responses: {
            energy: 10,
            social: 9,
            comfort: 7,
            overwhelm: 4,
            return: 10,
          },
          rawScore: 8.8,
          adjustedScore: 10.0,
          timestamp: "2024-01-21T23:00:00Z",
          socialIntensity: 10.0,
          noiseLevel: 9.5,
          crowdSize: 9.0,
        },
        {
          id: 8,
          userId: 5,
          name: "Botanical Garden",
          category: "Park/Outdoor",
          location: "North Side",
          description:
            "Serene garden with beautiful flowers and quiet walking paths. So peaceful and restorative.",
          responses: {
            energy: 9,
            social: 4,
            comfort: 10,
            overwhelm: 1,
            return: 10,
          },
          rawScore: 8.2,
          adjustedScore: 6.4,
          timestamp: "2024-01-22T15:00:00Z",
          socialIntensity: 1.5,
          noiseLevel: 1.0,
          crowdSize: 2.5,
        },
      ],
    };

    // Helper functions for edit modal
    function closeEditModal() {
      const modal = document.getElementById("edit-group-modal");
      if (modal) modal.remove();
    }

    function handleEditGroup(event, groupId) {
      event.preventDefault();

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      const name = document.getElementById("edit-group-name").value.trim();
      const description = document
        .getElementById("edit-group-description")
        .value.trim();

      // Update basic info
      groups[groupIndex].name = name;
      groups[groupIndex].description = description;

      // Update members
      const currentUser = DataLayer.load("currentUser");
      const personalityData = DataLayer.load("personalityScore");

      let newMembers = [
        {
          userId: currentUser.id,
          displayName: currentUser.displayName,
          personalityType: currentUser.personalityType,
          adjustmentFactor: personalityData.adjustmentFactor,
          avatar: currentUser.avatar,
          importance: 1.0,
        },
      ];

      // Keep existing members that are checked
      groups[groupIndex].members.forEach((member) => {
        if (member.userId !== currentUser.id) {
          const keepCheckbox = document.getElementById(
            `keep-member-${member.userId}`
          );
          if (keepCheckbox && keepCheckbox.checked) {
            newMembers.push(member);
          }
        }
      });

      // Add new members that are checked
      const friends = FriendsSystem.getFriends();
      friends.forEach((friend) => {
        const addCheckbox = document.getElementById(
          `add-member-${friend.id}`
        );
        if (addCheckbox && addCheckbox.checked) {
          newMembers.push({
            userId: friend.id,
            displayName: friend.displayName,
            personalityType: friend.personalityType,
            adjustmentFactor: friend.adjustmentFactor,
            avatar: friend.avatar,
            importance: 1.0,
          });
        }
      });

      groups[groupIndex].members = newMembers;
      DataLayer.save("groups", groups);

      closeEditModal();
      GroupsSystem.displayGroups();
      NotificationSystem.show("Group updated successfully!", "success");
    }

    // Activity system
    const ActivitySystem = {
      // Predefined activity categories
      categories: [
        {
          id: "restaurant",
          name: "Restaurant/Caf√©",
          description: "Dining establishments, cafes, food courts",
        },
        {
          id: "nightlife",
          name: "Nightlife",
          description: "Bars, clubs, lounges",
        },
        {
          id: "outdoor",
          name: "Park/Outdoor",
          description: "Parks, gardens, hiking trails",
        },
        {
          id: "entertainment",
          name: "Entertainment",
          description: "Movies, theaters, concerts",
        },
        {
          id: "shopping",
          name: "Shopping",
          description: "Malls, markets, retail stores",
        },
        {
          id: "sports",
          name: "Sports/Recreation",
          description: "Gyms, sports venues, recreational facilities",
        },
        {
          id: "cultural",
          name: "Cultural",
          description: "Museums, galleries, historical sites",
        },
        {
          id: "social",
          name: "Social Venue",
          description: "Community centers, meet-up spaces",
        },
        {
          id: "wellness",
          name: "Wellness/Relaxation",
          description: "Spas, yoga studios, meditation centers",
        },
      ],

      // Rating questions for activity experiences
      ratingQuestions: [
        { id: "energy", text: "How energized did you feel?", weight: 0.4 },
        {
          id: "social",
          text: "How satisfied were you with the social interaction?",
          weight: 0.25,
        },
        {
          id: "comfort",
          text: "How comfortable did you feel in this environment?",
          weight: 0.2,
        },
        {
          id: "overwhelm",
          text: "How overwhelming was the environment?",
          weight: 0.1,
          reverse: true,
        },
        { id: "return", text: "How likely are you to return?", weight: 0.05 },
      ],

      submitNewExperience: (event) => {
        event.preventDefault();

        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) {
          NotificationSystem.show(
            "Please complete the personality assessment first!",
            "warning"
          );
          showPage("assessment");
          return;
        }

        // Get form data
        const name = document.getElementById("activity-name").value.trim();
        const category = document.getElementById("activity-category").value;
        const location = document
          .getElementById("activity-location")
          .value.trim();
        const description = document
          .getElementById("activity-description")
          .value.trim();

        if (!name || !category) {
          NotificationSystem.show(
            "Please fill in all required fields.",
            "warning"
          );
          return;
        }

        // Get ratings
        const responses = {};
        let rawScore = 0;

        ActivitySystem.ratingQuestions.forEach((question) => {
          let value = parseInt(
            document.getElementById(`rating-${question.id}`).value
          );

          if (question.reverse) {
            value = 11 - value; // Reverse score for overwhelming
          }

          responses[question.id] = value;
          rawScore += value * question.weight;
        });

        // Apply personality adjustment
        const adjustedScore = Math.max(
          1,
          Math.min(10, rawScore + personalityData.adjustmentFactor * 2)
        );

        // Estimate social characteristics based on category and user ratings
        const socialIntensity = ActivitySystem.estimateSocialIntensity(
          category,
          responses
        );
        const noiseLevel = ActivitySystem.estimateNoiseLevel(
          category,
          responses
        );
        const crowdSize = ActivitySystem.estimateCrowdSize(
          category,
          responses
        );

        const experience = {
          id: Date.now(),
          userId: "user-main",
          name,
          category,
          location: location || "Not specified",
          description: description || "",
          responses,
          rawScore: parseFloat(rawScore.toFixed(1)),
          adjustedScore: parseFloat(adjustedScore.toFixed(1)),
          timestamp: new Date().toISOString(),
          socialIntensity,
          noiseLevel,
          crowdSize,
        };

        // Save experience
        DataLayer.push("userExperiences", experience);

        // Show success message
        NotificationSystem.show("Experience added successfully!", "success");

        // Reset form and redirect
        resetActivityForm();
        showPage("profile");
      },

      estimateSocialIntensity: (category, responses) => {
        const baseValues = {
          Nightclub: 9.5,
          "Bar/Pub": 7.0,
          Restaurant: 5.5,
          "Event/Party": 8.5,
          "Sports/Fitness": 6.0,
          Cafe: 3.5,
          Shopping: 5.0,
          Entertainment: 7.5,
          "Museum/Gallery": 2.0,
          "Library/Study": 1.0,
          "Park/Outdoor": 2.5,
          Other: 5.0,
        };

        const base = baseValues[category] || 5.0;
        const socialFactor = (responses.social - 5) * 0.5;
        return Math.max(1, Math.min(10, base + socialFactor));
      },

      estimateNoiseLevel: (category, responses) => {
        const baseValues = {
          Nightclub: 9.0,
          "Bar/Pub": 7.5,
          Restaurant: 4.0,
          "Event/Party": 8.0,
          "Sports/Fitness": 6.5,
          Cafe: 2.5,
          Shopping: 6.0,
          Entertainment: 8.5,
          "Museum/Gallery": 1.5,
          "Library/Study": 1.0,
          "Park/Outdoor": 2.0,
          Other: 5.0,
        };

        const base = baseValues[category] || 5.0;
        const overwhelmFactor = (responses.overwhelm - 5) * 0.3;
        return Math.max(1, Math.min(10, base + overwhelmFactor));
      },

      estimateCrowdSize: (category, responses) => {
        const baseValues = {
          Nightclub: 9.0,
          "Bar/Pub": 7.0,
          Restaurant: 6.0,
          "Event/Party": 8.5,
          "Sports/Fitness": 6.5,
          Cafe: 4.0,
          Shopping: 7.5,
          Entertainment: 8.0,
          "Museum/Gallery": 3.0,
          "Library/Study": 2.0,
          "Park/Outdoor": 4.5,
          Other: 5.0,
        };

        const base = baseValues[category] || 5.0;
        const overwhelmFactor = (responses.overwhelm - 5) * 0.2;
        const comfortFactor = (5 - responses.comfort) * 0.1; // Lower comfort might mean more crowded
        return Math.max(
          1,
          Math.min(10, base + overwhelmFactor + comfortFactor)
        );
      },

      // Prediction Algorithm - Exact implementation from plan
      predictRating: (
        userAdjustmentFactor,
        experience,
        ratingUserAdjustmentFactor,
        ratingScore
      ) => {
        const basePrediction = parseFloat(ratingScore);
        const personalityDifference = Math.abs(
          ratingUserAdjustmentFactor - userAdjustmentFactor
        );
        const confidenceFactor = Math.max(0.1, 1 - personalityDifference / 2);

        let prediction;
        if (ratingUserAdjustmentFactor < userAdjustmentFactor) {
          // Rating user is more introverted than current user
          prediction =
            basePrediction +
            personalityDifference * experience.socialIntensity * 0.2;
        } else {
          // Rating user is more extroverted than current user
          prediction =
            basePrediction -
            personalityDifference * experience.socialIntensity * 0.2;
        }

        const finalPrediction = Math.max(1, Math.min(10, prediction));
        return {
          prediction: finalPrediction,
          confidence: confidenceFactor,
        };
      },

      // Get all experiences (user + demo)
      getAllExperiences: () => {
        const userExperiences = DataLayer.load("userExperiences", []);
        return [...DemoUsers.experiences, ...userExperiences];
      },

      // Activity Recommendation Engine
      getRecommendations: (userAdjustmentFactor) => {
        const allExperiences = ActivitySystem.getAllExperiences();
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );
        const friendIds = FriendsSystem.getFriendIds();

        // Only include experiences from friends
        const friendExperiences = allExperiences.filter((exp) =>
          friendIds.includes(exp.userId)
        );

        const recommendations = [];

        // Group experiences by name to avoid duplicates
        const experienceGroups = {};
        friendExperiences.forEach((exp) => {
          const key = exp.name.toLowerCase();
          if (!experienceGroups[key]) {
            experienceGroups[key] = [];
          }
          experienceGroups[key].push(exp);
        });

        Object.entries(experienceGroups).forEach(([name, experiences]) => {
          // Skip if user has already been to this place
          if (userExperienceNames.includes(name)) return;

          const predictions = [];
          let totalScore = 0;
          let ratingCount = 0;

          experiences.forEach((exp) => {
            const ratingUser = DemoUsers.users[exp.userId];
            if (ratingUser) {
              const prediction = ActivitySystem.predictRating(
                userAdjustmentFactor,
                exp,
                ratingUser.adjustmentFactor,
                exp.rawScore
              );

              predictions.push({
                user: ratingUser,
                experience: exp,
                prediction: prediction,
              });

              totalScore += prediction.prediction * prediction.confidence;
              ratingCount++;
            }
          });

          if (ratingCount > 0) {
            const averageScore = totalScore / ratingCount;
            const avgConfidence =
              predictions.reduce(
                (sum, p) => sum + p.prediction.confidence,
                0
              ) / ratingCount;

            recommendations.push({
              experience: experiences[0], // Use first experience as representative
              predictedScore: averageScore,
              confidence: avgConfidence,
              ratingCount: ratingCount,
              predictions: predictions,
            });
          }
        });

        // Sort by predicted score * confidence
        return recommendations.sort(
          (a, b) =>
            b.predictedScore * b.confidence - a.predictedScore * a.confidence
        );
      },

      // Find Similar Users
      findSimilarUsers: (userAdjustmentFactor) => {
        const similarities = Object.values(DemoUsers.users)
          .map((user) => {
            const personalityDifference = Math.abs(
              user.adjustmentFactor - userAdjustmentFactor
            );
            const similarity = Math.max(0, 1 - personalityDifference / 2); // 0 to 1 scale

            return {
              user: user,
              similarity: similarity,
              personalityDifference: personalityDifference,
            };
          })
          .sort((a, b) => b.similarity - a.similarity);

        return similarities;
      },
    };

    function fillActivityForm(name, category, location, description = "") {
      // Switch to activities page
      showPage("activities");

      // Pre-fill the form
      setTimeout(() => {
        document.getElementById("activity-name").value = name;
        document.getElementById("activity-category").value = category;
        document.getElementById("activity-location").value = location;
        document.getElementById("activity-description").value = description;

        // Scroll to form
        document
          .getElementById("activity-form")
          .scrollIntoView({ behavior: "smooth" });

        NotificationSystem.show(
          "Form pre-filled! Add your ratings below.",
          "info"
        );
      }, 100);
    }

    // Feed System
    const FeedSystem = {
      currentFilter: "all",
      searchTerm: "",

      init: () => {
        FeedSystem.displayFeed();
      },

      setFilter: (filter) => {
        FeedSystem.currentFilter = filter;

        // Update active tab
        document.querySelectorAll(".filter-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        FeedSystem.displayFeed();
      },

      filterFeed: () => {
        FeedSystem.searchTerm = document
          .getElementById("feed-search")
          .value.toLowerCase();
        FeedSystem.displayFeed();
      },

      displayFeed: () => {
        const personalityData = DataLayer.load("personalityScore");
        const allExperiences = ActivitySystem.getAllExperiences();
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );

        let filteredExperiences = [...allExperiences];

        // Apply search filter
        if (FeedSystem.searchTerm) {
          filteredExperiences = filteredExperiences.filter(
            (exp) =>
              exp.name.toLowerCase().includes(FeedSystem.searchTerm) ||
              exp.category.toLowerCase().includes(FeedSystem.searchTerm) ||
              exp.location.toLowerCase().includes(FeedSystem.searchTerm) ||
              (DemoUsers.users[exp.userId] &&
                DemoUsers.users[exp.userId].displayName
                  .toLowerCase()
                  .includes(FeedSystem.searchTerm))
          );
        }

        // Apply category filters
        if (FeedSystem.currentFilter === "similar" && personalityData) {
          const similarUsers = ActivitySystem.findSimilarUsers(
            personalityData.adjustmentFactor
          )
            .slice(0, 3)
            .map((sim) => sim.user.id);
          filteredExperiences = filteredExperiences.filter((exp) =>
            similarUsers.includes(exp.userId)
          );
        } else if (FeedSystem.currentFilter === "high-rated") {
          filteredExperiences = filteredExperiences.filter(
            (exp) => exp.adjustedScore >= 7.5
          );
        } else if (FeedSystem.currentFilter === "recent") {
          const oneWeekAgo = new Date();
          oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
          filteredExperiences = filteredExperiences.filter(
            (exp) =>
              new Date(exp.timestamp) > oneWeekAgo ||
              exp.userId === "user-main"
          );
        }

        // Sort by timestamp (newest first)
        filteredExperiences.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        const feedContent = document.getElementById("feed-content");

        if (filteredExperiences.length === 0) {
          feedContent.innerHTML = `
        <div class="empty-state">
          <h3>No activities found</h3>
          <p>Try adjusting your search or filters to see more results.</p>
        </div>
      `;
          return;
        }

        feedContent.innerHTML = filteredExperiences
          .map((exp) => {
            const user =
              exp.userId === "user-main"
                ? DataLayer.load("currentUser")
                : DemoUsers.users[exp.userId];

            if (!user) return "";

            // Check if user has been to this place
            const hasBeenThere = userExperienceNames.includes(
              exp.name.toLowerCase()
            );
            const isFriend = FriendsSystem.isFriend(exp.userId);

            // Calculate prediction for current user
            let predictionHtml = "";
            if (personalityData && exp.userId !== "user-main") {
              const prediction = ActivitySystem.predictRating(
                personalityData.adjustmentFactor,
                exp,
                user.adjustmentFactor,
                exp.rawScore
              );

              predictionHtml = `
          <div class="prediction-card">
            <div class="prediction-score">Predicted for you: ${prediction.prediction.toFixed(
                1
              )}/10</div>
            <div class="prediction-confidence">Confidence: ${(
                  prediction.confidence * 100
                ).toFixed(0)}%</div>
          </div>
        `;
            }

            // Add friend status and rate button
            let actionButtons = "";
            if (exp.userId !== "user-main") {
              if (!isFriend) {
                actionButtons += `
            <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 6px 12px; margin-right: 0.5rem;"
                    onclick="FriendsSystem.addFriend(${exp.userId})">
              Add Friend
            </button>
          `;
              } else {
                actionButtons += `
            <span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color);">‚úì Friend</span>
          `;
              }

              if (!hasBeenThere) {
                actionButtons += `
            <button class="btn" style="font-size: 0.8rem; padding: 6px 12px;"
                    onclick="fillActivityForm('${exp.name}', '${exp.category
                  }', '${exp.location}', '${exp.description.replace(
                    /'/g,
                    "\\'"
                  )}')">
              Rate This Place
            </button>
          `;
              }
            }

            return `
        <div class="feed-item">
          <div class="feed-header">
            <div class="feed-avatar">${user.avatar}</div>
            <div class="feed-user-info">
              <h4>${user.displayName} ${isFriend ? '<span style="color: var(--primary-color);">‚òÖ</span>' : ""
              }</h4>
              <div class="personality-type">${user.personalityType || "Unknown Type"
              }</div>
              <div class="feed-timestamp">${new Date(
                exp.timestamp
              ).toLocaleDateString()}</div>
            </div>
          </div>
          <div class="feed-content">
            <h3>${exp.name} ${hasBeenThere
                ? '<span style="color: var(--primary-color);">‚úì Visited</span>'
                : ""
              }</h3>
            <div class="activity-category">${exp.category} ‚Ä¢ ${exp.location
              }</div>
            ${exp.description
                ? `<p style="margin: 0.5rem 0; color: #666;">"${exp.description}"</p>`
                : ""
              }
            <div class="feed-rating">Rated: ${exp.adjustedScore}/10</div>
            <div style="font-size: 0.9rem; color: #888; margin-top: 0.5rem;">
              Social Intensity: ${exp.socialIntensity.toFixed(1)}/10 |
              Noise Level: ${exp.noiseLevel.toFixed(1)}/10 |
              Crowd Size: ${exp.crowdSize.toFixed(1)}/10
            </div>
            ${predictionHtml}
            ${actionButtons
                ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">${actionButtons}</div>`
                : ""
              }
          </div>
        </div>
      `;
          })
          .join("");
      },
    };
    // AI Premium Feature Configuration
    const AI_PREMIUM_ENABLED = true; // Set to false to disable premium features

    // AI Itinerary Generator
    const AIItineraryGenerator = {
      generateItinerary: async (groupData, tripDetails) => {
        const prompt = `You are an expert trip planner. Based on the following group information and trip details, create a detailed day-by-day itinerary.

Group Information:
- Group Name: ${groupData.name}
- Group Description: ${groupData.description}
- Group Size: ${groupData.members.length} people
- Members and their personality types:
${groupData.members
            .map(
              (member) =>
                `  ‚Ä¢ ${member.displayName}: ${member.personalityType} (Adjustment Factor: ${member.adjustmentFactor})`
            )
            .join("\n")}

Trip Details:
- Duration: ${tripDetails.duration} days
- Location: ${tripDetails.location}
- Budget Level: ${tripDetails.budget}
- Interests: ${tripDetails.interests}
- Special Requirements: ${tripDetails.requirements || "None"}

Based on the group's personality mix and preferences, create EXACTLY ${tripDetails.duration} days (no more, no less) that balances social activities for extroverts and quieter experiences for introverts. 

IMPORTANT SCHEDULING RULES:
1. Account for travel time between activities (typically 15-45 minutes depending on distance)
2. If an activity takes 2 hours and starts at 9:00 AM, the next activity should start no earlier than 11:30 AM (2 hours + 30 minutes travel time)
3. Include realistic travel times in the duration field
4. Don't schedule activities too close together - allow buffer time for travel and preparation
5. Consider opening hours and peak times for venues

Include specific venue suggestions, timing, and explain why each activity suits the group's energy levels.

Return your response in the following JSON format:
{
  "overview": "Brief overview of the itinerary approach",
  "tripDetails": {
    "duration": ${tripDetails.duration},
    "location": "${tripDetails.location}",
    "budget": "${tripDetails.budget}",
    "interests": "${tripDetails.interests}",
    "requirements": "${tripDetails.requirements || ""}"
  },
  "days": [
    {
      "day": 1,
      "theme": "Day theme",
      "activities": [
        {
          "time": "9:00 AM",
          "activity": "Activity name",
          "location": "Venue/Location",
          "duration": "2 hours",
          "description": "Brief description",
          "energyLevel": "low/medium/high",
          "socialIntensity": "low/medium/high",
          "whyThisWorks": "Explanation for this group"
        }
      ]
    }
  ],
  "tips": ["Tip 1", "Tip 2", "Tip 3"]
}

IMPORTANT: Create exactly ${tripDetails.duration} days in the "days" array, numbered from 1 to ${tripDetails.duration}.

Only return the JSON, no additional text.`;

        try {
          const payload = {
            messages: [{ role: "user", content: prompt }],
          };

          const response = await fetch(
            "https://ai.hackclub.com/chat/completions",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          const content = data.choices[0].message.content;

          // Clean and parse the response - handle <think> tags and code blocks
          let cleanedContent = content
            .replace(/```json\n?|\n?```/g, "")
            .trim();

          // Remove <think> tags and everything before the first {
          if (cleanedContent.includes("<think>")) {
            const jsonStart = cleanedContent.indexOf("{");
            if (jsonStart !== -1) {
              cleanedContent = cleanedContent.substring(jsonStart);
            }
          }

          // Remove any trailing </think> or similar tags
          const jsonEnd = cleanedContent.lastIndexOf("}");
          if (jsonEnd !== -1) {
            cleanedContent = cleanedContent.substring(0, jsonEnd + 1);
          }

          return JSON.parse(cleanedContent);
        } catch (error) {
          console.error("AI Itinerary Generation Error:", error);
          throw new Error("Failed to generate itinerary. Please try again.");
        }
      },
    };

    // Enhanced Groups System with AI Premium Features


    function showAIPremiumModal(groupId) {
      if (!AI_PREMIUM_ENABLED) {
        NotificationSystem.show(
          "Premium features are currently disabled.",
          "warning"
        );
        return;
      }

      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      const modalHtml = `
    <div id="ai-premium-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeAIPremiumModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-robot"></i> AI Premium Trip Planner
          </h2>
          <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">
            PREMIUM
          </div>
        </div>
        <div class="modal-body">
          <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);">‚ú® AI-Powered Group Itinerary</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #666;">
              Our AI will analyze your group's personality types and create a personalized day-by-day itinerary 
              that balances everyone's energy preferences and interests.
            </p>
          </div>

          <form id="ai-trip-form" onsubmit="generateAIItinerary(event, ${groupId})">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group">
                <label for="trip-duration">Trip Duration *</label>
                <select id="trip-duration" class="form-control" required onchange="handleTripDurationChange()">
                  <option value="">Select duration</option>
                  <option value="1">1 Day</option>
                  <option value="2">2 Days</option>
                  <option value="3">3 Days</option>
                  <option value="4">4 Days</option>
                  <option value="5">5 Days</option>
                  <option value="7">1 Week</option>
                  <option value="custom">Custom Duration</option>
                </select>
                <input type="number" id="custom-duration" class="form-control" 
                       placeholder="Enter number of days" min="1" max="30" 
                       style="display: none; margin-top: 0.5rem;">
              </div>
              <div class="form-group">
                <label for="trip-budget">Budget Level *</label>
                <select id="trip-budget" class="form-control" required>
                  <option value="">Select budget</option>
                  <option value="budget">Budget-Friendly</option>
                  <option value="moderate">Moderate</option>
                  <option value="premium">Premium</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="trip-location">Location/City *</label>
              <input type="text" id="trip-location" class="form-control" 
                     placeholder="e.g., New York City, Paris, Tokyo" required>
            </div>

            <div class="form-group">
              <label for="trip-interests">Group Interests *</label>
              <textarea id="trip-interests" class="form-control" rows="3" 
                        placeholder="e.g., museums, nightlife, food tours, outdoor activities, shopping, historical sites..." required></textarea>
            </div>

            <div class="form-group">
              <label for="trip-requirements">Special Requirements (Optional)</label>
              <textarea id="trip-requirements" class="form-control" rows="2" 
                        placeholder="e.g., dietary restrictions, accessibility needs, transportation preferences..."></textarea>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 12px 24px;">
                <i class="fas fa-magic"></i> Generate AI Itinerary
              </button>
              <button type="button" class="btn btn-secondary" onclick="closeAIPremiumModal()">Cancel</button>
            </div>
          </form>

          <div id="ai-loading" class="ai-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>AI is crafting your perfect itinerary...</p>
          </div>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
    }

    function closeAIPremiumModal() {
      const modal = document.getElementById("ai-premium-modal");
      if (modal) modal.remove();
    }

    function handleTripDurationChange() {
      const durationSelect = document.getElementById("trip-duration");
      const customDurationInput = document.getElementById("custom-duration");
      
      if (durationSelect.value === "custom") {
        customDurationInput.style.display = "block";
        customDurationInput.required = true;
      } else {
        customDurationInput.style.display = "none";
        customDurationInput.required = false;
      }
    }

    async function generateAIItinerary(event, groupId) {
      event.preventDefault();

      let duration = document.getElementById("trip-duration").value;
      if (duration === "custom") {
        duration = document.getElementById("custom-duration").value;
        if (!duration || duration < 1 || duration > 30) {
          NotificationSystem.show("Please enter a valid custom duration (1-30 days)", "error");
          return;
        }
      }
      const budget = document.getElementById("trip-budget").value;
      const location = document.getElementById("trip-location").value;
      const interests = document.getElementById("trip-interests").value;
      const requirements = document.getElementById("trip-requirements").value;

      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      // Show loading state
      document.getElementById("ai-trip-form").style.display = "none";
      document.getElementById("ai-loading").style.display = "block";

      try {
        const tripDetails = {
          duration,
          budget,
          location,
          interests,
          requirements,
        };
        const itinerary = await AIItineraryGenerator.generateItinerary(
          group,
          tripDetails
        );

        // Save itinerary to group
        const groupIndex = groups.findIndex((g) => g.id === groupId);
        if (groupIndex !== -1) {
          groups[groupIndex].aiItinerary = {
            ...itinerary,
            tripDetails,
            generatedAt: new Date().toISOString(),
          };
          DataLayer.save("groups", groups);
        }

        closeAIPremiumModal();
        GroupsSystem.displayGroups();
        NotificationSystem.show(
          "AI Itinerary generated successfully!",
          "success"
        );

        // Scroll to the group with the new itinerary
        setTimeout(() => {
          const groupCard = document.querySelector(
            `[data-group-id="${groupId}"]`
          );
          if (groupCard) {
            groupCard.scrollIntoView({ behavior: "smooth" });
          }
        }, 500);
      } catch (error) {
        console.error("Error generating itinerary:", error);
        NotificationSystem.show(
          "Failed to generate itinerary. Please try again.",
          "error"
        );

        // Reset form
        document.getElementById("ai-loading").style.display = "none";
        document.getElementById("ai-trip-form").style.display = "block";
      }
    }

    function renderAIItinerary(group) {
      if (!group.aiItinerary) return "";

      const itinerary = group.aiItinerary;

      return `
    <div class="ai-itinerary-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(31, 59, 115, 0.05) 0%, rgba(74, 144, 226, 0.05) 100%); border-radius: 15px; border: 2px solid rgba(31, 59, 115, 0.2);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <h4 style="margin: 0; color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-robot"></i> AI Generated Itinerary
        </h4>
        <div style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
          PREMIUM
        </div>
      </div>
      
      <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; font-size: 0.8rem;">
          <div><strong>Duration:</strong> ${itinerary.tripDetails.duration} days</div>
          <div><strong>Location:</strong> ${itinerary.tripDetails.location.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ')}</div>
          <div><strong>Budget:</strong> ${itinerary.tripDetails.budget.charAt(0).toUpperCase() + itinerary.tripDetails.budget.slice(1).toLowerCase()}</div>
        </div>
      </div>

      <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
        <p style="margin: 0; font-style: italic; color: #666; font-size: 0.9rem;">${itinerary.overview
        }</p>
      </div>

      <div class="itinerary-timeline" style="position: relative;">
        ${itinerary.days
          .map(
            (day, index) => `
          <div class="day-card" style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid var(--secondary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <div style="width: 40px; height: 40px; background: var(--primary-gradient); color: var(--inverted-text-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${day.day}
              </div>
              <div>
                <h5 style="margin: 0; color: #333;">Day ${day.day}</h5>
                <div style="color: var(--secondary-color); font-weight: bold; font-size: 0.9rem;">${day.theme
              }</div>
              </div>
            </div>
            
            <div class="activities-list">
              ${day.activities
                .map(
                  (activity, activityIndex) => `
    <div class="activity-item" style="display: flex; gap: 1rem; padding: 1rem; background: rgba(31, 59, 115, 0.05); border-radius: 8px; margin-bottom: 0.8rem; position: relative;">
      <div style="width: 60px; text-align: center; font-weight: bold; color: var(--secondary-color); flex-shrink: 0;">
        ${activity.time}
      </div>
      <div style="flex: 1;">
        <div style="font-weight: bold; margin-bottom: 0.3rem;">${activity.activity
                    }</div>
        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.3rem;">
          üìç ${activity.location} ‚Ä¢ ‚è±Ô∏è ${activity.duration}
        </div>
        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">${activity.description
                    }</div>
        <div style="display: flex; gap: 1rem; font-size: 0.7rem;">
          <span style="background: ${activity.energyLevel === "high"
                      ? "#ff6b6b"
                      : activity.energyLevel === "medium"
                        ? "#ffd43b"
                        : "#51cf66"
                    }; color: white; padding: 0.2rem 0.5rem; border-radius: 10px;">
            Energy: ${activity.energyLevel}
          </span>
          <span style="background: ${activity.socialIntensity === "high"
                      ? "#ff6b6b"
                      : activity.socialIntensity === "medium"
                        ? "#ffd43b"
                        : "#51cf66"
                    }; color: white; padding: 0.2rem 0.5rem; border-radius: 10px;">
            Social: ${activity.socialIntensity}
          </span>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--secondary-color); font-style: italic;">
          üí° ${activity.whyThisWorks}
        </div>
      </div>
      <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.3rem;">
        <button onclick="showAIEditModal(${group.id}, ${index}, ${activityIndex})" 
                style="background: var(--secondary-color); color: var(--inverted-text-color); border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;" 
                title="Edit activity">
          ‚úèÔ∏è
        </button>
        <button onclick="deleteActivity(${group.id}, ${index}, ${activityIndex})" 
                style="background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;" 
                title="Delete activity">
          üóëÔ∏è
        </button>
      </div>
    </div>
  `
                )
                .join("")}
            </div>
          </div>
        `
          )
          .join("")}
      </div>

      <div style="background: white; padding: 1rem; border-radius: 10px; margin-top: 1rem;">
        <h5 style="margin: 0 0 0.8rem 0; color: var(--secondary-color);">üí° AI Tips for Your Group</h5>
        <ul style="margin: 0; padding-left: 1.2rem;">
          ${itinerary.tips
          .map(
            (tip) =>
              `<li style="margin-bottom: 0.3rem; color: #666; font-size: 0.9rem;">${tip}</li>`
          )
          .join("")}
        </ul>
      </div>

      <div style="text-align: center; margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
  <button class="btn" onclick="showAIAssistantModal(${group.id})" 
          style="font-size: 0.8rem; padding: 6px 12px; background: var(--primary-gradient); color: var(--inverted-text-color);">
    <i class="fas fa-robot"></i> AI Assistant
  </button>
  <button class="btn btn-secondary" onclick="regenerateItinerary(${group.id
        })" style="font-size: 0.8rem; padding: 6px 12px;">
    <i class="fas fa-redo"></i> Regenerate
  </button>
</div>
    </div>
  `;
    }

    function regenerateItinerary(groupId) {
      if (
        confirm(
          "Are you sure you want to regenerate the itinerary? This will replace the current one."
        )
      ) {
        showAIPremiumModal(groupId);
      }
    }
    function showAIEditModal(groupId, dayIndex, activityIndex) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      const activity = group.aiItinerary.days[dayIndex].activities[activityIndex];

      const modalHtml = `
    <div id="ai-edit-modal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeAIEditModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color);">‚úèÔ∏è Edit Activity</h2>
        </div>
        <div class="modal-body">
          <form id="ai-edit-form" onsubmit="updateActivity(event, ${groupId}, ${dayIndex}, ${activityIndex})">
            <div class="form-group">
              <label for="edit-activity-name">Activity Name *</label>
              <input type="text" id="edit-activity-name" class="form-control" value="${activity.activity}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-location">Location *</label>
              <input type="text" id="edit-activity-location" class="form-control" value="${activity.location}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-time">Time *</label>
              <input type="text" id="edit-activity-time" class="form-control" value="${activity.time}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-duration">Duration *</label>
              <input type="text" id="edit-activity-duration" class="form-control" value="${activity.duration}" required>
            </div>
            <div class="form-group">
              <label for="edit-activity-description">Description</label>
              <textarea id="edit-activity-description" class="form-control" rows="3">${activity.description}</textarea>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="closeAIEditModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
    }

    function closeAIEditModal() {
      const modal = document.getElementById("ai-edit-modal");
      if (modal) modal.remove();
    }

    function updateActivity(event, groupId, dayIndex, activityIndex) {
      event.preventDefault();

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      const activity = groups[groupIndex].aiItinerary.days[dayIndex].activities[activityIndex];

      activity.activity = document.getElementById("edit-activity-name").value;
      activity.location = document.getElementById("edit-activity-location").value;
      activity.time = document.getElementById("edit-activity-time").value;
      activity.duration = document.getElementById("edit-activity-duration").value;
      activity.description = document.getElementById("edit-activity-description").value;

      DataLayer.save("groups", groups);
      closeAIEditModal();
      GroupsSystem.displayGroups();
      NotificationSystem.show("Activity updated successfully!", "success");
    }

    function parseDuration(durationStr) {
      // Parse duration strings like "2 hours", "30 minutes", "1.5 hours"
      const match = durationStr.match(/(\d+(?:\.\d+)?)\s*(hour|minute|hr|min)s?/i);
      if (!match) return 60; // Default to 1 hour if can't parse
      
      const value = parseFloat(match[1]);
      const unit = match[2].toLowerCase();
      
      if (unit.includes('hour') || unit.includes('hr')) {
        return value * 60; // Convert to minutes
      } else if (unit.includes('minute') || unit.includes('min')) {
        return value;
      }
      return 60; // Default
    }

    function addMinutesToTime(timeStr, minutesToAdd) {
      // Parse time like "9:00 AM" and add minutes
      const [time, period] = timeStr.split(' ');
      let [hours, minutes] = time.split(':').map(Number);
      
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      
      const totalMinutes = hours * 60 + minutes + minutesToAdd;
      const newHours = Math.floor(totalMinutes / 60);
      const newMinutes = totalMinutes % 60;
      
      let displayHours = newHours;
      let newPeriod = 'AM';
      
      if (newHours >= 12) {
        newPeriod = 'PM';
        if (newHours > 12) displayHours = newHours - 12;
      }
      if (displayHours === 0) displayHours = 12;
      
      return `${displayHours}:${newMinutes.toString().padStart(2, '0')} ${newPeriod}`;
    }

    function rescheduleActivities(activities) {
      if (activities.length === 0) return activities;
      
      const rescheduled = [];
      let currentTime = activities[0].time;
      
      for (let i = 0; i < activities.length; i++) {
        const activity = { ...activities[i] };
        activity.time = currentTime;
        rescheduled.push(activity);
        
        // Calculate next start time
        const durationMinutes = parseDuration(activity.duration);
        const travelTime = 30; // Assume 30 minutes travel time between activities
        const totalTime = durationMinutes + travelTime;
        
        if (i < activities.length - 1) {
          currentTime = addMinutesToTime(currentTime, totalTime);
        }
      }
      
      return rescheduled;
    }

    function deleteActivity(groupId, dayIndex, activityIndex) {
      if (!confirm("Are you sure you want to delete this activity?")) return;

      const groups = DataLayer.load("groups", []);
      const groupIndex = groups.findIndex((g) => g.id === groupId);
      if (groupIndex === -1) return;

      // Remove the activity
      groups[groupIndex].aiItinerary.days[dayIndex].activities.splice(activityIndex, 1);

      // Reschedule remaining activities for this day
      if (groups[groupIndex].aiItinerary.days[dayIndex].activities.length > 0) {
        groups[groupIndex].aiItinerary.days[dayIndex].activities = 
          rescheduleActivities(groups[groupIndex].aiItinerary.days[dayIndex].activities);
      }

      DataLayer.save("groups", groups);
      GroupsSystem.displayGroups();
      NotificationSystem.show("Activity deleted and schedule updated!", "success");
    }

    function showAIAssistantModal(groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      const modalHtml = `
    <div id="ai-assistant-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeAIAssistantModal()">&times;</button>
        <div class="modal-header">
          <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-robot"></i> AI Assistant
          </h2>
        </div>
        <div class="modal-body">
          <div style="background: rgba(74, 144, 226, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);">ü§ñ Ask me to modify your itinerary!</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #666;">
              Examples: "Make day 2 more relaxing", "Replace the museum with outdoor activities", "Add more food options"
            </p>
          </div>

          <form id="ai-assistant-form" onsubmit="handleAIAssistantRequest(event, ${groupId})">
            <div class="form-group">
              <label for="ai-request">What would you like me to change? *</label>
              <textarea id="ai-request" class="form-control" rows="4" 
                        placeholder="e.g., Make the first day less crowded, add more restaurants, replace nightlife with quiet activities..." required></textarea>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color); padding: 12px 24px;">
                <i class="fas fa-magic"></i> Apply Changes
              </button>
              <button type="button" class="btn btn-secondary" onclick="closeAIAssistantModal()">Cancel</button>
            </div>
          </form>

          <div id="ai-assistant-loading" class="ai-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>AI is updating your itinerary...</p>
          </div>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
    }

    function closeAIAssistantModal() {
      const modal = document.getElementById("ai-assistant-modal");
      if (modal) modal.remove();
    }

    async function handleAIAssistantRequest(event, groupId) {
      event.preventDefault();

      const request = document.getElementById("ai-request").value;
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group || !group.aiItinerary) return;

      // Show loading state
      document.getElementById("ai-assistant-form").style.display = "none";
      document.getElementById("ai-assistant-loading").style.display = "block";

      try {
        const prompt = `You are an expert trip planner. I have an existing itinerary and need you to modify it based on a specific request.

Current Group Information:
- Group Name: ${group.name}
- Group Description: ${group.description}
- Members and their personality types:
${group.members
            .map(
              (member) =>
                `  ‚Ä¢ ${member.displayName}: ${member.personalityType} (Adjustment Factor: ${member.adjustmentFactor})`
            )
            .join("\n")}

Current Itinerary:
${JSON.stringify(group.aiItinerary, null, 2)}

User Request: "${request}"

IMPORTANT INSTRUCTIONS:
1. If the user requests changes to duration, location, or budget, update the tripDetails accordingly
2. If the user asks for a different number of days, create exactly that many days (no more, no less)
3. Maintain the same JSON structure and format
4. Keep the balance for the group's personality mix
5. Return the COMPLETE modified itinerary including updated tripDetails if needed

SCHEDULING RULES:
- Account for travel time between activities (15-45 minutes)
- If an activity takes 2 hours and starts at 9:00 AM, next activity should start no earlier than 11:30 AM
- Include realistic travel times in duration fields
- Don't schedule activities too close together
- Consider opening hours and peak times

Only return the JSON, no additional text.`;

        const payload = {
          messages: [{ role: "user", content: prompt }],
        };

        const response = await fetch("https://ai.hackclub.com/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content;

        // Clean and parse the response
        let cleanedContent = content.replace(/```json\n?|\n?```/g, "").trim();

        if (cleanedContent.includes("<think>")) {
          const jsonStart = cleanedContent.indexOf("{");
          if (jsonStart !== -1) {
            cleanedContent = cleanedContent.substring(jsonStart);
          }
        }

        const jsonEnd = cleanedContent.lastIndexOf("}");
        if (jsonEnd !== -1) {
          cleanedContent = cleanedContent.substring(0, jsonEnd + 1);
        }

        const updatedItinerary = JSON.parse(cleanedContent);

        // Update the group's itinerary
        const groupIndex = groups.findIndex((g) => g.id === groupId);
        if (groupIndex !== -1) {
          // Preserve existing tripDetails if the AI didn't update them
          const preservedTripDetails = updatedItinerary.tripDetails || group.aiItinerary.tripDetails;
          
          groups[groupIndex].aiItinerary = {
            ...updatedItinerary,
            tripDetails: preservedTripDetails,
            generatedAt: group.aiItinerary.generatedAt,
            lastModified: new Date().toISOString(),
          };
          DataLayer.save("groups", groups);
        }

        closeAIAssistantModal();
        GroupsSystem.displayGroups();
        NotificationSystem.show("Itinerary updated successfully!", "success");

      } catch (error) {
        console.error("Error updating itinerary:", error);
        NotificationSystem.show("Failed to update itinerary. Please try again.", "error");

        // Reset form
        document.getElementById("ai-assistant-loading").style.display = "none";
        document.getElementById("ai-assistant-form").style.display = "block";
      }
    }

    // Add CSS for AI Premium features
    const aiPremiumStyles = document.createElement("style");
    aiPremiumStyles.textContent = `
  .ai-loading {
    text-align: center;
    padding: 3rem 1rem;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .itinerary-timeline::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 60px;
    bottom: 20px;
    width: 2px;
    background: var(--primary-gradient);
    z-index: 0;
  }

  .day-card {
    position: relative;
    z-index: 1;
  }

  .activity-item:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-small);
    transition: all 0.2s ease;
  }

  @media (max-width: 768px) {
    .ai-itinerary-section {
      margin: 1rem -1rem;
      border-radius: 0;
    }
    
    .day-card {
      margin: 0 -0.5rem 1rem;
      border-radius: 8px;
    }
    
    .activity-item {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .activity-item > div:first-child {
      width: auto;
      text-align: left;
    }
  }
`;
    document.head.appendChild(aiPremiumStyles);

    // Groups System
    const GroupsSystem = {
      init: () => {
        GroupsSystem.displayGroups();
      },

      createGroup: (name, description, members) => {
        const currentUser = DataLayer.load("currentUser");
        const personalityData = DataLayer.load("personalityScore");

        if (!personalityData) {
          NotificationSystem.show(
            "Please complete the personality assessment first!",
            "warning"
          );
          return;
        }

        const group = {
          id: Date.now(),
          name: name.trim(),
          description: description.trim(),
          createdBy: currentUser.id,
          createdAt: new Date().toISOString(),
          members: [
            {
              userId: currentUser.id,
              displayName: currentUser.displayName,
              personalityType: currentUser.personalityType,
              adjustmentFactor: personalityData.adjustmentFactor,
              avatar: currentUser.avatar,
              importance: 1.0,
            },
            ...members,
          ],
        };

        DataLayer.push("groups", group);
        GroupsSystem.displayGroups();
        closeModal();
      },

      deleteGroup: (groupId) => {
        if (confirm("Are you sure you want to delete this group?")) {
          DataLayer.remove("groups", (group) => group.id === groupId);
          GroupsSystem.displayGroups();
        }
      },

      getGroupRecommendations: (group) => {
        const allExperiences = ActivitySystem.getAllExperiences();
        const userExperiences = DataLayer.load("userExperiences", []);
        const userExperienceNames = userExperiences.map((exp) =>
          exp.name.toLowerCase()
        );

        const recommendations = [];

        // Group experiences by name to avoid duplicates
        const experienceGroups = {};
        allExperiences.forEach((exp) => {
          const key = exp.name.toLowerCase();
          if (!experienceGroups[key]) {
            experienceGroups[key] = [];
          }
          experienceGroups[key].push(exp);
        });

        Object.entries(experienceGroups).forEach(([name, experiences]) => {
          let groupScore = 0;
          let individualScores = [];
          let totalWeight = 0;
          let hasValidPredictions = false;

          group.members.forEach((member) => {
            let memberScore = 0;
            let memberPredictions = 0;

            experiences.forEach((exp) => {
              const ratingUser = DemoUsers.users[exp.userId];
              if (ratingUser) {
                const prediction = ActivitySystem.predictRating(
                  member.adjustmentFactor,
                  exp,
                  ratingUser.adjustmentFactor,
                  exp.rawScore
                );
                memberScore += prediction.prediction * prediction.confidence;
                memberPredictions++;
                hasValidPredictions = true;
              }
            });

            if (memberPredictions > 0) {
              const avgMemberScore = memberScore / memberPredictions;
              individualScores.push({
                member: member,
                score: avgMemberScore,
              });
              groupScore += avgMemberScore * member.importance;
              totalWeight += member.importance;
            }
          });

          if (hasValidPredictions && totalWeight > 0) {
            const finalGroupScore = groupScore / totalWeight;
            const scoreVariance = GroupsSystem.calculateVariance(
              individualScores.map((s) => s.score)
            );
            const confidence = Math.max(0.1, 1 - scoreVariance / 10);

            recommendations.push({
              experience: experiences[0],
              groupScore: finalGroupScore,
              confidence: confidence,
              individualScores: individualScores,
              variance: scoreVariance,
            });
          }
        });

        return recommendations.sort(
          (a, b) => b.groupScore * b.confidence - a.groupScore * a.confidence
        );
      },

      calculateVariance: (scores) => {
        if (scores.length === 0) return 0;
        const mean =
          scores.reduce((sum, score) => sum + score, 0) / scores.length;
        const variance =
          scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) /
          scores.length;
        return Math.sqrt(variance);
      },

      displayGroups: () => {
        const groups = DataLayer.load("groups", []);
        const groupsContent = document.getElementById("groups-content");

        if (groups.length === 0) {
          groupsContent.innerHTML = `
      <div class="empty-state">
        <h3>No groups yet</h3>
        <p>Create your first group to start planning activities with friends!</p>
      </div>
    `;
          return;
        }

        groupsContent.innerHTML = groups
          .map((group) => {
            const recommendations =
              GroupsSystem.getGroupRecommendations(group);
            const topRecommendations = recommendations.slice(0, 3);

            // Initialize votes if not exists
            if (!group.votes) group.votes = {};

            // Find most voted activity
            let mostVoted = null;
            let maxVotes = 0;
            Object.entries(group.votes).forEach(([activityName, votes]) => {
              if (votes.length > maxVotes) {
                maxVotes = votes.length;
                mostVoted = activityName;
              }
            });

            return `
        <div class="group-card" data-group-id="${group.id}">
          <div class="group-header">
            <div>
              <h3>${group.name}</h3>
              <p style="margin: 0.5rem 0; color: #666;">${group.description}</p>
              <small style="color: #888;">Created ${new Date(
              group.createdAt
            ).toLocaleDateString()}</small>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              ${AI_PREMIUM_ENABLED
                ? `
                                <button class="btn" style="background: var(--primary-gradient); color: var(--inverted-text-color);"
                        onclick="showAIPremiumModal(${group.id})">
                  <i class="fa-solid fa-crown"></i> AI Trip Planner
                </button>
              `
                : ""
              }
              <button class="edit-group-btn" onclick="GroupsSystem.editGroup(${group.id
              })">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="btn btn-danger" onclick="GroupsSystem.deleteGroup(${group.id
              })">Delete</button>
            </div>
          </div>

          <div class="group-members">
            <strong>Members (${group.members.length}):</strong>
            <div>
              ${group.members
                .map(
                  (member) => `
                <div class="member-tag">
                  ${member.displayName} (${member.personalityType})
                </div>
              `
                )
                .join("")}
            </div>
          </div>

          ${renderAIItinerary(group)}

          ${topRecommendations.length > 0 && !group.aiItinerary
                ? `
  <div style="margin-top: 1.5rem;">
    <h4>Top Recommendations for Your Group</h4>
    <div class="voting-section">
      <p style="margin-bottom: 1rem; font-weight: bold; color: #333;">Vote for your preferred activity:</p>
    </div>
              <div class="activity-grid">
                ${topRecommendations
                  .map((rec) => {
                    const activityName = rec.experience.name;
                    const votes = group.votes[activityName] || [];
                    const currentUserId = DataLayer.load("currentUser").id;
                    const hasVoted = votes.includes(currentUserId);
                    const isMostVoted =
                      mostVoted === activityName && maxVotes > 0;

                    return `
                    <div class="activity-card ${isMostVoted ? "most-voted" : ""
                      }" style="border: 2px solid #51cf66;">
                      <div style="background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); color: white; padding: 0.5rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-radius: 15px 15px 0 0;">
                        <div style="font-weight: bold;">Group Score: ${rec.groupScore.toFixed(
                        1
                      )}/10</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Confidence: ${(
                        rec.confidence * 100
                      ).toFixed(0)}%</div>
                      </div>
                      <div class="activity-title">${rec.experience.name}</div>
                      <div class="activity-category">${rec.experience.category
                      } ‚Ä¢ ${rec.experience.location}</div>
                      ${rec.experience.description
                        ? `<p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">${rec.experience.description}</p>`
                        : ""
                      }

                      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                        <strong style="font-size: 0.9rem;">Individual Predictions:</strong>
                        ${rec.individualScores
                        .map(
                          (score) => `
                          <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; margin-top: 0.3rem;">
                            <span>${score.member.avatar} ${score.member.displayName
                            }</span>
                            <span style="font-weight: bold; color: ${score.score >= 7
                              ? "#4CAF50"
                              : score.score >= 5
                                ? "#FF9800"
                                : "#f44336"
                            }">${score.score.toFixed(1)}/10</span>
                          </div>
                        `
                        )
                        .join("")}
                        <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                          Group Compatibility: 
                          <span style="font-weight: bold; color: ${rec.variance <= 1.5
                        ? "#4CAF50"
                        : rec.variance <= 3
                          ? "#FF9800"
                          : "#f44336"
                      }">
                            ${rec.variance <= 1.5
                        ? "High"
                        : rec.variance <= 3
                          ? "Medium"
                          : "Low"
                      }
                          </span>
                        </div>
                        
                        <!-- Voting section -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                          <button class="vote-button ${hasVoted ? "voted" : ""
                      }" 
                                  onclick="GroupsSystem.voteForActivity(${group.id
                      }, '${activityName}')">
                            ${hasVoted ? "‚úì Voted" : "Vote for this"}
                          </button>
                          <div class="vote-count">
                            ${votes.length} vote${votes.length !== 1 ? "s" : ""}
                            ${votes.length > 0
                        ? `(${votes
                          .map((userId) => {
                            const member = group.members.find(
                              (m) => m.userId === userId
                            );
                            return member ? member.avatar : "?";
                          })
                          .join(", ")})`
                        : ""
                      }
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            </div>
          `
                : '<p style="color: #666;">No recommendations available yet. More community data needed!</p>'
              }
        </div>
      `;
          })
          .join("");
      },
    };

    //GroupsSystem object
    GroupsSystem.voteForActivity = function (groupId, activityName) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      // Initialize votes if not exists
      if (!group.votes) group.votes = {};

      const currentUserId = DataLayer.load("currentUser").id;

      // Remove user's vote from all other activities first
      Object.entries(group.votes).forEach(([activity, votes]) => {
        const voteIndex = votes.indexOf(currentUserId);
        if (voteIndex > -1) {
          votes.splice(voteIndex, 1);
        }
      });

      // Initialize the current activity's votes array if it doesn't exist
      if (!group.votes[activityName]) group.votes[activityName] = [];

      // Add vote for the new activity
      if (!group.votes[activityName].includes(currentUserId)) {
        group.votes[activityName].push(currentUserId);
      }

      // Update groups data
      DataLayer.save("groups", groups);
      GroupsSystem.displayGroups();
    };

    GroupsSystem.editGroup = function (groupId) {
      const groups = DataLayer.load("groups", []);
      const group = groups.find((g) => g.id === groupId);
      if (!group) return;

      const friends = FriendsSystem.getFriends();
      const currentMembers = group.members.filter(
        (m) => m.userId !== DataLayer.load("currentUser").id
      );

      const modalHtml = `
    <div id="edit-group-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
        <div class="modal-header">
          <h2>Edit Group</h2>
        </div>
        <div class="modal-body">
          <form id="edit-group-form" onsubmit="handleEditGroup(event, ${groupId})">
            <div class="form-group">
              <label for="edit-group-name">Group Name *</label>
              <input type="text" id="edit-group-name" class="form-control" value="${group.name
        }" required>
            </div>
            <div class="form-group">
              <label for="edit-group-description">Description</label>
              <textarea id="edit-group-description" class="form-control">${group.description
        }</textarea>
            </div>
            <div class="form-group">
              <label>Current Members</label>
              <div style="margin-bottom: 1rem;">
                ${currentMembers
          .map(
            (member) => `
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #eee; border-radius: 8px;">
                    <input type="checkbox" id="keep-member-${member.userId}" checked>
                    <div class="feed-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">${member.avatar}</div>
                    <span>${member.displayName} (${member.personalityType})</span>
                  </div>
                `
          )
          .join("")}
              </div>
              <label>Add New Members</label>
              ${friends
          .filter(
            (friend) => !group.members.some((m) => m.userId === friend.id)
          )
          .map(
            (friend) => `
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #eee; border-radius: 8px;">
                  <input type="checkbox" id="add-member-${friend.id}">
                  <div class="feed-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">${friend.avatar}</div>
                  <span>${friend.displayName} (${friend.personalityType})</span>
                </div>
              `
          )
          .join("")}
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
    };

    // Modal system for creating groups
    function showCreateGroupModal() {
      // Get friends list
      const friends = FriendsSystem.getFriends();

      if (friends.length === 0) {
        NotificationSystem.show(
          "Add some friends first before creating a group!",
          "warning"
        );
        showPage("feed");
        return;
      }

      const modalHtml = `
    <div id="group-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-header">
          <h2>Create New Group</h2>
        </div>
        <div class="modal-body">
          <form id="group-form" onsubmit="handleCreateGroup(event)">
            <div class="form-group">
              <label for="group-name">Group Name *</label>
              <input type="text" id="group-name" class="form-control" placeholder="e.g., Friday Night Crew, Study Group" required>
            </div>
            <div class="form-group">
              <label for="group-description">Description</label>
              <textarea id="group-description" class="form-control" placeholder="What's this group about?"></textarea>
            </div>
            <div class="form-group">
              <label>Add Friends to Group *</label>
              <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">Select friends to add to your group:</p>
              ${friends
          .map(
            (friend) => `
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid #eee; border-radius: 8px;">
                    <input type="checkbox" id="member-${friend.id}" value="${friend.id
              }">
                    <div class="feed-avatar" style="width: 35px; height: 35px; font-size: 1rem;">${friend.avatar
              }</div>
                    <div style="flex: 1;">
                      <strong>${friend.displayName}</strong>
                      <div style="font-size: 0.8rem; color: var(--secondary-color);">${friend.personalityType
              }</div>
                      <div style="font-size: 0.8rem; color: #888;">AF: ${friend.adjustmentFactor.toFixed(
                2
              )}</div>
                    </div>
                  </div>
              `
          )
          .join("")}
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Create Group</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
    }
    function handleCreateGroup(event) {
      event.preventDefault();

      const name = document.getElementById("group-name").value;
      const description = document.getElementById("group-description").value;

      // Get selected friends
      const selectedMembers = [];
      const friends = FriendsSystem.getFriends();
      friends.forEach((friend) => {
        const checkbox = document.getElementById(`member-${friend.id}`);
        if (checkbox && checkbox.checked) {
          selectedMembers.push({
            userId: friend.id,
            displayName: friend.displayName,
            personalityType: friend.personalityType,
            adjustmentFactor: friend.adjustmentFactor, // Fixed: was user.adjustmentFactor
            avatar: friend.avatar, // Fixed: was user.avatar
            importance: 1.0,
          });
        }
      });

      if (selectedMembers.length === 0) {
        NotificationSystem.show(
          "Please select at least one member to add to the group.",
          "warning"
        );
        return;
      }

      GroupsSystem.createGroup(name, description, selectedMembers);
    }

    // Updated showCreateGroupModal to limit to 3-6 friends displayed
    function showCreateGroupModal() {
      const friends = FriendsSystem.getFriends();

      if (friends.length === 0) {
        NotificationSystem.show(
          "Add some friends first before creating a group!",
          "warning"
        );
        showPage("feed");
        return;
      }

      // Limit to first 6 friends for better UI
      const displayFriends = friends.slice(0, 6);

      const modalHtml = `
    <div id="group-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-header">
          <h2>Create New Group</h2>
        </div>
        <div class="modal-body">
          <form id="group-form" onsubmit="handleCreateGroup(event)">
            <div class="form-group">
              <label for="group-name">Group Name *</label>
              <input type="text" id="group-name" class="form-control" placeholder="e.g., Friday Night Crew, Study Group" required>
            </div>
            <div class="form-group">
              <label for="group-description">Description</label>
              <textarea id="group-description" class="form-control" placeholder="What's this group about?"></textarea>
            </div>
            <div class="form-group">
              <label>Add Friends to Group *</label>
              <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">Select friends to add to your group:</p>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.8rem;">
                ${displayFriends
          .map(
            (friend) => `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; border: 1px solid #eee; border-radius: 8px;">
                      <input type="checkbox" id="member-${friend.id}" value="${friend.id
              }">
                      <div class="feed-avatar" style="width: 35px; height: 35px; font-size: 1rem;">${friend.avatar
              }</div>
                                          <div style="flex: 1;">
                      <strong>${friend.displayName}</strong>
                      <div style="font-size: 0.8rem; color: var(--secondary-color);">${friend.personalityType
              }</div>
                      <div style="font-size: 0.8rem; color: #888;">AF: ${friend.adjustmentFactor.toFixed(
                2
              )}</div>
                    </div>
                    </div>
                `
          )
          .join("")}
              </div>
              ${friends.length > 6
          ? `<p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem; font-style: italic;">Showing first 6 friends. You can add more after creating the group.</p>`
          : ""
        }
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Create Group</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);
    }

    // Enhanced closeModal function
    function closeModal() {
      const modal = document.getElementById("group-modal");
      if (modal) {
        modal.style.animation = "fadeOut 0.3s ease forwards";
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
          }
        }, 300);
      }
    }

    const fadeOutStyle = document.createElement("style");
    fadeOutStyle.textContent = `
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
`;
    document.head.appendChild(fadeOutStyle);
    function closeModal() {
      const modal = document.getElementById("group-modal");
      if (modal) {
        modal.remove();
      }
    }

    // Recommendation System
    const RecommendationSystem = {
      displayRecommendations: () => {
        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) return "";

        const recommendations = ActivitySystem.getRecommendations(
          personalityData.adjustmentFactor
        );
        const friends = FriendsSystem.getFriends();

        if (recommendations.length === 0) {
          if (friends.length === 0) {
            return `
          <div style="margin-bottom: 2rem;">
            <h3>No Recommendations Yet</h3>
            <p style="color: #666;">Add friends to get personalized recommendations based on places they've visited!</p>
            <div style="text-align: center; margin-top: 1rem;">
              <button class="btn" onclick="showPage('feed')">Find Similar Users</button>
            </div>
          </div>
        `;
          } else {
            return `
          <div style="margin-bottom: 2rem;">
            <h3>No New Recommendations</h3>
            <p style="color: #666;">Your friends haven't shared new places recently. Check the community feed for more experiences!</p>
          </div>
        `;
          }
        }

        return `
      <div style="margin-bottom: 2rem;">
        <h3>Recommended For You (From Friends)</h3>
        <p style="color: #666; margin-bottom: 1rem;">Based on places your friends have visited and enjoyed</p>
        <div class="activity-grid">
          ${recommendations
            .slice(0, 4)
            .map(
              (rec) => `
            <div class="activity-card" style="border: 2px solid var(--secondary-color);">
                              <div style="background: var(--secondary-gradient); color: white; padding: 0.5rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-radius: 15px 15px 0 0;">
                <div style="font-weight: bold;">Recommended: ${rec.predictedScore.toFixed(
                1
              )}/10</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Confidence: ${(
                  rec.confidence * 100
                ).toFixed(0)}%</div>
              </div>
              <div class="activity-title">${rec.experience.name}</div>
              <div class="activity-category">${rec.experience.category} ‚Ä¢ ${rec.experience.location
                }</div>
              <div class="activity-details">
                ${rec.experience.description
                  ? `<p style="margin: 0.5rem 0; color: #666;">"${rec.experience.description}"</p>`
                  : ""
                }
                <div style="font-size: 0.9rem; color: #888; margin-top: 0.5rem;">
                  Social Intensity: ${rec.experience.socialIntensity.toFixed(
                  1
                )}/10 |
                  Noise Level: ${rec.experience.noiseLevel.toFixed(1)}/10 |
                  Crowd Size: ${rec.experience.crowdSize.toFixed(1)}/10
                </div>
              </div>
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                  Recommended by friends:
                </div>
                ${rec.predictions
                  .slice(0, 2)
                  .map(
                    (p) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; margin-bottom: 0.3rem;">
                    <span>${p.user.displayName} (${p.user.personalityType})</span>
                    <span style="font-weight: bold;">${p.experience.adjustedScore}/10</span>
                  </div>
                `
                  )
                  .join("")}
                <div style="text-align: center; margin-top: 1rem;">
                  <button class="btn" style="font-size: 0.9rem; padding: 8px 16px;"
                          onclick="fillActivityForm('${rec.experience.name
                }', '${rec.experience.category}', '${rec.experience.location
                }', '${rec.experience.description.replace(/'/g, "\\'")}')">
                    Rate This Place
                  </button>
                </div>
              </div>
            </div>
          `
            )
            .join("")}
        </div>
      </div>
    `;
      },
    };
    // Similar Users System
    const SimilarUsersSystem = {
      displaySimilarUsers: () => {
        const personalityData = DataLayer.load("personalityScore");
        if (!personalityData) return "";

        const similarUsers = ActivitySystem.findSimilarUsers(
          personalityData.adjustmentFactor
        );
        const friends = FriendsSystem.getFriends();
        const friendIds = FriendsSystem.getFriendIds();

        // Filter out users who are already friends
        const nonFriendUsers = similarUsers.filter(
          (sim) => !friendIds.includes(sim.user.id)
        );

        return `
      <div style="margin-bottom: 2rem;">
        <h3>Users Similar to You</h3>
        <p style="color: #666; margin-bottom: 1rem;">Connect with people who have similar social energy preferences</p>

        ${friends.length > 0
            ? `
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(118, 191, 255, 0.08); border-radius: 10px;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--header-text);">Your Friends (${friends.length
            })</h4>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${friends
              .map(
                (friend) => `
                <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">
                  <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">
                    ${friend.avatar}
                  </div>
                  ${friend.displayName}
                  <button 
                    onclick="FriendsSystem.removeFriend(${friend.id})"
                    style="background: none; border: none; color: #999; cursor: pointer; font-size: 1rem; margin-left: 0.3rem; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;"
                    onmouseover="this.style.backgroundColor='var(--primary-color)'; this.style.color='white';"
                    onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';"
                    title="Remove friend">
                    √ó
                  </button>
                </div>
              `
              )
              .join("")}
            </div>
          </div>
        `
            : ""
          }

        <div class="similar-users-grid">
          ${nonFriendUsers
            .slice(0, 6)
            .map((sim) => {
              const userExperiences = DemoUsers.experiences.filter(
                (exp) => exp.userId === sim.user.id
              );
              return `
              <div class="similar-user-card">
                <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${sim.user.avatar}
                  </div>
                  <div style="text-align: left;">
                    <div style="font-weight: bold;">${sim.user.displayName
                }</div>
                    <div style="font-size: 0.8rem; color: var(--highlight);">${sim.user.personalityType
                }</div>
                  </div>
                </div>
                <div class="similarity-score">
                  ${(sim.similarity * 100).toFixed(0)}% Similar
                </div>    
                <div style="font-size: 0.8rem; color: #666; margin: 0.8rem 0;">
                  AF: ${sim.user.adjustmentFactor.toFixed(2)}
                </div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem;">
                  "${sim.user.bio}"
                </div>
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">
                  ${userExperiences.length} experiences posted
                </div>
                <div style="text-align: center;">
                  <button class="btn" style="font-size: 0.8rem; padding: 6px 12px;"
                          onclick="FriendsSystem.addFriend(${sim.user.id})">
                    Add Friend
                  </button>
                </div>
              </div>
            `;
            })
            .join("")}
        </div>

        ${nonFriendUsers.length === 0
            ? `
          <div style="text-align: center; color: #666; font-style: italic;">
            You're already friends with all similar users!
          </div>
        `
            : ""
          }
      </div>
    `;
      },
    };

    function updateDashboard() {
      const personalityData = DataLayer.load("personalityScore");
      const personalityType = DataLayer.load("personalityType");
      const currentUser = DataLayer.load("currentUser");

      if (
        personalityData &&
        personalityType &&
        DataLayer.exists("currentUser")
      ) {
        document.getElementById("user-avatar").textContent =
          currentUser.avatar;
        document.getElementById(
          "welcome-message"
        ).innerHTML = `Welcome back, <strong>${currentUser.displayName}</strong>! You're a ${personalityType.type}`;

        const userExperiences = DataLayer.load("userExperiences", []);
        const groups = DataLayer.load("groups", []);

        document.getElementById("dashboard-content").innerHTML = `
      <div style="margin-bottom: 2rem;">
        <h2>Your Social Energy Profile</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${personalityData.adjustmentFactor.toFixed(
          2
        )}</div>
            <div class="stat-label">Adjustment Factor</div>
          </div>
          <div class="stat-card" onclick="showPage('activities')" style="cursor: pointer;">
            <div class="stat-value">${userExperiences.length}</div>
            <div class="stat-label">Experiences</div>
          </div>
          <div class="stat-card" onclick="showPage('groups')" style="cursor: pointer;">
            <div class="stat-value">${groups.length}</div>
            <div class="stat-label">Groups</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${personalityType.type}</div>
            <div class="stat-label">Personality Type</div>
          </div>
        </div>
        <p style="font-style: italic; color: #666; margin: 1.5rem 0; text-align: center;">"${personalityType.description
          }"</p>
        <div class="action-buttons">
          <button class="btn" onclick="showPage('activities')"><i class="fas fa-plus-circle"></i> Add Experience</button>
          <button class="btn btn-secondary" onclick="showPage('feed')"><i class="fas fa-users"></i> Explore Community</button>
        </div>
      </div>

      ${RecommendationSystem.displayRecommendations()}
      ${SimilarUsersSystem.displaySimilarUsers()}
    `;
      }
    }

    function updateProfile() {
      const personalityData = DataLayer.load("personalityScore");
      const personalityType = DataLayer.load("personalityType");
      const userExperiences = DataLayer.load("userExperiences", []);
      const groups = DataLayer.load("groups", []);
      const currentUser = DataLayer.load("currentUser");

      const profileContent = document.getElementById("profile-content");

      if (!personalityData) {
        profileContent.innerHTML = `
      <div class="centered">
        <p style="padding: 1.2rem;">Complete the personality assessment to see your profile.</p>
        <button class="btn" onclick="showPage('assessment')">Take Assessment</button>
      </div>
    `;
        return;
      }

      const avgRating =
        userExperiences.length > 0
          ? userExperiences.reduce(
            (sum, exp) => sum + parseFloat(exp.adjustedScore),
            0
          ) / userExperiences.length
          : 0;

      // Get recommendations for profile
      const recommendations = ActivitySystem.getRecommendations(
        personalityData.adjustmentFactor
      );
      const unratedRecommendations = recommendations.filter(
        (rec) =>
          !userExperiences.some(
            (userExp) =>
              userExp.name.toLowerCase() === rec.experience.name.toLowerCase()
          )
      );

      // Get similar users
      const similarUsers = ActivitySystem.findSimilarUsers(
        personalityData.adjustmentFactor
      );

      profileContent.innerHTML = `
    <div class="user-info" style="margin-bottom: 2rem;">
      <div class="avatar" style="width: 80px; height: 80px; font-size: 2rem;">${currentUser.avatar
        }</div>
      <div>
        <h2 style="margin: 0;">${personalityType.type}</h2>
        <div style="color: var(--secondary-color); font-weight: bold; margin: 0.5rem 0;">Adjustment Factor: ${personalityData.adjustmentFactor.toFixed(
          2
        )}</div>
        <div style="color: #666; font-style: italic;">"${personalityType.description
        }"</div>
      </div>
    </div>

    <div class="stats-grid" style="margin-bottom: 2rem;">
      <div class="stat-card" onclick="showPage('activities')" style="cursor: pointer;">
        <div class="stat-value">${userExperiences.length}</div>
        <div class="stat-label">Experiences</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${avgRating > 0 ? avgRating.toFixed(1) : "0.0"
        }</div>
        <div class="stat-label">Avg Rating</div>
      </div>
      <div class="stat-card" onclick="showPage('groups')" style="cursor: pointer;">
        <div class="stat-value">${groups.length}</div>
        <div class="stat-label">Groups</div>
      </div>
      <div class="stat-card" onclick="showPage('dashboard')" style="cursor: pointer;">
        <div class="stat-value">${unratedRecommendations.length}</div>
        <div class="stat-label">New Recommendations</div>
      </div>
    </div>

    ${userExperiences.length > 0
          ? `
    <div class="card" style="margin-bottom: 2rem;">
      <h3>Your Experiences</h3>
      <div style="max-height: 400px; overflow-y: auto;">
        ${userExperiences
            .map(
              (exp) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #eee; border-radius: 10px; margin-bottom: 0.5rem;">
              <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 0.2rem;">${exp.name
                }</div>
                <div style="color: var(--secondary-color); font-size: 0.9rem; margin-bottom: 0.2rem;">${exp.category
                } ‚Ä¢ ${exp.location}</div>
                ${exp.description
                  ? `<div style="color: #666; font-size: 0.8rem; margin-bottom: 0.2rem;">"${exp.description}"</div>`
                  : ""
                }
                <div style="color: #888; font-size: 0.8rem;">
                  ${new Date(exp.timestamp).toLocaleDateString()} ‚Ä¢
                  Social: ${exp.socialIntensity.toFixed(1)}/10 ‚Ä¢
                  Noise: ${exp.noiseLevel.toFixed(1)}/10 ‚Ä¢
                  Crowd: ${exp.crowdSize.toFixed(1)}/10
                </div>
              </div>
              <div style="text-align: right; margin-left: 1rem;">
                <div style="font-weight: bold; font-size: 1.3rem; color: var(--secondary-color);">${exp.adjustedScore
                }/10</div>
                <div style="font-size: 0.8rem; color: #888;">Raw: ${exp.rawScore
                }/10</div>
              </div>
            </div>
        `
            )
            .join("")}
      </div>
    </div>`
          : `
    <div class="card" style="margin-bottom: 2rem;">
      <h3>Your Experiences</h3>
      <div class="empty-state">
        <p>You haven't added any experiences yet.</p>
        <button class="btn" onclick="showPage('activities')">Add Your First Experience</button>
      </div>
    </div>`
        }

    <div class="card" style="margin-bottom: 2rem;">
      <h3>Personality Breakdown</h3>
      <div style="margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>Introversion</span>
          <span>Extroversion</span>
        </div>
        <div style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; position: relative;">
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 100%; background: #ccc;"></div>
          <div style="width: ${((personalityData.adjustmentFactor + 1) / 2) * 100
        }%; height: 100%; background: var(--primary-gradient); border-radius: 10px; position: relative;">
            <div style="position: absolute; right: -10px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: white; border: 3px solid var(--secondary-color); border-radius: 50%;"></div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 0.5rem; font-weight: bold; color: var(--secondary-color);">
          ${personalityData.adjustmentFactor.toFixed(2)}
        </div>
      </div>
    </div>

            <div class="card" style="margin-bottom: 2rem;">
          <h3>Most Compatible Users</h3>
          <div class="similar-users-grid">
            ${similarUsers
          .slice(0, 3)
          .map(
            (sim) => `
                <div style="text-align: center; padding: 1rem; border: 1px solid #eee; border-radius: 10px;">
                  <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto 0.5rem;">
                    ${sim.user.avatar}
                  </div>
                  <div style="font-weight: bold; margin-bottom: 0.2rem;">${sim.user.displayName
              }</div>
                  <div style="font-size: 0.8rem; color: var(--secondary-color); margin-bottom: 0.3rem;">${sim.user.personalityType
              }</div>
                  <div style="font-size: 0.8rem; color: #4CAF50; font-weight: bold;">${(
                sim.similarity * 100
              ).toFixed(0)}% Match</div>
                  <button class="btn" style="margin-top: 0.5rem; font-size: 0.8rem; padding: 6px 12px;" 
                          onclick="FriendsSystem.addFriend(${sim.user.id})">
                    ${FriendsSystem.isFriend(sim.user.id)
                ? '<span style="background: #f8f9fa; color: var(--primary-color); font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--primary-color);">‚úì Friend</span>'
                : "Add Friend"
              }
                  </button>
                </div>
            `
          )
          .join("")}
          </div>
        </div>

    <div class="action-buttons">
      <button class="btn" onclick="showPage('activities')"><i class="fas fa-plus-circle"></i> Add Experience</button>
      <button class="btn btn-secondary" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
      <button class="btn btn-secondary" onclick="showPage('groups')"><i class="fas fa-users"></i> Groups</button>
    </div>
  `;
    }

    // UI Management
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll(".page").forEach((page) => {
        page.classList.add("hidden");
      });

      // Update active navigation
      document.querySelectorAll(".nav-links a").forEach((link) => {
        link.classList.remove("active");
      });
      const navElement = document.getElementById(`nav-${pageId}`);
      if (navElement) {
        navElement.classList.add("active");
      }

      // Show selected page
      document.getElementById(pageId).classList.remove("hidden");

      // Page-specific initialization
      switch (pageId) {
        case "dashboard":
          updateDashboard();
          break;
        case "assessment":
          PersonalityAssessment.init();
          break;
        case "activities":
          if (!DataLayer.exists("personalityScore")) {
            NotificationSystem.show(
              "Please complete the personality assessment first!",
              "warning"
            );
            showPage("assessment");
            return;
          }
          setTimeout(() => initializeLocationAutocomplete(), 100);
          break;
        case "feed":
          FeedSystem.init();
          break;
        case "groups":
          GroupsSystem.init();
          break;
        case "profile":
          updateProfile();
          break;
      }
    }

    function nextQuestion() {
      PersonalityAssessment.currentQuestion++;

      if (
        PersonalityAssessment.currentQuestion >=
        PersonalityAssessment.questions.length
      ) {
        PersonalityAssessment.showResults();
      } else {
        PersonalityAssessment.displayQuestion();
        document.getElementById("next-btn").disabled = true;
      }
    }

    function completeAssessment() {
      showPage("dashboard");
    }

    function updateSliderValue(slider, targetId) {
      document.getElementById(targetId).textContent = slider.value;
    }

    function resetActivityForm() {
      document.getElementById("activity-form").reset();

      // Reset all sliders to 5
      ActivitySystem.ratingQuestions.forEach((question) => {
        const slider = document.getElementById(`rating-${question.id}`);
        const display = document.getElementById(`slider-${question.id}`);
        if (slider && display) {
          slider.value = 5;
          display.textContent = "5";
        }
      });
    }

    // Notification system
    const NotificationSystem = {
  show: (message, type = "info", duration = 3000) => {
    const notification = document.createElement("div");
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      z-index: 10000;
      transform: translateX(100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 350px;
      min-width: 280px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    `;

    // Set background and icon based on type
    let icon;
    let bgColor = "var(--background-alt-color)"
    
    switch (type) {
      case "success":
        notification.style.borderLeft = "4px solid #10b981";
        icon = `<svg width="20" height="20" fill="var(--success-color)" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>`;
        break;
      case "error":
        notification.style.borderLeft = "4px solid var(--error-color)";
        icon = `<svg width="20" height="20" fill="#ef4444" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>`;
        break;
      case "warning":
        notification.style.borderLeft = "4px solid var(--warning-color)";
        icon = `<svg width="20" height="20" fill="#f59e0b" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>`;
        break;
      default:
        notification.style.borderLeft = "4px solid #3b82f6";
        icon = `<svg width="20" height="20" fill="var(--info-color)" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>`;
    }

    notification.style.backgroundColor = bgColor;

    // Create icon element
    const iconEl = document.createElement("div");
    iconEl.innerHTML = icon;
    iconEl.style.cssText = `
      flex-shrink: 0;
      margin-top: 1px;
    `;

    // Create content container
    const contentEl = document.createElement("div");
    contentEl.style.cssText = `
      flex: 1;
      line-height: 1.5;
    `;

    // Create message element
    const messageEl = document.createElement("div");
    messageEl.textContent = message;
    messageEl.style.cssText = `
      color: var(--primary-color);
      font-weight: 500;
    `;

    // Create close button
    const closeBtn = document.createElement("button");
    closeBtn.innerHTML = `<svg width="16" height="16" fill="var(--muted-text-color)" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
    </svg>`;
    closeBtn.style.cssText = `
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      margin: -4px -4px -4px 4px;
      border-radius: 6px;
      transition: all 0.2s ease;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      
    `;

    // Add hover effect to close button
    closeBtn.addEventListener("mouseenter", () => {
      closeBtn.style.backgroundColor = "#f3f4f6";
      closeBtn.querySelector('svg').setAttribute('fill', '#6b7280');
    });
    closeBtn.addEventListener("mouseleave", () => {
      closeBtn.style.backgroundColor = "transparent";
      closeBtn.querySelector('svg').setAttribute('fill', '#9ca3af');
    });

    // Function to remove notification
    const removeNotification = () => {
      notification.style.transform = "translateX(100%)";
      notification.style.opacity = "0";
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    };

    // Close button click handler
    closeBtn.addEventListener("click", removeNotification);

    // Append elements
    contentEl.appendChild(messageEl);
    notification.appendChild(iconEl);
    notification.appendChild(contentEl);
    notification.appendChild(closeBtn);
    document.body.appendChild(notification);

    // Animate in
    requestAnimationFrame(() => {
      notification.style.transform = "translateX(0)";
      notification.style.opacity = "1";
    });

    // Auto-remove after duration
    const autoRemoveTimer = setTimeout(removeNotification, duration);

    // Clear timer if manually closed
    closeBtn.addEventListener("click", () => {
      clearTimeout(autoRemoveTimer);
    });

    // Add pause on hover
    notification.addEventListener("mouseenter", () => {
      clearTimeout(autoRemoveTimer);
    });

    notification.addEventListener("mouseleave", () => {
      setTimeout(removeNotification, 1000); // Give 1 second after mouse leave
    });
  },
};
    // Location autocomplete functionality
    function initializeLocationAutocomplete() {
      // Check if Google Maps API is available
      if (
        typeof google !== "undefined" &&
        google.maps &&
        google.maps.places
      ) {
        const locationInput = document.getElementById("activity-location");
        if (locationInput) {
          const autocomplete = new google.maps.places.Autocomplete(
            locationInput,
            {
              types: ["establishment", "geocode"],
              fields: ["name", "formatted_address", "place_id"],
            }
          );

          autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.formatted_address) {
              locationInput.value = place.formatted_address;
            }
          });
        }
      } else {
        // Fallback: Simple location suggestions (common areas)
        const locationInput = document.getElementById("activity-location");
        if (locationInput) {
          const commonLocations = [
            "Downtown",
            "City Center",
            "University District",
            "Arts District",
            "Entertainment District",
            "Shopping District",
            "Financial District",
            "Old Town",
            "Midtown",
            "Uptown",
            "Suburbs",
            "Waterfront",
            "North Side",
            "South Side",
            "East Side",
            "West Side",
          ];

          locationInput.addEventListener("input", (e) => {
            const value = e.target.value.toLowerCase();
            if (value.length > 0) {
              const matches = commonLocations.filter((loc) =>
                loc.toLowerCase().includes(value)
              );

              // Create simple dropdown (basic implementation)
              let dropdown = document.getElementById("location-dropdown");
              if (dropdown) dropdown.remove();

              if (
                matches.length > 0 &&
                matches.length < commonLocations.length
              ) {
                dropdown = document.createElement("div");
                dropdown.id = "location-dropdown";
                dropdown.style.cssText = `
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              max-height: 200px;
              overflow-y: auto;
              z-index: 1000;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            `;

                matches.slice(0, 5).forEach((match) => {
                  const option = document.createElement("div");
                  option.style.cssText = `
                padding: 12px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
              `;
                  option.textContent = match;
                  option.addEventListener("mouseenter", () => {
                    option.style.background = "#f5f5f5";
                  });
                  option.addEventListener("mouseleave", () => {
                    option.style.background = "white";
                  });
                  option.addEventListener("click", () => {
                    locationInput.value = match;
                    dropdown.remove();
                  });
                  dropdown.appendChild(option);
                });

                locationInput.parentNode.style.position = "relative";
                locationInput.parentNode.appendChild(dropdown);
              }
            }
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            const dropdown = document.getElementById("location-dropdown");
            if (
              dropdown &&
              !locationInput.contains(e.target) &&
              !dropdown.contains(e.target)
            ) {
              dropdown.remove();
            }
          });
        }
      }
    }

    // Initialize app
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize demo data in memory to make the app feel populated
      const demoExperiences = DemoUsers.experiences.map((exp) => ({
        ...exp,
      }));

      showPage("dashboard");
    });

    // Keyboard shortcuts for power users
    document.addEventListener("keydown", (event) => {
      // Escape to close modals
      if (event.key === "Escape") {
        // Close all possible modals
        const modals = [
          document.getElementById("ai-premium-modal"),
          document.getElementById("ai-assistant-modal"),
          document.getElementById("ai-edit-modal")
        ];
        
        modals.forEach(modal => {
          if (modal && !modal.classList.contains("hidden")) {
            modal.remove();
          }
        });
        
        // Also try the generic closeModal function
        if (typeof closeModal === 'function') {
          closeModal();
        }
      }
    });

    // Enhanced activity submission with notifications
    const EnhancedActivitySystem = {
      submitWithNotification: (event) => {
        try {
          ActivitySystem.submitNewExperience(event);
          NotificationSystem.show(
            "Experience added successfully!",
            "success"
          );
        } catch (error) {
          console.error("Failed to submit experience:", error);
          NotificationSystem.show(
            "Failed to add experience. Please try again.",
            "error"
          );
        }
      },
    };

    // Error handling wrapper
    function safeExecute(fn, errorMessage = "An error occurred") {
      try {
        return fn();
      } catch (error) {
        console.error(errorMessage, error);
        NotificationSystem.show(
          errorMessage + ". Please try again.",
          "error"
        );
        return null;
      }
    }

    // Data export functionality (for demo purposes)
    function exportUserData() {
      const userData = {
        personality: DataLayer.load("personalityScore"),
        personalityType: DataLayer.load("personalityType"),
        experiences: DataLayer.load("userExperiences", []),
        groups: DataLayer.load("groups", []),
        friends: DataLayer.load("friends", []),
        exportDate: new Date().toISOString(),
      };

      const dataStr = JSON.stringify(userData, null, 2);
      const dataBlob = new Blob([dataStr], { type: "application/json" });

      const link = document.createElement("a");
      link.href = URL.createObjectURL(dataBlob);
      link.download = "social-energy-data.json";
      link.click();
    }

    // Final initialization
    console.log("Social Energy App initialized successfully!");
    console.log("Use Alt+1-6 for quick navigation between pages");
    console.log("Demo includes:", {
      users: Object.keys(DemoUsers.users).length,
      experiences: DemoUsers.experiences.length,
      features: [
        "Personality Assessment",
        "Activity Tracking",
        "Social Feed",
        "Group Planning",
        "Personalized Recommendations",
      ],
    });
  </script>
</body>
</html>